<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG — Inventory</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <script type="module" src="./js/pwa.js"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Inventory...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  <!-- Supplier Modal -->
  <div id="supplierModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[70]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-lg">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 id="supplier-modal-title" class="text-nfgblue dark:text-blue-400 font-semibold">Add Supplier</h4>
        <button data-action="close-modal" data-target="supplierModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="supplier-form" class="p-4 space-y-4">
        <input type="hidden" id="supplier-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Supplier Name <span class="text-red-500">*</span></label>
            <input type="text" id="supplier-name" required class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Contact Person</label>
            <input type="text" id="supplier-contact" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Email</label>
            <input type="email" id="supplier-email" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Phone</label>
            <input type="text" id="supplier-phone" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Preferred Contact</label>
            <select id="supplier-preferred-contact" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="">None</option>
              <option value="email">Email</option>
              <option value="phone">Phone</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" id="supplier-active" class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue" checked />
            <label for="supplier-active" class="text-sm font-medium text-gray-600 dark:text-gray-400">Active supplier</label>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Notes</label>
          <textarea id="supplier-notes" rows="3" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none"></textarea>
        </div>
        <div id="supplier-form-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl px-3 py-2"></div>
        <div class="flex items-center justify-end gap-2 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="supplierModal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark">
            Save Supplier
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Purchase Order Modal -->
  <div id="poModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[70]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-3xl">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">New Purchase Order</h4>
        <button data-action="close-modal" data-target="poModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="po-form" class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Supplier <span class="text-red-500">*</span></label>
            <select id="po-supplier" required class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="">Select supplier</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Site <span class="text-red-500">*</span></label>
            <select id="po-site" required class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="">Select site</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Expected Date</label>
            <input type="date" id="po-expected-date" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Notes</label>
            <textarea id="po-notes" rows="2" class="w-full border border-nfgray rounded-xl px-3 py-2 focus:ring-2 focus:ring-nfgblue outline-none"></textarea>
          </div>
        </div>

        <div class="border border-nfgray rounded-xl overflow-hidden">
          <div class="flex items-center justify-between px-3 py-2 border-b border-nfgray bg-nfglight/40 dark:bg-gray-700/40">
            <h5 class="font-medium text-nfgblue dark:text-blue-400">Items</h5>
            <button type="button" id="add-po-item-row" class="inline-flex items-center gap-1 px-3 py-1 rounded-lg border border-nfgray hover:bg-nfglight text-sm">
              <i data-lucide="plus" class="w-4 h-4"></i> Add Item
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-nfglight/40 border-b border-nfgray">
                <tr>
                  <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Item</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Quantity</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Cost / Unit</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Total</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400"></th>
                </tr>
              </thead>
              <tbody id="po-items-table">
                <tr data-placeholder="true">
                  <td colspan="5" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">No items added yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Estimated Total</p>
            <p id="po-total-value" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">$0.00</p>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" data-action="close-modal" data-target="poModal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark">
              Create Purchase Order
            </button>
          </div>
        </div>
        <div id="po-form-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl px-3 py-2"></div>
      </form>
    </div>
  </div>

  <!-- Purchase Order Detail Modal -->
  <div id="poDetailModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[75]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide">Purchase Order</p>
          <h4 id="po-detail-title" class="text-nfgblue dark:text-blue-400 font-semibold text-lg">PO Details</h4>
        </div>
        <button data-action="close-modal" data-target="poDetailModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border border-nfgray rounded-xl p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Supplier</p>
            <p id="po-detail-supplier" class="font-semibold text-nfgblue dark:text-blue-400">—</p>
            <p class="text-xs text-gray-500 dark:text-gray-400" id="po-detail-site">Site: —</p>
            <p class="text-xs text-gray-500 dark:text-gray-400" id="po-detail-expected">Expected: —</p>
          </div>
          <div class="border border-nfgray rounded-xl p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 uppercase mb-2">Payment Status</p>
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Paid</p>
                <p id="po-detail-paid" class="font-semibold text-green-600">$0.00</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Balance</p>
                <p id="po-detail-balance" class="font-semibold text-rose-600">$0.00</p>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="border border-nfgray rounded-xl p-4 space-y-3">
            <div class="flex items-center justify-between">
              <h5 class="font-semibold text-nfgblue dark:text-blue-400">Payments</h5>
              <button id="add-po-payment-btn" class="px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">Add Payment</button>
            </div>
            <div id="po-payments-list" class="space-y-3">
              <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">No payments recorded</p>
            </div>
            <form id="po-payment-form" class="hidden space-y-3 border-t border-nfgray pt-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Amount</label>
                  <input type="number" step="0.01" min="0" id="po-payment-amount" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" required />
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Date</label>
                  <input type="date" id="po-payment-date" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Method</label>
                  <input type="text" id="po-payment-method" placeholder="ACH, Wire..." class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Reference</label>
                  <input type="text" id="po-payment-reference" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Notes</label>
                <textarea id="po-payment-notes" rows="2" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none"></textarea>
              </div>
              <div class="flex items-center justify-end gap-2">
                <button type="button" id="cancel-po-payment" class="px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">Cancel</button>
                <button type="submit" class="px-3 py-1.5 rounded-lg bg-nfgblue text-white text-sm font-medium hover:bg-nfgdark">Save Payment</button>
              </div>
            </form>
          </div>
          <div class="border border-nfgray rounded-xl p-4 space-y-3">
            <div class="flex items-center justify-between">
              <h5 class="font-semibold text-nfgblue dark:text-blue-400">Documents</h5>
              <button id="add-po-doc-btn" class="px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">Upload</button>
            </div>
            <div id="po-documents-list" class="space-y-3">
              <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">No documents uploaded</p>
            </div>
            <form id="po-doc-form" class="hidden space-y-3 border-t border-nfgray pt-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Document Type</label>
                <select id="po-doc-type" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                  <option value="packing_slip">Packing Slip</option>
                  <option value="invoice">Invoice</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">File</label>
                <input type="file" id="po-doc-file" accept="application/pdf,image/*" class="w-full text-sm" required />
              </div>
              <div class="flex items-center justify-end gap-2">
                <button type="button" id="cancel-po-doc" class="px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">Cancel</button>
                <button type="submit" class="px-3 py-1.5 rounded-lg bg-nfgblue text-white text-sm font-medium hover:bg-nfgdark">Upload</button>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Max 10MB. Stored in Supabase bucket <code>purchase-order-docs</code>.</p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <!-- Northern Facilities Group Logo -->
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
        alt="Northern Facilities Group" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="dashboard.html">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Overview
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="sites.html">
        <i data-lucide="map-pin" class="w-4 h-4"></i> Sites
      </a>
      <a id="nav-bookings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="bookings.html">
        <i data-lucide="calendar" class="w-4 h-4"></i> Bookings
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="jobs.html">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i> Jobs
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="inventory.html">
        <i data-lucide="package" class="w-4 h-4"></i> Inventory
      </a>
      <a id="nav-reports" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="reports.html">
        <i data-lucide="file-chart-column" class="w-4 h-4"></i> Reports
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700">
      <button id="logout-btn" class="w-full border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Inventory</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <!-- Site Filter -->
          <select id="site-filter" data-custom-dropdown="true" data-placeholder="All Sites" class="px-2 sm:px-3 py-1.5 rounded-lg sm:rounded-xl border border-nfgray bg-white dark:bg-gray-800 text-xs sm:text-sm flex-shrink-0">
            <option value="all">All Sites</option>
          </select>
          
          <!-- Add Item Button -->
          <button id="add-item-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition flex-shrink-0"
>
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span class="hidden sm:inline text-xs sm:text-sm">Add Item</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-4 md:p-6 space-y-6">
      <div class="flex items-center justify-between gap-4 pb-2">
      <div>
        <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Inventory Management</h2>
        <p class="text-sm text-gray-500 mt-1">Track supplies and equipment across all sites</p>
        </div>
        <!-- Select All Checkbox (only for non-staff) -->
        <div id="select-all-inventory-container" class="hidden flex items-center gap-2 px-3 py-2 whitespace-nowrap flex-shrink-0">
          <input 
            type="checkbox" 
            id="select-all-inventory" 
            class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue cursor-pointer"
            aria-label="Select all inventory items"
          />
          <label for="select-all-inventory" class="text-sm font-medium text-nfgblue dark:text-blue-400 cursor-pointer">
            Select All
          </label>
        </div>
      </div>

      <!-- Low Stock Alerts Banner -->
      <div id="low-stock-alerts" class="hidden bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-xl p-4">
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3 flex-1">
            <div class="flex-shrink-0 mt-0.5">
              <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-orange-900 dark:text-orange-200 mb-1">Low Stock Alert</h3>
              <p class="text-sm text-orange-700 dark:text-orange-300 mb-2">
                <span id="low-stock-count">0</span> item(s) are running low on stock and need to be restocked.
              </p>
              <div id="low-stock-items-list" class="flex flex-wrap gap-2">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
          <button id="dismiss-low-stock-alert" class="flex-shrink-0 p-1 rounded-lg hover:bg-orange-100 dark:hover:bg-orange-800/50 text-orange-600 dark:text-orange-400">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Inventory Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Items</p>
              <p id="total-items-count" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">0</p>
            </div>
            <div class="p-3 bg-nfglight dark:bg-gray-700 rounded-lg">
              <i data-lucide="package" class="w-6 h-6 text-nfgblue dark:text-blue-400"></i>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Low Stock</p>
              <p id="low-stock-summary-count" class="text-2xl font-semibold text-orange-600 dark:text-orange-400">0</p>
            </div>
            <div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
              <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Out of Stock</p>
              <p id="out-of-stock-count" class="text-2xl font-semibold text-red-600 dark:text-red-400">0</p>
            </div>
            <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
              <i data-lucide="package-x" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Active Sites</p>
              <p id="active-sites-count" class="text-2xl font-semibold text-green-600 dark:text-green-400">0</p>
            </div>
            <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
              <i data-lucide="map-pin" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- View Toggle -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex bg-nfglight/60 dark:bg-gray-800 rounded-xl p-1 w-full sm:w-auto">
          <button class="inventory-view-tab flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-white bg-nfgblue shadow-nfg transition" data-view="inventory">
            Inventory
          </button>
          <button class="inventory-view-tab flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-nfgblue hover:bg-white/70 transition" data-view="history">
            History
          </button>
          <button class="inventory-view-tab flex-1 sm:flex-none px-4 py-2 rounded-lg text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-nfgblue hover:bg-white/70 transition" data-view="suppliers">
            Suppliers &amp; Orders
          </button>
        </div>
        <div id="history-inline-actions" class="hidden sm:flex items-center gap-2">
          <button id="history-refresh-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition">
            Refresh
          </button>
          <button id="history-export-btn" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition">
            Export CSV
          </button>
        </div>
        <div id="suppliers-inline-actions" class="hidden sm:flex items-center gap-2">
          <button id="add-supplier-btn" class="px-4 py-2 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight text-sm font-medium transition">
            Add Supplier
          </button>
          <button id="new-po-btn" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition">
            New Purchase Order
          </button>
        </div>
      </div>

      <!-- Inventory View -->
      <div id="inventory-view" class="space-y-6">
      <!-- Category Tabs -->
      <div class="flex gap-2 border-b border-nfgray overflow-x-auto">
        <button class="inventory-filter-tab px-4 py-2 font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue whitespace-nowrap" data-category="all">
          All Items
        </button>
        <button class="inventory-filter-tab px-4 py-2 font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-category="Cleaning Supplies">
           Cleaning
        </button>
        <button class="inventory-filter-tab px-4 py-2 font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-category="Chemicals">
           Chemicals
        </button>
        <button class="inventory-filter-tab px-4 py-2 font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-category="Tools">
           Tools
        </button>
        <button class="inventory-filter-tab px-4 py-2 font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-category="Paper Products">
           Paper
        </button>
        <button class="inventory-filter-tab px-4 py-2 font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-category="PPE">
           PPE
        </button>
      </div>

      <!-- Inventory Table -->
      <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-nfglight/50 border-b border-nfgray dark:border-gray-700">
              <tr>
                  <th class="px-4 py-3 text-left text-sm font-medium text-nfgblue dark:text-blue-400 w-10">
                    <!-- Checkbox column -->
                  </th>
                <th class="px-4 py-3 text-left text-sm font-medium text-nfgblue dark:text-blue-400">Item</th>
                <th class="px-4 py-3 text-left text-sm font-medium text-nfgblue dark:text-blue-400 hidden md:table-cell">Category</th>
                <th class="px-4 py-3 text-center text-sm font-medium text-nfgblue dark:text-blue-400">Quantity</th>
                <th class="px-4 py-3 text-center text-sm font-medium text-nfgblue dark:text-blue-400">Status</th>
                <th class="px-4 py-3 text-center text-sm font-medium text-nfgblue dark:text-blue-400">Actions</th>
              </tr>
            </thead>
            <tbody id="inventory-table-body" class="divide-y divide-nfgray">
              <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading inventory...</td>
              </tr>
            </tbody>
          </table>
          </div>
        </div>
      </div>

      <!-- History View -->
      <div id="history-view" class="hidden space-y-4">
        <!-- History Summary -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Transactions</p>
            <p id="history-total-count" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Restocks</p>
            <p id="history-restock-count" class="text-2xl font-semibold text-green-600 dark:text-green-400">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Usage</p>
            <p id="history-use-count" class="text-2xl font-semibold text-red-600 dark:text-red-400">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Adjustments</p>
            <p id="history-adjustment-count" class="text-2xl font-semibold text-blue-600 dark:text-blue-400">0</p>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-nfgblue dark:text-blue-400">Transaction Type</label>
              <select id="history-type-filter" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                <option value="all">All Types</option>
                <option value="restock">Restock</option>
                <option value="use">Usage</option>
                <option value="adjustment">Adjustment</option>
                <option value="transfer">Transfer</option>
                <option value="return">Return</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-nfgblue dark:text-blue-400">Site</label>
              <select id="history-site-filter" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                <option value="all">All Sites</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-nfgblue dark:text-blue-400">Search</label>
              <input type="text" id="history-search-input" placeholder="Search item, site, or user" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1 text-nfgblue dark:text-blue-400">Date From</label>
              <input type="date" id="history-date-from" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1 text-nfgblue dark:text-blue-400">Date To</label>
              <input type="date" id="history-date-to" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none" />
            </div>
            <div class="flex items-end gap-2">
              <button id="history-apply-filters" class="w-full bg-nfgblue text-white rounded-lg px-4 py-2 text-sm font-medium hover:bg-nfgdark transition">
                Apply Filters
              </button>
              <button id="history-clear-filters" class="w-full border border-nfgray rounded-lg px-4 py-2 text-sm font-medium text-nfgblue hover:bg-nfglight transition">
                Clear
              </button>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 sm:justify-end">
            <button id="history-refresh-btn-mobile" class="sm:hidden px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition">
              Refresh
            </button>
            <button id="history-export-btn-mobile" class="sm:hidden px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition">
              Export CSV
            </button>
          </div>
        </div>

        <!-- History Table -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-nfglight/50 border-b border-nfgray dark:border-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Date</th>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Item</th>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Site</th>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Type</th>
                  <th class="px-4 py-3 text-center font-medium text-nfgblue dark:text-blue-400">Change</th>
                  <th class="px-4 py-3 text-center font-medium text-nfgblue dark:text-blue-400">Before → After</th>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">By</th>
                  <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Notes</th>
                </tr>
              </thead>
              <tbody id="history-table-body">
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">History data will load once filters are applied</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Suppliers & Purchase Orders View -->
      <div id="suppliers-view" class="hidden space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Active Suppliers</p>
            <p id="suppliers-active-count" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Pending Orders</p>
            <p id="po-pending-count" class="text-2xl font-semibold text-orange-500">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Received Orders</p>
            <p id="po-received-count" class="text-2xl font-semibold text-green-600">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Open Items</p>
            <p id="po-open-items-count" class="text-2xl font-semibold text-purple-600">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <p class="text-sm text-gray-500 dark:text-gray-400">Outstanding Balance</p>
            <p id="po-outstanding-amount" class="text-2xl font-semibold text-rose-600">$0.00</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg p-4 flex flex-col">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Suppliers</h3>
              <button id="refresh-suppliers-btn" class="px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">Refresh</button>
            </div>
            <div id="suppliers-list" class="divide-y divide-nfgray dark:divide-gray-700 overflow-y-auto max-h-[480px]">
              <p class="text-center text-gray-500 dark:text-gray-400 py-8">No suppliers yet</p>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg p-4 lg:col-span-2">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Purchase Orders</h3>
              <div class="flex flex-wrap items-center gap-2">
                <select id="po-status-filter" class="border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                  <option value="all">All Statuses</option>
                  <option value="draft">Draft</option>
                  <option value="pending">Pending</option>
                  <option value="ordered">Ordered</option>
                  <option value="received">Received</option>
                  <option value="cancelled">Cancelled</option>
                </select>
                <select id="po-supplier-filter" class="border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                  <option value="all">All Suppliers</option>
                </select>
                <button id="po-refresh-btn" class="px-3 py-2 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm">
                  Refresh
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-nfglight/50 border-b border-nfgray dark:border-gray-700">
                  <tr>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">PO #</th>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Supplier</th>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Site</th>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Expected</th>
                    <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Items</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Status</th>
                  <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Balance</th>
                    <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Actions</th>
                  </tr>
                </thead>
                <tbody id="po-table-body">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No purchase orders yet</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bulk Actions Toolbar for Inventory -->
  <div id="bulk-inventory-toolbar" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-lg p-4 z-50 max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between gap-4 flex-nowrap">
      <span id="selected-inventory-count" class="text-sm font-medium text-nfgblue dark:text-blue-400 whitespace-nowrap flex-shrink-0">
        0 selected
      </span>
      <div class="flex gap-2 flex-nowrap items-center">
        <button id="bulk-update-quantity-inventory" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Update Quantity
        </button>
        <button id="bulk-update-category-inventory" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Update Category
        </button>
        <button id="bulk-export-inventory" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Export CSV
        </button>
        <button id="bulk-cancel-inventory" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Quantity Update Modal -->
  <div id="bulk-quantity-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Update Quantity</h4>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Update Type</label>
          <select id="quantity-update-type" data-custom-dropdown="true" data-placeholder="Select update type" class="w-full border border-nfgray rounded-xl p-2.5 bg-white dark:bg-gray-700">
            <option value="set">Set to specific amount</option>
            <option value="adjust">Adjust by amount (+/-)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Amount</label>
          <input 
            type="number" 
            id="quantity-amount" 
            class="w-full border border-nfgray rounded-xl p-2.5 bg-white dark:bg-gray-700"
            placeholder="Enter amount"
            required
          />
        </div>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end gap-2">
        <button data-cancel-quantity class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
        <button id="confirm-quantity-update" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark font-medium transition">
          Update
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Category Update Modal -->
  <div id="bulk-category-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Select Category</h4>
      </div>
      <div class="p-4 max-h-96 overflow-y-auto space-y-2" id="bulk-category-list">
        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading categories...</p>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end">
        <button data-cancel-category class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Item Modal -->
  <div id="itemModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
        <h4 id="modal-title" class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Add Item</h4>
        <button data-action="close-modal" data-target="itemModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="item-form" class="p-6 space-y-4">
        <input type="hidden" id="item-id" name="id" />
        
        <div>
          <label class="block text-sm font-medium mb-1.5">Item Name <span class="text-red-500">*</span></label>
          <input type="text" id="item-name" name="name" required placeholder="e.g., Bleach (5L)" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Category <span class="text-red-500">*</span></label>
            <select id="item-category" name="category_id" required class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="">Select category</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Unit <span class="text-red-500">*</span></label>
            <select id="item-unit" name="unit" required class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="pieces">Pieces</option>
              <option value="bottles">Bottles</option>
              <option value="boxes">Boxes</option>
              <option value="packs">Packs</option>
              <option value="rolls">Rolls</option>
              <option value="liters">Liters</option>
              <option value="gallons">Gallons</option>
              <option value="kilograms">Kilograms</option>
              <option value="pairs">Pairs</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Low Stock Threshold</label>
            <input type="number" id="item-threshold" name="low_stock_threshold" min="0" value="5" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
            <p class="text-xs text-gray-500 mt-1">Alert when quantity falls below this number</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Reorder Quantity</label>
            <input type="number" id="item-reorder" name="reorder_quantity" min="0" value="20" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
            <p class="text-xs text-gray-500 mt-1">Suggested quantity to order</p>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Notes</label>
          <textarea id="item-notes" name="notes" rows="2" placeholder="Additional information..." class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>

        <div id="item-form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="itemModal" class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button type="submit" id="submit-item-btn" class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Save Item
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Stock Modal (Use/Restock) -->
  <div id="stockModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-lg">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 id="stock-modal-title" class="text-nfgblue dark:text-blue-400 font-semibold">Manage Stock</h4>
        <button data-action="close-modal" data-target="stockModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="stock-form" class="p-6 space-y-4">
        <input type="hidden" id="stock-site-id" name="site_id" />
        <input type="hidden" id="stock-item-id" name="item_id" />
        
        <div class="bg-nfglight/30 rounded-xl p-4 border border-nfgblue/20">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">Item:</span>
            <span id="stock-item-name" class="font-semibold text-nfgblue dark:text-blue-400"></span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600 dark:text-gray-400">Current Stock:</span>
            <span id="stock-current-qty" class="text-2xl font-bold text-nfgblue dark:text-blue-400"></span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Action <span class="text-red-500">*</span></label>
          <select id="stock-action" name="transaction_type" required class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none">
            <option value="restock">Restock (Add)</option>
            <option value="use">Use (Remove)</option>
            <option value="adjustment">Adjustment (Set Exact Qty)</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Quantity <span class="text-red-500">*</span></label>
          <input type="number" id="stock-quantity" name="quantity" min="1" required class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Notes</label>
          <textarea id="stock-notes" name="notes" rows="2" placeholder="Why are you changing the stock?" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>

        <div id="stock-form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="stockModal" class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button type="submit" id="submit-stock-btn" class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Update Stock
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- View History Modal -->
  <div id="historyModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Transaction History</h4>
        <div class="flex items-center gap-2">
          <button id="export-history-btn" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 text-nfgblue dark:text-blue-400" title="Export to CSV">
            <i data-lucide="download" class="w-5 h-5"></i>
          </button>
          <button data-action="close-modal" data-target="historyModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="bg-nfglight/30 rounded-xl p-4 border border-nfgblue/20 mb-4">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <span id="history-item-name" class="font-semibold text-nfgblue dark:text-blue-400 text-lg"></span>
              <span id="history-site-name" class="text-sm text-gray-600 dark:text-gray-400 ml-2"></span>
            </div>
          </div>
        </div>

        <!-- History Filters -->
        <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Transaction Type</label>
            <select id="history-filter-type" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
              <option value="all">All Types</option>
              <option value="restock">Restock</option>
              <option value="use">Use</option>
              <option value="adjustment">Adjustment</option>
              <option value="transfer">Transfer</option>
              <option value="return">Return</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Date From</label>
            <input type="date" id="history-filter-date-from" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
          </div>
          <div>
            <label class="block text-xs font-medium mb-1 text-gray-600 dark:text-gray-400">Date To</label>
            <input type="date" id="history-filter-date-to" class="w-full border border-nfgray rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
          </div>
          <div class="flex items-end">
            <button id="apply-history-filters" class="w-full bg-nfgblue hover:bg-nfgdark text-white rounded-lg px-4 py-2 text-sm font-medium transition">
              Apply Filters
            </button>
          </div>
        </div>
        
        <div id="history-list" class="space-y-3">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      
      // Initialize mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleButtons = document.querySelectorAll('[data-action="toggle-sidebar"], button[aria-label="Toggle sidebar"]');
      
      let overlay = document.getElementById('sidebar-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';
        document.body.appendChild(overlay);
      }
      
      function toggleSidebar() {
        if (sidebar && overlay) {
          const isHidden = sidebar.classList.contains('hidden') || !sidebar.classList.contains('mobile-sidebar-open');
          
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in');
            overlay.classList.remove('hidden');
            overlay.classList.add('animate-fade-in');
            document.body.style.overflow = 'hidden';
          } else {
            sidebar.classList.add('animate-slide-out');
            overlay.classList.add('animate-fade-out');
            
            setTimeout(() => {
              sidebar.classList.add('hidden');
              sidebar.classList.remove('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in', 'animate-slide-out');
              overlay.classList.add('hidden');
              overlay.classList.remove('animate-fade-in', 'animate-fade-out');
              document.body.style.overflow = '';
            }, 200);
          }
        }
      }
      
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      });
      
      overlay?.addEventListener('click', toggleSidebar);
      
      const navLinks = sidebar?.querySelectorAll('a');
      navLinks?.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            toggleSidebar();
          }
        });
      });
    });

    // Modal functionality
    document.addEventListener('click', (e) => {
      const openModalBtn = e.target.closest('[data-action="open-modal"]');
      if (openModalBtn) {
        const targetId = openModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          if (window.lucide) lucide.createIcons();
        }
      }

      const closeModalBtn = e.target.closest('[data-action="close-modal"]');
      if (closeModalBtn) {
        const targetId = closeModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          const form = modal.querySelector('form');
          if (form) form.reset();
        }
      }

      if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
        e.target.classList.add('hidden');
        e.target.classList.remove('flex');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
        modals.forEach(modal => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        });
      }
    });
  </script>

  <script type="module" src="./js/inventory.js"></script>
  
  <!-- Custom Dropdown -->
  <script type="module" src="./js/custom-dropdown.js"></script>
  
  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- Bulk Inventory Operations JavaScript -->
  <script>
    // Get inventory and selection tracking from module scope
    const getInventoryData = () => {
      return {
        selectedInventory: window.selectedInventory || new Set(),
        allInventory: window.allInventory || [],
        currentUserProfile: window.currentUserProfile || null,
        currentFilter: window.currentFilter || 'all'
      };
    };

    // Initialize bulk operations
    function initBulkInventoryOperations() {
      // Select All checkbox
      const selectAllCheckbox = document.getElementById('select-all-inventory');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          const { selectedInventory } = getInventoryData();
          if (e.target.checked) {
            selectAllInventory();
          } else {
            deselectAllInventory();
          }
        });
      }

      // Cancel selection
      document.getElementById('bulk-cancel-inventory')?.addEventListener('click', () => {
        deselectAllInventory();
        if (window.renderInventory) {
          window.renderInventory();
        }
      });

      // Bulk update quantity
      document.getElementById('bulk-update-quantity-inventory')?.addEventListener('click', async () => {
        const { selectedInventory } = getInventoryData();
        if (selectedInventory.size === 0) {
          toast.error('Please select at least one item');
          return;
        }
        
        const result = await showBulkQuantityModal();
        if (!result) return;
        
        const confirmed = await showConfirm(
          `${result.type === 'set' ? 'Set quantity to' : 'Adjust quantity by'} ${result.amount} for ${selectedInventory.size} item(s)?`,
          'Bulk Update Quantity'
        );
        if (!confirmed) return;
        
        await bulkUpdateQuantities(result.type, result.amount);
      });

      // Bulk update category
      document.getElementById('bulk-update-category-inventory')?.addEventListener('click', async () => {
        const { selectedInventory } = getInventoryData();
        if (selectedInventory.size === 0) {
          toast.error('Please select at least one item');
          return;
        }
        
        const categoryId = await showBulkCategoryModal();
        if (!categoryId) return;
        
        const confirmed = await showConfirm(
          `Update category for ${selectedInventory.size} item(s)?`,
          'Bulk Update Category'
        );
        if (!confirmed) return;
        
        await bulkUpdateCategory(categoryId);
      });

      // Bulk export to CSV
      document.getElementById('bulk-export-inventory')?.addEventListener('click', async () => {
        const { selectedInventory } = getInventoryData();
        if (selectedInventory.size === 0) {
          toast.error('Please select at least one item');
          return;
        }
        
        await bulkExportInventory();
      });
    }

    // Get visible inventory (based on current filter)
    function getVisibleInventory() {
      const { allInventory, currentFilter } = getInventoryData();
      let filtered = allInventory || [];
      
      // Apply category filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(item => item.category_name === currentFilter);
      }
      
      // Apply site filter if exists
      const siteFilter = window.currentSiteFilter || 'all';
      if (siteFilter !== 'all') {
        filtered = filtered.filter(item => item.site_id == siteFilter);
      }
      
      return filtered;
    }

    // Select all visible inventory
    function selectAllInventory() {
      const visibleItems = getVisibleInventory();
      const { selectedInventory } = getInventoryData();
      
      visibleItems.forEach(item => {
        const itemKey = `${item.site_id}_${item.item_id}`;
        selectedInventory.add(itemKey);
      });
      
      window.selectedInventory = selectedInventory;
      updateInventoryCheckboxes();
      updateBulkInventoryToolbar();
      updateSelectAllInventoryCheckbox();
    }

    // Deselect all inventory
    function deselectAllInventory() {
      const { selectedInventory } = getInventoryData();
      selectedInventory.clear();
      window.selectedInventory = selectedInventory;
      updateInventoryCheckboxes();
      updateBulkInventoryToolbar();
      updateSelectAllInventoryCheckbox();
    }

    // Attach checkbox listeners (make globally available)
    window.attachInventoryCheckboxListeners = function() {
      document.querySelectorAll('.inventory-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const itemKey = e.target.dataset.itemKey;
          toggleInventorySelection(itemKey);
        });
      });
    };

    // Toggle inventory selection
    function toggleInventorySelection(itemKey) {
      const { selectedInventory } = getInventoryData();
      
      if (selectedInventory.has(itemKey)) {
        selectedInventory.delete(itemKey);
      } else {
        selectedInventory.add(itemKey);
      }
      
      window.selectedInventory = selectedInventory;
      updateBulkInventoryToolbar();
      updateSelectAllInventoryCheckbox();
      updateInventoryCheckboxes();
    }

    // Update select all checkbox (make globally available)
    window.updateSelectAllInventoryCheckbox = function() {
      const selectAllCheckbox = document.getElementById('select-all-inventory');
      if (!selectAllCheckbox) return;
      
      const { selectedInventory } = getInventoryData();
      const visibleItems = getVisibleInventory();
      const allVisibleSelected = visibleItems.length > 0 && visibleItems.every(item => {
        const itemKey = `${item.site_id}_${item.item_id}`;
        return selectedInventory.has(itemKey);
      });
      
      selectAllCheckbox.checked = allVisibleSelected;
      selectAllCheckbox.indeterminate = !allVisibleSelected && visibleItems.some(item => {
        const itemKey = `${item.site_id}_${item.item_id}`;
        return selectedInventory.has(itemKey);
      });
    };

    // Update checkbox states
    function updateInventoryCheckboxes() {
      const { selectedInventory } = getInventoryData();
      
      document.querySelectorAll('.inventory-checkbox').forEach(checkbox => {
        const itemKey = checkbox.dataset.itemKey;
        checkbox.checked = selectedInventory.has(itemKey);
        
        const row = checkbox.closest('tr');
        if (row) {
          if (checkbox.checked) {
            row.classList.add('bg-nfglight/30', 'dark:bg-blue-900/20');
          } else {
            row.classList.remove('bg-nfglight/30', 'dark:bg-blue-900/20');
          }
        }
      });
    }

    // Update bulk toolbar
    function updateBulkInventoryToolbar() {
      const toolbar = document.getElementById('bulk-inventory-toolbar');
      const count = document.getElementById('selected-inventory-count');
      
      if (!toolbar || !count) return;
      
      const { selectedInventory, currentUserProfile } = getInventoryData();
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
      
      if (selectedInventory.size > 0 && !isStaff) {
        toolbar.classList.remove('hidden');
        count.textContent = `${selectedInventory.size} ${selectedInventory.size === 1 ? 'item' : 'items'} selected`;
      } else {
        toolbar.classList.add('hidden');
      }
    }

    // Bulk update quantities
    async function bulkUpdateQuantities(updateType, amount) {
      const { selectedInventory, allInventory } = getInventoryData();
      const itemKeys = Array.from(selectedInventory);
      
      // Get supabase from global scope
      const supabaseClient = window.supabase;
      if (!supabaseClient) {
        toast.error('Error: Supabase client not available');
        return;
      }
      
      try {
        // Extract site_id and item_id from itemKeys
        const updates = [];
        for (const itemKey of itemKeys) {
          const [siteId, itemId] = itemKey.split('_');
          const item = allInventory.find(i => i.site_id == siteId && i.item_id == itemId);
          
          if (!item) continue;
          
          let newQuantity;
          if (updateType === 'set') {
            newQuantity = parseInt(amount, 10);
          } else {
            newQuantity = Math.max(0, (item.quantity || 0) + parseInt(amount, 10));
          }
          
          // Update inventory_item_sites table (or inventory_with_categories view)
          // First, get the current user
          const { data: { user } } = await supabaseClient.auth.getUser();
          if (!user) {
            toast.error('Error: User not available');
            return;
          }
          
          // Update the quantity in inventory_item_sites table
          const { error } = await supabaseClient
            .from('inventory_item_sites')
            .update({ quantity: newQuantity })
            .eq('site_id', siteId)
            .eq('item_id', itemId);
          
          if (error) {
            console.error(`Error updating item ${itemId} at site ${siteId}:`, error);
            continue;
          }
          
          // Create transaction history entry
          await supabaseClient
            .from('inventory_transactions')
            .insert({
              site_id: parseInt(siteId, 10),
              item_id: parseInt(itemId, 10),
              transaction_type: 'adjustment',
              quantity_change: updateType === 'set' ? newQuantity - (item.quantity || 0) : parseInt(amount, 10),
              quantity_before: item.quantity || 0,
              quantity_after: newQuantity,
              created_by: user.id
            });
          
          updates.push({ siteId, itemId, newQuantity });
        }
        
        if (updates.length === 0) {
          toast.error('Failed to update any items');
          return;
        }
        
        toast.success(`Updated quantities for ${updates.length} item(s) successfully`);
        deselectAllInventory();
        
        // Refresh inventory
        if (window.renderInventory) {
          await window.renderInventory();
        }
      } catch (err) {
        console.error('Error bulk updating quantities:', err);
        toast.error('An error occurred while updating quantities');
      }
    }

    // Bulk update category
    async function bulkUpdateCategory(categoryId) {
      const { selectedInventory, allInventory } = getInventoryData();
      const itemKeys = Array.from(selectedInventory);
      
      // Get supabase from global scope
      const supabaseClient = window.supabase;
      if (!supabaseClient) {
        toast.error('Error: Supabase client not available');
        return;
      }
      
      try {
        // Extract item_ids from itemKeys (category applies to all sites for an item)
        const itemIds = [...new Set(itemKeys.map(key => key.split('_')[1]))];
        
        const { error } = await supabaseClient
          .from('inventory_items')
          .update({ category_id: parseInt(categoryId, 10) })
          .in('id', itemIds.map(id => parseInt(id, 10)));
        
        if (error) {
          toast.error('Failed to update category: ' + error.message);
          return;
        }
        
        toast.success(`Category updated for ${itemIds.length} item(s) successfully`);
        deselectAllInventory();
        
        // Refresh inventory
        if (window.renderInventory) {
          await window.renderInventory();
        }
      } catch (err) {
        console.error('Error bulk updating category:', err);
        toast.error('An error occurred while updating category');
      }
    }

    // Bulk export to CSV
    async function bulkExportInventory() {
      const { selectedInventory, allInventory } = getInventoryData();
      const itemKeys = Array.from(selectedInventory);
      
      try {
        // Get selected items
        const selectedItems = allInventory.filter(item => {
          const itemKey = `${item.site_id}_${item.item_id}`;
          return selectedInventory.has(itemKey);
        });
        
        if (selectedItems.length === 0) {
          toast.error('No items selected');
          return;
        }
        
        // Generate CSV
        const headers = ['Item Name', 'Category', 'Site', 'Quantity', 'Unit', 'Low Stock Threshold', 'Status'];
        const rows = selectedItems.map(item => [
          item.item_name || '',
          item.category_name || '',
          item.site_name || '',
          item.quantity || 0,
          item.unit || '',
          item.low_stock_threshold || 0,
          item.stock_status || 'ok'
        ]);
        
        const csv = [headers, ...rows]
          .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
          .join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inventory-export-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        toast.success(`Exported ${selectedItems.length} item(s) to CSV`);
        deselectAllInventory();
      } catch (err) {
        console.error('Error exporting inventory:', err);
        toast.error('An error occurred while exporting inventory');
      }
    }

    // Show bulk quantity modal
    async function showBulkQuantityModal() {
      return new Promise((resolve) => {
        const modal = document.getElementById('bulk-quantity-modal');
        const cancelBtn = modal.querySelector('[data-cancel-quantity]');
        const confirmBtn = document.getElementById('confirm-quantity-update');
        const quantityTypeSelect = document.getElementById('quantity-update-type');
        
        // Reset form
        quantityTypeSelect.value = 'set';
        document.getElementById('quantity-amount').value = '';
        
        // Reinitialize custom dropdown when modal opens
        if (quantityTypeSelect.dataset.customDropdown === 'true' && window.NFGDropdown) {
          // Remove existing wrapper if any
          const existingWrapper = quantityTypeSelect.closest('.nfg-select-wrapper');
          if (existingWrapper) {
            quantityTypeSelect.dataset.initialized = 'false';
            existingWrapper.replaceWith(quantityTypeSelect);
          }
          // Reinitialize with default value 'set'
          new window.NFGDropdown(quantityTypeSelect);
          quantityTypeSelect.dataset.initialized = 'true';
          
          // Set default value after initialization
          setTimeout(() => {
            const wrapper = quantityTypeSelect.closest('.nfg-select-wrapper');
            const hiddenInput = wrapper?.querySelector('input[type="hidden"]');
            if (hiddenInput) {
              hiddenInput.value = 'set';
              quantityTypeSelect.value = 'set';
              // Update displayed text
              const selectedText = wrapper?.querySelector('.nfg-selected-text');
              const selectedOption = quantityTypeSelect.querySelector('option[value="set"]');
              if (selectedText && selectedOption) {
                selectedText.textContent = selectedOption.textContent;
                selectedText.classList.remove('placeholder');
              }
            }
          }, 0);
        }
        
        modal.classList.remove('hidden');
        
        const handleConfirm = () => {
          // Get value from custom dropdown or regular select
          const quantityTypeSelect = document.getElementById('quantity-update-type');
          let updateType;
          if (quantityTypeSelect.dataset.customDropdown === 'true') {
            // Get value from custom dropdown hidden input
            const wrapper = quantityTypeSelect.closest('.nfg-select-wrapper');
            const hiddenInput = wrapper?.querySelector('input[type="hidden"]');
            updateType = hiddenInput?.value || quantityTypeSelect.value;
          } else {
            updateType = quantityTypeSelect.value;
          }
          
          const amount = document.getElementById('quantity-amount').value;
          
          if (!amount) {
            toast.error('Please enter an amount');
            return;
          }
          
          modal.classList.add('hidden');
          resolve({ type: updateType, amount: parseInt(amount, 10) });
        };
        
        const handleCancel = () => {
          modal.classList.add('hidden');
          resolve(null);
        };
        
        confirmBtn.onclick = handleConfirm;
        cancelBtn.onclick = handleCancel;
      });
    }

    // Show bulk category modal
    async function showBulkCategoryModal() {
      return new Promise(async (resolve) => {
        const modal = document.getElementById('bulk-category-modal');
        const categoryList = document.getElementById('bulk-category-list');
        const cancelBtn = modal.querySelector('[data-cancel-category]');
        
        // Get supabase from global scope
        const supabaseClient = window.supabase;
        if (!supabaseClient) {
          categoryList.innerHTML = '<p class="text-red-500 text-center py-4">Error: Supabase client not available</p>';
          return;
        }
        
        categoryList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading categories...</p>';
        modal.classList.remove('hidden');
        
        try {
          const { data: cats, error } = await supabaseClient
            .from('inventory_categories')
            .select('id, name, icon')
            .order('sort_order');
          
          if (error) {
            categoryList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load categories</p>';
            return;
          }
          
          if (!cats || cats.length === 0) {
            categoryList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No categories available</p>';
            return;
          }
          
          categoryList.innerHTML = cats.map(cat => `
            <button 
              data-category-id="${cat.id}" 
              class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition"
            >
              <span class="font-medium block">${cat.icon || ''} ${cat.name}</span>
            </button>
          `).join('');
          
          categoryList.querySelectorAll('[data-category-id]').forEach(btn => {
            btn.addEventListener('click', () => {
              const categoryId = btn.dataset.categoryId;
              modal.classList.add('hidden');
              resolve(categoryId);
            });
          });
        } catch (err) {
          console.error('Error loading categories:', err);
          categoryList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load categories</p>';
        }
        
        cancelBtn.onclick = () => {
          modal.classList.add('hidden');
          resolve(null);
        };
      });
    }

    // Initialize bulk operations when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBulkInventoryOperations);
    } else {
      initBulkInventoryOperations();
    }
    
    // renderInventory is already made globally available in inventory.js module
  </script>
  
  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>


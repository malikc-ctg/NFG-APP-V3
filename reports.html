
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports & Analytics â€” NFG Dashboard</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons + Charts -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notifications -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Reports...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <!-- Northern Facilities Group Logo -->
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
        alt="Northern Facilities Group" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="dashboard.html">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Overview
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="sites.html">
        <i data-lucide="map-pin" class="w-4 h-4"></i> Sites
      </a>
      <a id="nav-bookings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="bookings.html">
        <i data-lucide="calendar" class="w-4 h-4"></i> Bookings
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="jobs.html">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i> Jobs
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="inventory.html">
        <i data-lucide="package" class="w-4 h-4"></i> Inventory
      </a>
      <a id="nav-reports" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="reports.html">
        <i data-lucide="file-chart-column" class="w-4 h-4"></i> Reports
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700">
      <button id="logout-btn" class="w-full border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Reports</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <button id="export-csv-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl border border-nfgray hover:bg-nfglight text-xs sm:text-sm flex-shrink-0"
                  title="Export CSV">
            <i data-lucide="download" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Export CSV</span>
          </button>
          <button id="print-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl border border-nfgray hover:bg-nfglight text-xs sm:text-sm flex-shrink-0"
                  title="Print">
            <i data-lucide="printer" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Print</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-4 md:p-6 space-y-6 overflow-y-auto">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Reports & Analytics</h2>
          <p class="text-sm text-gray-500 mt-1" id="reports-description">View performance metrics and generate reports</p>
        </div>
        
        <!-- Time Period Filter -->
        <div class="flex flex-wrap items-center gap-2">
          <select id="time-period" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">This Year</option>
            <option value="custom">Custom Range</option>
            <option value="all">All Time</option>
          </select>
          
          <!-- Custom Date Range (hidden by default) -->
          <div id="custom-date-range" class="hidden flex items-center gap-2">
            <input type="date" id="date-from" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
            <span class="text-gray-500">to</span>
            <input type="date" id="date-to" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
            <button id="apply-date-range" class="px-3 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm">
              Apply
            </button>
          </div>
          
          <button id="refresh-btn" class="p-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700" title="Refresh Reports">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="border-b border-nfgray dark:border-gray-700">
        <nav class="flex gap-2 -mb-px">
          <button 
            id="tab-overview" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-nfgblue text-nfgblue dark:text-blue-400 transition-colors"
            data-tab="overview"
          >
            <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i>
            Overview
          </button>
          <button 
            id="tab-time-tracking" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="time-tracking"
          >
            <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>
            Time Tracking
          </button>
          <button 
            id="tab-billing" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="billing"
          >
            <i data-lucide="dollar-sign" class="w-4 h-4 inline mr-2"></i>
            Billing
          </button>
          <button 
            id="tab-expenses" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="expenses"
          >
            <i data-lucide="receipt" class="w-4 h-4 inline mr-2"></i>
            Expenses
          </button>
          <button 
            id="tab-team" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="team"
          >
            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
            Team
          </button>
          <button 
            id="tab-inventory" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="inventory"
          >
            <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
            Inventory
          </button>
        </nav>
      </div>

      <!-- Overview Tab Content (existing content) -->
      <div id="tab-content-overview" class="tab-content space-y-6">
      <!-- Metric Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Total Jobs -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Jobs</p>
              <p id="metric-total-jobs" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <i data-lucide="clipboard-check" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
          </div>
        </div>

        <!-- Completed Jobs -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Completed</p>
              <p id="metric-completed-jobs" class="text-2xl font-bold text-green-600 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
              <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
            </div>
          </div>
        </div>

        <!-- Active Sites -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Active Sites</p>
              <p id="metric-active-sites" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <i data-lucide="building-2" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
          </div>
        </div>

        <!-- Emergency Requests -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Emergencies</p>
              <p id="metric-emergency-jobs" class="text-2xl font-bold text-red-600 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
              <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Jobs Over Time Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Jobs Over Time</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="jobs-over-time-chart"></canvas>
          </div>
        </div>

        <!-- Staff Hours Worked Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center gap-2 mb-4">
            <i data-lucide="clock" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Staff Hours Worked</h3>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="staff-hours-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Worker Performance -->
      <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
        <div class="flex items-center gap-2 mb-4">
          <i data-lucide="users" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Worker Performance</h3>
        </div>
        
        <!-- Bar Chart: Top Workers by Completed Jobs -->
        <div class="mb-6">
          <p class="text-sm text-gray-500 mb-3">Top 5 Workers (By Completed Jobs)</p>
          <div style="height: 220px; position: relative;">
            <canvas id="worker-performance-chart"></canvas>
          </div>
        </div>
        
        <!-- Stats Table -->
        <div class="border-t border-nfgray pt-4">
          <p class="text-sm font-medium text-gray-600 mb-3">Detailed Breakdown</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Worker</th>
                  <th class="pb-2 font-medium text-gray-500 text-center">Done âœ…</th>
                  <th class="pb-2 font-medium text-gray-500 text-center">Active ðŸ”µ</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Rate ðŸ“Š</th>
                </tr>
              </thead>
              <tbody id="worker-stats-table">
                <tr>
                  <td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Data Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Sites -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Top Performing Sites</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Site</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Jobs</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Completed</th>
                </tr>
              </thead>
              <tbody id="top-sites-table">
                <tr>
                  <td colspan="3" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Most Requested Services -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Most Requested Services</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Service</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Count</th>
                </tr>
              </thead>
              <tbody id="top-services-table">
                <tr>
                  <td colspan="2" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Completed Jobs -->
      <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Recent Completed Jobs</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="border-b border-nfgray dark:border-gray-700">
              <tr class="text-left">
                <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Job Title</th>
                <th class="pb-2 font-medium text-gray-500 hidden md:table-cell">Site</th>
                <th class="pb-2 font-medium text-gray-500 hidden md:table-cell">Date</th>
                <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Status</th>
              </tr>
            </thead>
            <tbody id="recent-jobs-table">
              <tr>
                <td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
      <!-- END Overview Tab Content -->

      <!-- Time Tracking Tab Content -->
      <div id="tab-content-time-tracking" class="tab-content hidden space-y-6">
        <!-- Role-Based Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 id="time-tracking-title" class="text-xl font-semibold text-nfgblue dark:text-blue-400">My Time Sheet</h2>
            <p class="text-sm text-gray-500 mt-1">Track your work hours and view time entries</p>
          </div>
          
          <div class="flex gap-2">
            <button id="export-time-sheet-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700 text-sm flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              <span>Export</span>
            </button>
          </div>
        </div>
        
        <!-- Staff View: Time Sheets -->
        <div id="time-sheets-view" class="hidden">
          <!-- Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Hours</p>
              <p id="time-total-hours" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0h</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Overtime Hours</p>
              <p id="time-overtime-hours" class="text-2xl font-bold text-orange-600 mt-1">0h</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Pending Approval</p>
              <p id="time-pending-count" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Average/Day</p>
              <p id="time-avg-hours" class="text-2xl font-bold text-green-600 mt-1">0h</p>
            </div>
          </div>
          
          <!-- Time Entries Table -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
            <div class="p-4 border-b border-nfgray">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">My Time Entries</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-nfglight dark:bg-gray-700">
                  <tr>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Date</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Job</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock In</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock Out</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Duration</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Status</th>
                  </tr>
                </thead>
                <tbody id="time-entries-table" class="divide-y divide-nfgray">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Admin View: Time Approval + Reports -->
        <div id="time-admin-view" class="hidden">
          <!-- Sub-tabs for Admin -->
          <div class="border-b border-nfgray dark:border-gray-700 mb-6">
            <nav class="flex gap-2 -mb-px">
              <button 
                id="subtab-approval" 
                class="subtab-btn px-4 py-2 text-sm font-medium border-b-2 border-nfgblue text-nfgblue dark:text-blue-400 transition-colors"
                data-subtab="approval"
              >
                Time Approval
              </button>
              <button 
                id="subtab-reports" 
                class="subtab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
                data-subtab="reports"
              >
                Time Reports
              </button>
            </nav>
          </div>
          
          <!-- Approval Sub-tab -->
          <div id="subtab-content-approval" class="subtab-content space-y-4">
            <!-- Filters -->
            <div class="flex flex-wrap gap-2 items-center">
              <select id="approval-filter-staff" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
                <option value="">All Staff</option>
                <!-- Populated with staff list -->
              </select>
              <select id="approval-filter-status" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
                <option value="pending" selected>Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="">All</option>
              </select>
              <button id="bulk-approve-btn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm flex items-center gap-2">
                <i data-lucide="check-circle" class="w-4 h-4"></i>
                <span>Bulk Approve Selected</span>
              </button>
            </div>
            
            <!-- Pending Time Entries Table -->
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
              <div class="p-4 border-b border-nfgray">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Pending Time Entries</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left">
                        <input type="checkbox" id="select-all-time-entries" class="rounded">
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Staff</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Date</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Job</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock In</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock Out</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Duration</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="pending-time-entries-table" class="divide-y divide-nfgray">
                    <tr>
                      <td colspan="9" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Reports Sub-tab -->
          <div id="subtab-content-reports" class="subtab-content hidden space-y-6">
            <!-- Time Summary Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Hours</p>
                <p id="admin-total-hours" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0h</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Overtime Hours</p>
                <p id="admin-overtime-hours" class="text-2xl font-bold text-orange-600 mt-1">0h</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Pending Approval</p>
                <p id="admin-pending-count" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Active Staff</p>
                <p id="admin-active-staff" class="text-2xl font-bold text-green-600 mt-1">0</p>
              </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Hours by Staff Chart -->
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Hours by Staff</h3>
                <div style="height: 300px; position: relative;">
                  <canvas id="hours-by-staff-chart"></canvas>
                </div>
              </div>
              
              <!-- Daily Hours Trend Chart -->
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Daily Hours Trend</h3>
                <div style="height: 300px; position: relative;">
                  <canvas id="daily-hours-trend-chart"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Staff Time Summary Table -->
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
              <div class="p-4 border-b border-nfgray">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Staff Time Summary</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Staff</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Total Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Regular Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Jobs</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Avg/Day</th>
                    </tr>
                  </thead>
                  <tbody id="staff-time-summary-table" class="divide-y divide-nfgray">
                    <tr>
                      <td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- END Time Tracking Tab Content -->

      <!-- Billing Tab Content -->
      <div id="tab-content-billing" class="tab-content hidden space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Total Revenue -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Revenue</p>
                <p id="billing-total-revenue" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                <i data-lucide="dollar-sign" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
              </div>
            </div>
          </div>

          <!-- Outstanding Balance -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Outstanding</p>
                <p id="billing-outstanding" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i data-lucide="alert-circle" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
              </div>
            </div>
          </div>

          <!-- Overdue Invoices -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Overdue</p>
                <p id="billing-overdue-count" class="text-2xl font-bold text-red-600 dark:text-red-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <i data-lucide="clock-alert" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
              </div>
            </div>
          </div>

          <!-- This Month Revenue -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">This Month</p>
                <p id="billing-month-revenue" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="trending-up" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Revenue Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Revenue Trend</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="revenue-chart"></canvas>
          </div>
        </div>

        <!-- Invoices Section -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg">
          <div class="p-6 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Invoices</h3>
            <button id="create-invoice-btn" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              Create Invoice
            </button>
          </div>

          <!-- Filters -->
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex flex-wrap gap-3">
            <select id="invoice-status-filter" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">All Status</option>
              <option value="draft">Draft</option>
              <option value="sent">Sent</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <select id="invoice-client-filter" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">All Clients</option>
            </select>
            <input type="date" id="invoice-date-from" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
            <input type="date" id="invoice-date-to" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
            <button id="apply-invoice-filters" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm">
              Apply Filters
            </button>
            <button id="clear-invoice-filters" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm">
              Clear
            </button>
          </div>

          <!-- Invoices Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-nfglight dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Invoice #</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Client</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Site</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Job</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Amount</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Status</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Due Date</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="invoices-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading invoices...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- END Billing Tab Content -->

      <!-- Expenses Tab Content -->
      <div id="tab-content-expenses" class="tab-content hidden space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Total Expenses -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Expenses</p>
                <p id="expenses-total" class="text-2xl font-bold text-red-600 dark:text-red-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <i data-lucide="receipt" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
              </div>
            </div>
          </div>

          <!-- This Month Expenses -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">This Month</p>
                <p id="expenses-month" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i data-lucide="calendar" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
              </div>
            </div>
          </div>

          <!-- By Category -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Top Category</p>
                <p id="expenses-top-category" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">â€”</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="tag" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
            </div>
          </div>

          <!-- Average per Job -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Avg per Job</p>
                <p id="expenses-avg-job" class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">$0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                <i data-lucide="trending-down" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Expenses Section -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg">
          <div class="p-6 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Expenses</h3>
            <button id="add-expense-btn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm font-medium flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i>
              Add Expense
            </button>
          </div>

          <!-- Filters -->
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex flex-wrap gap-3">
            <select id="expense-category-filter" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">All Categories</option>
              <option value="supplies">Supplies</option>
              <option value="equipment">Equipment</option>
              <option value="travel">Travel</option>
              <option value="labor">Labor</option>
              <option value="other">Other</option>
            </select>
            <select id="expense-job-filter" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">All Jobs</option>
            </select>
            <select id="expense-site-filter" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">All Sites</option>
            </select>
            <input type="date" id="expense-date-from" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" placeholder="From">
            <input type="date" id="expense-date-to" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" placeholder="To">
            <input type="text" id="expense-search" class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" placeholder="Search...">
            <button id="apply-expense-filters" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm">
              Apply Filters
            </button>
            <button id="clear-expense-filters" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm">
              Clear
            </button>
            <button id="export-expenses-btn" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              Export CSV
            </button>
          </div>

          <!-- Expenses Table -->
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-nfglight dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Description</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Category</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Amount</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Job</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Site</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Vendor</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Receipt</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="expenses-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                <tr>
                  <td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading expenses...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- END Expenses Tab Content -->

      <!-- Team Tab Content -->
      <div id="tab-content-team" class="tab-content hidden space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Total Employees -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Employees</p>
                <p id="team-total-employees" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="users" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
            </div>
          </div>

          <!-- Active Employees -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Active</p>
                <p id="team-active-employees" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                <i data-lucide="user-check" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
              </div>
            </div>
          </div>

          <!-- Pending Invitations -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Pending</p>
                <p id="team-pending-employees" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i data-lucide="user-plus" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
              </div>
            </div>
          </div>

          <!-- Staff Count -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Staff</p>
                <p id="team-staff-count" class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                <i data-lucide="briefcase" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Role Breakdown Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Admins -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Admins</p>
                <p id="team-admin-count" class="text-xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="shield" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
            </div>
          </div>

          <!-- Clients -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Clients</p>
                <p id="team-client-count" class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                <i data-lucide="user" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
              </div>
            </div>
          </div>

          <!-- Total Jobs Assigned -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Jobs Assigned</p>
                <p id="team-total-jobs" class="text-xl font-bold text-teal-600 dark:text-teal-400 mt-1">0</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center">
                <i data-lucide="clipboard-list" class="w-5 h-5 text-teal-600 dark:text-teal-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex flex-wrap gap-3 items-center">
            <input 
              type="text" 
              id="team-search" 
              class="flex-1 min-w-[200px] px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" 
              placeholder="Search by name or email..."
            >
            <select 
              id="team-role-filter" 
              class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            >
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="staff">Staff</option>
              <option value="client">Client</option>
            </select>
            <select 
              id="team-status-filter" 
              class="px-3 py-2 rounded-xl border border-nfgray dark:border-gray-600 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            >
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="pending">Pending</option>
              <option value="inactive">Inactive</option>
            </select>
            <button 
              id="team-clear-filters" 
              class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm"
            >
              Clear
            </button>
            <button 
              id="team-export-btn" 
              class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm flex items-center gap-2"
            >
              <i data-lucide="download" class="w-4 h-4"></i>
              Export CSV
            </button>
          </div>
        </div>

        <!-- Top Performers Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Most Jobs Completed -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                <i data-lucide="award" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
              </div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Most Jobs Completed</p>
            <p id="top-performer-jobs" class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-1">-</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="top-performer-jobs-count">0 jobs</p>
          </div>

          <!-- Most Active -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="activity" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
              </div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Most Active</p>
            <p id="top-performer-active" class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-1">-</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="top-performer-active-info">Recently active</p>
          </div>

          <!-- Most Sites -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                <i data-lucide="map-pin" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
              </div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Most Sites</p>
            <p id="top-performer-sites" class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-1">-</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="top-performer-sites-count">0 sites</p>
          </div>

          <!-- Best Completion Rate -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between mb-2">
              <div class="w-10 h-10 rounded-full bg-teal-100 dark:bg-teal-900/30 flex items-center justify-center">
                <i data-lucide="trending-up" class="w-5 h-5 text-teal-600 dark:text-teal-400"></i>
              </div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Best Completion Rate</p>
            <p id="top-performer-rate" class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-1">-</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="top-performer-rate-percent">0%</p>
          </div>
        </div>

        <!-- Currently Working On Section -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Currently Working On</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Employees actively working on jobs with real-time timers</p>
            </div>
            <div id="active-workers-count" class="px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-sm font-medium">
              0 active
            </div>
          </div>
          
          <div id="currently-working-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i data-lucide="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
              <p>No employees currently working</p>
            </div>
          </div>
        </div>

        <!-- Role Distribution Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Role Distribution</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="team-role-chart"></canvas>
          </div>
        </div>

        <!-- Employee Performance Table -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
          <div class="p-4 border-b border-nfgray">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Employee Performance</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">View employee statistics and performance metrics</p>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-nfglight dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="name">
                    Employee <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="role">
                    Role <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="status">
                    Status <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="jobs-assigned">
                    Jobs Assigned <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="jobs-completed">
                    Jobs Completed <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="completion-rate">
                    Completion Rate <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="active-jobs">
                    Active Jobs <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" data-sort="sites">
                    Sites <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="team-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                <tr>
                  <td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading employees...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- END Team Tab Content -->

      <!-- Inventory Reports Tab Content -->
      <div id="tab-content-inventory" class="tab-content hidden space-y-6">
        <!-- Inventory Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Items</p>
                <p id="inventory-report-total-items" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">â€”</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                <i data-lucide="package" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Value</p>
                <p id="inventory-report-total-value" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">â€”</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                <i data-lucide="dollar-sign" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Low Stock</p>
                <p id="inventory-report-low-stock" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">â€”</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600 dark:text-orange-400"></i>
              </div>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Expiring Soon</p>
                <p id="inventory-report-expiring" class="text-2xl font-bold text-red-600 dark:text-red-400 mt-1">â€”</p>
              </div>
              <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                <i data-lucide="calendar-x" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Report Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Inventory Valuation Report -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Inventory Valuation</h3>
              <button onclick="exportInventoryValuationReport()" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700">
                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="border-b border-nfgray dark:border-gray-700">
                  <tr>
                    <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Site</th>
                    <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Category</th>
                    <th class="pb-2 text-right font-medium text-gray-500 dark:text-gray-400">Value</th>
                  </tr>
                </thead>
                <tbody id="inventory-valuation-summary">
                  <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ABC Analysis -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">ABC Analysis</h3>
              <button onclick="exportABCAnalysis()" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700">
                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export
              </button>
            </div>
            <div class="space-y-3">
              <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <span class="font-medium">Category A (High Value)</span>
                <span id="abc-category-a-count" class="text-blue-600 dark:text-blue-400 font-bold">â€”</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <span class="font-medium">Category B (Medium Value)</span>
                <span id="abc-category-b-count" class="text-green-600 dark:text-green-400 font-bold">â€”</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                <span class="font-medium">Category C (Low Value)</span>
                <span id="abc-category-c-count" class="text-orange-600 dark:text-orange-400 font-bold">â€”</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Expiring Items Report -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Expiring Items</h3>
            <div class="flex items-center gap-2">
              <select id="expiring-filter" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray">
                <option value="all">All Expiring</option>
                <option value="expired">Expired</option>
                <option value="expiring_soon_critical">Critical (â‰¤7 days)</option>
                <option value="expiring_soon">Soon (â‰¤30 days)</option>
                <option value="expiring_later">Later (â‰¤90 days)</option>
              </select>
              <button onclick="exportExpiringItems()" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700">
                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Item</th>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Site</th>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Batch #</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Quantity</th>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Expiration</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Days Left</th>
                </tr>
              </thead>
              <tbody id="expiring-items-table">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Stock Movement Trends Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Stock Movement Trends (Last 6 Months)</h3>
          <div style="height: 300px; position: relative;">
            <canvas id="stock-movement-chart"></canvas>
          </div>
        </div>

        <!-- Cost Analysis Report -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Cost Analysis</h3>
            <button onclick="exportCostAnalysis()" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700">
              <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Item</th>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Category</th>
                  <th class="pb-2 text-right font-medium text-gray-500 dark:text-gray-400">Avg Cost</th>
                  <th class="pb-2 text-right font-medium text-gray-500 dark:text-gray-400">Min Cost</th>
                  <th class="pb-2 text-right font-medium text-gray-500 dark:text-gray-400">Max Cost</th>
                  <th class="pb-2 text-right font-medium text-gray-500 dark:text-gray-400">Total Value</th>
                </tr>
              </thead>
              <tbody id="cost-analysis-table">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Usage Forecast -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Usage Forecast</h3>
            <button onclick="exportUsageForecast()" class="text-sm px-3 py-1.5 rounded-lg border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700">
              <i data-lucide="download" class="w-4 h-4 inline mr-1"></i> Export
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Item</th>
                  <th class="pb-2 text-left font-medium text-gray-500 dark:text-gray-400">Site</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Current Qty</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Avg Monthly Usage</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Months Remaining</th>
                  <th class="pb-2 text-center font-medium text-gray-500 dark:text-gray-400">Status</th>
                </tr>
              </thead>
              <tbody id="usage-forecast-table">
                <tr>
                  <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- END Inventory Reports Tab Content -->

      <!-- Employee Details Modal -->
      <div id="employee-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-nfgray p-4 flex items-center justify-between z-10">
            <h2 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Employee Details</h2>
            <button id="close-employee-modal" class="p-2 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          
          <div class="p-6 space-y-6">
            <!-- Employee Header -->
            <div id="employee-modal-header" class="flex items-center gap-4 pb-4 border-b border-nfgray">
              <!-- Will be populated by JavaScript -->
            </div>

            <!-- Statistics Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-nfglight dark:bg-gray-700 rounded-xl p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Jobs Assigned</p>
                <p id="emp-detail-jobs-assigned" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
              </div>
              <div class="bg-nfglight dark:bg-gray-700 rounded-xl p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Jobs Completed</p>
                <p id="emp-detail-jobs-completed" class="text-2xl font-bold text-green-600 dark:text-green-400 mt-1">0</p>
              </div>
              <div class="bg-nfglight dark:bg-gray-700 rounded-xl p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Completion Rate</p>
                <p id="emp-detail-completion-rate" class="text-2xl font-bold text-teal-600 dark:text-teal-400 mt-1">0%</p>
              </div>
              <div class="bg-nfglight dark:bg-gray-700 rounded-xl p-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">Sites Assigned</p>
                <p id="emp-detail-sites" class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">0</p>
              </div>
            </div>

            <!-- Employee Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Contact Information</h3>
                <div class="space-y-2">
                  <p id="emp-detail-email" class="text-sm text-gray-900 dark:text-gray-100"></p>
                  <p id="emp-detail-phone" class="text-sm text-gray-900 dark:text-gray-100"></p>
                </div>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Role & Status</h3>
                <div class="space-y-2">
                  <div id="emp-detail-role-badge"></div>
                  <div id="emp-detail-status-badge"></div>
                </div>
              </div>
            </div>

            <!-- Active Work Section -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4"></i>
                Active Work
              </h3>
              <div id="emp-detail-active-jobs" class="space-y-3">
                <p class="text-sm text-gray-500 dark:text-gray-400">Loading...</p>
              </div>
            </div>

            <!-- Recent Jobs -->
            <div>
              <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">Recent Jobs</h3>
              <div id="emp-detail-recent-jobs" class="space-y-2">
                <p class="text-sm text-gray-500 dark:text-gray-400">Loading...</p>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 pt-4 border-t border-nfgray">
              <button id="emp-detail-message-btn" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm flex items-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4"></i>
                Send Message
              </button>
              <button id="emp-detail-view-profile-btn" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 text-sm flex items-center gap-2">
                <i data-lucide="user" class="w-4 h-4"></i>
                View Full Profile
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- PWA Installation -->
  <script type="module" src="./js/pwa.js"></script>
  <script src="./js/inventory-reports.js"></script>

  <!-- ========== SCRIPTS ========== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      
      // Initialize mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleButtons = document.querySelectorAll('[data-action="toggle-sidebar"], button[aria-label="Toggle sidebar"]');
      
      let overlay = document.getElementById('sidebar-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';
        document.body.appendChild(overlay);
      }
      
      function toggleSidebar() {
        if (sidebar && overlay) {
          const isHidden = sidebar.classList.contains('hidden') || !sidebar.classList.contains('mobile-sidebar-open');
          
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in');
            overlay.classList.remove('hidden');
            overlay.classList.add('animate-fade-in');
            document.body.style.overflow = 'hidden';
          } else {
            sidebar.classList.add('animate-slide-out');
            overlay.classList.add('animate-fade-out');
            
            setTimeout(() => {
              sidebar.classList.add('hidden');
              sidebar.classList.remove('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in', 'animate-slide-out');
              overlay.classList.add('hidden');
              overlay.classList.remove('animate-fade-in', 'animate-fade-out');
              document.body.style.overflow = '';
            }, 200);
          }
        }
      }
      
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      });
      
      overlay?.addEventListener('click', toggleSidebar);
      
      const navLinks = sidebar?.querySelectorAll('a');
      navLinks?.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            toggleSidebar();
          }
        });
      });
      
      // Modal close handler
      document.addEventListener('click', (e) => {
        const closeBtn = e.target.closest('[data-action="close-modal"]');
        if (closeBtn) {
          const targetId = closeBtn.dataset.target;
          const modal = document.getElementById(targetId);
          if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            // Reset form if it exists
            const form = modal.querySelector('form');
            if (form) form.reset();
            // Clear any error messages
            const errorEl = modal.querySelector('#invoice-form-error, #form-error');
            if (errorEl) errorEl.classList.add('hidden');
          }
        }
        
        // Close modal when clicking backdrop (the overlay)
        if (e.target.classList.contains('fixed') && 
            e.target.classList.contains('inset-0') && 
            e.target.id === 'create-invoice-modal') {
          e.target.classList.add('hidden');
          e.target.classList.remove('flex');
          // Reset form
          const form = e.target.querySelector('form');
          if (form) form.reset();
        }
      });
      
      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
          modals.forEach(modal => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            // Reset form if it exists
            const form = modal.querySelector('form');
            if (form) form.reset();
          });
        }
      });
    });
  </script>

  <script type="module">
    import { supabase } from './js/supabase.js'
    import { showNotification, showConfirm, showPrompt, toast, notify, handleError } from './js/notifications.js'

    let currentUser = null;
    let currentUserProfile = null;
    let reportsData = {
      jobs: [],
      sites: [],
      bookings: [],
      services: []
    };

    // Chart instances
    let jobsOverTimeChart = null;
    let staffHoursChart = null;
    let workerPerformanceChart = null;
    let hoursByStaffChart = null;
    let dailyHoursTrendChart = null;

    // Get current user and their profile
    async function getCurrentUser() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;
        if (!user) {
          window.location.href = './index.html';
          return null;
        }
        
        currentUser = user;
        
        // Get user profile
        const { data: profile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          console.error('Error fetching profile:', profileError);
        }
        
        currentUserProfile = profile;
        
        return user;
      } catch (error) {
        console.error('Error getting current user:', error);
        window.location.href = './index.html';
        return null;
      }
    }

    // Fetch data based on time period
    async function fetchData(days = 30, customStartDate = null, customEndDate = null) {
      console.log('[Reports] Fetching data for period:', days, 'days', customStartDate ? `(custom: ${customStartDate} to ${customEndDate})` : '');
      
      try {
        let dateFilter = null;
        let dateEndFilter = null;
        
        if (days === 'custom' && customStartDate && customEndDate) {
          // Custom date range
          dateFilter = new Date(customStartDate).toISOString();
          const endDate = new Date(customEndDate);
          endDate.setHours(23, 59, 59, 999); // Include full end date
          dateEndFilter = endDate.toISOString();
        } else if (days !== 'all') {
          // Preset period
          const date = new Date();
          date.setDate(date.getDate() - parseInt(days));
          date.setHours(0, 0, 0, 0);
          dateFilter = date.toISOString();
        }

        // Fetch jobs (without site join since FK might not exist)
        let jobsQuery = supabase
          .from('jobs')
          .select('*');
        
        if (dateFilter) {
          jobsQuery = jobsQuery.gte('created_at', dateFilter);
        }
        if (dateEndFilter) {
          jobsQuery = jobsQuery.lte('created_at', dateEndFilter);
        }

        const { data: jobs, error: jobsError } = await jobsQuery.order('created_at', { ascending: false });
        if (jobsError) {
          console.error('[Reports] Jobs error:', jobsError);
          throw jobsError;
        }
        console.log('[Reports] âœ… Loaded', jobs?.length || 0, 'jobs');

        // Fetch sites
        const { data: sites, error: sitesError } = await supabase
          .from('sites')
          .select('*');
        if (sitesError) {
          console.error('[Reports] Sites error:', sitesError);
          throw sitesError;
        }
        console.log('[Reports] âœ… Loaded', sites?.length || 0, 'sites');

        // Manually join jobs with sites data
        const sitesMap = {};
        (sites || []).forEach(site => {
          sitesMap[site.id] = site;
        });

        reportsData.jobs = (jobs || []).map(job => ({
          ...job,
          sites: job.site_id ? sitesMap[job.site_id] : null
        }));
        reportsData.sites = sites || [];
        
        console.log('[Reports] ðŸ”— Jobs linked with sites successfully');

        // Fetch bookings with services (without site join)
        let bookingsQuery = supabase
          .from('bookings')
          .select(`
            *,
            booking_services (
              service_id,
              quantity,
              services (
                id,
                name
              )
            )
          `);
        
        if (dateFilter) {
          bookingsQuery = bookingsQuery.gte('created_at', dateFilter);
        }
        if (dateEndFilter) {
          bookingsQuery = bookingsQuery.lte('created_at', dateEndFilter);
        }

        const { data: bookings, error: bookingsError } = await bookingsQuery.order('created_at', { ascending: false });
        if (bookingsError) {
          console.error('[Reports] Bookings error:', bookingsError);
          // Don't fail if bookings error - just log it (bookings are optional)
          console.warn('[Reports] âš ï¸ Continuing without bookings data');
          reportsData.bookings = [];
        } else {
          // Manually link bookings with sites
          reportsData.bookings = (bookings || []).map(booking => ({
            ...booking,
            sites: booking.site_id ? sitesMap[booking.site_id] : null
          }));
          console.log('[Reports] âœ… Loaded', bookings?.length || 0, 'bookings');
          
          // Log emergency bookings for debugging
          const emergencyCount = (bookings || []).filter(b => b.is_emergency === true).length;
          console.log('[Reports] ðŸš¨ Emergency bookings found:', emergencyCount);
        }

        // Summary log
        console.log('[Reports] ðŸ“Š Data Summary:', {
          jobs: reportsData.jobs.length,
          sites: reportsData.sites.length,
          bookings: reportsData.bookings.length,
          completedJobs: reportsData.jobs.filter(j => j.status === 'completed').length,
          emergencyJobs: reportsData.jobs.filter(j => j.job_type === 'emergency').length
        });

        return true;
      } catch (error) {
        console.error('[Reports] âŒ Error fetching data:', error);
        handleError(error, 'Loading reports data');
        return false;
      }
    }

    // Update metrics
    function updateMetrics() {
      // Total jobs (all jobs)
      const totalJobs = reportsData.jobs.length;
      console.log('[Reports] ðŸ“Š Total Jobs:', totalJobs);
      
      // Completed jobs
      const completedJobs = reportsData.jobs.filter(j => j.status === 'completed').length;
      console.log('[Reports] âœ… Completed Jobs:', completedJobs);
      
      // Active sites (count sites that are NOT 'Inactive')
      const activeSites = reportsData.sites.filter(s => s.status !== 'Inactive').length;
      console.log('[Reports] ðŸ¢ Active Sites:', activeSites, '(Total:', reportsData.sites.length + ')');
      
      // Emergency requests (count from bookings with is_emergency true OR jobs with job_type 'emergency')
      const emergencyBookings = reportsData.bookings.filter(b => b.is_emergency === true).length;
      const emergencyJobs = reportsData.jobs.filter(j => j.job_type === 'emergency').length;
      const totalEmergencies = Math.max(emergencyBookings, emergencyJobs); // Use whichever is higher
      console.log('[Reports] ðŸš¨ Emergency Requests:', totalEmergencies, '(Bookings:', emergencyBookings, 'Jobs:', emergencyJobs + ')');

      // Update DOM
      document.getElementById('metric-total-jobs').textContent = totalJobs;
      document.getElementById('metric-completed-jobs').textContent = completedJobs;
      document.getElementById('metric-active-sites').textContent = activeSites;
      document.getElementById('metric-emergency-jobs').textContent = totalEmergencies;
      
      console.log('[Reports] âœ… Metrics updated successfully');
      
      // Show a helpful message if there's no data at all
      if (totalJobs === 0 && reportsData.sites.length === 0) {
        console.warn('[Reports] âš ï¸ No data found in the system');
        toast.warning('No data available yet. Create some sites and jobs to see reports!');
      }
    }

    // Dark Mode Support for Charts
    function getChartColors() {
      const isDark = document.documentElement.classList.contains('dark');
      return {
        text: isDark ? '#E5E7EB' : '#1F2937',
        grid: isDark ? '#374151' : '#E5E7EB',
        background: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(13, 71, 161, 0.1)',
        border: isDark ? '#3B82F6' : '#0D47A1',
        tooltipBg: isDark ? '#1F2937' : '#FFFFFF',
        tooltipBorder: isDark ? '#374151' : '#E5E7EB'
      };
    }

    // Listen for theme changes and recreate charts
    window.addEventListener('themeChange', () => {
      console.log('[Reports] Theme changed, updating charts...');
      createJobsOverTimeChart();
      createStaffHoursChart();
      createWorkerPerformanceChart();
    });

    // Create Jobs Over Time Chart
    function createJobsOverTimeChart() {
      const ctx = document.getElementById('jobs-over-time-chart');
      if (!ctx) {
        console.warn('[Reports] Jobs over time chart canvas not found');
        return;
      }

      // Group jobs by date
      const jobsByDate = {};
      reportsData.jobs.forEach(job => {
        if (job.created_at) {
          const date = new Date(job.created_at).toLocaleDateString();
          jobsByDate[date] = (jobsByDate[date] || 0) + 1;
        }
      });

      // Sort by date and get last 30 days
      const dates = Object.keys(jobsByDate).sort((a, b) => new Date(a) - new Date(b)).slice(-30);
      const counts = dates.map(date => jobsByDate[date]);

      // Handle empty data
      if (dates.length === 0) {
        dates.push(new Date().toLocaleDateString());
        counts.push(0);
      }

      if (jobsOverTimeChart) {
        jobsOverTimeChart.destroy();
      }

      const colors = getChartColors();
      jobsOverTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Jobs Created',
            data: counts,
            borderColor: colors.border,
            backgroundColor: colors.background,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
              labels: {
                color: colors.text
              }
            },
            tooltip: {
              backgroundColor: colors.tooltipBg,
              borderColor: colors.tooltipBorder,
              borderWidth: 1,
              titleColor: colors.text,
              bodyColor: colors.text,
              callbacks: {
                label: function(context) {
                  return 'Jobs: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: colors.text },
              grid: { color: colors.grid }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: colors.text,
                stepSize: 1,
                precision: 0
              },
              grid: { color: colors.grid }
            }
          }
        }
      });
    }

    // Create Staff Hours Worked Chart
    async function createStaffHoursChart() {
      const ctx = document.getElementById('staff-hours-chart');
      if (!ctx) {
        console.warn('[Reports] Staff hours chart canvas not found');
        return;
      }

      console.log('[Reports] ðŸ• Creating staff hours chart...');

      try {
        // Fetch time entries
        const timeRange = document.getElementById('time-period')?.value || '30';
        let dateFilter = null;
        let dateEndFilter = null;
        
        if (timeRange === 'custom') {
          const dateFrom = document.getElementById('date-from')?.value;
          const dateTo = document.getElementById('date-to')?.value;
          if (dateFrom) {
            dateFilter = new Date(dateFrom).toISOString();
          }
          if (dateTo) {
            const endDate = new Date(dateTo);
            endDate.setHours(23, 59, 59, 999);
            dateEndFilter = endDate.toISOString();
          }
        } else if (timeRange !== 'all') {
          const date = new Date();
          date.setDate(date.getDate() - parseInt(timeRange));
          date.setHours(0, 0, 0, 0);
          dateFilter = date.toISOString();
        }

        let query = supabase
          .from('time_entries')
          .select('user_id, total_hours, clock_in, clock_out')
          .not('clock_out', 'is', null); // Only completed shifts

        if (dateFilter) {
          query = query.gte('clock_in', dateFilter);
        }
        if (dateEndFilter) {
          query = query.lte('clock_in', dateEndFilter);
        }

        const { data: timeEntries, error } = await query;

        if (error) {
          console.warn('[Reports] âš ï¸ Could not fetch time entries (table may not exist):', error.message);
          // Show empty state
          if (staffHoursChart) staffHoursChart.destroy();
          return;
        }

        console.log('[Reports] â±ï¸ Loaded', timeEntries?.length || 0, 'time entries');

        // Fetch user profiles to get names
        const { data: profiles } = await supabase
          .from('user_profiles')
          .select('id, full_name, role')
          .in('role', ['staff', 'admin']);

        // Calculate total hours per worker
        const workerHours = {};
        timeEntries?.forEach(entry => {
          const userId = entry.user_id;
          const hours = parseFloat(entry.total_hours) || 0;
          workerHours[userId] = (workerHours[userId] || 0) + hours;
        });

        // Map to names and prepare data
        const staffData = [];
        profiles?.forEach(profile => {
          const hours = workerHours[profile.id] || 0;
          if (hours > 0) {
            staffData.push({
              name: profile.full_name || 'Unknown',
              hours: hours
            });
          }
        });

        // Sort by hours and prepare chart data
        staffData.sort((a, b) => b.hours - a.hours);
        
        const names = staffData.map(s => s.name);
        const hours = staffData.map(s => s.hours);
        const total = hours.reduce((a, b) => a + b, 0);

        console.log('[Reports] ðŸ“Š Staff hours data:', names, hours);

        // Handle empty data
        if (names.length === 0) {
          console.warn('[Reports] âš ï¸ No staff hours data available');
          console.log('[Reports] ðŸ’¡ Reason: Staff need to clock in and clock out to generate hours data');
          console.log('[Reports] ðŸ“‹ Time entries found:', timeEntries?.length || 0);
          console.log('[Reports] ðŸ‘¥ Worker profiles found:', profiles?.length || 0);
          if (timeEntries && timeEntries.length > 0) {
            console.log('[Reports] ðŸ” Sample time entry:', timeEntries[0]);
            console.log('[Reports] ðŸ“Š Hours calculated:', timeEntries.map(e => `${e.user_id}: ${e.total_hours} hrs`));
          }
          names.push('No Data Yet');
          hours.push(1); // Show something on chart
        }

        if (staffHoursChart) {
          staffHoursChart.destroy();
        }

        // Generate colors for each staff member
        const colors = [
          '#0D47A1', // Blue
          '#4CAF50', // Green
          '#FFC107', // Yellow
          '#F44336', // Red
          '#9C27B0', // Purple
          '#00BCD4', // Cyan
          '#FF9800', // Orange
          '#795548'  // Brown
        ];

        const themeColors = getChartColors();
        staffHoursChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: names,
            datasets: [{
              data: hours,
              backgroundColor: colors.slice(0, names.length),
              borderWidth: 2,
              borderColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: themeColors.text,
                  padding: 8,
                  font: {
                    size: 11
                  },
                  boxWidth: 12
                }
              },
              tooltip: {
                backgroundColor: themeColors.tooltipBg,
                borderColor: themeColors.tooltipBorder,
                borderWidth: 1,
                titleColor: themeColors.text,
                bodyColor: themeColors.text,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value.toFixed(1)} hrs (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        console.log('[Reports] âœ… Staff hours chart created successfully');
      } catch (error) {
        console.error('[Reports] âŒ Error creating staff hours chart:', error);
      }
    }

    // Create Worker Performance Chart
    async function createWorkerPerformanceChart() {
      const ctx = document.getElementById('worker-performance-chart');
      if (!ctx) {
        console.warn('[Reports] âš ï¸ Worker performance chart canvas not found');
        return;
      }

      console.log('[Reports] ðŸ“Š Creating worker performance chart...');

      // Calculate worker stats
      const workerStats = await calculateWorkerStats();
      
      // Sort by completed jobs and get top 5
      const topWorkers = workerStats
        .sort((a, b) => b.completed - a.completed)
        .slice(0, 5);

      const workerNames = topWorkers.map(w => w.name);
      const completedCounts = topWorkers.map(w => w.completed);

      console.log('[Reports] ðŸ“ˆ Chart data:', workerNames, completedCounts);

      // Handle empty data
      if (workerNames.length === 0) {
        console.warn('[Reports] âš ï¸ No worker data for chart, showing empty state');
        workerNames.push('No Workers');
        completedCounts.push(0);
      }

      if (workerPerformanceChart) {
        workerPerformanceChart.destroy();
      }

      const colors = getChartColors();
      workerPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: workerNames,
          datasets: [{
            label: 'Completed Jobs',
            data: completedCounts,
            backgroundColor: '#4CAF50',
            borderRadius: 6,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: colors.tooltipBg,
              borderColor: colors.tooltipBorder,
              borderWidth: 1,
              titleColor: colors.text,
              bodyColor: colors.text,
              callbacks: {
                label: function(context) {
                  return 'Completed: ' + context.parsed.y + ' jobs';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: colors.text,
                stepSize: 1,
                precision: 0
              },
              grid: {
                color: colors.grid
              }
            },
            x: {
              ticks: {
                color: colors.text,
                font: {
                  size: 11
                }
              },
              grid: {
                color: colors.grid
              }
            }
          }
        }
      });
      
      console.log('[Reports] âœ… Worker performance chart created successfully');
    }

    // Calculate worker statistics
    async function calculateWorkerStats() {
      try {
        console.log('[Reports] ðŸ‘· Calculating worker statistics...');
        
        // Fetch all user profiles (workers)
        const { data: profiles, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, role')
          .in('role', ['staff', 'admin']);

        if (error) {
          console.error('[Reports] âŒ Error fetching user profiles:', error);
          return [];
        }

        console.log('[Reports] ðŸ“‹ Fetched', profiles?.length || 0, 'worker profiles');
        console.log('[Reports] ðŸ“Š Total jobs to analyze:', reportsData.jobs.length);

        const workerStats = [];
        const timeRange = document.getElementById('time-period')?.value || '30';
        let daysInPeriod = 30;
        if (timeRange === 'custom') {
          const dateFrom = document.getElementById('date-from')?.value;
          const dateTo = document.getElementById('date-to')?.value;
          if (dateFrom && dateTo) {
            const start = new Date(dateFrom);
            const end = new Date(dateTo);
            daysInPeriod = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
          }
        } else if (timeRange === 'all') {
          daysInPeriod = 365;
        } else {
          daysInPeriod = parseInt(timeRange);
        }
        const weeksInPeriod = daysInPeriod / 7;

        console.log('[Reports] ðŸ“… Time period:', timeRange, 'days =', weeksInPeriod.toFixed(1), 'weeks');

        profiles?.forEach(profile => {
          const workerId = profile.id;
          const workerJobs = reportsData.jobs.filter(j => j.assigned_to === workerId);
          
          const completed = workerJobs.filter(j => j.status === 'completed').length;
          const active = workerJobs.filter(j => j.status === 'pending' || j.status === 'in-progress').length;
          const rate = weeksInPeriod > 0 ? (completed / weeksInPeriod).toFixed(1) : '0.0';

          // Only include workers who have at least some activity
          if (completed > 0 || active > 0) {
            console.log(`[Reports] âœ… ${profile.full_name}: ${completed} completed, ${active} active, ${rate}/wk`);
            workerStats.push({
              id: workerId,
              name: profile.full_name || 'Unknown Worker',
              completed: completed,
              active: active,
              rate: rate
            });
          }
        });

        console.log('[Reports] ðŸ† Found', workerStats.length, 'workers with activity');
        
        // Debug: Show why no workers found
        if (workerStats.length === 0 && reportsData.jobs.length > 0) {
          console.warn('[Reports] âš ï¸ No workers with activity found!');
          console.log('[Reports] ðŸ” Debugging info:');
          console.log('[Reports] ðŸ“Š Total jobs:', reportsData.jobs.length);
          console.log('[Reports] ðŸ‘¥ Worker IDs:', profiles?.map(p => p.id));
          
          // Check if jobs have assigned_to field
          const sampleJob = reportsData.jobs[0];
          console.log('[Reports] ðŸ“‹ Sample job:', {
            id: sampleJob.id,
            title: sampleJob.title,
            assigned_to: sampleJob.assigned_to,
            status: sampleJob.status
          });
          
          // Count jobs with assigned_to
          const assignedJobs = reportsData.jobs.filter(j => j.assigned_to != null).length;
          console.log('[Reports] ðŸŽ¯ Jobs with assigned_to:', assignedJobs, 'out of', reportsData.jobs.length);
          
          if (assignedJobs === 0) {
            console.error('[Reports] âŒ PROBLEM: No jobs have assigned_to field set!');
            console.log('[Reports] ðŸ’¡ Solution: Assign jobs to workers in the Jobs page');
          }
        }
        
        return workerStats;
      } catch (error) {
        console.error('[Reports] âŒ Error calculating worker stats:', error);
        return [];
      }
    }

    // Update Worker Stats Table
    async function updateWorkerStatsTable() {
      const tbody = document.getElementById('worker-stats-table');
      
      console.log('[Reports] ðŸ“Š Updating worker stats table...');
      const workerStats = await calculateWorkerStats();
      
      // Sort by completed jobs and get top 5
      const topWorkers = workerStats
        .sort((a, b) => b.completed - a.completed)
        .slice(0, 5);

      console.log('[Reports] ðŸ… Top 5 workers:', topWorkers.map(w => w.name).join(', '));

      if (topWorkers.length === 0) {
        console.warn('[Reports] âš ï¸ No worker data to display');
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No worker data available</td></tr>';
        return;
      }

      tbody.innerHTML = topWorkers.map(worker => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${worker.name}</td>
          <td class="py-3 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-700 font-semibold text-sm">
              ${worker.completed}
            </span>
          </td>
          <td class="py-3 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-semibold text-sm">
              ${worker.active}
            </span>
          </td>
          <td class="py-3 text-right text-gray-700 font-medium">${worker.rate}/wk</td>
        </tr>
      `).join('');
      
      console.log('[Reports] âœ… Worker stats table updated successfully');
    }

    // Update Top Sites Table
    function updateTopSitesTable() {
      const tbody = document.getElementById('top-sites-table');
      
      // Count jobs per site
      const siteStats = {};
      reportsData.jobs.forEach(job => {
        const siteName = job.sites?.name || 'Unknown';
        if (!siteStats[siteName]) {
          siteStats[siteName] = { total: 0, completed: 0 };
        }
        siteStats[siteName].total++;
        if (job.status === 'completed') {
          siteStats[siteName].completed++;
        }
      });

      // Sort by total jobs and get top 5
      const topSites = Object.entries(siteStats)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

      if (topSites.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500 dark:text-gray-400">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = topSites.map(([siteName, stats]) => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${siteName}</td>
          <td class="py-3 text-right">${stats.total}</td>
          <td class="py-3 text-right text-green-600">${stats.completed}</td>
        </tr>
      `).join('');
    }

    // Update Top Services Table
    function updateTopServicesTable() {
      const tbody = document.getElementById('top-services-table');
      
      // Count services from bookings
      const serviceCounts = {};
      reportsData.bookings.forEach(booking => {
        if (booking.booking_services) {
          booking.booking_services.forEach(bs => {
            const serviceName = bs.services?.name || 'Unknown';
            serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
          });
        }
      });

      // Sort and get top 5
      const topServices = Object.entries(serviceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      if (topServices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="py-4 text-center text-gray-500 dark:text-gray-400">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = topServices.map(([serviceName, count]) => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${serviceName}</td>
          <td class="py-3 text-right">${count}</td>
        </tr>
      `).join('');
    }

    // Update Recent Jobs Table
    function updateRecentJobsTable() {
      const tbody = document.getElementById('recent-jobs-table');
      
      const completedJobs = reportsData.jobs
        .filter(j => j.status === 'completed')
        .slice(0, 10);

      if (completedJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No completed jobs yet</td></tr>';
        return;
      }

      tbody.innerHTML = completedJobs.map(job => {
        const date = new Date(job.created_at).toLocaleDateString();
        return `
          <tr class="border-b border-nfgray last:border-0">
            <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${job.title}</td>
            <td class="py-3 hidden md:table-cell">${job.sites?.name || 'Unknown'}</td>
            <td class="py-3 hidden md:table-cell">${date}</td>
            <td class="py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                Completed
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Refresh all reports
    async function refreshReports() {
      const timePeriod = document.getElementById('time-period')?.value || '30';
      const refreshBtn = document.getElementById('refresh-btn');
      const icon = refreshBtn?.querySelector('i');
      
      // Handle custom date range
      let customStartDate = null;
      let customEndDate = null;
      
      if (timePeriod === 'custom') {
        customStartDate = document.getElementById('date-from')?.value;
        customEndDate = document.getElementById('date-to')?.value;
        
        if (!customStartDate || !customEndDate) {
          toast.error('Please select both start and end dates for custom range');
          // Reset to default
          document.getElementById('time-period').value = '30';
          return refreshReports();
        }
        
        if (new Date(customStartDate) > new Date(customEndDate)) {
          toast.error('Start date must be before end date');
          return;
        }
      }
      
      // Add spin animation (if icon exists)
      if (icon) {
        icon.classList.add('animate-spin');
      }
      
      const success = await fetchData(timePeriod, customStartDate, customEndDate);
      
      if (success) {
        updateMetrics();
        createJobsOverTimeChart();
        await createStaffHoursChart();
        await createWorkerPerformanceChart();
        await updateWorkerStatsTable();
        updateTopSitesTable();
        updateTopServicesTable();
        updateRecentJobsTable();
        toast.success('Reports refreshed!');
      }
      
      // Remove spin animation (if icon exists)
      if (icon) {
        setTimeout(() => {
          icon.classList.remove('animate-spin');
        }, 500);
      }
    }

    // Export to CSV
    async function exportToCSV() {
      try {
        console.log('[Reports] ðŸ“¥ Exporting CSV...');
        
        // Get current filter settings
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const dateFrom = document.getElementById('date-from')?.value;
        const dateTo = document.getElementById('date-to')?.value;
        
        // Fetch user profiles for worker names
        const { data: profiles } = await supabase
          .from('user_profiles')
          .select('id, full_name, email');
        const profilesMap = {};
        (profiles || []).forEach(p => {
          profilesMap[p.id] = p;
        });
        
        // Build CSV header
        let csv = 'NFG Jobs Report\n';
        csv += `Generated: ${new Date().toLocaleString()}\n`;
        if (timePeriod === 'custom' && dateFrom && dateTo) {
          csv += `Date Range: ${dateFrom} to ${dateTo}\n`;
        } else if (timePeriod !== 'all') {
          csv += `Period: Last ${timePeriod} Days\n`;
        } else {
          csv += `Period: All Time\n`;
        }
        csv += '\n';
        
        // CSV headers
        csv += 'Job Title,Site,Status,Type,Assigned Worker,Worker Email,Created Date,Completed Date,Total Duration (hours),Description\n';
        
        // Add job data
        reportsData.jobs.forEach(job => {
          const createdDate = new Date(job.created_at).toLocaleDateString();
          const completedDate = job.completed_at ? new Date(job.completed_at).toLocaleDateString() : '';
          const worker = job.assigned_worker_id ? profilesMap[job.assigned_worker_id] : null;
          const workerName = worker?.full_name || worker?.email || 'Unassigned';
          const workerEmail = worker?.email || '';
          const duration = job.total_duration ? (job.total_duration / 3600).toFixed(2) : ''; // Convert seconds to hours
          const description = (job.description || '').replace(/"/g, '""'); // Escape quotes for CSV
          
          csv += `"${job.title}","${job.sites?.name || 'Unknown'}","${job.status}","${job.job_type || 'cleaning'}","${workerName}","${workerEmail}","${createdDate}","${completedDate}","${duration}","${description}"\n`;
        });
        
        // Create and download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().split('T')[0];
        a.download = `nfg-jobs-report-${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('[Reports] âœ… CSV exported successfully');
        toast.success('CSV exported successfully!');
      } catch (error) {
        console.error('[Reports] âŒ Error exporting CSV:', error);
        const { handleError } = await import('./js/notifications.js');
        handleError(error, 'Exporting CSV');
      }
    }

    // Print report
    function printReport() {
      window.print();
    }

    // ========== TAB SYSTEM ==========
    
    // Initialize tabs
    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.dataset.tab;
          
          // Update button styles
          tabButtons.forEach(btn => {
            btn.classList.remove('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
            btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          });
          
          button.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          button.classList.add('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
          
          // Show/hide tab content
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          const targetContent = document.getElementById(`tab-content-${targetTab}`);
          if (targetContent) {
            targetContent.classList.remove('hidden');
          }
          
          // Load tab-specific data if needed
          if (targetTab === 'time-tracking') {
            loadTimeTrackingData();
          } else if (targetTab === 'billing') {
            loadBillingData();
          } else if (targetTab === 'expenses') {
            loadExpensesData();
          } else if (targetTab === 'team') {
            // Team tab logic (already exists)
          } else if (targetTab === 'inventory') {
            // Initialize inventory reports when tab is first opened
            if (typeof initInventoryReports === 'function') {
              initInventoryReports();
            }
            loadTeamData();
            // Subscribe to realtime updates when Team tab is opened
            subscribeToJobChanges();
            // Start timers when Team tab is opened
            setTimeout(() => {
              startActiveJobTimers();
            }, 500);
          } else {
            // Stop timers and unsubscribe when switching away from Team tab
            stopActiveJobTimers();
            unsubscribeFromJobChanges();
          }
          
          // Recreate icons after tab switch
          setTimeout(() => {
            if (window.lucide) lucide.createIcons();
          }, 100);
        });
      });
      
      // Initialize sub-tabs for admin view
      const subtabButtons = document.querySelectorAll('.subtab-btn');
      subtabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetSubtab = button.dataset.subtab;
          
          // Update button styles
          subtabButtons.forEach(btn => {
            btn.classList.remove('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
            btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          });
          
          button.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          button.classList.add('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
          
          // Show/hide sub-tab content
          document.querySelectorAll('.subtab-content').forEach(content => {
            content.classList.add('hidden');
          });
          
          const targetContent = document.getElementById(`subtab-content-${targetSubtab}`);
          if (targetContent) {
            targetContent.classList.remove('hidden');
          }
          
          // Load sub-tab data
          if (targetSubtab === 'approval') {
            loadPendingTimeEntries();
          } else if (targetSubtab === 'reports') {
            loadTimeReports();
          }
          
          setTimeout(() => {
            if (window.lucide) lucide.createIcons();
          }, 100);
        });
      });
    }

    // ========== TIME TRACKING FUNCTIONS ==========
    
    // Get date range helper
    function getDateRange(period) {
      const now = new Date();
      let startDate, endDate;
      
      if (period === 'custom') {
        startDate = document.getElementById('date-from')?.value;
        endDate = document.getElementById('date-to')?.value;
      } else if (period === 'all') {
        startDate = '2000-01-01';
        endDate = now.toISOString().split('T')[0];
      } else {
        const days = parseInt(period);
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - days);
        startDate = startDate.toISOString().split('T')[0];
        endDate = now.toISOString().split('T')[0];
      }
      
      return { startDate, endDate };
    }
    
    // Format duration helper
    function formatDuration(seconds) {
      if (!seconds) return '0:00:00';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    // Load time tracking data based on user role
    async function loadTimeTrackingData() {
      if (!currentUser || !currentUserProfile) return;
      
      const isStaff = currentUserProfile.role === 'staff';
      
      if (isStaff) {
        // Show staff view
        document.getElementById('time-sheets-view')?.classList.remove('hidden');
        document.getElementById('time-admin-view')?.classList.add('hidden');
        document.getElementById('time-tracking-title').textContent = 'My Time Sheet';
        await loadMyTimeSheet();
      } else {
        // Show admin view
        document.getElementById('time-sheets-view')?.classList.add('hidden');
        document.getElementById('time-admin-view')?.classList.remove('hidden');
        document.getElementById('time-tracking-title').textContent = 'Time Tracking & Approval';
        await loadStaffList();
        await loadPendingTimeEntries();
        await loadTimeReports();
      }
    }
    
    // Staff: Load my time sheet
    async function loadMyTimeSheet() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        // Fetch time entries
        const { data: timeEntries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .eq('user_id', currentUser.id)
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .order('clock_in', { ascending: false });
        
        if (error) {
          console.error('Error loading time sheet:', error);
          // If table doesn't exist, show empty state
          if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
            document.getElementById('time-entries-table').innerHTML = `
              <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                  Time tracking not yet set up. Please run the database migration.
                </td>
              </tr>
            `;
            return;
          }
          toast.error('Failed to load time sheet: ' + error.message);
          return;
        }
        
        const entries = timeEntries || [];
        
        // Calculate summary metrics
        const totalSeconds = entries.reduce((sum, entry) => sum + (entry.total_duration || 0), 0);
        const overtimeEntries = entries.filter(e => e.is_overtime);
        const overtimeSeconds = overtimeEntries.reduce((sum, entry) => {
          const regularSeconds = 8 * 3600; // 8 hours
          return sum + Math.max(0, (entry.total_duration || 0) - regularSeconds);
        }, 0);
        
        const totalHours = (totalSeconds / 3600).toFixed(1);
        const overtimeHours = (overtimeSeconds / 3600).toFixed(1);
        const pendingCount = entries.filter(e => e.status === 'pending').length;
        
        // Update summary cards
        document.getElementById('time-total-hours').textContent = `${totalHours}h`;
        document.getElementById('time-overtime-hours').textContent = `${overtimeHours}h`;
        document.getElementById('time-pending-count').textContent = pendingCount;
        
        // Calculate average hours per day
        const days = Math.ceil((new Date(endDate + 'T23:59:59') - new Date(startDate + 'T00:00:00')) / (1000 * 60 * 60 * 24)) || 1;
        const avgHours = (totalSeconds / 3600 / days).toFixed(1);
        document.getElementById('time-avg-hours').textContent = `${avgHours}h`;
        
        // Render time entries table
        renderTimeEntriesTable(entries, 'time-entries-table', true);
      } catch (error) {
        console.error('Error in loadMyTimeSheet:', error);
        toast.error('Failed to load time sheet');
      }
    }
    
    // Render time entries table
    function renderTimeEntriesTable(entries, tableId, isStaff = false) {
      const tbody = document.getElementById(tableId);
      if (!tbody) return;
      
      if (entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
              No time entries found for this period
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = entries.map(entry => {
        const date = new Date(entry.clock_in).toLocaleDateString();
        const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const clockOut = entry.clock_out 
          ? new Date(entry.clock_out).toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            })
          : 'In Progress';
        
        const duration = entry.total_duration 
          ? formatDuration(entry.total_duration)
          : 'Calculating...';
        
        const overtimeBadge = entry.is_overtime 
          ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300">Yes</span>'
          : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">No</span>';
        
        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300',
          'approved': 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
          'rejected': 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
        };
        
        const statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[entry.status] || statusColors.pending}">${entry.status}</span>`;
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3">${date}</td>
            <td class="px-4 py-3">
              ${entry.jobs?.title || 'General Work'}
              ${entry.jobs?.sites?.name ? `<br><span class="text-xs text-gray-500">${entry.jobs.sites.name}</span>` : ''}
            </td>
            <td class="px-4 py-3">${clockIn}</td>
            <td class="px-4 py-3">${clockOut}</td>
            <td class="px-4 py-3 font-medium">${duration}</td>
            <td class="px-4 py-3">${overtimeBadge}</td>
            <td class="px-4 py-3">${statusBadge}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Admin: Load staff list for filter
    async function loadStaffList() {
      try {
        const { data: staff, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email')
          .eq('role', 'staff')
          .order('full_name');
        
        if (error) {
          console.error('Error loading staff list:', error);
          return;
        }
        
        const select = document.getElementById('approval-filter-staff');
        if (!select) return;
        
        // Clear existing options except "All Staff"
        select.innerHTML = '<option value="">All Staff</option>';
        
        staff.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = member.full_name || member.email;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error in loadStaffList:', error);
      }
    }
    
    // Admin: Load pending time entries
    async function loadPendingTimeEntries() {
      try {
        const staffFilter = document.getElementById('approval-filter-staff')?.value || '';
        const statusFilter = document.getElementById('approval-filter-status')?.value || 'pending';
        
        let query = supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))');
        
        if (statusFilter) {
          query = query.eq('status', statusFilter);
        }
        
        if (staffFilter) {
          query = query.eq('user_id', staffFilter);
        }
        
        const { data: entries, error } = await query.order('clock_in', { ascending: false });
        
        if (error) throw error;
        
        // Fetch user profiles separately
        if (entries && entries.length > 0) {
          const userIds = [...new Set(entries.map(e => e.user_id))];
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', userIds);
          
          // Merge profiles into entries
          const profilesMap = {};
          (profiles || []).forEach(p => {
            profilesMap[p.id] = p;
          });
          
          entries.forEach(entry => {
            entry.user_profiles = profilesMap[entry.user_id] || null;
          });
        }
        
        renderPendingTimeEntriesTable(entries || []);
      } catch (error) {
        console.error('Error in loadPendingTimeEntries:', error);
        if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
          document.getElementById('pending-time-entries-table').innerHTML = `
            <tr>
              <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                Time tracking not yet set up. Please run the database migration.
              </td>
            </tr>
          `;
        } else {
          toast.error('Failed to load pending entries: ' + (error.message || 'Unknown error'));
        }
      }
    }
    
    // Render pending time entries for admin approval
    function renderPendingTimeEntriesTable(entries) {
      const tbody = document.getElementById('pending-time-entries-table');
      if (!tbody) return;
      
      if (entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
              No pending time entries
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = entries.map(entry => {
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        const date = new Date(entry.clock_in).toLocaleDateString();
        const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const clockOut = entry.clock_out 
          ? new Date(entry.clock_out).toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            })
          : 'In Progress';
        
        const duration = entry.total_duration 
          ? formatDuration(entry.total_duration)
          : 'Calculating...';
        
        const overtimeBadge = entry.is_overtime 
          ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300">Yes</span>'
          : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">No</span>';
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3">
              <input type="checkbox" class="time-entry-checkbox rounded" data-entry-id="${entry.id}">
            </td>
            <td class="px-4 py-3 font-medium">${staffName}</td>
            <td class="px-4 py-3">${date}</td>
            <td class="px-4 py-3">
              ${entry.jobs?.title || 'General Work'}
            </td>
            <td class="px-4 py-3">${clockIn}</td>
            <td class="px-4 py-3">${clockOut}</td>
            <td class="px-4 py-3 font-medium">${duration}</td>
            <td class="px-4 py-3">${overtimeBadge}</td>
            <td class="px-4 py-3">
              ${entry.status === 'pending' ? `
                <div class="flex gap-2">
                  <button 
                    onclick="approveTimeEntry('${entry.id}')" 
                    class="px-3 py-1 rounded-lg bg-green-600 text-white hover:bg-green-700 text-xs"
                  >
                    Approve
                  </button>
                  <button 
                    onclick="rejectTimeEntry('${entry.id}')" 
                    class="px-3 py-1 rounded-lg bg-red-600 text-white hover:bg-red-700 text-xs"
                  >
                    Reject
                  </button>
                </div>
              ` : `
                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                  entry.status === 'approved' 
                    ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' 
                    : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
                }">${entry.status}</span>
              `}
            </td>
          </tr>
        `;
      }).join('');
      
      // Attach checkbox listeners
      attachCheckboxListeners();
    }
    
    // Attach checkbox listeners for bulk approval
    function attachCheckboxListeners() {
      const selectAll = document.getElementById('select-all-time-entries');
      const checkboxes = document.querySelectorAll('.time-entry-checkbox');
      
      if (selectAll) {
        selectAll.addEventListener('change', (e) => {
          checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
          });
        });
      }
    }
    
    // Approve time entry (global function for onclick)
    window.approveTimeEntry = async function(entryId) {
      const confirmed = await showConfirm('Approve this time entry?', 'Approve Time Entry');
      if (!confirmed) return;
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'approved',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString()
        })
        .eq('id', entryId);
      
      if (error) {
        console.error('Error approving entry:', error);
        toast.error('Failed to approve time entry');
        return;
      }
      
      toast.success('Time entry approved');
      await loadPendingTimeEntries();
      await loadTimeReports();
      if (currentUserProfile?.role === 'staff') {
        await loadMyTimeSheet();
      }
    };
    
    // Reject time entry (global function for onclick)
    window.rejectTimeEntry = async function(entryId) {
      const reason = await showPrompt('Rejection reason (optional):', 'Reject Time Entry', '');
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'rejected',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString(),
          notes: reason || 'Rejected by admin'
        })
        .eq('id', entryId);
      
      if (error) {
        console.error('Error rejecting entry:', error);
        toast.error('Failed to reject time entry');
        return;
      }
      
      toast.success('Time entry rejected');
      await loadPendingTimeEntries();
      await loadTimeReports();
    };
    
    // Bulk approve selected entries
    async function bulkApproveTimeEntries() {
      const checkboxes = document.querySelectorAll('.time-entry-checkbox:checked');
      const entryIds = Array.from(checkboxes).map(cb => cb.dataset.entryId);
      
      if (entryIds.length === 0) {
        toast.error('Please select at least one time entry');
        return;
      }
      
      const confirmed = await showConfirm(
        `Approve ${entryIds.length} selected time ${entryIds.length === 1 ? 'entry' : 'entries'}?`,
        'Bulk Approve'
      );
      if (!confirmed) return;
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'approved',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString()
        })
        .in('id', entryIds);
      
      if (error) {
        console.error('Error bulk approving entries:', error);
        toast.error('Failed to approve time entries');
        return;
      }
      
      toast.success(`${entryIds.length} time ${entryIds.length === 1 ? 'entry' : 'entries'} approved`);
      await loadPendingTimeEntries();
      await loadTimeReports();
    }
    
    // Admin: Load time reports
    async function loadTimeReports() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        // Fetch all time entries
        const { data: timeEntries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .eq('status', 'approved'); // Only approved entries for reports
        
        if (error) throw error;
        
        // Fetch user profiles separately
        if (timeEntries && timeEntries.length > 0) {
          const userIds = [...new Set(timeEntries.map(e => e.user_id))];
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', userIds);
          
          // Merge profiles into entries
          const profilesMap = {};
          (profiles || []).forEach(p => {
            profilesMap[p.id] = p;
          });
          
          timeEntries.forEach(entry => {
            entry.user_profiles = profilesMap[entry.user_id] || null;
          });
        }
        
        const entries = timeEntries || [];
        
        // Calculate metrics
        const totalSeconds = entries.reduce((sum, e) => sum + (e.total_duration || 0), 0);
        const overtimeEntries = entries.filter(e => e.is_overtime);
        const overtimeSeconds = overtimeEntries.reduce((sum, e) => {
          const regularSeconds = 8 * 3600;
          return sum + Math.max(0, (e.total_duration || 0) - regularSeconds);
        }, 0);
        
        // Count pending entries
        const { data: pendingEntries } = await supabase
          .from('staff_time_logs')
          .select('id')
          .eq('status', 'pending');
        
        const activeStaff = [...new Set(entries.map(e => e.user_id))].length;
        
        // Update metrics
        document.getElementById('admin-total-hours').textContent = `${(totalSeconds / 3600).toFixed(1)}h`;
        document.getElementById('admin-overtime-hours').textContent = `${(overtimeSeconds / 3600).toFixed(1)}h`;
        document.getElementById('admin-pending-count').textContent = pendingEntries?.length || 0;
        document.getElementById('admin-active-staff').textContent = activeStaff;
        
        // Create charts
        createHoursByStaffChart(entries);
        createDailyHoursTrendChart(entries);
        
        // Render staff summary table
        renderStaffTimeSummaryTable(entries, startDate, endDate);
      } catch (error) {
        console.error('Error in loadTimeReports:', error);
        if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
          // Table doesn't exist yet - silently return
          return;
        }
        toast.error('Failed to load time reports: ' + (error.message || 'Unknown error'));
      }
    }
    
    // Create hours by staff chart
    function createHoursByStaffChart(entries) {
      const ctx = document.getElementById('hours-by-staff-chart');
      if (!ctx) return;
      
      // Group by staff
      const staffHours = {};
      entries.forEach(entry => {
        const staffId = entry.user_id;
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        if (!staffHours[staffId]) {
          staffHours[staffId] = { name: staffName, hours: 0 };
        }
        staffHours[staffId].hours += (entry.total_duration || 0) / 3600;
      });
      
      const sortedStaff = Object.values(staffHours)
        .sort((a, b) => b.hours - a.hours)
        .slice(0, 10);
      
      if (hoursByStaffChart) {
        hoursByStaffChart.destroy();
      }
      
      const themeColors = {
        text: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937',
        tooltipBg: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
        tooltipBorder: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB'
      };
      
      hoursByStaffChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedStaff.map(s => s.name),
          datasets: [{
            label: 'Hours',
            data: sortedStaff.map(s => s.hours.toFixed(1)),
            backgroundColor: '#0D47A1',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: themeColors.tooltipBg,
              borderColor: themeColors.tooltipBorder,
              borderWidth: 1,
              titleColor: themeColors.text,
              bodyColor: themeColors.text
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: themeColors.text },
              grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB' }
            },
            x: {
              ticks: { color: themeColors.text },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Create daily hours trend chart
    function createDailyHoursTrendChart(entries) {
      const ctx = document.getElementById('daily-hours-trend-chart');
      if (!ctx) return;
      
      // Group by date
      const dailyHours = {};
      entries.forEach(entry => {
        const date = new Date(entry.clock_in).toISOString().split('T')[0];
        if (!dailyHours[date]) {
          dailyHours[date] = 0;
        }
        dailyHours[date] += (entry.total_duration || 0) / 3600;
      });
      
      // Sort dates
      const sortedDates = Object.keys(dailyHours).sort();
      const hours = sortedDates.map(date => dailyHours[date]);
      
      if (dailyHoursTrendChart) {
        dailyHoursTrendChart.destroy();
      }
      
      const themeColors = {
        text: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937',
        tooltipBg: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
        tooltipBorder: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB'
      };
      
      dailyHoursTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'Hours',
            data: hours,
            borderColor: '#0D47A1',
            backgroundColor: 'rgba(13, 71, 161, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: themeColors.tooltipBg,
              borderColor: themeColors.tooltipBorder,
              borderWidth: 1,
              titleColor: themeColors.text,
              bodyColor: themeColors.text
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: themeColors.text },
              grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB' }
            },
            x: {
              ticks: { color: themeColors.text },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Render staff time summary table
    function renderStaffTimeSummaryTable(entries, startDate, endDate) {
      const tbody = document.getElementById('staff-time-summary-table');
      if (!tbody) return;
      
      // Group by staff
      const staffStats = {};
      entries.forEach(entry => {
        const staffId = entry.user_id;
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        if (!staffStats[staffId]) {
          staffStats[staffId] = {
            name: staffName,
            totalSeconds: 0,
            regularSeconds: 0,
            overtimeSeconds: 0,
            jobCount: 0,
            uniqueJobs: new Set()
          };
        }
        const seconds = entry.total_duration || 0;
        staffStats[staffId].totalSeconds += seconds;
        staffStats[staffId].uniqueJobs.add(entry.job_id);
        
        if (entry.is_overtime) {
          const regularSeconds = 8 * 3600;
          const overtimeSecs = Math.max(0, seconds - regularSeconds);
          staffStats[staffId].overtimeSeconds += overtimeSecs;
          staffStats[staffId].regularSeconds += regularSeconds;
        } else {
          staffStats[staffId].regularSeconds += seconds;
        }
      });
      
      const staffArray = Object.values(staffStats).map(stats => ({
        ...stats,
        jobCount: stats.uniqueJobs.size
      }));
      
      if (staffArray.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              No time data available
            </td>
          </tr>
        `;
        return;
      }
      
      const days = Math.ceil((new Date(endDate + 'T23:59:59') - new Date(startDate + 'T00:00:00')) / (1000 * 60 * 60 * 24)) || 1;
      
      tbody.innerHTML = staffArray.map(stats => {
        const totalHours = (stats.totalSeconds / 3600).toFixed(1);
        const regularHours = (stats.regularSeconds / 3600).toFixed(1);
        const overtimeHours = (stats.overtimeSeconds / 3600).toFixed(1);
        const avgHours = (stats.totalSeconds / 3600 / days).toFixed(1);
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3 font-medium">${stats.name}</td>
            <td class="px-4 py-3">${totalHours}h</td>
            <td class="px-4 py-3">${regularHours}h</td>
            <td class="px-4 py-3 text-orange-600">${overtimeHours}h</td>
            <td class="px-4 py-3">${stats.jobCount}</td>
            <td class="px-4 py-3">${avgHours}h</td>
          </tr>
        `;
      }).join('');
    }
    
    // Export time sheet to CSV
    async function exportTimeSheet() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        const { data: entries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .eq('user_id', currentUser.id)
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .order('clock_in', { ascending: false });
        
        if (error) {
          toast.error('Failed to export time sheet: ' + error.message);
          return;
        }
        
        // Create CSV
        const headers = ['Date', 'Job', 'Site', 'Clock In', 'Clock Out', 'Duration', 'Overtime', 'Status'];
        const rows = entries.map(entry => {
          const date = new Date(entry.clock_in).toLocaleDateString();
          const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const clockOut = entry.clock_out ? new Date(entry.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : 'In Progress';
          const duration = entry.total_duration ? formatDuration(entry.total_duration) : '0:00:00';
          return [
            date,
            entry.jobs?.title || 'General Work',
            entry.jobs?.sites?.name || '',
            clockIn,
            clockOut,
            duration,
            entry.is_overtime ? 'Yes' : 'No',
            entry.status
          ];
        });
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `time-sheet-${startDate}-to-${endDate}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        toast.success('Time sheet exported successfully');
      } catch (error) {
        console.error('Error exporting time sheet:', error);
        toast.error('Failed to export time sheet');
      }
    }

    // ========== BILLING FUNCTIONS ==========
    
    // Load billing data
    async function loadBillingData() {
      try {
        console.log('[Billing] Loading billing data...');
        await loadBillingSummary();
        await loadInvoices();
        await loadRevenueChart();
        await loadClientFilter();
      } catch (error) {
        console.error('[Billing] Error loading billing data:', error);
        toast.error('Failed to load billing data', 'Error');
      }
    }

    // Open add expense modal
    async function openAddExpenseModal() {
      const modal = document.getElementById('add-expense-modal');
      if (!modal) {
        console.error('[Expenses] Add expense modal not found');
        return;
      }

      // Set default expense date to today
      const today = new Date();
      document.getElementById('expense-date').value = today.toISOString().split('T')[0];

      // Reset form
      document.getElementById('add-expense-form').reset();
      document.getElementById('expense-date').value = today.toISOString().split('T')[0]; // Reset again after form reset
      document.getElementById('expense-receipt-preview').classList.add('hidden');
      document.getElementById('expense-error-message').classList.add('hidden');

      // Load job and site dropdowns
      await loadExpenseJobs();
      await loadExpenseSites();

      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    }

    // Load jobs for expense dropdown
    async function loadExpenseJobs() {
      try {
        const { data: jobs, error } = await supabase
          .from('jobs')
          .select('id, title, status')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;

        const select = document.getElementById('expense-job-select');
        if (!select) return;

        // Clear existing options (keep first "Select a job" option)
        select.innerHTML = '<option value="">Select a job (optional)</option>';

        if (jobs && jobs.length > 0) {
          jobs.forEach(job => {
            const option = document.createElement('option');
            option.value = job.id;
            option.textContent = `${job.title} (${job.status})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('[Expenses] Error loading jobs:', error);
      }
    }

    // Load sites for expense dropdown
    async function loadExpenseSites() {
      try {
        const { data: sites, error } = await supabase
          .from('sites')
          .select('id, name')
          .order('name', { ascending: true });

        if (error) throw error;

        const select = document.getElementById('expense-site-select');
        if (!select) return;

        // Clear existing options (keep first "Select a site" option)
        select.innerHTML = '<option value="">Select a site (optional)</option>';

        if (sites && sites.length > 0) {
          sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('[Expenses] Error loading sites:', error);
      }
    }

    // Convert file to base64
    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // Remove data:image/...;base64, prefix
          const base64 = reader.result.split(',')[1];
          resolve({
            content: base64,
            filename: file.name,
            mimeType: file.type
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Send expense receipt email via Edge Function
    async function sendExpenseReceiptEmail(expenseId, expenseData, receiptFile, userEmail, userName) {
      try {
        console.log('[Expenses] Invoking Edge Function:', {
          functionName: 'send-expense-receipt-email',
          expenseId,
          userEmail,
          receiptFileSize: receiptFile ? `${receiptFile.content?.length || 0} bytes` : 'none'
        });

        const { data, error } = await supabase.functions.invoke('send-expense-receipt-email', {
          body: {
            expenseId,
            expenseData,
            userEmail,
            userName,
            receiptFile
          }
        });
        
        if (error) {
          console.error('[Expenses] Edge Function error:', error);
          throw error;
        }

        console.log('[Expenses] Edge Function response:', data);
        return data;
      } catch (error) {
        console.error('[Expenses] Error sending receipt email:', error);
        console.error('[Expenses] Full error object:', JSON.stringify(error, null, 2));
        throw error;
      }
    }

    // Submit expense form
    document.getElementById('add-expense-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorDiv = document.getElementById('expense-error-message');
      errorDiv.classList.add('hidden');
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i> Adding...';
      if (window.lucide) lucide.createIcons();
      
      try {
        // Get form data
        const description = document.getElementById('expense-description').value.trim();
        const category = document.getElementById('expense-category').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const expenseDate = document.getElementById('expense-date').value;
        const jobId = document.getElementById('expense-job-select').value || null;
        const siteId = document.getElementById('expense-site-select').value || null;
        const vendorName = document.getElementById('expense-vendor').value.trim() || null;
        const notes = document.getElementById('expense-notes').value.trim() || null;
        const receiptFileInput = document.getElementById('expense-receipt');
        const receiptFile = receiptFileInput?.files?.[0];

        console.log('[Expenses] Receipt file check:', {
          hasFileInput: !!receiptFileInput,
          fileCount: receiptFileInput?.files?.length || 0,
          hasFile: !!receiptFile,
          fileName: receiptFile?.name,
          fileSize: receiptFile?.size,
          fileType: receiptFile?.type
        });

        // Validate required fields
        if (!description || !category || !amount || !expenseDate) {
          throw new Error('Please fill in all required fields');
        }

        // Validate file size (max 15 MB for email)
        if (receiptFile && receiptFile.size > 15 * 1024 * 1024) {
          throw new Error('Receipt file is too large. Maximum size is 15 MB for email attachments.');
        }

        // Convert receipt to base64 if provided
        let receiptBase64 = null;
        if (receiptFile) {
          console.log('[Expenses] Converting receipt file to base64...', {
            fileName: receiptFile.name,
            fileSize: receiptFile.size,
            fileType: receiptFile.type
          });
          try {
            receiptBase64 = await fileToBase64(receiptFile);
            console.log('[Expenses] Receipt converted to base64:', {
              hasContent: !!receiptBase64?.content,
              contentLength: receiptBase64?.content?.length || 0,
              filename: receiptBase64?.filename,
              mimeType: receiptBase64?.mimeType
            });
          } catch (convertError) {
            console.error('[Expenses] Error converting file to base64:', convertError);
            throw new Error('Failed to process receipt file. Please try again.');
          }
        } else {
          console.log('[Expenses] No receipt file provided');
        }

        // Fetch job and site names for email
        let jobTitle = null;
        let siteName = null;
        
        if (jobId) {
          const { data: job } = await supabase.from('jobs').select('title').eq('id', jobId).single();
          if (job) jobTitle = job.title;
        }
        
        if (siteId) {
          const siteIdNum = typeof siteId === 'string' ? parseInt(siteId, 10) : siteId;
          const { data: site } = await supabase.from('sites').select('name').eq('id', siteIdNum).single();
          if (site) siteName = site.name;
        }

        // Insert expense into database
        const expenseData = {
          job_id: jobId,
          site_id: siteId ? (typeof siteId === 'string' ? parseInt(siteId, 10) : siteId) : null,
          description: description,
          category: category,
          amount: amount,
          expense_date: expenseDate,
          vendor_name: vendorName,
          notes: notes,
          receipt_url: null, // Not storing in storage, emailing instead
          created_by: currentUser.id
        };

        const { data: expense, error: expenseError } = await supabase
          .from('expenses')
          .insert(expenseData)
          .select()
          .single();

        if (expenseError) {
          console.error('[Expenses] Error creating expense:', expenseError);
          throw expenseError;
        }

        // Send expense confirmation email (with or without receipt)
        let emailSent = false;
        if (currentUserProfile?.email) {
          try {
            console.log('[Expenses] Sending expense confirmation email...', {
              expenseId: expense.id,
              userEmail: currentUserProfile.email,
              hasReceipt: !!receiptBase64
            });

            const expenseDataForEmail = {
              description,
              amount,
              category,
              expense_date: expenseDate,
              vendor_name: vendorName,
              notes,
              job_title: jobTitle,
              site_name: siteName
            };

            const emailResult = await sendExpenseReceiptEmail(
              expense.id,
              expenseDataForEmail,
              receiptBase64, // Can be null if no receipt
              currentUserProfile.email,
              currentUserProfile.full_name || currentUserProfile.email
            );

            console.log('[Expenses] Email result:', emailResult);

            // Update expense with receipt_emailed_at timestamp (even if no receipt, we still sent confirmation)
            const { error: updateError } = await supabase
              .from('expenses')
              .update({ receipt_emailed_at: new Date().toISOString() })
              .eq('id', expense.id);

            if (updateError) {
              console.error('[Expenses] Error updating receipt_emailed_at:', updateError);
            }

            emailSent = true;
            console.log('[Expenses] Expense confirmation email sent successfully');
          } catch (emailError) {
            console.error('[Expenses] Error sending expense confirmation email:', emailError);
            console.error('[Expenses] Error details:', {
              message: emailError.message,
              stack: emailError.stack,
              response: emailError.response
            });
            // Don't throw - expense was created successfully, just email failed
            // We'll show a warning to the user
          }
        } else {
          console.log('[Expenses] Email not sent - no user email found:', {
            hasReceipt: !!receiptBase64,
            hasEmail: !!currentUserProfile?.email,
            userEmail: currentUserProfile?.email
          });
        }

        // Success message
        if (emailSent) {
          if (receiptBase64) {
            toast.success('Expense created and confirmation email sent with receipt', 'Expense Added');
          } else {
            toast.success('Expense created and confirmation email sent', 'Expense Added');
          }
        } else if (currentUserProfile?.email) {
          toast.warning('Expense created, but confirmation email failed. Please contact support.', 'Partial Success');
        } else {
          toast.success('Expense created successfully', 'Expense Added');
        }

        // Close modal
        document.getElementById('add-expense-modal').classList.add('hidden');
        document.getElementById('add-expense-modal').classList.remove('flex');

        // Refresh expense list
        await loadExpensesData();

      } catch (error) {
        console.error('[Expenses] Error creating expense:', error);
        const errorMessage = error.message || 'Failed to create expense. Please try again.';
        errorDiv.querySelector('p').textContent = errorMessage;
        errorDiv.classList.remove('hidden');
        toast.error(errorMessage, 'Error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        if (window.lucide) lucide.createIcons();
      }
    });
    
    // Load expenses data
    let allExpenses = [];
    let currentExpenseFilters = {
      category: '',
      job: '',
      site: '',
      dateFrom: '',
      dateTo: '',
      search: ''
    };

    // ========== TEAM FUNCTIONS ==========
    
    let allTeamEmployees = [];
    let teamFilters = {
      search: '',
      role: '',
      status: ''
    };
    let teamSortColumn = 'name';
    let teamSortDirection = 'asc';
    
    async function loadTeamData() {
      try {
        console.log('[Team] Loading team data...');
        
        // Fetch all users
        const { data: users, error: usersError } = await supabase
          .from('user_profiles')
          .select('id, full_name, email, role, status, created_at, profile_picture')
          .order('created_at', { ascending: false });
        
        if (usersError) {
          console.error('[Team] Error fetching users:', usersError);
          return;
        }
        
        if (!users || users.length === 0) {
          console.log('[Team] No users found');
          updateTeamSummaryCards(0, 0, 0, 0, 0, 0, 0);
          renderTeamTable([]);
          return;
        }
        
        // Calculate statistics for summary cards
        const totalEmployees = users.length;
        const activeEmployees = users.filter(u => u.status === 'active').length;
        const pendingEmployees = users.filter(u => u.status === 'pending' || !u.status).length;
        const staffCount = users.filter(u => u.role === 'staff').length;
        const adminCount = users.filter(u => u.role === 'admin' || u.role === 'super_admin').length;
        const clientCount = users.filter(u => u.role === 'client').length;
        
        // Count total jobs assigned
        const { data: jobs, error: jobsError } = await supabase
          .from('jobs')
          .select('assigned_worker_id')
          .not('assigned_worker_id', 'is', null);
        
        const totalJobsAssigned = jobs ? jobs.length : 0;
        
        // Update summary cards
        updateTeamSummaryCards(totalEmployees, activeEmployees, pendingEmployees, staffCount, adminCount, clientCount, totalJobsAssigned);
        
        // Fetch detailed stats for each employee
        const employeesWithStats = await fetchEmployeeStats(users);
        allTeamEmployees = employeesWithStats;
        
        // Apply filters and render table
        applyTeamFilters();
        
        // Update top performers
        updateTopPerformers(employeesWithStats);
        
        // Render "Currently Working On" section
        renderCurrentlyWorkingOn(employeesWithStats);
        
        // Render charts (only role distribution now)
        renderTeamCharts(employeesWithStats);
        
        console.log('[Team] Team data loaded:', {
          total: totalEmployees,
          active: activeEmployees,
          employees: employeesWithStats.length
        });
        
      } catch (error) {
        console.error('[Team] Error loading team data:', error);
      }
    }
    
    async function fetchEmployeeStats(users) {
      const userIds = users.map(u => u.id);
      
      // Fetch jobs for all users
      const { data: allJobs, error: jobsError } = await supabase
        .from('jobs')
        .select('id, assigned_worker_id, status')
        .in('assigned_worker_id', userIds);
      
      if (jobsError) {
        console.error('[Team] Error fetching jobs:', jobsError);
      }
      
      // Fetch active jobs (in-progress with timer running)
      const { data: activeJobs, error: activeJobsError } = await supabase
        .from('jobs')
        .select('id, title, assigned_worker_id, status, work_started_at, work_ended_at, total_duration, site_id, sites(name)')
        .in('assigned_worker_id', userIds)
        .eq('status', 'in-progress')
        .not('work_started_at', 'is', null)
        .is('work_ended_at', null);
      
      if (activeJobsError) {
        console.error('[Team] Error fetching active jobs:', activeJobsError);
      }
      
      // Fetch site assignments (from worker_site_assignments or sites.assigned_worker_id)
      const { data: sites, error: sitesError } = await supabase
        .from('sites')
        .select('id, assigned_worker_id')
        .in('assigned_worker_id', userIds);
      
      if (sitesError) {
        console.error('[Team] Error fetching sites:', sitesError);
      }
      
      // Calculate stats for each user
      return users.map(user => {
        const userJobs = allJobs?.filter(j => j.assigned_worker_id === user.id) || [];
        const jobsAssigned = userJobs.length;
        const jobsCompleted = userJobs.filter(j => j.status === 'completed').length;
        const completionRate = jobsAssigned > 0 ? Math.round((jobsCompleted / jobsAssigned) * 100) : 0;
        
        const userSites = sites?.filter(s => s.assigned_worker_id === user.id) || [];
        const sitesAssigned = userSites.length;
        
        // Get active jobs for this user
        const userActiveJobs = activeJobs?.filter(j => j.assigned_worker_id === user.id) || [];
        const activeJobsWithTimers = userActiveJobs.map(job => {
          const startTime = new Date(job.work_started_at);
          const now = new Date();
          const elapsedSeconds = Math.floor((now - startTime) / 1000);
          
          return {
            id: job.id,
            title: job.title || 'Untitled Job',
            site_id: job.site_id,
            site_name: job.sites?.name || 'No site',
            work_started_at: job.work_started_at,
            work_ended_at: job.work_ended_at,
            elapsed_seconds: elapsedSeconds,
            elapsed_display: formatElapsedTime(elapsedSeconds),
            is_active: !job.work_ended_at
          };
        });
        
        return {
          ...user,
          jobsAssigned,
          jobsCompleted,
          completionRate,
          sitesAssigned,
          activeJobs: activeJobsWithTimers,
          activeJobsCount: activeJobsWithTimers.length
        };
      });
    }
    
    function formatElapsedTime(seconds) {
      if (!seconds || seconds < 0) return '0:00:00';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }
    
    function calculateElapsedTime(workStartedAt) {
      if (!workStartedAt) return 0;
      
      const startTime = new Date(workStartedAt);
      const now = new Date();
      const elapsed = Math.floor((now - startTime) / 1000);
      
      return elapsed >= 0 ? elapsed : 0;
    }
    
    function updateTeamSummaryCards(total, active, pending, staff, admin, client, jobs) {
      const totalEl = document.getElementById('team-total-employees');
      const activeEl = document.getElementById('team-active-employees');
      const pendingEl = document.getElementById('team-pending-employees');
      const staffEl = document.getElementById('team-staff-count');
      const adminEl = document.getElementById('team-admin-count');
      const clientEl = document.getElementById('team-client-count');
      const jobsEl = document.getElementById('team-total-jobs');
      
      if (totalEl) totalEl.textContent = total;
      if (activeEl) activeEl.textContent = active;
      if (pendingEl) pendingEl.textContent = pending;
      if (staffEl) staffEl.textContent = staff;
      if (adminEl) adminEl.textContent = admin;
      if (clientEl) clientEl.textContent = client;
      if (jobsEl) jobsEl.textContent = jobs;
    }
    
    function applyTeamFilters() {
      let filtered = [...allTeamEmployees];
      
      // Apply search filter
      if (teamFilters.search) {
        const searchLower = teamFilters.search.toLowerCase();
        filtered = filtered.filter(emp => 
          emp.full_name?.toLowerCase().includes(searchLower) ||
          emp.email?.toLowerCase().includes(searchLower)
        );
      }
      
      // Apply role filter
      if (teamFilters.role) {
        filtered = filtered.filter(emp => emp.role === teamFilters.role);
      }
      
      // Apply status filter
      if (teamFilters.status) {
        filtered = filtered.filter(emp => emp.status === teamFilters.status);
      }
      
      // Apply sorting
      filtered.sort((a, b) => {
        let aVal, bVal;
        
        switch (teamSortColumn) {
          case 'name':
            aVal = (a.full_name || a.email || '').toLowerCase();
            bVal = (b.full_name || b.email || '').toLowerCase();
            break;
          case 'role':
            aVal = a.role || '';
            bVal = b.role || '';
            break;
          case 'status':
            aVal = a.status || '';
            bVal = b.status || '';
            break;
          case 'jobs-assigned':
            aVal = a.jobsAssigned || 0;
            bVal = b.jobsAssigned || 0;
            break;
          case 'jobs-completed':
            aVal = a.jobsCompleted || 0;
            bVal = b.jobsCompleted || 0;
            break;
          case 'completion-rate':
            aVal = a.completionRate || 0;
            bVal = b.completionRate || 0;
            break;
          case 'sites':
            aVal = a.sitesAssigned || 0;
            bVal = b.sitesAssigned || 0;
            break;
          case 'active-jobs':
            aVal = a.activeJobsCount || 0;
            bVal = b.activeJobsCount || 0;
            break;
          default:
            return 0;
        }
        
        if (typeof aVal === 'string') {
          return teamSortDirection === 'asc' 
            ? aVal.localeCompare(bVal)
            : bVal.localeCompare(aVal);
        } else {
          return teamSortDirection === 'asc' 
            ? aVal - bVal
            : bVal - aVal;
        }
      });
      
      renderTeamTable(filtered);
    }
    
    function renderTeamTable(employees) {
      const tbody = document.getElementById('team-table-body');
      if (!tbody) return;
      
      if (employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No employees found</td></tr>';
        return;
      }
      
      tbody.innerHTML = employees.map(emp => {
        const initials = getInitials(emp.full_name || emp.email);
        const roleBadge = getRoleBadge(emp.role);
        const statusBadge = getStatusBadge(emp.status);
        const avatarUrl = emp.profile_picture || '';
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700 cursor-pointer" data-employee-id="${emp.id}">
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                ${avatarUrl 
                  ? `<img src="${avatarUrl}" alt="${emp.full_name || emp.email}" class="w-8 h-8 rounded-full object-cover">`
                  : `<div class="w-8 h-8 rounded-full bg-nfgblue dark:bg-blue-600 flex items-center justify-center text-white text-xs font-medium">${initials}</div>`
                }
                <div>
                  <div class="font-medium text-gray-900 dark:text-gray-100">${emp.full_name || 'No name'}</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">${emp.email}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3">${roleBadge}</td>
            <td class="px-4 py-3">${statusBadge}</td>
            <td class="px-4 py-3">
              <span class="font-medium text-gray-900 dark:text-gray-100">${emp.jobsAssigned || 0}</span>
            </td>
            <td class="px-4 py-3">
              <span class="font-medium text-green-600 dark:text-green-400">${emp.jobsCompleted || 0}</span>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-900 dark:text-gray-100">${emp.completionRate || 0}%</span>
                <div class="w-16 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div class="h-full bg-green-500 rounded-full" style="width: ${emp.completionRate || 0}%"></div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3">
              ${renderActiveJobsCell(emp)}
            </td>
            <td class="px-4 py-3">
              <span class="font-medium text-gray-900 dark:text-gray-100">${emp.sitesAssigned || 0}</span>
            </td>
            <td class="px-4 py-3">
              <button class="text-nfgblue dark:text-blue-400 hover:underline text-sm" onclick="viewEmployeeDetails('${emp.id}')">
                View
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Recreate icons
      setTimeout(() => {
        if (window.lucide) lucide.createIcons();
      }, 100);
    }
    
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    function getRoleBadge(role) {
      const badges = {
        'admin': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">Admin</span>',
        'super_admin': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">Super Admin</span>',
        'staff': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">Staff</span>',
        'client': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300">Client</span>'
      };
      return badges[role] || '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">' + (role || 'Unknown') + '</span>';
    }
    
    function getStatusBadge(status) {
      const badges = {
        'active': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">Active</span>',
        'pending': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300">Pending</span>',
        'inactive': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">Inactive</span>',
        'suspended': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">Suspended</span>'
      };
      return badges[status] || '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">' + (status || 'Unknown') + '</span>';
    }
    
    function renderActiveJobsCell(emp) {
      const activeCount = emp.activeJobsCount || 0;
      const activeJobs = emp.activeJobs || [];
      
      if (activeCount === 0) {
        return '<span class="text-gray-400 dark:text-gray-500">-</span>';
      }
      
      // Calculate total elapsed time for display
      const totalElapsed = activeJobs.reduce((sum, job) => sum + (job.elapsed_seconds || 0), 0);
      const totalDisplay = formatElapsedTime(totalElapsed);
      
      // Create unique ID for this employee's active jobs row
      const expandId = `active-jobs-${emp.id}`;
      
      return `
        <div class="active-jobs-cell" data-employee-id="${emp.id}">
          <button 
            class="flex items-center gap-2 text-nfgblue dark:text-blue-400 hover:underline text-sm font-medium"
            onclick="toggleActiveJobs('${emp.id}')"
          >
            <span>${activeCount} â±ï¸ ${totalDisplay}</span>
            <i data-lucide="chevron-down" class="w-4 h-4" id="chevron-${emp.id}"></i>
          </button>
          <div id="${expandId}" class="hidden mt-2 ml-4 space-y-2 border-l-2 border-nfgray dark:border-gray-700 pl-4">
            ${activeJobs.map(job => `
              <div class="text-xs">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-medium text-gray-900 dark:text-gray-100">${job.title}</p>
                    <p class="text-gray-500 dark:text-gray-400">${job.site_name}</p>
                  </div>
                  <span class="text-nfgblue dark:text-blue-400 font-mono" data-job-timer="${job.id}" data-start-time="${job.work_started_at}">
                    â±ï¸ ${job.elapsed_display}
                  </span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    function toggleActiveJobs(employeeId) {
      const expandId = `active-jobs-${employeeId}`;
      const expandEl = document.getElementById(expandId);
      const chevronEl = document.getElementById(`chevron-${employeeId}`);
      
      if (expandEl) {
        expandEl.classList.toggle('hidden');
        if (chevronEl && window.lucide) {
          if (expandEl.classList.contains('hidden')) {
            chevronEl.setAttribute('data-lucide', 'chevron-down');
          } else {
            chevronEl.setAttribute('data-lucide', 'chevron-up');
          }
          lucide.createIcons();
        }
      }
    }
    
    function renderCurrentlyWorkingOn(employees) {
      const workingListEl = document.getElementById('currently-working-list');
      const countEl = document.getElementById('active-workers-count');
      
      if (!workingListEl) return;
      
      // Filter employees with active jobs
      const activeEmployees = employees.filter(emp => (emp.activeJobsCount || 0) > 0);
      
      // Update count
      if (countEl) {
        countEl.textContent = `${activeEmployees.length} active`;
      }
      
      if (activeEmployees.length === 0) {
        workingListEl.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-lucide="users" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
            <p>No employees currently working</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }
      
      // Render active workers
      workingListEl.innerHTML = activeEmployees.map(emp => {
        const initials = getInitials(emp.full_name || emp.email);
        const avatarUrl = emp.profile_picture || '';
        const activeJobs = emp.activeJobs || [];
        
        return `
          <div class="border border-nfgray dark:border-gray-700 rounded-xl p-4 hover:bg-nfglight dark:hover:bg-gray-700/50 transition-colors">
            <div class="flex items-start gap-4">
              ${avatarUrl 
                ? `<img src="${avatarUrl}" alt="${emp.full_name || emp.email}" class="w-12 h-12 rounded-full object-cover flex-shrink-0">`
                : `<div class="w-12 h-12 rounded-full bg-nfgblue dark:bg-blue-600 flex items-center justify-center text-white font-medium flex-shrink-0">${initials}</div>`
              }
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">${emp.full_name || emp.email}</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${emp.email}</p>
                
                <div class="space-y-2">
                  ${activeJobs.map(job => `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-3 border border-nfgray dark:border-gray-600">
                      <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                          <p class="font-medium text-sm text-gray-900 dark:text-gray-100 truncate">${job.title}</p>
                          <p class="text-xs text-gray-500 dark:text-gray-400">${job.site_name}</p>
                        </div>
                        <div class="ml-4 flex items-center gap-2">
                          <span class="text-nfgblue dark:text-blue-400 font-mono text-sm font-semibold" data-job-timer="${job.id}" data-start-time="${job.work_started_at}">
                            â±ï¸ ${job.elapsed_display}
                          </span>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Recreate icons
      setTimeout(() => {
        if (window.lucide) lucide.createIcons();
      }, 100);
      
      // Start timer updates
      startActiveJobTimers();
    }
    
    let activeJobTimerInterval = null;
    
    function startActiveJobTimers() {
      // Clear existing interval
      if (activeJobTimerInterval) {
        clearInterval(activeJobTimerInterval);
      }
      
      // Update all active job timers every second
      activeJobTimerInterval = setInterval(() => {
        document.querySelectorAll('[data-job-timer]').forEach(timerEl => {
          const startTime = timerEl.getAttribute('data-start-time');
          if (!startTime) return;
          
          const elapsed = calculateElapsedTime(startTime);
          const formatted = formatElapsedTime(elapsed);
          timerEl.textContent = `â±ï¸ ${formatted}`;
        });
      }, 1000);
    }
    
    function stopActiveJobTimers() {
      if (activeJobTimerInterval) {
        clearInterval(activeJobTimerInterval);
        activeJobTimerInterval = null;
      }
    }
    
    // ========== PHASE 5: SUPABASE REALTIME SYNC ==========
    let jobsRealtimeChannel = null;
    
    function subscribeToJobChanges() {
      // Unsubscribe from existing channel if any
      if (jobsRealtimeChannel) {
        supabase.removeChannel(jobsRealtimeChannel);
      }
      
      // Create new channel for job changes
      jobsRealtimeChannel = supabase
        .channel('team-active-jobs-realtime')
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'jobs',
          filter: 'status=eq.in-progress'
        }, async (payload) => {
          await handleJobUpdate(payload.new);
        })
        .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'jobs'
        }, async (payload) => {
          // Also listen for status changes (job becoming in-progress or completed)
          const oldStatus = payload.old?.status;
          const newStatus = payload.new?.status;
          
          // If status changed to/from in-progress, or work timer started/stopped
          if (oldStatus !== newStatus || 
              payload.old?.work_started_at !== payload.new?.work_started_at ||
              payload.old?.work_ended_at !== payload.new?.work_ended_at) {
            await handleJobUpdate(payload.new);
          }
        })
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'jobs',
          filter: 'status=eq.in-progress'
        }, async (payload) => {
          await handleJobUpdate(payload.new);
        })
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('[Team] Realtime subscription active for job changes');
          } else if (status === 'CHANNEL_ERROR') {
            console.error('[Team] Realtime subscription error');
          }
        });
    }
    
    function unsubscribeFromJobChanges() {
      if (jobsRealtimeChannel) {
        supabase.removeChannel(jobsRealtimeChannel);
        jobsRealtimeChannel = null;
        console.log('[Team] Realtime subscription removed');
      }
    }
    
    async function handleJobUpdate(job) {
      // Only process if job has assigned_worker_id
      if (!job?.assigned_worker_id) return;
      
      // Find the affected employee
      const affectedEmployee = allTeamEmployees.find(emp => emp.id === job.assigned_worker_id);
      if (!affectedEmployee) return;
      
      // Reload team data to get fresh active jobs
      // Use debounce to avoid too many refreshes
      if (!handleJobUpdate.refreshTimer) {
        handleJobUpdate.refreshTimer = setTimeout(async () => {
          await refreshEmployeeActiveJobs(job.assigned_worker_id);
          handleJobUpdate.refreshTimer = null;
        }, 500);
      }
    }
    
    // Debounce timer for refresh
    handleJobUpdate.refreshTimer = null;
    
    async function refreshEmployeeActiveJobs(workerId) {
      try {
        // Fetch fresh active jobs for this worker
        const { data: activeJobs, error } = await supabase
          .from('jobs')
          .select('id, title, assigned_worker_id, status, work_started_at, work_ended_at, total_duration, site_id, sites(name)')
          .eq('assigned_worker_id', workerId)
          .eq('status', 'in-progress')
          .not('work_started_at', 'is', null)
          .is('work_ended_at', null);
        
        if (error) {
          console.error('[Team] Error refreshing active jobs:', error);
          return;
        }
        
        // Update the employee's active jobs
        const employee = allTeamEmployees.find(emp => emp.id === workerId);
        if (!employee) return;
        
        // Calculate elapsed times
        const activeJobsWithTimers = (activeJobs || []).map(job => {
          const startTime = new Date(job.work_started_at);
          const now = new Date();
          const elapsedSeconds = Math.floor((now - startTime) / 1000);
          
          return {
            id: job.id,
            title: job.title || 'Untitled Job',
            site_id: job.site_id,
            site_name: job.sites?.name || 'No site',
            work_started_at: job.work_started_at,
            work_ended_at: job.work_ended_at,
            elapsed_seconds: elapsedSeconds,
            elapsed_display: formatElapsedTime(elapsedSeconds),
            is_active: !job.work_ended_at
          };
        });
        
        // Update employee data
        employee.activeJobs = activeJobsWithTimers;
        employee.activeJobsCount = activeJobsWithTimers.length;
        
        // Refresh the display
        applyTeamFilters();
        renderCurrentlyWorkingOn(allTeamEmployees);
        
        // If modal is open for this employee, refresh it
        const modal = document.getElementById('employee-details-modal');
        if (modal && !modal.classList.contains('hidden')) {
          // Check if modal is showing this employee
          const modalHeader = document.getElementById('employee-modal-header');
          if (modalHeader && employee) {
            // Refresh active work section in modal
            renderEmployeeActiveWork(employee);
          }
        }
        
        console.log('[Team] Updated active jobs for employee:', workerId, activeJobsWithTimers.length);
      } catch (error) {
        console.error('[Team] Error in refreshEmployeeActiveJobs:', error);
      }
    }
    // ========== END PHASE 5 ==========
    
    let teamRoleChart = null;
    
    // Clean up timers when tab changes
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopActiveJobTimers();
        // Keep realtime subscription active in background
      } else {
        // Restart timers when tab becomes visible
        const workingListEl = document.getElementById('currently-working-list');
        if (workingListEl && !workingListEl.querySelector('.text-center')) {
          startActiveJobTimers();
        }
      }
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      unsubscribeFromJobChanges();
      stopActiveJobTimers();
    });
    
    // ========== PHASE 6: ENHANCED EMPLOYEE DETAILS MODAL ==========
    let modalTimerInterval = null;
    
    function renderEmployeeActiveWork(employee) {
      const activeJobsEl = document.getElementById('emp-detail-active-jobs');
      if (!activeJobsEl) return;
      
      const activeJobs = employee.activeJobs || [];
      
      if (activeJobs.length === 0) {
        activeJobsEl.innerHTML = `
          <div class="text-center py-6 text-gray-500 dark:text-gray-400 bg-nfglight dark:bg-gray-700 rounded-xl">
            <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">No active work</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        
        // Stop modal timers if no active jobs
        stopModalTimers();
        return;
      }
      
      // Get current user role to check if they can end work
      const canEndWork = currentUserProfile && (currentUserProfile.role === 'admin' || currentUserProfile.role === 'super_admin');
      
      activeJobsEl.innerHTML = activeJobs.map(job => `
        <div class="bg-nfglight dark:bg-gray-700 rounded-xl p-4 border border-nfgray dark:border-gray-600">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-1">${job.title}</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                ${job.site_name}
              </p>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <i data-lucide="clock" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
                  <span class="text-nfgblue dark:text-blue-400 font-mono text-sm font-semibold" 
                        data-modal-job-timer="${job.id}" 
                        data-modal-start-time="${job.work_started_at}">
                    â±ï¸ ${job.elapsed_display}
                  </span>
                </div>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">
                  In Progress
                </span>
              </div>
            </div>
            <div class="flex flex-col gap-2">
              <button 
                onclick="viewJobFromModal('${job.id}')"
                class="px-3 py-1.5 rounded-lg bg-nfgblue text-white hover:bg-nfgdark text-xs flex items-center gap-2 transition-colors"
                title="View Job Details"
              >
                <i data-lucide="eye" class="w-3 h-3"></i>
                View Job
              </button>
              ${canEndWork ? `
                <button 
                  onclick="endWorkFromModal('${job.id}', '${employee.id}')"
                  class="px-3 py-1.5 rounded-lg border border-orange-300 dark:border-orange-700 text-orange-600 dark:text-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/20 text-xs flex items-center gap-2 transition-colors"
                  title="End Work (Admin Only)"
                >
                  <i data-lucide="square" class="w-3 h-3"></i>
                  End Work
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
      
      // Recreate icons
      if (window.lucide) lucide.createIcons();
      
      // Start modal timer updates
      startModalTimers();
    }
    
    function startModalTimers() {
      // Clear existing interval
      if (modalTimerInterval) {
        clearInterval(modalTimerInterval);
      }
      
      // Update all modal job timers every second
      modalTimerInterval = setInterval(() => {
        document.querySelectorAll('[data-modal-job-timer]').forEach(timerEl => {
          const startTime = timerEl.getAttribute('data-modal-start-time');
          if (!startTime) return;
          
          const elapsed = calculateElapsedTime(startTime);
          const formatted = formatElapsedTime(elapsed);
          timerEl.textContent = `â±ï¸ ${formatted}`;
        });
      }, 1000);
    }
    
    function stopModalTimers() {
      if (modalTimerInterval) {
        clearInterval(modalTimerInterval);
        modalTimerInterval = null;
      }
    }
    
    // Global functions for modal actions (called from onclick)
    window.viewJobFromModal = async function(jobId) {
      // Navigate to jobs page and open the job
      window.location.href = `jobs.html?job=${jobId}`;
    };
    
    window.endWorkFromModal = async function(jobId, employeeId) {
      if (!confirm('Are you sure you want to end work on this job? This will stop the timer.')) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('jobs')
          .update({
            work_ended_at: new Date().toISOString(),
            status: 'completed'
          })
          .eq('id', jobId);
        
        if (error) throw error;
        
        // Refresh employee data and active work
        const employee = allTeamEmployees.find(emp => emp.id === employeeId);
        if (employee) {
          await refreshEmployeeActiveJobs(employeeId);
          renderEmployeeActiveWork(employee);
        }
        
        // Show success message
        alert('Work ended successfully');
      } catch (error) {
        console.error('[Team] Error ending work:', error);
        alert('Failed to end work. Please try again.');
      }
    };
    // ========== END PHASE 6 ==========
    
    // Make viewEmployeeDetails globally accessible for onclick handlers
    window.viewEmployeeDetails = async function(employeeId) {
      try {
        const employee = allTeamEmployees.find(emp => emp.id === employeeId);
        if (!employee) {
          console.error('[Team] Employee not found:', employeeId);
          return;
        }
        
        // Populate modal header
        const headerEl = document.getElementById('employee-modal-header');
        const initials = getInitials(employee.full_name || employee.email);
        const avatarUrl = employee.profile_picture || '';
        
        headerEl.innerHTML = `
          ${avatarUrl 
            ? `<img src="${avatarUrl}" alt="${employee.full_name || employee.email}" class="w-16 h-16 rounded-full object-cover">`
            : `<div class="w-16 h-16 rounded-full bg-nfgblue dark:bg-blue-600 flex items-center justify-center text-white text-xl font-medium">${initials}</div>`
          }
          <div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">${employee.full_name || 'No name'}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400">${employee.email}</p>
          </div>
        `;
        
        // Update statistics
        document.getElementById('emp-detail-jobs-assigned').textContent = employee.jobsAssigned || 0;
        document.getElementById('emp-detail-jobs-completed').textContent = employee.jobsCompleted || 0;
        document.getElementById('emp-detail-completion-rate').textContent = (employee.completionRate || 0) + '%';
        document.getElementById('emp-detail-sites').textContent = employee.sitesAssigned || 0;
        
        // Update contact info
        document.getElementById('emp-detail-email').textContent = employee.email || 'No email';
        document.getElementById('emp-detail-phone').textContent = employee.phone || 'No phone number';
        
        // Update role and status badges
        document.getElementById('emp-detail-role-badge').innerHTML = getRoleBadge(employee.role);
        document.getElementById('emp-detail-status-badge').innerHTML = getStatusBadge(employee.status);
        
        // Render active work section
        renderEmployeeActiveWork(employee);
        
        // Fetch recent jobs
        const { data: recentJobs, error: jobsError } = await supabase
          .from('jobs')
          .select('id, title, status, created_at, sites(name)')
          .eq('assigned_worker_id', employeeId)
          .order('created_at', { ascending: false })
          .limit(5);
        
        const recentJobsEl = document.getElementById('emp-detail-recent-jobs');
        if (recentJobs && recentJobs.length > 0) {
          recentJobsEl.innerHTML = recentJobs.map(job => `
            <div class="flex items-center justify-between p-3 bg-nfglight dark:bg-gray-700 rounded-lg">
              <div>
                <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${job.title || 'Untitled Job'}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">${job.sites?.name || 'No site'} â€¢ ${new Date(job.created_at).toLocaleDateString()}</p>
              </div>
              <span class="px-2 py-1 text-xs font-medium rounded-full ${getJobStatusBadgeClass(job.status)}">${job.status || 'pending'}</span>
            </div>
          `).join('');
        } else {
          recentJobsEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No recent jobs</p>';
        }
        
        // Set up action buttons
        const messageBtn = document.getElementById('emp-detail-message-btn');
        const profileBtn = document.getElementById('emp-detail-view-profile-btn');
        
        messageBtn.onclick = () => {
          window.location.href = `messages.html?user=${employeeId}`;
        };
        
        profileBtn.onclick = () => {
          window.location.href = `settings.html#user-${employeeId}`;
        };
        
        // Show modal
        document.getElementById('employee-details-modal').classList.remove('hidden');
        document.getElementById('employee-details-modal').classList.add('flex');
        
        // Close button handler
        const closeModal = () => {
          stopModalTimers();
          document.getElementById('employee-details-modal').classList.add('hidden');
          document.getElementById('employee-details-modal').classList.remove('flex');
        };
        
        document.getElementById('close-employee-modal').onclick = closeModal;
        
        // Also close when clicking backdrop (outside modal content)
        const modal = document.getElementById('employee-details-modal');
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeModal();
          }
        };
        
        // Recreate icons
        setTimeout(() => {
          if (window.lucide) lucide.createIcons();
        }, 100);
        
      } catch (error) {
        console.error('[Team] Error loading employee details:', error);
      }
    }
    
    function getJobStatusBadgeClass(status) {
      const classes = {
        'completed': 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300',
        'in-progress': 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300',
        'pending': 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300',
        'cancelled': 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
      };
      return classes[status] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
    }
    
    function updateTopPerformers(employees) {
      if (!employees || employees.length === 0) return;
      
      // Most jobs completed
      const mostJobs = employees.reduce((max, emp) => 
        (emp.jobsCompleted || 0) > (max.jobsCompleted || 0) ? emp : max, employees[0]);
      document.getElementById('top-performer-jobs').textContent = mostJobs.full_name || mostJobs.email || 'N/A';
      document.getElementById('top-performer-jobs-count').textContent = `${mostJobs.jobsCompleted || 0} jobs completed`;
      
      // Most active (most recent jobs)
      const mostActive = employees.reduce((max, emp) => 
        (emp.jobsAssigned || 0) > (max.jobsAssigned || 0) ? emp : max, employees[0]);
      document.getElementById('top-performer-active').textContent = mostActive.full_name || mostActive.email || 'N/A';
      document.getElementById('top-performer-active-info').textContent = `${mostActive.jobsAssigned || 0} jobs assigned`;
      
      // Most sites
      const mostSites = employees.reduce((max, emp) => 
        (emp.sitesAssigned || 0) > (max.sitesAssigned || 0) ? emp : max, employees[0]);
      document.getElementById('top-performer-sites').textContent = mostSites.full_name || mostSites.email || 'N/A';
      document.getElementById('top-performer-sites-count').textContent = `${mostSites.sitesAssigned || 0} sites`;
      
      // Best completion rate (with at least 5 jobs)
      const withJobs = employees.filter(emp => (emp.jobsAssigned || 0) >= 5);
      if (withJobs.length > 0) {
        const bestRate = withJobs.reduce((max, emp) => 
          (emp.completionRate || 0) > (max.completionRate || 0) ? emp : max, withJobs[0]);
        document.getElementById('top-performer-rate').textContent = bestRate.full_name || bestRate.email || 'N/A';
        document.getElementById('top-performer-rate-percent').textContent = `${bestRate.completionRate || 0}% completion rate`;
      } else {
        document.getElementById('top-performer-rate').textContent = 'N/A';
        document.getElementById('top-performer-rate-percent').textContent = 'Need 5+ jobs';
      }
    }
    
    function renderTeamCharts(employees) {
      // Role Distribution Chart
      const roleCtx = document.getElementById('team-role-chart');
      if (roleCtx && employees.length > 0) {
        const roleCounts = {
          admin: employees.filter(emp => emp.role === 'admin' || emp.role === 'super_admin').length,
          staff: employees.filter(emp => emp.role === 'staff').length,
          client: employees.filter(emp => emp.role === 'client').length
        };
        
        if (teamRoleChart) {
          teamRoleChart.destroy();
        }
        
        const isDark = document.documentElement.classList.contains('dark');
        const colors = {
          text: isDark ? '#E5E7EB' : '#1F2937',
          tooltipBg: isDark ? '#1F2937' : '#FFFFFF',
          tooltipBorder: isDark ? '#374151' : '#E5E7EB'
        };
        
        teamRoleChart = new Chart(roleCtx, {
          type: 'doughnut',
          data: {
            labels: ['Admin', 'Staff', 'Client'],
            datasets: [{
              data: [roleCounts.admin, roleCounts.staff, roleCounts.client],
              backgroundColor: [
                'rgba(13, 71, 161, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(99, 102, 241, 0.8)'
              ],
              borderColor: [
                '#0D47A1',
                '#22C55E',
                '#6366F1'
              ],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: colors.text }
              },
              tooltip: {
                backgroundColor: colors.tooltipBg,
                borderColor: colors.tooltipBorder,
                borderWidth: 1,
                titleColor: colors.text,
                bodyColor: colors.text
              }
            }
          }
        });
      }
    }
    
    // Initialize team filters and sorting
    function initTeamFilters() {
      const searchInput = document.getElementById('team-search');
      const roleFilter = document.getElementById('team-role-filter');
      const statusFilter = document.getElementById('team-status-filter');
      const clearBtn = document.getElementById('team-clear-filters');
      const exportBtn = document.getElementById('team-export-btn');
      
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          teamFilters.search = e.target.value;
          applyTeamFilters();
        });
      }
      
      if (roleFilter) {
        roleFilter.addEventListener('change', (e) => {
          teamFilters.role = e.target.value;
          applyTeamFilters();
        });
      }
      
      if (statusFilter) {
        statusFilter.addEventListener('change', (e) => {
          teamFilters.status = e.target.value;
          applyTeamFilters();
        });
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          teamFilters = { search: '', role: '', status: '' };
          if (searchInput) searchInput.value = '';
          if (roleFilter) roleFilter.value = '';
          if (statusFilter) statusFilter.value = '';
          applyTeamFilters();
        });
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          exportTeamToCSV();
        });
      }
      
      // Table header sorting
      document.querySelectorAll('[data-sort]').forEach(header => {
        header.addEventListener('click', () => {
          const column = header.dataset.sort;
          if (teamSortColumn === column) {
            teamSortDirection = teamSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            teamSortColumn = column;
            teamSortDirection = 'asc';
          }
          applyTeamFilters();
        });
      });
    }
    
    function exportTeamToCSV() {
      const filtered = allTeamEmployees.filter(emp => {
        if (teamFilters.search) {
          const searchLower = teamFilters.search.toLowerCase();
          if (!emp.full_name?.toLowerCase().includes(searchLower) && 
              !emp.email?.toLowerCase().includes(searchLower)) {
            return false;
          }
        }
        if (teamFilters.role && emp.role !== teamFilters.role) return false;
        if (teamFilters.status && emp.status !== teamFilters.status) return false;
        return true;
      });
      
      const headers = ['Name', 'Email', 'Role', 'Status', 'Jobs Assigned', 'Jobs Completed', 'Completion Rate', 'Sites Assigned'];
      const rows = filtered.map(emp => [
        emp.full_name || '',
        emp.email || '',
        emp.role || '',
        emp.status || '',
        emp.jobsAssigned || 0,
        emp.jobsCompleted || 0,
        (emp.completionRate || 0) + '%',
        emp.sitesAssigned || 0
      ]);
      
      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `team-report-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    async function loadExpensesData(showToast = false) {
      try {
        const tbody = document.getElementById('expenses-table-body');
        if (!tbody) return;

        // Show loading state
        tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading expenses...</td></tr>';

        // Fetch expenses with related data
        let query = supabase
          .from('expenses')
          .select('*, jobs(title), sites(name)')
          .order('expense_date', { ascending: false })
          .order('created_at', { ascending: false });

        // Apply filters
        if (currentExpenseFilters.category) {
          query = query.eq('category', currentExpenseFilters.category);
        }
        if (currentExpenseFilters.job) {
          query = query.eq('job_id', currentExpenseFilters.job);
        }
        if (currentExpenseFilters.site) {
          const siteIdNum = typeof currentExpenseFilters.site === 'string' ? parseInt(currentExpenseFilters.site, 10) : currentExpenseFilters.site;
          query = query.eq('site_id', siteIdNum);
        }
        if (currentExpenseFilters.dateFrom) {
          query = query.gte('expense_date', currentExpenseFilters.dateFrom);
        }
        if (currentExpenseFilters.dateTo) {
          query = query.lte('expense_date', currentExpenseFilters.dateTo);
        }

        const { data: expenses, error } = await query;

        if (error) {
          console.error('[Expenses] Error loading expenses:', error);
          if (error.code === 'PGRST204') {
            // Table doesn't exist yet
            tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Expenses table not found. Please run the SQL migration.</td></tr>';
            return;
          }
          throw error;
        }

        allExpenses = expenses || [];

        // Apply search filter (client-side)
        let filteredExpenses = allExpenses;
        if (currentExpenseFilters.search) {
          const searchLower = currentExpenseFilters.search.toLowerCase();
          filteredExpenses = allExpenses.filter(exp => 
            exp.description?.toLowerCase().includes(searchLower) ||
            exp.vendor_name?.toLowerCase().includes(searchLower) ||
            exp.notes?.toLowerCase().includes(searchLower) ||
            exp.category?.toLowerCase().includes(searchLower)
          );
        }

        // Update summary cards
        updateExpenseSummaryCards(filteredExpenses);

        // Render table
        renderExpensesTable(filteredExpenses);

        // Populate filter dropdowns
        populateExpenseFilters();

        if (showToast) {
          toast.success(`Loaded ${filteredExpenses.length} expense${filteredExpenses.length !== 1 ? 's' : ''}`, 'Expenses Loaded');
        }
      } catch (error) {
        console.error('[Expenses] Error loading expenses:', error);
        const tbody = document.getElementById('expenses-table-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-red-600 dark:text-red-400">Error loading expenses. Please try again.</td></tr>';
        }
        toast.error('Failed to load expenses', 'Error');
      }
    }

    // Update expense summary cards
    function updateExpenseSummaryCards(expenses) {
      const total = expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
      
      // This month
      const now = new Date();
      const thisMonth = expenses.filter(exp => {
        const expDate = new Date(exp.expense_date);
        return expDate.getMonth() === now.getMonth() && 
               expDate.getFullYear() === now.getFullYear();
      });
      const monthTotal = thisMonth.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);

      // Top category
      const categoryTotals = {};
      expenses.forEach(exp => {
        const cat = exp.category || 'other';
        categoryTotals[cat] = (categoryTotals[cat] || 0) + parseFloat(exp.amount || 0);
      });
      const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
      const topCategoryName = topCategory ? topCategory[0].charAt(0).toUpperCase() + topCategory[0].slice(1) : 'â€”';

      // Average per job
      const jobExpenses = expenses.filter(exp => exp.job_id);
      const jobTotal = jobExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
      const avgPerJob = jobExpenses.length > 0 ? jobTotal / jobExpenses.length : 0;

      // Update UI
      document.getElementById('expenses-total').textContent = `$${total.toFixed(2)}`;
      document.getElementById('expenses-month').textContent = `$${monthTotal.toFixed(2)}`;
      document.getElementById('expenses-top-category').textContent = topCategoryName;
      document.getElementById('expenses-avg-job').textContent = `$${avgPerJob.toFixed(2)}`;
    }

    // Render expenses table
    function renderExpensesTable(expenses) {
      const tbody = document.getElementById('expenses-table-body');
      if (!tbody) return;

      if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No expenses found</td></tr>';
        return;
      }

      tbody.innerHTML = expenses.map(exp => {
        const date = exp.expense_date ? new Date(exp.expense_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'â€”';
        const category = exp.category ? exp.category.charAt(0).toUpperCase() + exp.category.slice(1) : 'â€”';
        const amount = parseFloat(exp.amount || 0).toFixed(2);
        const jobTitle = exp.jobs?.title || 'â€”';
        const siteName = exp.sites?.name || 'â€”';
        const vendor = exp.vendor_name || 'â€”';
        const hasReceipt = exp.receipt_emailed_at ? 'Yes' : 'No';
        const receiptBadge = exp.receipt_emailed_at 
          ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">Emailed</span>'
          : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">No Receipt</span>';

        return `
          <tr class="hover:bg-nfglight/30 dark:hover:bg-gray-700/30">
            <td class="px-4 py-3">${date}</td>
            <td class="px-4 py-3 font-medium">${escapeHtml(exp.description || 'â€”')}</td>
            <td class="px-4 py-3">${category}</td>
            <td class="px-4 py-3 font-semibold text-red-600 dark:text-red-400">$${amount}</td>
            <td class="px-4 py-3">${escapeHtml(jobTitle)}</td>
            <td class="px-4 py-3">${escapeHtml(siteName)}</td>
            <td class="px-4 py-3">${escapeHtml(vendor)}</td>
            <td class="px-4 py-3">${receiptBadge}</td>
            <td class="px-4 py-3">
              <button onclick="viewExpense('${exp.id}')" class="text-nfgblue dark:text-blue-400 hover:underline text-sm">View</button>
            </td>
          </tr>
        `;
      }).join('');

      // Recreate icons
      if (window.lucide) lucide.createIcons();
    }

    // Populate expense filter dropdowns
    async function populateExpenseFilters() {
      // Populate jobs filter
      const jobFilter = document.getElementById('expense-job-filter');
      if (jobFilter && allExpenses.length > 0) {
        const jobIds = [...new Set(allExpenses.map(exp => exp.job_id).filter(Boolean))];
        const { data: jobs } = await supabase
          .from('jobs')
          .select('id, title')
          .in('id', jobIds);
        
        if (jobs) {
          const currentValue = jobFilter.value;
          jobFilter.innerHTML = '<option value="">All Jobs</option>';
          jobs.forEach(job => {
            const option = document.createElement('option');
            option.value = job.id;
            option.textContent = job.title;
            if (job.id === currentValue) option.selected = true;
            jobFilter.appendChild(option);
          });
        }
      }

      // Populate sites filter
      const siteFilter = document.getElementById('expense-site-filter');
      if (siteFilter && allExpenses.length > 0) {
        const siteIds = [...new Set(allExpenses.map(exp => exp.site_id).filter(Boolean))];
        const { data: sites } = await supabase
          .from('sites')
          .select('id, name')
          .in('id', siteIds);
        
        if (sites) {
          const currentValue = siteFilter.value;
          siteFilter.innerHTML = '<option value="">All Sites</option>';
          sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.name;
            if (site.id === currentValue) option.selected = true;
            siteFilter.appendChild(option);
          });
        }
      }
    }

    // Helper to escape HTML
    function escapeHtml(text) {
      if (!text) return 'â€”';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // View expense detail
    window.viewExpense = async function(expenseId) {
      try {
        const modal = document.getElementById('expense-detail-modal');
        if (!modal) {
          console.error('[Expenses] Expense detail modal not found');
          return;
        }

        // Show loading state (don't replace content, just show modal)
        // The modal structure stays intact so we can populate it

        // Fetch expense with related data
        let { data: expense, error: expenseError } = await supabase
          .from('expenses')
          .select('*, jobs(title, status), sites(name)')
          .eq('id', expenseId)
          .single();

        if (expenseError || !expense) {
          console.error('[Expenses] Error loading expense:', expenseError);
          toast.error('Failed to load expense details', 'Error');
          return;
        }

        // Fetch creator profile separately (if created_by exists)
        if (expense.created_by) {
          const { data: creator } = await supabase
            .from('user_profiles')
            .select('full_name, email')
            .eq('id', expense.created_by)
            .single();
          expense.user_profiles = creator;
        }

        // Populate modal (with null checks)
        const descEl = document.getElementById('expense-detail-description');
        if (descEl) descEl.textContent = expense.description || 'â€”';
        
        const amountEl = document.getElementById('expense-detail-amount');
        if (amountEl) amountEl.textContent = `$${Number(expense.amount || 0).toFixed(2)}`;
        
        // Category badge
        const categoryEl = document.getElementById('expense-detail-category');
        if (categoryEl) {
          const category = expense.category || 'other';
          const categoryLabels = {
            'supplies': 'Supplies',
            'equipment': 'Equipment',
            'travel': 'Travel',
            'labor': 'Labor',
            'other': 'Other'
          };
          categoryEl.textContent = categoryLabels[category] || category.charAt(0).toUpperCase() + category.slice(1);
        }
        
        // Date
        const dateEl = document.getElementById('expense-detail-date');
        if (dateEl) {
          dateEl.textContent = expense.expense_date 
            ? new Date(expense.expense_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
            : 'â€”';
        }

        // Job
        const jobEl = document.getElementById('expense-detail-job');
        if (jobEl) {
          if (expense.jobs) {
            jobEl.innerHTML = `
              <a href="jobs.html" class="text-nfgblue dark:text-blue-400 hover:underline">${escapeHtml(expense.jobs.title)}</a>
              <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">(${expense.jobs.status || 'N/A'})</span>
            `;
          } else {
            jobEl.textContent = 'â€”';
          }
        }

        // Site
        const siteEl = document.getElementById('expense-detail-site');
        if (siteEl) {
          if (expense.sites) {
            siteEl.innerHTML = `<a href="sites.html" class="text-nfgblue dark:text-blue-400 hover:underline">${escapeHtml(expense.sites.name)}</a>`;
          } else {
            siteEl.textContent = 'â€”';
          }
        }

        // Vendor
        const vendorEl = document.getElementById('expense-detail-vendor');
        if (vendorEl) vendorEl.textContent = expense.vendor_name || 'â€”';

        // Notes
        const notesEl = document.getElementById('expense-detail-notes');
        if (notesEl) {
          if (expense.notes) {
            notesEl.textContent = expense.notes;
            notesEl.classList.remove('text-gray-400', 'dark:text-gray-500');
          } else {
            notesEl.textContent = 'No notes';
            notesEl.classList.add('text-gray-400', 'dark:text-gray-500');
          }
        }

        // Receipt status
        const receiptEl = document.getElementById('expense-detail-receipt');
        if (receiptEl) {
          if (expense.receipt_emailed_at) {
            receiptEl.innerHTML = `
              <span class="px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 font-medium">
                <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>
                Receipt Emailed
              </span>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                ${new Date(expense.receipt_emailed_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
              </p>
            `;
          } else {
            receiptEl.innerHTML = `
              <span class="px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 font-medium">
                <i data-lucide="x-circle" class="w-3 h-3 inline mr-1"></i>
                No Receipt
              </span>
            `;
          }
        }

        // Created by
        const createdByEl = document.getElementById('expense-detail-created-by');
        if (createdByEl) {
          if (expense.user_profiles) {
            createdByEl.textContent = expense.user_profiles.full_name || expense.user_profiles.email || 'Unknown';
          } else {
            createdByEl.textContent = 'â€”';
          }
        }

        // Created at
        const createdAtEl = document.getElementById('expense-detail-created-at');
        if (createdAtEl) {
          createdAtEl.textContent = expense.created_at
            ? new Date(expense.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
            : 'â€”';
        }

        // Store current expense for email functionality
        window.currentExpenseForEmail = expense;

        // Attach email button handler
        const emailBtn = document.getElementById('expense-email-to-btn');
        if (emailBtn) {
          // Remove old listeners by cloning
          const newBtn = emailBtn.cloneNode(true);
          emailBtn.parentNode.replaceChild(newBtn, emailBtn);
          newBtn.onclick = () => openEmailExpenseModal(expense);
        }

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (window.lucide) lucide.createIcons();

      } catch (error) {
        console.error('[Expenses] Error viewing expense:', error);
        toast.error('Failed to load expense details', 'Error');
      }
    };

    // Email expense to users
    let selectedUsersForEmail = new Set();
    let allUsersForEmail = [];

    async function openEmailExpenseModal(expense) {
      try {
        const modal = document.getElementById('email-expense-modal');
        if (!modal) {
          console.error('[Expenses] Email modal not found');
          return;
        }

        // Reset selection
        selectedUsersForEmail.clear();
        allUsersForEmail = [];

        // Show loading
        const usersList = document.getElementById('expense-email-users-list');
        if (usersList) {
          usersList.innerHTML = '<div class="p-3 text-center text-gray-500 dark:text-gray-400">Loading users...</div>';
        }

        // Fetch all users
        const { data: users, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email, role')
          .order('full_name', { ascending: true });

        if (error) {
          console.error('[Expenses] Error loading users:', error);
          if (usersList) {
            usersList.innerHTML = '<div class="p-3 text-center text-red-600 dark:text-red-400">Error loading users</div>';
          }
          return;
        }

        allUsersForEmail = users || [];
        renderEmailUserList();

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (window.lucide) lucide.createIcons();

      } catch (error) {
        console.error('[Expenses] Error opening email modal:', error);
        toast.error('Failed to open email modal', 'Error');
      }
    }

    function renderEmailUserList() {
      const usersList = document.getElementById('expense-email-users-list');
      if (!usersList) return;

      if (allUsersForEmail.length === 0) {
        usersList.innerHTML = '<div class="p-3 text-center text-gray-500 dark:text-gray-400">No users found</div>';
        return;
      }

      usersList.innerHTML = allUsersForEmail.map(user => {
        const isSelected = selectedUsersForEmail.has(user.id);
        return `
          <label class="flex items-center gap-3 p-3 rounded-lg border border-nfgray dark:border-gray-600 hover:bg-nfglight/30 dark:hover:bg-gray-700/30 cursor-pointer transition ${isSelected ? 'bg-nfglight dark:bg-gray-700 border-nfgblue dark:border-blue-400' : ''}">
            <input 
              type="checkbox" 
              value="${user.id}" 
              ${isSelected ? 'checked' : ''}
              class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue"
              onchange="toggleExpenseEmailUser('${user.id}', this.checked)"
            />
            <div class="flex-1 min-w-0">
              <p class="font-medium text-gray-900 dark:text-white">${escapeHtml(user.full_name || user.email || 'Unknown')}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(user.email || '')}</p>
              ${user.role ? `<span class="inline-block mt-1 px-2 py-0.5 text-xs rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">${user.role}</span>` : ''}
            </div>
          </label>
        `;
      }).join('');

      updateEmailSelectedCount();
    }

    window.toggleExpenseEmailUser = function(userId, isSelected) {
      if (isSelected) {
        selectedUsersForEmail.add(userId);
      } else {
        selectedUsersForEmail.delete(userId);
      }
      renderEmailUserList();
      updateEmailSelectedCount();
    }

    function updateEmailSelectedCount() {
      const count = selectedUsersForEmail.size;
      const countEl = document.getElementById('expense-email-selected-count');
      const countText = document.getElementById('expense-email-count');
      const sendBtn = document.getElementById('expense-email-send-btn');

      if (countEl && countText) {
        countText.textContent = count;
        if (count > 0) {
          countEl.classList.remove('hidden');
        } else {
          countEl.classList.add('hidden');
        }
      }

      if (sendBtn) {
        sendBtn.disabled = count === 0;
      }
    }

    // Send expense email to selected users
    document.getElementById('expense-email-send-btn')?.addEventListener('click', async () => {
      const expense = window.currentExpenseForEmail;
      if (!expense) {
        toast.error('Expense data not found', 'Error');
        return;
      }

      if (selectedUsersForEmail.size === 0) {
        toast.warning('Please select at least one user', 'No Selection');
        return;
      }

      const sendBtn = document.getElementById('expense-email-send-btn');
      const errorDiv = document.getElementById('expense-email-error');
      const originalText = sendBtn.innerHTML;

      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-1 animate-spin"></i> Sending...';
      if (window.lucide) lucide.createIcons();
      if (errorDiv) errorDiv.classList.add('hidden');

      try {
        // Get selected users
        const selectedUserIds = Array.from(selectedUsersForEmail);
        const selectedUsers = allUsersForEmail.filter(u => selectedUserIds.includes(u.id));

        // Prepare expense data for email
        const expenseDataForEmail = {
          description: expense.description,
          amount: expense.amount,
          category: expense.category,
          expense_date: expense.expense_date,
          vendor_name: expense.vendor_name,
          notes: expense.notes,
          job_title: expense.jobs?.title,
          site_name: expense.sites?.name
        };

        // Send email to each selected user
        let successCount = 0;
        let failCount = 0;

        for (const user of selectedUsers) {
          try {
            // Note: We don't have the receipt file, so sending without attachment
            await sendExpenseReceiptEmail(
              expense.id,
              expenseDataForEmail,
              null, // No receipt file available
              user.email,
              user.full_name || user.email
            );
            successCount++;
          } catch (emailError) {
            console.error(`[Expenses] Error sending email to ${user.email}:`, emailError);
            failCount++;
          }
        }

        // Show results
        if (successCount > 0 && failCount === 0) {
          toast.success(`Expense receipt sent to ${successCount} user(s)`, 'Email Sent');
          document.getElementById('email-expense-modal').classList.add('hidden');
          document.getElementById('email-expense-modal').classList.remove('flex');
        } else if (successCount > 0 && failCount > 0) {
          toast.warning(`Sent to ${successCount} user(s), failed for ${failCount} user(s)`, 'Partial Success');
        } else {
          toast.error('Failed to send emails', 'Error');
          if (errorDiv) {
            errorDiv.textContent = 'Failed to send emails. Please try again.';
            errorDiv.classList.remove('hidden');
          }
        }

      } catch (error) {
        console.error('[Expenses] Error sending expense emails:', error);
        toast.error('Failed to send emails', 'Error');
        if (errorDiv) {
          errorDiv.textContent = error.message || 'Failed to send emails. Please try again.';
          errorDiv.classList.remove('hidden');
        }
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
        if (window.lucide) lucide.createIcons();
      }
    });

    // Attach expense filter listeners
    document.getElementById('apply-expense-filters')?.addEventListener('click', () => {
      currentExpenseFilters.category = document.getElementById('expense-category-filter')?.value || '';
      currentExpenseFilters.job = document.getElementById('expense-job-filter')?.value || '';
      currentExpenseFilters.site = document.getElementById('expense-site-filter')?.value || '';
      currentExpenseFilters.dateFrom = document.getElementById('expense-date-from')?.value || '';
      currentExpenseFilters.dateTo = document.getElementById('expense-date-to')?.value || '';
      currentExpenseFilters.search = document.getElementById('expense-search')?.value || '';
      loadExpensesData();
    });

    document.getElementById('clear-expense-filters')?.addEventListener('click', () => {
      currentExpenseFilters = {
        category: '',
        job: '',
        site: '',
        dateFrom: '',
        dateTo: '',
        search: ''
      };
      document.getElementById('expense-category-filter').value = '';
      document.getElementById('expense-job-filter').value = '';
      document.getElementById('expense-site-filter').value = '';
      document.getElementById('expense-date-from').value = '';
      document.getElementById('expense-date-to').value = '';
      document.getElementById('expense-search').value = '';
      loadExpensesData();
    });

    // Export expenses
    document.getElementById('export-expenses-btn')?.addEventListener('click', () => {
      if (allExpenses.length === 0) {
        toast.warning('No expenses to export', 'Export');
        return;
      }

      const csv = [
        ['Date', 'Description', 'Category', 'Amount', 'Job', 'Site', 'Vendor', 'Notes'].join(','),
        ...allExpenses.map(exp => [
          exp.expense_date || '',
          `"${(exp.description || '').replace(/"/g, '""')}"`,
          exp.category || '',
          exp.amount || 0,
          exp.jobs?.title || '',
          exp.sites?.name || '',
          `"${(exp.vendor_name || '').replace(/"/g, '""')}"`,
          `"${(exp.notes || '').replace(/"/g, '""')}"`
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `expenses-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast.success('Expenses exported to CSV', 'Export');
    });

    // Load billing summary metrics
    async function loadBillingSummary() {
      try {
        const { data: invoices, error } = await supabase
          .from('invoices')
          .select('total_amount, paid_amount, status, issue_date, due_date');

        if (error) {
          console.error('[Billing] Error loading invoices for summary:', error);
          // Table might not exist yet, show zeros
          updateBillingSummaryUI({
            totalRevenue: 0,
            outstanding: 0,
            overdueCount: 0,
            monthRevenue: 0
          });
          return;
        }

        const totalRevenue = invoices
          .filter(inv => inv.status === 'paid')
          .reduce((sum, inv) => sum + parseFloat(inv.paid_amount || 0), 0);

        const outstanding = invoices
          .filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled')
          .reduce((sum, inv) => sum + (parseFloat(inv.total_amount || 0) - parseFloat(inv.paid_amount || 0)), 0);

        const overdueCount = invoices.filter(inv => 
          inv.status !== 'paid' && 
          inv.status !== 'cancelled' &&
          new Date(inv.due_date) < new Date()
        ).length;

        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();
        const monthRevenue = invoices
          .filter(inv => {
            const date = new Date(inv.issue_date);
            return inv.status === 'paid' && 
                   date.getMonth() === thisMonth && 
                   date.getFullYear() === thisYear;
          })
          .reduce((sum, inv) => sum + parseFloat(inv.paid_amount || 0), 0);

        updateBillingSummaryUI({
          totalRevenue,
          outstanding,
          overdueCount,
          monthRevenue
        });

      } catch (error) {
        console.error('[Billing] Error loading billing summary:', error);
        updateBillingSummaryUI({
          totalRevenue: 0,
          outstanding: 0,
          overdueCount: 0,
          monthRevenue: 0
        });
      }
    }
    
    // Update billing summary UI
    function updateBillingSummaryUI({ totalRevenue, outstanding, overdueCount, monthRevenue }) {
      const formatCurrency = (amount) => {
        return `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      };

      const totalRevenueEl = document.getElementById('billing-total-revenue');
      const outstandingEl = document.getElementById('billing-outstanding');
      const overdueCountEl = document.getElementById('billing-overdue-count');
      const monthRevenueEl = document.getElementById('billing-month-revenue');

      if (totalRevenueEl) totalRevenueEl.textContent = formatCurrency(totalRevenue);
      if (outstandingEl) outstandingEl.textContent = formatCurrency(outstanding);
      if (overdueCountEl) overdueCountEl.textContent = overdueCount.toString();
      if (monthRevenueEl) monthRevenueEl.textContent = formatCurrency(monthRevenue);
    }
    
    // Load invoices
    async function loadInvoices() {
      try {
        const statusFilter = document.getElementById('invoice-status-filter')?.value || '';
        const clientFilter = document.getElementById('invoice-client-filter')?.value || '';
        const dateFrom = document.getElementById('invoice-date-from')?.value || '';
        const dateTo = document.getElementById('invoice-date-to')?.value || '';

        // Fetch invoices first (without relationships to avoid PostgREST errors)
        let query = supabase
          .from('invoices')
          .select('*')
          .order('created_at', { ascending: false });

        if (statusFilter) query = query.eq('status', statusFilter);
        if (clientFilter) query = query.eq('client_id', clientFilter);
        if (dateFrom) query = query.gte('issue_date', dateFrom);
        if (dateTo) query = query.lte('issue_date', dateTo);

        const { data: invoices, error } = await query;

        if (error) {
          console.error('[Billing] Error loading invoices:', error);
          // Check if table doesn't exist
          if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
            renderInvoicesTable([]);
            toast.info('Invoices table not found. Please run the database migration.', 'Setup Required');
          } else {
            throw error;
          }
          return;
        }

        if (!invoices || invoices.length === 0) {
          renderInvoicesTable([]);
          return;
        }

        // Fetch related data separately to avoid relationship errors
        const clientIds = [...new Set(invoices.filter(inv => inv.client_id).map(inv => inv.client_id))];
        const siteIds = [...new Set(invoices.filter(inv => inv.site_id).map(inv => inv.site_id))];
        const jobIds = [...new Set(invoices.filter(inv => inv.job_id).map(inv => inv.job_id))];

        // Fetch user profiles
        let userProfiles = [];
        if (clientIds.length > 0) {
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', clientIds);
          userProfiles = profiles || [];
        }

        // Fetch sites
        let sites = [];
        if (siteIds.length > 0) {
          const { data: siteData } = await supabase
            .from('sites')
            .select('id, name')
            .in('id', siteIds);
          sites = siteData || [];
        }

        // Fetch jobs
        let jobs = [];
        if (jobIds.length > 0) {
          const { data: jobData } = await supabase
            .from('jobs')
            .select('id, title')
            .in('id', jobIds);
          jobs = jobData || [];
        }

        // Create lookup maps
        const profilesMap = new Map(userProfiles.map(p => [p.id, p]));
        const sitesMap = new Map(sites.map(s => [s.id, s]));
        const jobsMap = new Map(jobs.map(j => [j.id, j]));

        // Merge data into invoices
        const enrichedInvoices = invoices.map(invoice => ({
          ...invoice,
          user_profiles: invoice.client_id ? profilesMap.get(invoice.client_id) : null,
          sites: invoice.site_id ? sitesMap.get(invoice.site_id) : null,
          jobs: invoice.job_id ? jobsMap.get(invoice.job_id) : null
        }));

        renderInvoicesTable(enrichedInvoices);

      } catch (error) {
        console.error('[Billing] Error loading invoices:', error);
        toast.error('Failed to load invoices', 'Error');
        renderInvoicesTable([]);
      }
    }
    
    // Render invoices table
    function renderInvoicesTable(invoices) {
      const tbody = document.getElementById('invoices-table-body');
      if (!tbody) return;

      if (invoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No invoices found</td></tr>';
        return;
      }

      const statusColors = {
        'draft': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
        'sent': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',
        'paid': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
        'overdue': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
        'cancelled': 'bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400'
      };

      tbody.innerHTML = invoices.map(invoice => {
        const clientName = invoice.user_profiles?.full_name || invoice.user_profiles?.email || 'N/A';
        const siteName = invoice.sites?.name || 'N/A';
        const jobTitle = invoice.jobs?.title || 'N/A';
        const amount = parseFloat(invoice.total_amount || 0);
        const statusClass = statusColors[invoice.status] || statusColors.draft;

        return `
          <tr class="hover:bg-nfglight/30 dark:hover:bg-gray-700/30">
            <td class="px-4 py-3 text-sm font-medium">${invoice.invoice_number || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${clientName}</td>
            <td class="px-4 py-3 text-sm">${siteName}</td>
            <td class="px-4 py-3 text-sm">${jobTitle}</td>
            <td class="px-4 py-3 text-sm font-medium">$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-lg text-xs font-medium ${statusClass}">
                ${invoice.status || 'draft'}
              </span>
            </td>
            <td class="px-4 py-3 text-sm">${new Date(invoice.due_date).toLocaleDateString()}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button onclick="viewInvoice('${invoice.id}')" class="text-nfgblue dark:text-blue-400 hover:underline text-sm">View</button>
                <button onclick="downloadInvoicePDF('${invoice.id}')" class="text-gray-600 dark:text-gray-400 hover:underline text-sm">PDF</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Recreate icons
      if (window.lucide) lucide.createIcons();
    }
    
    // Load client filter dropdown
    async function loadClientFilter() {
      try {
        // Fetch invoices with client_id only
        const { data: invoices, error } = await supabase
          .from('invoices')
          .select('client_id');

        if (error) {
          console.error('[Billing] Error loading invoices for client filter:', error);
          return;
        }

        if (!invoices || invoices.length === 0) return;

        // Get unique client IDs (filter out nulls client-side)
        const clientIds = [...new Set(invoices.filter(inv => inv.client_id != null).map(inv => inv.client_id))];
        
        if (clientIds.length === 0) return;

        // Fetch user profiles separately
        const { data: profiles, error: profileError } = await supabase
          .from('user_profiles')
          .select('id, full_name, email')
          .in('id', clientIds);

        if (profileError) {
          console.error('[Billing] Error loading profiles for client filter:', profileError);
          return;
        }

        if (!profiles || profiles.length === 0) return;

        const clientFilter = document.getElementById('invoice-client-filter');
        if (!clientFilter) return;

        // Clear existing options (keep "All Clients")
        const allClientsOption = clientFilter.querySelector('option[value=""]');
        clientFilter.innerHTML = '';
        if (allClientsOption) clientFilter.appendChild(allClientsOption);

        // Add client options
        profiles.forEach(profile => {
          const option = document.createElement('option');
          option.value = profile.id;
          option.textContent = profile.full_name || profile.email || 'Unknown Client';
          clientFilter.appendChild(option);
        });

      } catch (error) {
        console.error('[Billing] Error loading client filter:', error);
      }
    }
    
    // Load revenue chart
    async function loadRevenueChart() {
      try {
        const { data: invoices, error } = await supabase
          .from('invoices')
          .select('issue_date, paid_amount, status')
          .eq('status', 'paid')
          .order('issue_date', { ascending: true });

        if (error) {
          console.error('[Billing] Error loading revenue data:', error);
          return;
        }

        // Group by month
        const monthlyRevenue = {};
        invoices.forEach(invoice => {
          const date = new Date(invoice.issue_date);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyRevenue[monthKey]) {
            monthlyRevenue[monthKey] = 0;
          }
          monthlyRevenue[monthKey] += parseFloat(invoice.paid_amount || 0);
        });

        // Get last 12 months
        const months = [];
        const revenues = [];
        const now = new Date();
        for (let i = 11; i >= 0; i--) {
          const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          months.push(monthName);
          revenues.push(monthlyRevenue[monthKey] || 0);
        }

        // Render chart
        const canvas = document.getElementById('revenue-chart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const isDark = document.documentElement.classList.contains('dark');
        
        // Destroy existing chart if it exists
        if (window.revenueChart) {
          window.revenueChart.destroy();
        }

        window.revenueChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Revenue',
              data: revenues,
              borderColor: '#0D47A1',
              backgroundColor: 'rgba(13, 71, 161, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '$' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: isDark ? '#9CA3AF' : '#6B7280',
                  callback: function(value) {
                    return '$' + value.toLocaleString('en-US');
                  }
                },
                grid: {
                  color: isDark ? '#374151' : '#E5E7EB'
                }
              },
              x: {
                ticks: {
                  color: isDark ? '#9CA3AF' : '#6B7280'
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });

      } catch (error) {
        console.error('[Billing] Error loading revenue chart:', error);
      }
    }
    
    // ========== INVOICE CREATION FUNCTIONS ==========
    
    let lineItemCounter = 0;
    
    // Initialize invoice modal event listeners (called once)
    function initInvoiceModalListeners() {
      // Client change handler
      const clientSelect = document.getElementById('invoice-client-select');
      if (clientSelect && !clientSelect.hasAttribute('data-listener-attached')) {
        clientSelect.setAttribute('data-listener-attached', 'true');
        clientSelect.addEventListener('change', async (e) => {
          const clientId = e.target.value;
          // Sites don't have client_id, so we just clear selections when client changes
          // Sites will already be loaded from modal open
          // Clear site, job, booking selections
          document.getElementById('invoice-site-select').value = '';
          document.getElementById('invoice-job-select').innerHTML = '<option value="">Select a job (optional)</option>';
          document.getElementById('invoice-booking-select').innerHTML = '<option value="">Select a booking (optional)</option>';
        });
      }
      
      // Site change handler
      const siteSelect = document.getElementById('invoice-site-select');
      if (siteSelect && !siteSelect.hasAttribute('data-listener-attached')) {
        siteSelect.setAttribute('data-listener-attached', 'true');
        siteSelect.addEventListener('change', async (e) => {
          const siteId = e.target.value;
          console.log('[Billing] Site selection changed:', siteId);
          if (siteId) {
            console.log('[Billing] Loading jobs and bookings for site:', siteId);
            await loadInvoiceJobs(siteId);
            await loadInvoiceBookings(siteId);
          } else {
            // Clear jobs and bookings if no site selected
            document.getElementById('invoice-job-select').innerHTML = '<option value="">Select a job (optional)</option>';
            document.getElementById('invoice-booking-select').innerHTML = '<option value="">Select a booking (optional)</option>';
          }
        });
      }
      
      // Tax rate and discount handlers
      const taxRateInput = document.getElementById('invoice-tax-rate');
      if (taxRateInput && !taxRateInput.hasAttribute('data-listener-attached')) {
        taxRateInput.setAttribute('data-listener-attached', 'true');
        taxRateInput.addEventListener('input', updateInvoiceSummary);
      }
      
      const discountInput = document.getElementById('invoice-discount');
      if (discountInput && !discountInput.hasAttribute('data-listener-attached')) {
        discountInput.setAttribute('data-listener-attached', 'true');
        discountInput.addEventListener('input', updateInvoiceSummary);
      }
      
      // Add line item button
      const addItemBtn = document.getElementById('add-line-item-btn');
      if (addItemBtn && !addItemBtn.hasAttribute('data-listener-attached')) {
        addItemBtn.setAttribute('data-listener-attached', 'true');
        addItemBtn.addEventListener('click', () => {
          addLineItem();
        });
      }
    }
    
    // Open invoice creation modal
    async function openCreateInvoiceModal() {
      const modal = document.getElementById('create-invoice-modal');
      if (!modal) {
        console.error('[Billing] Modal not found!');
        return;
      }
      
      // Initialize event listeners (safe to call multiple times)
      initInvoiceModalListeners();
      
      // Attach listener immediately
      attachSiteChangeListener();
      
      // Reset form
      document.getElementById('create-invoice-form')?.reset();
      document.getElementById('invoice-line-items').innerHTML = '';
      lineItemCounter = 0;
      updateInvoiceSummary();
      
      // Set default dates
      const today = new Date();
      const dueDate = new Date(today);
      dueDate.setDate(dueDate.getDate() + 30); // Default 30 days
      
      document.getElementById('invoice-issue-date').value = today.toISOString().split('T')[0];
      document.getElementById('invoice-due-date').value = dueDate.toISOString().split('T')[0];
      
      // Load dropdowns
      console.log('[Billing] Loading invoice dropdowns...');
      await loadInvoiceClients();
      await loadInvoiceSites(); // Load all sites initially
      console.log('[Billing] Invoice dropdowns loaded');
      
      // Check for pending job data from sessionStorage
      const pendingJob = sessionStorage.getItem('pendingInvoiceJob');
      if (pendingJob) {
        try {
          const jobData = JSON.parse(pendingJob);
          // Pre-fill form with job data
          document.getElementById('invoice-client-select').value = jobData.clientId || '';
          if (jobData.clientId) {
            await loadInvoiceSites(jobData.clientId);
            if (jobData.siteId) {
              document.getElementById('invoice-site-select').value = jobData.siteId;
              await loadInvoiceJobs(jobData.siteId);
              await loadInvoiceBookings(jobData.siteId);
              if (jobData.jobId) {
                document.getElementById('invoice-job-select').value = jobData.jobId;
              }
            }
          }
          
          // Add initial line item based on job
          if (jobData.jobTitle) {
            addLineItem({
              description: jobData.jobTitle,
              quantity: 1,
              unitPrice: 0 // Will need to be filled manually
            });
          }
          
          // Clear sessionStorage after use
          sessionStorage.removeItem('pendingInvoiceJob');
        } catch (error) {
          console.error('[Billing] Error parsing pending job data:', error);
        }
      } else {
        // Add initial empty line item
        addLineItem();
      }
      
      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    }
    
    // Function to attach site change listener (defined at module scope)
    function attachSiteChangeListener() {
      const siteSelect = document.getElementById('invoice-site-select');
      if (!siteSelect) {
        console.warn('[Billing] Site select element not found for listener attachment');
        return;
      }
      
      // Use direct onchange property (most reliable method)
      siteSelect.onchange = async function(e) {
        const siteId = this.value;
        if (siteId && siteId !== '') {
          await loadInvoiceJobs(siteId);
          await loadInvoiceBookings(siteId);
        } else {
          // Clear jobs and bookings if no site selected
          document.getElementById('invoice-job-select').innerHTML = '<option value="">Select a job (optional)</option>';
          document.getElementById('invoice-booking-select').innerHTML = '<option value="">Select a booking (optional)</option>';
        }
      };
    }
    
    // Load clients for invoice creation
    async function loadInvoiceClients() {
      try {
        const { data: profiles, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email, role')
          .eq('role', 'client');
        
        if (error) {
          console.error('[Billing] Error loading clients:', error);
          return;
        }
        
        const select = document.getElementById('invoice-client-select');
        if (!select) return;
        
        // Clear existing options (keep first option)
        const firstOption = select.querySelector('option[value=""]');
        select.innerHTML = '';
        if (firstOption) select.appendChild(firstOption);
        
        // Add clients
        (profiles || []).forEach(profile => {
          const option = document.createElement('option');
          option.value = profile.id;
          option.textContent = profile.full_name || profile.email || 'Unknown Client';
          select.appendChild(option);
        });
      } catch (error) {
        console.error('[Billing] Error loading clients:', error);
      }
    }
    
    // Load sites (sites table uses created_by, not client_id)
    async function loadInvoiceSites(clientId = null) {
      try {
        const select = document.getElementById('invoice-site-select');
        if (!select) {
          console.error('[Billing] Site select element not found!');
          return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select a site (optional)</option>';
        
        console.log('[Billing] Fetching sites (all accessible sites)...');
        
        // Sites table uses created_by, not client_id, so we load all accessible sites
        // RLS policies will handle filtering by user permissions
        const { data: sites, error } = await supabase
          .from('sites')
          .select('id, name')
          .order('name', { ascending: true });
        
        if (error) {
          console.error('[Billing] Error loading sites:', error);
          return;
        }
        
        console.log('[Billing] Found', sites?.length || 0, 'sites');
        
        // Add sites to dropdown
        (sites || []).forEach(site => {
          const option = document.createElement('option');
          option.value = site.id;
          option.textContent = site.name;
          select.appendChild(option);
        });
        
        console.log('[Billing] Sites loaded into dropdown');
        
        // Attach site change listener AFTER sites are loaded
        setTimeout(() => {
          attachSiteChangeListener();
        }, 100);
      } catch (error) {
        console.error('[Billing] Error loading sites:', error);
      }
    }
    
    // Load jobs for selected site
    async function loadInvoiceJobs(siteId) {
      try {
        if (!siteId) {
          const select = document.getElementById('invoice-job-select');
          if (select) {
            select.innerHTML = '<option value="">Select a job (optional)</option>';
          }
          return;
        }
        
        console.log('[Billing] Fetching jobs for site:', siteId);
        
        // Convert siteId to number if it's a string (sites table uses BIGSERIAL)
        const siteIdNum = typeof siteId === 'string' ? parseInt(siteId, 10) : siteId;
        
        if (isNaN(siteIdNum)) {
          console.error('[Billing] Invalid site ID:', siteId);
          return;
        }
        
        console.log('[Billing] Converted site ID to number:', siteIdNum);
        
        // Test query to verify jobs table access and see all site_ids
        console.log('[Billing] Testing jobs query to check site_id format...');
        const { data: allJobs, error: testError } = await supabase
          .from('jobs')
          .select('id, title, status, site_id')
          .limit(10);
        
        if (testError) {
          console.error('[Billing] Cannot query jobs table:', testError);
          const select = document.getElementById('invoice-job-select');
          if (select) {
            select.innerHTML = '<option value="">Error: Cannot access jobs</option>';
          }
          return;
        }
        
        console.log('[Billing] Jobs table is accessible. Found', allJobs?.length || 0, 'total jobs (sample)');
        if (allJobs && allJobs.length > 0) {
          console.log('[Billing] Sample jobs with site_ids:', allJobs.map(j => ({ 
            id: j.id, 
            title: j.title, 
            site_id: j.site_id, 
            site_id_type: typeof j.site_id,
            site_id_value: j.site_id
          })));
          
          // Check if any jobs match our site_id
          const matchingJobs = allJobs.filter(j => {
            const jobSiteId = typeof j.site_id === 'string' ? parseInt(j.site_id, 10) : j.site_id;
            return jobSiteId === siteIdNum;
          });
          console.log('[Billing] Jobs matching site_id', siteIdNum, ':', matchingJobs.length);
        }
        
        // Try querying with both string and number to handle type issues
        console.log('[Billing] Querying jobs for site_id (as number):', siteIdNum);
        let { data: jobs, error } = await supabase
          .from('jobs')
          .select('id, title, status, site_id, created_by')
          .eq('site_id', siteIdNum)
          .order('created_at', { ascending: false });
        
        // If no results, try as string (in case database stores as string)
        if ((!jobs || jobs.length === 0) && !error) {
          console.log('[Billing] No results with number, trying as string:', String(siteIdNum));
          const result = await supabase
            .from('jobs')
            .select('id, title, status, site_id, created_by')
            .eq('site_id', String(siteIdNum))
            .order('created_at', { ascending: false });
          jobs = result.data;
          error = result.error;
        }
        
        if (error) {
          console.error('[Billing] Error loading jobs:', error);
          console.error('[Billing] Error details:', JSON.stringify(error, null, 2));
          console.error('[Billing] Site ID used:', siteIdNum, 'Type:', typeof siteIdNum);
          
          // Show error in dropdown
          const select = document.getElementById('invoice-job-select');
          if (select) {
            select.innerHTML = '<option value="">Error loading jobs</option>';
          }
          return;
        }
        
        console.log('[Billing] Found', jobs?.length || 0, 'jobs for site');
        
        const select = document.getElementById('invoice-job-select');
        if (!select) {
          console.error('[Billing] Job select element not found!');
          return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select a job (optional)</option>';
        
        // Add jobs with status indicator
        if (jobs && jobs.length > 0) {
          jobs.forEach(job => {
            const option = document.createElement('option');
            option.value = job.id;
            const statusLabel = job.status ? ` (${job.status})` : '';
            option.textContent = `${job.title}${statusLabel}`;
            select.appendChild(option);
          });
          console.log('[Billing] Jobs loaded into dropdown:', jobs.length, 'jobs');
        } else {
          console.log('[Billing] No jobs found for this site');
        }
        
        // Check if this select uses custom dropdown - if so, reinitialize it
        if (select.hasAttribute('data-custom-dropdown')) {
          console.log('[Billing] Reinitializing custom dropdown for jobs select...');
          // Remove existing wrapper if it exists
          const wrapper = select.previousElementSibling;
          if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
            wrapper.remove();
          }
          // Reset select display
          select.style.display = '';
          // Reinitialize custom dropdown
          if (window.NFGDropdown) {
            new window.NFGDropdown(select);
            console.log('[Billing] Custom dropdown reinitialized');
          } else {
            console.warn('[Billing] NFGDropdown not available, skipping reinit');
          }
        }
      } catch (error) {
        console.error('[Billing] Error loading jobs:', error);
      }
    }
    
    // Load bookings for selected site
    async function loadInvoiceBookings(siteId) {
      try {
        if (!siteId) {
          const select = document.getElementById('invoice-booking-select');
          if (select) {
            select.innerHTML = '<option value="">Select a booking (optional)</option>';
          }
          return;
        }
        
        console.log('[Billing] Fetching bookings for site:', siteId);
        
        // Convert siteId to number if it's a string (sites table uses BIGSERIAL)
        const siteIdNum = typeof siteId === 'string' ? parseInt(siteId, 10) : siteId;
        
        if (isNaN(siteIdNum)) {
          console.error('[Billing] Invalid site ID for bookings:', siteId);
          return;
        }
        
        // Try querying with number first
        let { data: bookings, error } = await supabase
          .from('bookings')
          .select('id, title, scheduled_date, status')
          .eq('site_id', siteIdNum)
          .in('status', ['confirmed', 'completed']);
        
        // If no results, try as string (in case database stores as string)
        if ((!bookings || bookings.length === 0) && !error) {
          const result = await supabase
            .from('bookings')
            .select('id, title, scheduled_date, status')
            .eq('site_id', String(siteIdNum))
            .in('status', ['confirmed', 'completed']);
          bookings = result.data;
          error = result.error;
        }
        
        if (error) {
          console.error('[Billing] Error loading bookings:', error);
          return;
        }
        
        const select = document.getElementById('invoice-booking-select');
        if (!select) {
          console.error('[Billing] Booking select element not found!');
          return;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">Select a booking (optional)</option>';
        
        // Add bookings
        if (bookings && bookings.length > 0) {
          bookings.forEach(booking => {
            const option = document.createElement('option');
            option.value = booking.id;
            const dateStr = booking.scheduled_date ? new Date(booking.scheduled_date).toLocaleDateString() : '';
            option.textContent = `${booking.title || 'Booking'}${dateStr ? ' - ' + dateStr : ''}`;
            select.appendChild(option);
          });
          console.log('[Billing] Bookings loaded into dropdown:', bookings.length, 'bookings');
        } else {
          console.log('[Billing] No bookings found for this site');
        }
      } catch (error) {
        console.error('[Billing] Error loading bookings:', error);
      }
    }
    
    // Add line item row
    function addLineItem(defaults = {}) {
      lineItemCounter++;
      const container = document.getElementById('invoice-line-items');
      if (!container) return;
      
      const itemId = `line-item-${lineItemCounter}`;
      const itemHTML = `
        <div class="line-item border border-nfgray dark:border-gray-600 rounded-xl p-3 bg-nfglight/30 dark:bg-gray-700/30" data-item-id="${itemId}">
          <div class="grid grid-cols-12 gap-3 items-end">
            <div class="col-span-12 md:col-span-5">
              <label class="block text-xs font-medium mb-1 dark:text-gray-300">Description</label>
              <input type="text" class="line-item-description w-full border border-nfgray dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 text-sm focus:ring-2 focus:ring-nfgblue outline-none" 
                     placeholder="Item description" value="${defaults.description || ''}" required />
            </div>
            <div class="col-span-4 md:col-span-2">
              <label class="block text-xs font-medium mb-1 dark:text-gray-300">Quantity</label>
              <input type="number" class="line-item-quantity w-full border border-nfgray dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 text-sm focus:ring-2 focus:ring-nfgblue outline-none" 
                     step="0.01" min="0" value="${defaults.quantity || 1}" required />
            </div>
            <div class="col-span-6 md:col-span-3">
              <label class="block text-xs font-medium mb-1 dark:text-gray-300">Unit Price ($)</label>
              <input type="number" class="line-item-price w-full border border-nfgray dark:border-gray-600 rounded-lg p-2 dark:bg-gray-700 text-sm focus:ring-2 focus:ring-nfgblue outline-none" 
                     step="0.01" min="0" value="${defaults.unitPrice || 0}" required />
            </div>
            <div class="col-span-2 md:col-span-1">
              <label class="block text-xs font-medium mb-1 dark:text-gray-300">Total</label>
              <div class="line-item-total text-sm font-medium p-2 text-gray-600 dark:text-gray-400">$0.00</div>
            </div>
            <div class="col-span-12 md:col-span-1">
              <button type="button" class="remove-line-item w-full px-2 py-2 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm" data-item-id="${itemId}">
                <i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', itemHTML);
      
      // Attach event listeners
      const itemEl = container.querySelector(`[data-item-id="${itemId}"]`);
      const quantityInput = itemEl.querySelector('.line-item-quantity');
      const priceInput = itemEl.querySelector('.line-item-price');
      const removeBtn = itemEl.querySelector('.remove-line-item');
      
      [quantityInput, priceInput].forEach(input => {
        input.addEventListener('input', () => {
          updateLineItemTotal(itemId);
          updateInvoiceSummary();
        });
      });
      
      removeBtn.addEventListener('click', () => {
        itemEl.remove();
        updateInvoiceSummary();
      });
      
      // Update initial total
      updateLineItemTotal(itemId);
      updateInvoiceSummary();
      
      // Reinitialize icons
      if (window.lucide) lucide.createIcons();
    }
    
    // Update line item total
    function updateLineItemTotal(itemId) {
      const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
      if (!itemEl) return;
      
      const quantity = parseFloat(itemEl.querySelector('.line-item-quantity').value || 0);
      const price = parseFloat(itemEl.querySelector('.line-item-price').value || 0);
      const total = quantity * price;
      
      const totalEl = itemEl.querySelector('.line-item-total');
      if (totalEl) {
        totalEl.textContent = `$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }
    }
    
    // Update invoice summary
    function updateInvoiceSummary() {
      const lineItems = document.querySelectorAll('.line-item');
      let subtotal = 0;
      
      lineItems.forEach(item => {
        const quantity = parseFloat(item.querySelector('.line-item-quantity').value || 0);
        const price = parseFloat(item.querySelector('.line-item-price').value || 0);
        subtotal += quantity * price;
      });
      
      const taxRate = parseFloat(document.getElementById('invoice-tax-rate').value || 0) / 100;
      const discountAmount = parseFloat(document.getElementById('invoice-discount').value || 0);
      const taxAmount = subtotal * taxRate;
      const total = subtotal + taxAmount - discountAmount;
      
      document.getElementById('invoice-subtotal').textContent = `$${subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('invoice-tax-amount').textContent = `$${taxAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('invoice-discount-amount').textContent = `-$${discountAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('invoice-total').textContent = `$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    // Submit invoice creation form
    document.getElementById('create-invoice-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorDiv = document.getElementById('invoice-form-error');
      errorDiv.classList.add('hidden');
      
      try {
        // Validate line items
        const lineItems = document.querySelectorAll('.line-item');
        if (lineItems.length === 0) {
          errorDiv.textContent = 'Please add at least one line item';
          errorDiv.classList.remove('hidden');
          return;
        }
        
        // Collect form data
        const clientId = document.getElementById('invoice-client-select').value;
        const siteId = document.getElementById('invoice-site-select').value || null;
        const jobId = document.getElementById('invoice-job-select').value || null;
        const bookingId = document.getElementById('invoice-booking-select').value || null;
        const issueDate = document.getElementById('invoice-issue-date').value;
        const dueDate = document.getElementById('invoice-due-date').value;
        const taxRate = parseFloat(document.getElementById('invoice-tax-rate').value || 0);
        const discountAmount = parseFloat(document.getElementById('invoice-discount').value || 0);
        const notes = document.getElementById('invoice-notes').value || null;
        const terms = document.getElementById('invoice-terms').value || null;
        
        // Calculate totals
        let subtotal = 0;
        const lineItemsData = [];
        
        lineItems.forEach((item, index) => {
          const description = item.querySelector('.line-item-description').value.trim();
          const quantity = parseFloat(item.querySelector('.line-item-quantity').value || 0);
          const unitPrice = parseFloat(item.querySelector('.line-item-price').value || 0);
          const lineTotal = quantity * unitPrice;
          
          if (!description || quantity <= 0 || unitPrice < 0) {
            throw new Error('Please fill in all line item fields correctly');
          }
          
          subtotal += lineTotal;
          
          lineItemsData.push({
            description,
            quantity,
            unit_price: unitPrice,
            line_total: lineTotal,
            sort_order: index
          });
        });
        
        const taxAmount = subtotal * (taxRate / 100);
        const totalAmount = subtotal + taxAmount - discountAmount;
        
        // Create invoice
        const { data: invoice, error: invoiceError } = await supabase
          .from('invoices')
          .insert({
            client_id: clientId,
            site_id: siteId,
            job_id: jobId,
            booking_id: bookingId,
            issue_date: issueDate,
            due_date: dueDate,
            status: 'draft',
            subtotal: subtotal,
            tax_rate: taxRate,
            tax_amount: taxAmount,
            discount_amount: discountAmount,
            total_amount: totalAmount,
            balance_due: totalAmount,
            notes: notes,
            terms: terms,
            created_by: currentUser.id
          })
          .select()
          .single();
        
        if (invoiceError) {
          console.error('[Billing] Error creating invoice:', invoiceError);
          throw invoiceError;
        }
        
        // Create line items
        const lineItemsWithInvoiceId = lineItemsData.map(item => ({
          ...item,
          invoice_id: invoice.id
        }));
        
        const { error: lineItemsError } = await supabase
          .from('invoice_line_items')
          .insert(lineItemsWithInvoiceId);
        
        if (lineItemsError) {
          console.error('[Billing] Error creating line items:', lineItemsError);
          // Delete invoice if line items fail
          await supabase.from('invoices').delete().eq('id', invoice.id);
          throw lineItemsError;
        }
        
        // Success
        toast.success(`Invoice ${invoice.invoice_number} created successfully`, 'Invoice Created');
        
        // Close modal
        document.getElementById('create-invoice-modal').classList.add('hidden');
        document.getElementById('create-invoice-modal').classList.remove('flex');
        
        // Refresh invoices list
        await loadInvoices();
        await loadBillingSummary();
        
        // Update URL without reloading
        const url = new URL(window.location);
        url.searchParams.delete('create_invoice');
        window.history.replaceState({}, '', url);
        
      } catch (error) {
        console.error('[Billing] Error creating invoice:', error);
        errorDiv.textContent = error.message || 'Failed to create invoice. Please try again.';
        errorDiv.classList.remove('hidden');
      }
    });
    
    // Event listeners are now initialized in initInvoiceModalListeners() above
    
    // Submit payment form
    document.getElementById('add-payment-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorDiv = document.getElementById('payment-error-message');
      const amountError = document.getElementById('payment-amount-error');
      errorDiv.classList.add('hidden');
      amountError.classList.add('hidden');
      
      try {
        // Get form data
        const invoiceId = window.currentPaymentInvoiceId;
        const invoice = window.currentPaymentInvoice;
        
        if (!invoiceId || !invoice) {
          throw new Error('Invoice information is missing. Please close and reopen the payment modal.');
        }
        
        const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
        const paymentDate = document.getElementById('payment-date').value;
        const paymentMethod = document.getElementById('payment-method').value;
        const referenceNumber = document.getElementById('payment-reference').value.trim() || null;
        const notes = document.getElementById('payment-notes').value.trim() || null;
        
        // Validate payment amount
        const balanceDue = Number(invoice.balance_due || 0);
        const validation = validatePaymentAmount(paymentAmount, balanceDue);
        
        if (!validation.valid) {
          amountError.textContent = validation.error;
          amountError.classList.remove('hidden');
          document.getElementById('payment-amount').classList.add('border-red-500');
          return;
        }
        
        // Insert payment
        const { data: payment, error: paymentError } = await supabase
          .from('payments')
          .insert({
            invoice_id: invoiceId,
            amount: paymentAmount,
            payment_date: paymentDate,
            payment_method: paymentMethod,
            reference_number: referenceNumber,
            notes: notes,
            created_by: currentUser.id
          })
          .select()
          .single();
        
        if (paymentError) {
          console.error('[Billing] Error creating payment:', paymentError);
          throw paymentError;
        }
        
        // Calculate new paid amount and balance
        const currentPaidAmount = Number(invoice.paid_amount || 0);
        const newPaidAmount = currentPaidAmount + paymentAmount;
        const invoiceTotalAmount = Number(invoice.total_amount || 0);
        const newBalanceDue = invoiceTotalAmount - newPaidAmount;
        
        // Prepare update data
        const updateData = {
          paid_amount: newPaidAmount,
          balance_due: newBalanceDue,
          updated_at: new Date().toISOString()
        };
        
        // Auto-update status if fully paid
        if (newBalanceDue <= 0) {
          updateData.status = 'paid';
          updateData.paid_at = new Date().toISOString();
        }
        
        // Update invoice
        const { error: updateError } = await supabase
          .from('invoices')
          .update(updateData)
          .eq('id', invoiceId);
        
        if (updateError) {
          console.error('[Billing] Error updating invoice:', updateError);
          // Try to delete the payment if invoice update fails
          await supabase.from('payments').delete().eq('id', payment.id);
          throw updateError;
        }
        
        // Success
        const successMessage = newBalanceDue <= 0 
          ? `Payment of ${formatCurrency(paymentAmount)} recorded. Invoice is now fully paid.`
          : `Payment of ${formatCurrency(paymentAmount)} recorded successfully.`;
        
        toast.success(successMessage, 'Payment Recorded');
        
        // Close payment modal
        document.getElementById('add-payment-modal').classList.add('hidden');
        document.getElementById('add-payment-modal').classList.remove('flex');
        
        // Refresh invoice detail modal
        await viewInvoice(invoiceId);
        
        // Refresh invoices list and summary if on billing tab
        const billingTab = document.getElementById('tab-billing');
        if (billingTab && (billingTab.classList.contains('active') || billingTab.classList.contains('bg-nfgblue'))) {
          await loadInvoices();
          await loadBillingSummary();
        }
        
      } catch (error) {
        console.error('[Billing] Error recording payment:', error);
        const errorMessage = error.message || 'Failed to record payment. Please try again.';
        errorDiv.querySelector('p').textContent = errorMessage;
        errorDiv.classList.remove('hidden');
        toast.error(errorMessage, 'Payment Error');
      }
    });
    
    // View invoice details
    window.viewInvoice = async function(invoiceId) {
      try {
        const modal = document.getElementById('invoice-detail-modal');
        if (!modal) {
          console.error('[Billing] Invoice detail modal not found');
          return;
        }

        // Show loading state
        document.getElementById('invoice-detail-line-items').innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td></tr>';

        // Fetch invoice with line items and payments
        const { data: invoice, error: invoiceError } = await supabase
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (invoiceError || !invoice) {
          console.error('[Billing] Error loading invoice:', invoiceError);
          toast.error('Failed to load invoice', 'Error');
          return;
        }

        // Fetch line items
        const { data: lineItems, error: lineItemsError } = await supabase
          .from('invoice_line_items')
          .select('*')
          .eq('invoice_id', invoiceId)
          .order('sort_order', { ascending: true });

        // Fetch payments
        const { data: payments, error: paymentsError } = await supabase
          .from('payments')
          .select('*')
          .eq('invoice_id', invoiceId)
          .order('payment_date', { ascending: false });

        // Fetch related data (client, site, job, booking)
        const [client, site, job, booking] = await Promise.all([
          invoice.client_id ? supabase.from('user_profiles').select('full_name, email').eq('id', invoice.client_id).single() : Promise.resolve({ data: null }),
          invoice.site_id ? supabase.from('sites').select('name').eq('id', invoice.site_id).single() : Promise.resolve({ data: null }),
          invoice.job_id ? supabase.from('jobs').select('title').eq('id', invoice.job_id).single() : Promise.resolve({ data: null }),
          invoice.booking_id ? supabase.from('bookings').select('title').eq('id', invoice.booking_id).single() : Promise.resolve({ data: null })
        ]);

        // Populate modal
        document.getElementById('invoice-detail-number').textContent = invoice.invoice_number || 'N/A';
        document.getElementById('invoice-detail-client').textContent = client.data?.full_name || client.data?.email || 'N/A';
        document.getElementById('invoice-detail-site').textContent = site.data?.name || 'N/A';
        document.getElementById('invoice-detail-job').textContent = job.data?.title || 'N/A';
        document.getElementById('invoice-detail-booking').textContent = booking.data?.title || 'N/A';
        
        document.getElementById('invoice-detail-issue-date').textContent = invoice.issue_date ? new Date(invoice.issue_date).toLocaleDateString() : 'N/A';
        document.getElementById('invoice-detail-due-date').textContent = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A';
        
        // Status badge
        const statusEl = document.getElementById('invoice-detail-status');
        const statusColors = {
          'draft': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
          'sent': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',
          'paid': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
          'overdue': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
          'cancelled': 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'
        };
        statusEl.textContent = invoice.status || 'draft';
        statusEl.className = `inline-block px-3 py-1 rounded-full text-xs font-medium ${statusColors[invoice.status] || statusColors.draft}`;

        // Line items
        const lineItemsTbody = document.getElementById('invoice-detail-line-items');
        if (lineItems && lineItems.length > 0) {
          lineItemsTbody.innerHTML = lineItems.map(item => `
            <tr>
              <td class="px-4 py-3">${item.description || 'â€”'}</td>
              <td class="px-4 py-3 text-right">${Number(item.quantity || 0).toFixed(2)}</td>
              <td class="px-4 py-3 text-right">$${Number(item.unit_price || 0).toFixed(2)}</td>
              <td class="px-4 py-3 text-right font-medium">$${Number(item.line_total || 0).toFixed(2)}</td>
            </tr>
          `).join('');
        } else {
          lineItemsTbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No line items</td></tr>';
        }

        // Summary
        document.getElementById('invoice-detail-subtotal').textContent = `$${Number(invoice.subtotal || 0).toFixed(2)}`;
        document.getElementById('invoice-detail-tax-rate').textContent = Number(invoice.tax_rate || 0).toFixed(1);
        document.getElementById('invoice-detail-tax').textContent = `$${Number(invoice.tax_amount || 0).toFixed(2)}`;
        document.getElementById('invoice-detail-discount').textContent = `-$${Number(invoice.discount_amount || 0).toFixed(2)}`;
        document.getElementById('invoice-detail-total').textContent = `$${Number(invoice.total_amount || 0).toFixed(2)}`;
        document.getElementById('invoice-detail-paid').textContent = `$${Number(invoice.paid_amount || 0).toFixed(2)}`;
        document.getElementById('invoice-detail-balance').textContent = `$${Number(invoice.balance_due || 0).toFixed(2)}`;

        // Payments
        const paymentsEl = document.getElementById('invoice-detail-payments');
        if (payments && payments.length > 0) {
          const paymentMethodBadges = {
            'cash': { icon: 'ðŸ’µ', label: 'Cash', color: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' },
            'check': { icon: 'ðŸ“', label: 'Check', color: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' },
            'credit_card': { icon: 'ðŸ’³', label: 'Credit Card', color: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400' },
            'bank_transfer': { icon: 'ðŸ¦', label: 'Bank Transfer', color: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400' },
            'other': { icon: 'ðŸ“„', label: 'Other', color: 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300' }
          };
          
          paymentsEl.innerHTML = payments.map(payment => {
            const method = payment.payment_method || 'other';
            const badge = paymentMethodBadges[method] || paymentMethodBadges.other;
            return `
              <div class="flex items-center justify-between p-3 bg-nfglight/30 dark:bg-gray-700/30 border border-nfgray dark:border-gray-600 rounded-xl">
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-lg text-nfgblue dark:text-blue-400">$${Number(payment.amount).toFixed(2)}</span>
                    <span class="px-2 py-0.5 rounded text-xs font-medium ${badge.color}">${badge.icon} ${badge.label}</span>
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(payment.payment_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</p>
                  ${payment.reference_number ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ref: ${payment.reference_number}</p>` : ''}
                  ${payment.notes ? `<p class="text-xs text-gray-400 dark:text-gray-500 mt-1 italic">${payment.notes}</p>` : ''}
                </div>
              </div>
            `;
          }).join('');
        } else {
          paymentsEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No payments recorded</p>';
        }

        // Notes & Terms
        document.getElementById('invoice-detail-notes').textContent = invoice.notes || 'â€”';
        document.getElementById('invoice-detail-terms').textContent = invoice.terms || 'â€”';

        // Show edit button only for draft invoices
        const editBtn = document.getElementById('edit-invoice-btn');
        if (invoice.status === 'draft') {
          editBtn.classList.remove('hidden');
          editBtn.onclick = () => {
            // TODO: Implement edit functionality
            toast.info('Edit functionality coming soon', 'Coming Soon');
          };
        } else {
          editBtn.classList.add('hidden');
        }

        // Show "Add Payment" button only if balance due > 0
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const balanceDue = Number(invoice.balance_due || 0);
        if (balanceDue > 0) {
          addPaymentBtn.classList.remove('hidden');
          addPaymentBtn.onclick = () => {
            openAddPaymentModal(invoiceId, invoice);
          };
        } else {
          addPaymentBtn.classList.add('hidden');
        }

        // PDF download button
        document.getElementById('download-invoice-pdf-btn').onclick = () => {
          downloadInvoicePDF(invoiceId);
        };

        // Store current invoice ID for PDF generation
        window.currentInvoiceId = invoiceId;
        window.currentInvoiceData = invoice;
        window.currentInvoiceLineItems = lineItems || [];

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (window.lucide) lucide.createIcons();

      } catch (error) {
        console.error('[Billing] Error viewing invoice:', error);
        toast.error('Failed to load invoice details', 'Error');
      }
    };
    
    // Validate payment amount
    function validatePaymentAmount(amount, balanceDue) {
      if (!amount || amount <= 0) {
        return { valid: false, error: 'Payment amount must be greater than 0' };
      }
      if (amount > balanceDue) {
        return { valid: false, error: `Payment cannot exceed balance due of $${balanceDue.toFixed(2)}` };
      }
      return { valid: true };
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount);
    }

    // Update payment form validation
    function updatePaymentFormValidation() {
      const amountInput = document.getElementById('payment-amount');
      const amountError = document.getElementById('payment-amount-error');
      const submitBtn = document.querySelector('#add-payment-form button[type="submit"]');
      const balanceDueEl = document.getElementById('payment-balance-due');
      
      if (!amountInput || !window.currentPaymentInvoice) return;

      const paymentAmount = parseFloat(amountInput.value) || 0;
      const balanceDue = Number(window.currentPaymentInvoice.balance_due || 0);
      
      // Validate amount
      const validation = validatePaymentAmount(paymentAmount, balanceDue);
      
      if (paymentAmount > 0 && !validation.valid) {
        // Show error
        amountError.textContent = validation.error;
        amountError.classList.remove('hidden');
        amountInput.classList.add('border-red-500');
        amountInput.classList.remove('border-nfgray');
        if (submitBtn) submitBtn.disabled = true;
        submitBtn?.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        // Hide error
        amountError.classList.add('hidden');
        amountInput.classList.remove('border-red-500');
        amountInput.classList.add('border-nfgray');
        if (submitBtn) submitBtn.disabled = false;
        submitBtn?.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      // Update balance preview
      const newBalanceHint = document.getElementById('payment-new-balance-hint');
      if (paymentAmount > 0 && paymentAmount <= balanceDue) {
        const newBalance = balanceDue - paymentAmount;
        balanceDueEl.textContent = `$${newBalance.toFixed(2)}`;
        if (newBalanceHint) {
          newBalanceHint.classList.remove('hidden');
          newBalanceHint.textContent = `New balance after payment: $${newBalance.toFixed(2)}`;
        }
        if (newBalance === 0) {
          balanceDueEl.textContent = `$${newBalance.toFixed(2)} (Fully Paid)`;
          balanceDueEl.classList.remove('text-orange-600', 'dark:text-orange-400');
          balanceDueEl.classList.add('text-green-600', 'dark:text-green-400');
          if (newBalanceHint) {
            newBalanceHint.textContent = 'Invoice will be fully paid';
            newBalanceHint.classList.add('text-green-600', 'dark:text-green-400');
            newBalanceHint.classList.remove('text-gray-500', 'dark:text-gray-400');
          }
        } else {
          balanceDueEl.classList.remove('text-green-600', 'dark:text-green-400');
          balanceDueEl.classList.add('text-orange-600', 'dark:text-orange-400');
          if (newBalanceHint) {
            newBalanceHint.classList.remove('text-green-600', 'dark:text-green-400');
            newBalanceHint.classList.add('text-gray-500', 'dark:text-gray-400');
          }
        }
      } else if (paymentAmount === 0 || !amountInput.value) {
        // Reset to original balance
        balanceDueEl.textContent = `$${balanceDue.toFixed(2)}`;
        balanceDueEl.classList.remove('text-green-600', 'dark:text-green-400');
        balanceDueEl.classList.add('text-orange-600', 'dark:text-orange-400');
        if (newBalanceHint) {
          newBalanceHint.classList.add('hidden');
        }
      }
    }

    // Open add payment modal
    function openAddPaymentModal(invoiceId, invoice) {
      const modal = document.getElementById('add-payment-modal');
      if (!modal) {
        console.error('[Billing] Add payment modal not found');
        return;
      }

      // Populate invoice info
      document.getElementById('payment-invoice-number').textContent = invoice.invoice_number || 'N/A';
      const balanceDue = Number(invoice.balance_due || 0);
      document.getElementById('payment-balance-due').textContent = `$${balanceDue.toFixed(2)}`;

      // Set default payment date to today
      const today = new Date();
      document.getElementById('payment-date').value = today.toISOString().split('T')[0];

      // Reset form
      document.getElementById('add-payment-form').reset();
      document.getElementById('payment-date').value = today.toISOString().split('T')[0]; // Reset again after form reset
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-method').value = '';
      document.getElementById('payment-reference').value = '';
      document.getElementById('payment-notes').value = '';
      document.getElementById('payment-amount-error').classList.add('hidden');
      document.getElementById('payment-error-message').classList.add('hidden');

      // Reset balance display
      const balanceDueEl = document.getElementById('payment-balance-due');
      const newBalanceHint = document.getElementById('payment-new-balance-hint');
      balanceDueEl.textContent = `$${balanceDue.toFixed(2)}`;
      balanceDueEl.classList.remove('text-green-600', 'dark:text-green-400');
      balanceDueEl.classList.add('text-orange-600', 'dark:text-orange-400');
      if (newBalanceHint) {
        newBalanceHint.classList.add('hidden');
        newBalanceHint.classList.remove('text-green-600', 'dark:text-green-400');
        newBalanceHint.classList.add('text-gray-500', 'dark:text-gray-400');
      }

      // Reset input border
      const amountInput = document.getElementById('payment-amount');
      amountInput.classList.remove('border-red-500');
      amountInput.classList.add('border-nfgray');

      // Enable submit button
      const submitBtn = document.querySelector('#add-payment-form button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }

      // Store current invoice ID and data
      window.currentPaymentInvoiceId = invoiceId;
      window.currentPaymentInvoice = invoice;

      // Attach real-time validation listeners
      const paymentAmountInput = document.getElementById('payment-amount');
      if (paymentAmountInput) {
        // Remove existing listeners to avoid duplicates
        const newAmountInput = paymentAmountInput.cloneNode(true);
        paymentAmountInput.parentNode.replaceChild(newAmountInput, paymentAmountInput);
        
        // Add new listeners
        newAmountInput.addEventListener('input', updatePaymentFormValidation);
        newAmountInput.addEventListener('blur', updatePaymentFormValidation);
      }

      // Show modal
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    }

    // Generate and download invoice PDF
    window.downloadInvoicePDF = async function(invoiceId) {
      try {
        // Use invoice data if already loaded, otherwise fetch it
        let invoice = window.currentInvoiceData;
        let lineItems = window.currentInvoiceLineItems;

        if (!invoice || invoice.id !== invoiceId) {
          const { data: invoiceData, error: invoiceError } = await supabase
            .from('invoices')
            .select('*')
            .eq('id', invoiceId)
            .single();

          if (invoiceError || !invoiceData) {
            toast.error('Failed to load invoice for PDF', 'Error');
            return;
          }

          invoice = invoiceData;

          const { data: lineItemsData } = await supabase
            .from('invoice_line_items')
            .select('*')
            .eq('invoice_id', invoiceId)
            .order('sort_order', { ascending: true });

          lineItems = lineItemsData || [];
        }

        // Load jsPDF
        if (!window.jspdf) {
          await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
          window.jspdf = window.jspdf || window.jspdf;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Fetch related data
        const [client, site] = await Promise.all([
          invoice.client_id ? supabase.from('user_profiles').select('full_name, email').eq('id', invoice.client_id).single() : Promise.resolve({ data: null }),
          invoice.site_id ? supabase.from('sites').select('name').eq('id', invoice.site_id).single() : Promise.resolve({ data: null })
        ]);

        // PDF Content - Professional Design (Minimal Color)
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 20;
        const contentWidth = pageWidth - (margin * 2);
        let yPos = margin;

        // Header - Minimal design
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text('NFG ONE', margin, yPos);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text('WHERE INNOVATION MEETS EXECUTION', margin, yPos + 7);
        
        // Invoice Title (Right side)
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('INVOICE', pageWidth - margin - 35, yPos);
        
        // Header line
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(margin, yPos + 12, pageWidth - margin, yPos + 12);
        
        yPos += 25; // Start content below header

        // Invoice Details (Right side) - Simple text, no box
        const detailsBoxX = pageWidth - margin - 75;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('INVOICE #', detailsBoxX, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(invoice.invoice_number || 'N/A', detailsBoxX + 25, yPos);
        yPos += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Date:', detailsBoxX, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(invoice.issue_date ? new Date(invoice.issue_date).toLocaleDateString() : 'N/A', detailsBoxX + 25, yPos);
        yPos += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Due:', detailsBoxX, yPos);
        doc.setFont(undefined, 'normal');
        doc.text(invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A', detailsBoxX + 25, yPos);
        yPos += 6;
        doc.setFont(undefined, 'bold');
        doc.text('Status:', detailsBoxX, yPos);
        doc.setFont(undefined, 'normal');
        doc.text((invoice.status || 'draft').toUpperCase(), detailsBoxX + 25, yPos);

        // Bill To Section
        yPos += 60;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Bill To:', margin, yPos);
        yPos += 8;
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(client.data?.full_name || client.data?.email || 'N/A', margin, yPos);
        if (client.data?.email && client.data?.full_name) {
          yPos += 6;
          doc.setFontSize(9);
          doc.setTextColor(100, 100, 100);
          doc.text(client.data.email, margin, yPos);
          doc.setTextColor(0, 0, 0);
        }
        if (site.data?.name) {
          yPos += 8;
          doc.setFontSize(10);
          doc.text(`Site: ${site.data.name}`, margin, yPos);
        }

        // Line Items Section
        yPos += 20;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Line Items', margin, yPos);
        yPos += 8;

        // Table header - simple underline
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Description', margin, yPos);
        doc.text('Qty', margin + 100, yPos);
        doc.text('Unit Price', margin + 130, yPos);
        doc.text('Total', margin + 160, yPos);
        yPos += 4;
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 6;

        // Table rows - simple, clean
        doc.setFont(undefined, 'normal');
        let rowIndex = 0;
        (lineItems || []).forEach(item => {
          if (yPos > pageHeight - 80) {
            doc.addPage();
            yPos = margin + 20;
            // Redraw header on new page
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('NFG ONE', margin, yPos);
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('WHERE INNOVATION MEETS EXECUTION', margin, yPos + 7);
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos + 12, pageWidth - margin, yPos + 12);
            yPos += 25;
            doc.setTextColor(0, 0, 0);
          }
          
          doc.setFontSize(9);
          // Wrap description if too long
          const descLines = doc.splitTextToSize(item.description || 'â€”', 90);
          doc.text(descLines[0], margin, yPos);
          doc.text(Number(item.quantity || 0).toFixed(2), margin + 100, yPos);
          doc.text(`$${Number(item.unit_price || 0).toFixed(2)}`, margin + 130, yPos);
          doc.setFont(undefined, 'bold');
          doc.text(`$${Number(item.line_total || 0).toFixed(2)}`, margin + 160, yPos);
          doc.setFont(undefined, 'normal');
          
          yPos += 6;
          if (descLines.length > 1) {
            doc.text(descLines[1], margin, yPos);
            yPos += 6;
          }
          
          // Subtle row divider
          if (rowIndex < lineItems.length - 1) {
            doc.setDrawColor(240, 240, 240);
            doc.line(margin, yPos + 2, pageWidth - margin, yPos + 2);
            yPos += 4;
          }
          rowIndex++;
        });

        // Summary (Right aligned) - Clean and simple
        yPos += 10;
        const summaryBoxY = yPos;
        const summaryBoxWidth = 75;
        const summaryBoxX = pageWidth - margin - summaryBoxWidth;
        
        let summaryY = summaryBoxY;
        doc.setFontSize(9);
        doc.setTextColor(0, 0, 0);
        
        // Subtotal
        doc.text('Subtotal:', summaryBoxX, summaryY);
        doc.text(`$${Number(invoice.subtotal || 0).toFixed(2)}`, summaryBoxX + summaryBoxWidth, summaryY, { align: 'right' });
        summaryY += 6;
        
        // Tax
        doc.text(`Tax (${Number(invoice.tax_rate || 0).toFixed(1)}%):`, summaryBoxX, summaryY);
        doc.text(`$${Number(invoice.tax_amount || 0).toFixed(2)}`, summaryBoxX + summaryBoxWidth, summaryY, { align: 'right' });
        summaryY += 6;
        
        // Discount
        if (Number(invoice.discount_amount || 0) > 0) {
          doc.text('Discount:', summaryBoxX, summaryY);
          doc.text(`-$${Number(invoice.discount_amount || 0).toFixed(2)}`, summaryBoxX + summaryBoxWidth, summaryY, { align: 'right' });
          summaryY += 6;
        }
        
        // Divider line
        doc.setDrawColor(200, 200, 200);
        doc.line(summaryBoxX, summaryY, summaryBoxX + summaryBoxWidth, summaryY);
        summaryY += 6;
        
        // Total (bold and larger, but still black)
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Total:', summaryBoxX, summaryY);
        doc.text(`$${Number(invoice.total_amount || 0).toFixed(2)}`, summaryBoxX + summaryBoxWidth, summaryY, { align: 'right' });
        summaryY += 8;
        
        // Paid and Balance
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text(`Paid: $${Number(invoice.paid_amount || 0).toFixed(2)}`, summaryBoxX, summaryY);
        summaryY += 6;
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text(`Balance: $${Number(invoice.balance_due || 0).toFixed(2)}`, summaryBoxX, summaryY);

        // Notes & Terms (Left side, below line items)
        yPos = summaryBoxY;
        if (invoice.notes || invoice.terms) {
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          
          if (invoice.notes) {
            doc.text('Notes:', margin, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const notesLines = doc.splitTextToSize(invoice.notes, 100);
            notesLines.forEach(line => {
              doc.text(line, margin, yPos);
              yPos += 5;
            });
            yPos += 5;
          }
          
          if (invoice.terms) {
            doc.setFont(undefined, 'bold');
            doc.text('Payment Terms:', margin, yPos);
            yPos += 7;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            const termsLines = doc.splitTextToSize(invoice.terms, 100);
            termsLines.forEach(line => {
              doc.text(line, margin, yPos);
              yPos += 5;
            });
          }
        }

        // Footer
        const footerY = pageHeight - 20;
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, footerY - 10, pageWidth - margin, footerY - 10);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Thank you for your business!', margin, footerY);
        doc.text(`Page 1`, pageWidth - margin, footerY, { align: 'right' });

        // Download PDF
        doc.save(`Invoice-${invoice.invoice_number || invoiceId}.pdf`);
        toast.success('Invoice PDF downloaded', 'Success');

      } catch (error) {
        console.error('[Billing] Error generating PDF:', error);
        toast.error('Failed to generate PDF', 'Error');
      }
    };

    // Initialize
    async function init() {
      console.log('[Reports] ðŸš€ Initializing Reports page...');
      
      const user = await getCurrentUser();
      if (!user) {
        console.error('[Reports] âŒ No user found, initialization aborted');
        return;
      }
      
      console.log('[Reports] âœ… User authenticated:', user.email);
      console.log('[Reports] ðŸ‘¤ User role:', currentUserProfile?.role || 'unknown');
      
      // Update page description and Bookings link for staff
      if (currentUserProfile && currentUserProfile.role === 'staff') {
        const descriptionEl = document.getElementById('reports-description');
        if (descriptionEl) {
          descriptionEl.textContent = 'View your time tracking and time sheets';
        }
        
        const bookingsNav = document.getElementById('nav-bookings');
        if (bookingsNav) {
          const bookingsText = bookingsNav.querySelector('span') || bookingsNav.childNodes[bookingsNav.childNodes.length - 1];
          if (bookingsText && bookingsText.textContent) {
            bookingsText.textContent = 'Schedule';
          } else {
            bookingsNav.innerHTML = '<i data-lucide="calendar" class="w-4 h-4"></i> Schedule';
            if (window.lucide) lucide.createIcons();
          }
        }
        
        // Hide Overview tab for staff - they only see Time Tracking
        const overviewTab = document.getElementById('tab-overview');
        if (overviewTab) {
          overviewTab.style.display = 'none';
        }
        
        // Hide Overview tab content
        const overviewContent = document.getElementById('tab-content-overview');
        if (overviewContent) {
          overviewContent.classList.add('hidden');
        }
        
        // Show Time Tracking tab content and make it active
        const timeTrackingTab = document.getElementById('tab-time-tracking');
        const timeTrackingContent = document.getElementById('tab-content-time-tracking');
        
        if (timeTrackingTab) {
          // Make Time Tracking tab active
          timeTrackingTab.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          timeTrackingTab.classList.add('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
        }
        
        if (timeTrackingContent) {
          timeTrackingContent.classList.remove('hidden');
      }

        // Load time tracking data immediately for staff
        setTimeout(() => {
          loadTimeTrackingData();
        }, 300);
      }

      // Load initial data (skip Overview data for staff)
      if (!currentUserProfile || currentUserProfile.role !== 'staff') {
      console.log('[Reports] ðŸ“Š Loading initial reports data...');
      await refreshReports();
      } else {
        console.log('[Reports] ðŸ‘¤ Staff user - skipping Overview data, loading Time Tracking only');
      }

      // Event listeners
      const timePeriodSelect = document.getElementById('time-period');
      const customDateRange = document.getElementById('custom-date-range');
      const applyDateRangeBtn = document.getElementById('apply-date-range');
      
      timePeriodSelect?.addEventListener('change', (e) => {
        if (e.target.value === 'custom') {
          customDateRange?.classList.remove('hidden');
          // Set default dates (last 30 days)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);
          document.getElementById('date-to')?.setAttribute('value', endDate.toISOString().split('T')[0]);
          document.getElementById('date-from')?.setAttribute('value', startDate.toISOString().split('T')[0]);
        } else {
          customDateRange?.classList.add('hidden');
          refreshReports();
        }
      });
      
      applyDateRangeBtn?.addEventListener('click', refreshReports);
      document.getElementById('refresh-btn')?.addEventListener('click', refreshReports);
      document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);
      document.getElementById('print-btn')?.addEventListener('click', printReport);
      
      // Time tracking event listeners
      document.getElementById('export-time-sheet-btn')?.addEventListener('click', exportTimeSheet);
      document.getElementById('bulk-approve-btn')?.addEventListener('click', bulkApproveTimeEntries);
      document.getElementById('approval-filter-staff')?.addEventListener('change', loadPendingTimeEntries);
      document.getElementById('approval-filter-status')?.addEventListener('change', loadPendingTimeEntries);
      
      // Billing event listeners
      document.getElementById('apply-invoice-filters')?.addEventListener('click', loadInvoices);
      document.getElementById('clear-invoice-filters')?.addEventListener('click', () => {
        document.getElementById('invoice-status-filter').value = '';
        document.getElementById('invoice-client-filter').value = '';
        document.getElementById('invoice-date-from').value = '';
        document.getElementById('invoice-date-to').value = '';
        loadInvoices();
      });
      document.getElementById('create-invoice-btn')?.addEventListener('click', () => {
        openCreateInvoiceModal();
      });
      
      // Expenses event listeners
      document.getElementById('add-expense-btn')?.addEventListener('click', () => {
        openAddExpenseModal();
      });
      
      // Receipt preview handler
      document.getElementById('expense-receipt')?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const preview = document.getElementById('expense-receipt-preview');
              const previewImg = document.getElementById('expense-receipt-preview-img');
              if (preview && previewImg) {
                previewImg.src = event.target.result;
                preview.classList.remove('hidden');
              }
            };
            reader.readAsDataURL(file);
          } else {
            // For PDFs, just show a message
            const preview = document.getElementById('expense-receipt-preview');
            if (preview) {
              preview.innerHTML = `<p class="text-sm text-gray-600 dark:text-gray-400">PDF file selected: ${file.name}</p><button type="button" id="expense-receipt-remove" class="mt-2 text-sm text-red-600 dark:text-red-400 hover:underline">Remove receipt</button>`;
              preview.classList.remove('hidden');
            }
          }
        }
      });
      
      // Remove receipt handler (event delegation for dynamically created button)
      document.addEventListener('click', (e) => {
        if (e.target.id === 'expense-receipt-remove') {
          document.getElementById('expense-receipt').value = '';
          const preview = document.getElementById('expense-receipt-preview');
          if (preview) {
            preview.classList.add('hidden');
            // Reset preview content
            const previewImg = document.getElementById('expense-receipt-preview-img');
            if (previewImg) {
              previewImg.src = '';
            }
          }
        }
      });
      
      // Initialize tabs
      initTabs();
      initTeamFilters();
      
      // Check URL parameter for tab (e.g., ?tab=billing)
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      if (tabParam === 'billing') {
        const billingTab = document.getElementById('tab-billing');
        if (billingTab) {
          billingTab.click();
        }
        
        // Check if we should open invoice creation modal
        const createInvoice = urlParams.get('create_invoice');
        if (createInvoice === 'true') {
          setTimeout(() => {
            openCreateInvoiceModal();
          }, 500); // Wait for tab to load
        }
        
        // Check if we should view an invoice
        const invoiceId = urlParams.get('invoice');
        if (invoiceId) {
          setTimeout(() => {
            viewInvoice(invoiceId);
          }, 500); // Wait for tab to load
        }
      } else if (tabParam === 'time-tracking') {
        const timeTab = document.getElementById('tab-time-tracking');
        if (timeTab) {
          timeTab.click();
        }
      }
      
      // Allow Enter key to apply date range
      document.getElementById('date-from')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshReports();
      });
      document.getElementById('date-to')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshReports();
      });
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
        console.log('[Reports] ðŸŽ¨ Lucide icons initialized');
      }
      
      console.log('[Reports] âœ… Initialization complete!');
    }

    // Wait for DOM to be fully loaded before initializing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Logout functionality
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = './index.html'
    });
  </script>
  
  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- Invoice Creation Modal -->
  <div id="create-invoice-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg flex items-center gap-2">
          <i data-lucide="file-plus" class="w-5 h-5"></i>
          Create Invoice
        </h4>
        <button data-action="close-modal" data-target="create-invoice-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <form id="create-invoice-form" class="p-6 space-y-6">
        <!-- Client & Site Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Client <span class="text-red-500">*</span></label>
            <select id="invoice-client-select" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">Select a client</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Site</label>
            <select id="invoice-site-select" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">Select a site (optional)</option>
            </select>
          </div>
        </div>

        <!-- Job/Booking Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Job</label>
            <select id="invoice-job-select" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">Select a job (optional)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Booking</label>
            <select id="invoice-booking-select" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm">
              <option value="">Select a booking (optional)</option>
            </select>
          </div>
        </div>

        <!-- Dates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Issue Date <span class="text-red-500">*</span></label>
            <input type="date" id="invoice-issue-date" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Due Date <span class="text-red-500">*</span></label>
            <input type="date" id="invoice-due-date" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" />
          </div>
        </div>

        <!-- Line Items -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <label class="block text-sm font-medium dark:text-gray-200">Line Items <span class="text-red-500">*</span></label>
            <button type="button" id="add-line-item-btn" class="text-sm px-3 py-1.5 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700">
              <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
              Add Item
            </button>
          </div>
          <div id="invoice-line-items" class="space-y-3">
            <!-- Line items will be added here -->
          </div>
        </div>

        <!-- Tax & Discount -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Tax Rate (%)</label>
            <input type="number" id="invoice-tax-rate" step="0.01" min="0" max="100" value="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Discount Amount ($)</label>
            <input type="number" id="invoice-discount" step="0.01" min="0" value="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm" />
          </div>
        </div>

        <!-- Notes & Terms -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Notes</label>
            <textarea id="invoice-notes" rows="3" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm resize-none"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Payment Terms</label>
            <textarea id="invoice-terms" rows="3" placeholder="e.g., Net 30" class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm resize-none"></textarea>
          </div>
        </div>

        <!-- Summary -->
        <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgray rounded-xl p-4">
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Subtotal:</span>
              <span id="invoice-subtotal" class="font-medium">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Tax:</span>
              <span id="invoice-tax-amount" class="font-medium">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Discount:</span>
              <span id="invoice-discount-amount" class="font-medium">-$0.00</span>
            </div>
            <div class="flex justify-between text-lg font-semibold border-t border-nfgray pt-2 mt-2">
              <span class="text-nfgblue dark:text-blue-400">Total:</span>
              <span id="invoice-total" class="text-nfgblue dark:text-blue-400">$0.00</span>
            </div>
          </div>
        </div>

        <div id="invoice-form-error" class="hidden text-sm text-red-600 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl px-3 py-2"></div>

        <div class="flex items-center justify-end gap-3 pt-4 border-t border-nfgray">
          <button type="button" data-action="close-modal" data-target="create-invoice-modal" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 font-medium">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium">
            Create Invoice
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Expense Detail Modal -->
  <div id="expense-detail-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg flex items-center gap-2">
          <i data-lucide="receipt" class="w-5 h-5"></i>
          Expense Details
        </h4>
        <div class="flex items-center gap-2">
          <button id="expense-email-to-btn" class="px-3 py-1.5 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium flex items-center gap-2">
            <i data-lucide="mail" class="w-4 h-4"></i>
            Email To
          </button>
          <button data-action="close-modal" data-target="expense-detail-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <div id="expense-detail-content" class="p-6 space-y-6">
        <!-- Expense Header -->
        <div class="border-b border-nfgray dark:border-gray-700 pb-4">
          <h3 id="expense-detail-description" class="text-xl font-semibold text-gray-900 dark:text-white mb-2">â€”</h3>
          <div class="flex items-center gap-4">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Amount</p>
              <p id="expense-detail-amount" class="text-2xl font-bold text-red-600 dark:text-red-400">$0.00</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Category</p>
              <p id="expense-detail-category" class="font-medium">â€”</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Date</p>
              <p id="expense-detail-date" class="font-medium">â€”</p>
            </div>
          </div>
        </div>

        <!-- Expense Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Job</p>
            <p id="expense-detail-job" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Site</p>
            <p id="expense-detail-site" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Vendor</p>
            <p id="expense-detail-vendor" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Receipt Status</p>
            <div id="expense-detail-receipt">â€”</div>
          </div>
        </div>

        <!-- Notes -->
        <div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Notes</p>
          <p id="expense-detail-notes" class="text-sm text-gray-700 dark:text-gray-300 bg-nfglight/30 dark:bg-gray-700/30 rounded-lg p-3 min-h-[60px]">â€”</p>
        </div>

        <!-- Metadata -->
        <div class="border-t border-nfgray dark:border-gray-700 pt-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Created By</p>
              <p id="expense-detail-created-by" class="font-medium">â€”</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Created At</p>
              <p id="expense-detail-created-at" class="font-medium">â€”</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Expense To Users Modal -->
  <div id="email-expense-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2">
          <i data-lucide="mail" class="w-5 h-5"></i>
          Email Expense Receipt
        </h4>
        <button data-action="close-modal" data-target="email-expense-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 space-y-4">
        <p class="text-sm text-gray-600 dark:text-gray-400">
          Select users to send the expense receipt to:
        </p>

        <!-- User Selection -->
        <div class="max-h-64 overflow-y-auto border border-nfgray dark:border-gray-600 rounded-xl p-2 space-y-2">
          <div id="expense-email-users-list" class="space-y-2">
            <div class="p-3 text-center text-gray-500 dark:text-gray-400">Loading users...</div>
          </div>
        </div>

        <!-- Selected Users Count -->
        <div id="expense-email-selected-count" class="text-sm text-gray-600 dark:text-gray-400 hidden">
          <span id="expense-email-count">0</span> user(s) selected
        </div>

        <!-- Error Message -->
        <div id="expense-email-error" class="hidden text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3"></div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-nfgray">
          <button type="button" data-action="close-modal" data-target="email-expense-modal" class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 font-medium">
            Cancel
          </button>
          <button id="expense-email-send-btn" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium flex items-center gap-2" disabled>
            <i data-lucide="send" class="w-4 h-4"></i>
            Send Email
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Payment Modal -->
  <div id="add-payment-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg flex items-center gap-2">
          <i data-lucide="dollar-sign" class="w-5 h-5"></i>
          Add Payment
        </h4>
        <button data-action="close-modal" data-target="add-payment-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <form id="add-payment-form" class="p-6 space-y-6">
        <!-- Invoice Info (Read-only) -->
        <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgray dark:border-gray-600 rounded-xl p-4">
          <div class="space-y-2">
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Invoice</p>
              <p id="payment-invoice-number" class="font-semibold text-nfgblue dark:text-blue-400">â€”</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Current Balance Due</p>
              <p id="payment-balance-due" class="font-bold text-lg text-orange-600 dark:text-orange-400">$0.00</p>
              <p id="payment-new-balance-hint" class="hidden text-xs text-gray-500 dark:text-gray-400 mt-1">New balance after payment</p>
            </div>
          </div>
        </div>

        <!-- Payment Amount -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Payment Amount ($) <span class="text-red-500">*</span></label>
          <input 
            type="number" 
            id="payment-amount" 
            step="0.01" 
            min="0" 
            required 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            placeholder="0.00"
          />
          <p id="payment-amount-error" class="hidden text-xs text-red-500 mt-1"></p>
        </div>

        <!-- Payment Date -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Payment Date <span class="text-red-500">*</span></label>
          <input 
            type="date" 
            id="payment-date" 
            required 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
          />
        </div>

        <!-- Payment Method -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Payment Method <span class="text-red-500">*</span></label>
          <select 
            id="payment-method" 
            required 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
          >
            <option value="">Select payment method</option>
            <option value="cash">ðŸ’µ Cash</option>
            <option value="check">ðŸ“ Check</option>
            <option value="credit_card">ðŸ’³ Credit Card</option>
            <option value="bank_transfer">ðŸ¦ Bank Transfer</option>
            <option value="other">ðŸ“„ Other</option>
          </select>
        </div>

        <!-- Reference Number -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Reference Number</label>
          <input 
            type="text" 
            id="payment-reference" 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            placeholder="Check #, Transaction ID, etc."
          />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Optional: Check number, transaction ID, or other reference</p>
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Notes</label>
          <textarea 
            id="payment-notes" 
            rows="3" 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm resize-none"
            placeholder="Optional notes about this payment"
          ></textarea>
        </div>

        <!-- Error Message -->
        <div id="payment-error-message" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-3">
          <p class="text-sm text-red-600 dark:text-red-400"></p>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-nfgray dark:border-gray-600">
          <button 
            type="button" 
            data-action="close-modal" 
            data-target="add-payment-modal" 
            class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 font-medium"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="px-4 py-2 rounded-xl bg-green-600 dark:bg-green-700 text-white hover:bg-green-700 dark:hover:bg-green-600 font-medium"
          >
            <i data-lucide="dollar-sign" class="w-4 h-4 inline mr-1"></i>
            Record Payment
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div id="add-expense-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg flex items-center gap-2">
          <i data-lucide="receipt" class="w-5 h-5"></i>
          Add Expense
        </h4>
        <button data-action="close-modal" data-target="add-expense-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <form id="add-expense-form" class="p-6 space-y-6">
        <!-- Description -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Description <span class="text-red-500">*</span></label>
          <input 
            type="text" 
            id="expense-description" 
            required 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            placeholder="e.g., Cleaning supplies for office"
          />
        </div>

        <!-- Category & Amount -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Category <span class="text-red-500">*</span></label>
            <select 
              id="expense-category" 
              required 
              class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            >
              <option value="">Select category</option>
              <option value="supplies">Supplies</option>
              <option value="equipment">Equipment</option>
              <option value="travel">Travel</option>
              <option value="labor">Labor</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Amount ($) <span class="text-red-500">*</span></label>
            <input 
              type="number" 
              id="expense-amount" 
              step="0.01" 
              min="0" 
              required 
              class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
              placeholder="0.00"
            />
          </div>
        </div>

        <!-- Expense Date -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Expense Date <span class="text-red-500">*</span></label>
          <input 
            type="date" 
            id="expense-date" 
            required 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
          />
        </div>

        <!-- Job & Site -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Job</label>
            <select 
              id="expense-job-select" 
              class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            >
              <option value="">Select a job (optional)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Site</label>
            <select 
              id="expense-site-select" 
              class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            >
              <option value="">Select a site (optional)</option>
            </select>
          </div>
        </div>

        <!-- Vendor Name -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Vendor Name</label>
          <input 
            type="text" 
            id="expense-vendor" 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm"
            placeholder="e.g., Office Depot, Amazon, etc."
          />
        </div>

        <!-- Receipt Upload -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Receipt</label>
          <div class="space-y-2">
            <input 
              type="file" 
              id="expense-receipt" 
              accept="image/*,.pdf"
              class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-medium file:bg-nfglight dark:file:bg-gray-700 file:text-nfgblue dark:file:text-blue-400 hover:file:bg-nfgray dark:hover:file:bg-gray-600"
            />
            <p class="text-xs text-gray-500 dark:text-gray-400">Upload receipt image or PDF (optional). Receipt will be emailed to you.</p>
            <p class="text-xs text-orange-600 dark:text-orange-400 mt-1">Maximum file size: 15 MB</p>
            <div id="expense-receipt-preview" class="hidden mt-2">
              <img id="expense-receipt-preview-img" src="" alt="Receipt preview" class="max-w-xs rounded-xl border border-nfgray dark:border-gray-600">
              <button type="button" id="expense-receipt-remove" class="mt-2 text-sm text-red-600 dark:text-red-400 hover:underline">
                Remove receipt
              </button>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Notes</label>
          <textarea 
            id="expense-notes" 
            rows="3" 
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none text-sm resize-none"
            placeholder="Optional notes about this expense"
          ></textarea>
        </div>

        <!-- Error Message -->
        <div id="expense-error-message" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-3">
          <p class="text-sm text-red-600 dark:text-red-400"></p>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-nfgray dark:border-gray-600">
          <button 
            type="button" 
            data-action="close-modal" 
            data-target="add-expense-modal" 
            class="px-4 py-2 rounded-xl border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 font-medium"
          >
            Cancel
          </button>
          <button 
            type="submit" 
            class="px-4 py-2 rounded-xl bg-green-600 dark:bg-green-700 text-white hover:bg-green-700 dark:hover:bg-green-600 font-medium"
          >
            <i data-lucide="receipt" class="w-4 h-4 inline mr-1"></i>
            Add Expense
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Detail Modal -->
  <div id="invoice-detail-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg flex items-center gap-2">
          <i data-lucide="file-text" class="w-5 h-5"></i>
          Invoice <span id="invoice-detail-number"></span>
        </h4>
        <div class="flex items-center gap-2">
          <button id="add-payment-btn" class="hidden px-3 py-1.5 rounded-lg border border-green-600 text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 text-sm font-medium">
            <i data-lucide="dollar-sign" class="w-4 h-4 inline mr-1"></i>
            Add Payment
          </button>
          <button id="edit-invoice-btn" class="hidden px-3 py-1.5 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium">
            <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
            Edit
          </button>
          <button id="download-invoice-pdf-btn" class="px-3 py-1.5 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium">
            <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
            PDF
          </button>
          <button data-action="close-modal" data-target="invoice-detail-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <div class="p-6 space-y-6">
        <!-- Invoice Header Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Client</p>
            <p id="invoice-detail-client" class="font-medium text-nfgblue dark:text-blue-400">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Site</p>
            <p id="invoice-detail-site" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Job</p>
            <p id="invoice-detail-job" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Booking</p>
            <p id="invoice-detail-booking" class="font-medium">â€”</p>
          </div>
        </div>

        <!-- Invoice Dates & Status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Issue Date</p>
            <p id="invoice-detail-issue-date" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Due Date</p>
            <p id="invoice-detail-due-date" class="font-medium">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Status</p>
            <span id="invoice-detail-status" class="inline-block px-3 py-1 rounded-full text-xs font-medium">â€”</span>
          </div>
        </div>

        <!-- Line Items -->
        <div>
          <h5 class="text-sm font-semibold text-nfgblue dark:text-blue-400 mb-3">Line Items</h5>
          <div class="border border-nfgray dark:border-gray-600 rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-nfglight dark:bg-gray-700">
                <tr>
                  <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Description</th>
                  <th class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">Quantity</th>
                  <th class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">Unit Price</th>
                  <th class="px-4 py-3 text-right font-medium text-gray-700 dark:text-gray-300">Total</th>
                </tr>
              </thead>
              <tbody id="invoice-detail-line-items" class="divide-y divide-nfgray dark:divide-gray-600">
                <tr>
                  <td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Invoice Summary -->
        <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgray dark:border-gray-600 rounded-xl p-4">
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Subtotal:</span>
              <span id="invoice-detail-subtotal" class="font-medium">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Tax (<span id="invoice-detail-tax-rate">0</span>%):</span>
              <span id="invoice-detail-tax" class="font-medium">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Discount:</span>
              <span id="invoice-detail-discount" class="font-medium">-$0.00</span>
            </div>
            <div class="flex justify-between text-sm pt-2 border-t border-nfgray dark:border-gray-600">
              <span class="font-semibold text-nfgblue dark:text-blue-400">Total:</span>
              <span id="invoice-detail-total" class="font-bold text-lg text-nfgblue dark:text-blue-400">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Paid:</span>
              <span id="invoice-detail-paid" class="font-medium text-green-600 dark:text-green-400">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600 dark:text-gray-400">Balance Due:</span>
              <span id="invoice-detail-balance" class="font-medium text-orange-600 dark:text-orange-400">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Payment History -->
        <div>
          <h5 class="text-sm font-semibold text-nfgblue dark:text-blue-400 mb-3">Payment History</h5>
          <div id="invoice-detail-payments" class="space-y-2">
            <p class="text-sm text-gray-500 dark:text-gray-400">No payments recorded</p>
          </div>
        </div>

        <!-- Notes & Terms -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Notes</p>
            <p id="invoice-detail-notes" class="text-sm">â€”</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Payment Terms</p>
            <p id="invoice-detail-terms" class="text-sm">â€”</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>

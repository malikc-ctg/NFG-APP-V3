
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports & Analytics â€” NFG Dashboard</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons + Charts -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notifications -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Reports...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <!-- Northern Facilities Group Logo -->
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
        alt="Northern Facilities Group" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="dashboard.html">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Overview
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="sites.html">
        <i data-lucide="map-pin" class="w-4 h-4"></i> Sites
      </a>
      <a id="nav-bookings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="bookings.html">
        <i data-lucide="calendar" class="w-4 h-4"></i> Bookings
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="jobs.html">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i> Jobs
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="inventory.html">
        <i data-lucide="package" class="w-4 h-4"></i> Inventory
      </a>
      <a id="nav-reports" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="reports.html">
        <i data-lucide="file-chart-column" class="w-4 h-4"></i> Reports
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700">
      <button id="logout-btn" class="w-full border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Reports</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <button id="export-csv-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl border border-nfgray hover:bg-nfglight text-xs sm:text-sm flex-shrink-0"
                  title="Export CSV">
            <i data-lucide="download" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Export CSV</span>
          </button>
          <button id="print-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl border border-nfgray hover:bg-nfglight text-xs sm:text-sm flex-shrink-0"
                  title="Print">
            <i data-lucide="printer" class="w-4 h-4"></i>
            <span class="hidden sm:inline">Print</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-4 md:p-6 space-y-6 overflow-y-auto">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Reports & Analytics</h2>
          <p class="text-sm text-gray-500 mt-1" id="reports-description">View performance metrics and generate reports</p>
        </div>
        
        <!-- Time Period Filter -->
        <div class="flex flex-wrap items-center gap-2">
          <select id="time-period" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm">
            <option value="7">Last 7 Days</option>
            <option value="30" selected>Last 30 Days</option>
            <option value="90">Last 90 Days</option>
            <option value="365">This Year</option>
            <option value="custom">Custom Range</option>
            <option value="all">All Time</option>
          </select>
          
          <!-- Custom Date Range (hidden by default) -->
          <div id="custom-date-range" class="hidden flex items-center gap-2">
            <input type="date" id="date-from" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
            <span class="text-gray-500">to</span>
            <input type="date" id="date-to" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
            <button id="apply-date-range" class="px-3 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm">
              Apply
            </button>
          </div>
          
          <button id="refresh-btn" class="p-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700" title="Refresh Reports">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="border-b border-nfgray dark:border-gray-700">
        <nav class="flex gap-2 -mb-px">
          <button 
            id="tab-overview" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-nfgblue text-nfgblue dark:text-blue-400 transition-colors"
            data-tab="overview"
          >
            <i data-lucide="bar-chart-3" class="w-4 h-4 inline mr-2"></i>
            Overview
          </button>
          <button 
            id="tab-time-tracking" 
            class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue hover:border-gray-300 dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
            data-tab="time-tracking"
          >
            <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>
            Time Tracking
          </button>
        </nav>
      </div>

      <!-- Overview Tab Content (existing content) -->
      <div id="tab-content-overview" class="tab-content space-y-6">
        <!-- Metric Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Total Jobs -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Jobs</p>
              <p id="metric-total-jobs" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <i data-lucide="clipboard-check" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
          </div>
        </div>

        <!-- Completed Jobs -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Completed</p>
              <p id="metric-completed-jobs" class="text-2xl font-bold text-green-600 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
              <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
            </div>
          </div>
        </div>

        <!-- Active Sites -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Active Sites</p>
              <p id="metric-active-sites" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
              <i data-lucide="building-2" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
          </div>
        </div>

        <!-- Emergency Requests -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400">Emergencies</p>
              <p id="metric-emergency-jobs" class="text-2xl font-bold text-red-600 mt-1">0</p>
            </div>
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
              <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Jobs Over Time Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Jobs Over Time</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="jobs-over-time-chart"></canvas>
          </div>
        </div>

        <!-- Staff Hours Worked Chart -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <div class="flex items-center gap-2 mb-4">
            <i data-lucide="clock" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Staff Hours Worked</h3>
          </div>
          <div style="height: 200px; position: relative;">
            <canvas id="staff-hours-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Worker Performance -->
      <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
        <div class="flex items-center gap-2 mb-4">
          <i data-lucide="users" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Worker Performance</h3>
        </div>
        
        <!-- Bar Chart: Top Workers by Completed Jobs -->
        <div class="mb-6">
          <p class="text-sm text-gray-500 mb-3">Top 5 Workers (By Completed Jobs)</p>
          <div style="height: 220px; position: relative;">
            <canvas id="worker-performance-chart"></canvas>
          </div>
        </div>
        
        <!-- Stats Table -->
        <div class="border-t border-nfgray pt-4">
          <p class="text-sm font-medium text-gray-600 mb-3">Detailed Breakdown</p>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Worker</th>
                  <th class="pb-2 font-medium text-gray-500 text-center">Done âœ…</th>
                  <th class="pb-2 font-medium text-gray-500 text-center">Active ðŸ”µ</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Rate ðŸ“Š</th>
                </tr>
              </thead>
              <tbody id="worker-stats-table">
                <tr>
                  <td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Data Tables -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Sites -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Top Performing Sites</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Site</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Jobs</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Completed</th>
                </tr>
              </thead>
              <tbody id="top-sites-table">
                <tr>
                  <td colspan="3" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Most Requested Services -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
          <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Most Requested Services</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="border-b border-nfgray dark:border-gray-700">
                <tr class="text-left">
                  <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Service</th>
                  <th class="pb-2 font-medium text-gray-500 text-right">Count</th>
                </tr>
              </thead>
              <tbody id="top-services-table">
                <tr>
                  <td colspan="2" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Completed Jobs -->
      <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Recent Completed Jobs</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="border-b border-nfgray dark:border-gray-700">
              <tr class="text-left">
                <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Job Title</th>
                <th class="pb-2 font-medium text-gray-500 hidden md:table-cell">Site</th>
                <th class="pb-2 font-medium text-gray-500 hidden md:table-cell">Date</th>
                <th class="pb-2 font-medium text-gray-500 dark:text-gray-400">Status</th>
              </tr>
            </thead>
            <tbody id="recent-jobs-table">
              <tr>
                <td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
      <!-- END Overview Tab Content -->

      <!-- Time Tracking Tab Content -->
      <div id="tab-content-time-tracking" class="tab-content hidden space-y-6">
        <!-- Role-Based Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 id="time-tracking-title" class="text-xl font-semibold text-nfgblue dark:text-blue-400">My Time Sheet</h2>
            <p class="text-sm text-gray-500 mt-1">Track your work hours and view time entries</p>
          </div>
          
          <div class="flex gap-2">
            <button id="export-time-sheet-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700 text-sm flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              <span>Export</span>
            </button>
          </div>
        </div>
        
        <!-- Staff View: Time Sheets -->
        <div id="time-sheets-view" class="hidden">
          <!-- Summary Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Hours</p>
              <p id="time-total-hours" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0h</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Overtime Hours</p>
              <p id="time-overtime-hours" class="text-2xl font-bold text-orange-600 mt-1">0h</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Pending Approval</p>
              <p id="time-pending-count" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Average/Day</p>
              <p id="time-avg-hours" class="text-2xl font-bold text-green-600 mt-1">0h</p>
            </div>
          </div>
          
          <!-- Time Entries Table -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
            <div class="p-4 border-b border-nfgray">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">My Time Entries</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-nfglight dark:bg-gray-700">
                  <tr>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Date</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Job</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock In</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock Out</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Duration</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime</th>
                    <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Status</th>
                  </tr>
                </thead>
                <tbody id="time-entries-table" class="divide-y divide-nfgray">
                  <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Admin View: Time Approval + Reports -->
        <div id="time-admin-view" class="hidden">
          <!-- Sub-tabs for Admin -->
          <div class="border-b border-nfgray dark:border-gray-700 mb-6">
            <nav class="flex gap-2 -mb-px">
              <button 
                id="subtab-approval" 
                class="subtab-btn px-4 py-2 text-sm font-medium border-b-2 border-nfgblue text-nfgblue dark:text-blue-400 transition-colors"
                data-subtab="approval"
              >
                Time Approval
              </button>
              <button 
                id="subtab-reports" 
                class="subtab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-nfgblue dark:text-gray-400 dark:hover:text-blue-400 transition-colors"
                data-subtab="reports"
              >
                Time Reports
              </button>
            </nav>
          </div>
          
          <!-- Approval Sub-tab -->
          <div id="subtab-content-approval" class="subtab-content space-y-4">
            <!-- Filters -->
            <div class="flex flex-wrap gap-2 items-center">
              <select id="approval-filter-staff" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
                <option value="">All Staff</option>
                <!-- Populated with staff list -->
              </select>
              <select id="approval-filter-status" class="px-3 py-2 rounded-xl border border-nfgray focus:ring-2 focus:ring-nfgblue outline-none text-sm dark:bg-gray-800">
                <option value="pending" selected>Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
                <option value="">All</option>
              </select>
              <button id="bulk-approve-btn" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm flex items-center gap-2">
                <i data-lucide="check-circle" class="w-4 h-4"></i>
                <span>Bulk Approve Selected</span>
              </button>
            </div>
            
            <!-- Pending Time Entries Table -->
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
              <div class="p-4 border-b border-nfgray">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Pending Time Entries</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left">
                        <input type="checkbox" id="select-all-time-entries" class="rounded">
                      </th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Staff</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Date</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Job</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock In</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Clock Out</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Duration</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="pending-time-entries-table" class="divide-y divide-nfgray">
                    <tr>
                      <td colspan="9" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Reports Sub-tab -->
          <div id="subtab-content-reports" class="subtab-content hidden space-y-6">
            <!-- Time Summary Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Hours</p>
                <p id="admin-total-hours" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mt-1">0h</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Overtime Hours</p>
                <p id="admin-overtime-hours" class="text-2xl font-bold text-orange-600 mt-1">0h</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Pending Approval</p>
                <p id="admin-pending-count" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
                <p class="text-sm text-gray-500 dark:text-gray-400">Active Staff</p>
                <p id="admin-active-staff" class="text-2xl font-bold text-green-600 mt-1">0</p>
              </div>
            </div>
            
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Hours by Staff Chart -->
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Hours by Staff</h3>
                <div style="height: 300px; position: relative;">
                  <canvas id="hours-by-staff-chart"></canvas>
                </div>
              </div>
              
              <!-- Daily Hours Trend Chart -->
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-6 shadow-nfg">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Daily Hours Trend</h3>
                <div style="height: 300px; position: relative;">
                  <canvas id="daily-hours-trend-chart"></canvas>
                </div>
              </div>
            </div>
            
            <!-- Staff Time Summary Table -->
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg overflow-hidden">
              <div class="p-4 border-b border-nfgray">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Staff Time Summary</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Staff</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Total Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Regular Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Overtime Hours</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Jobs</th>
                      <th class="px-4 py-3 text-left font-medium text-gray-700 dark:text-gray-300">Avg/Day</th>
                    </tr>
                  </thead>
                  <tbody id="staff-time-summary-table" class="divide-y divide-nfgray">
                    <tr>
                      <td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- END Time Tracking Tab Content -->
    </main>
  </div>

  <!-- PWA Installation -->
  <script type="module" src="./js/pwa.js"></script>

  <!-- ========== SCRIPTS ========== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      
      // Initialize mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleButtons = document.querySelectorAll('[data-action="toggle-sidebar"], button[aria-label="Toggle sidebar"]');
      
      let overlay = document.getElementById('sidebar-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';
        document.body.appendChild(overlay);
      }
      
      function toggleSidebar() {
        if (sidebar && overlay) {
          const isHidden = sidebar.classList.contains('hidden') || !sidebar.classList.contains('mobile-sidebar-open');
          
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in');
            overlay.classList.remove('hidden');
            overlay.classList.add('animate-fade-in');
            document.body.style.overflow = 'hidden';
          } else {
            sidebar.classList.add('animate-slide-out');
            overlay.classList.add('animate-fade-out');
            
            setTimeout(() => {
              sidebar.classList.add('hidden');
              sidebar.classList.remove('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in', 'animate-slide-out');
              overlay.classList.add('hidden');
              overlay.classList.remove('animate-fade-in', 'animate-fade-out');
              document.body.style.overflow = '';
            }, 200);
          }
        }
      }
      
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      });
      
      overlay?.addEventListener('click', toggleSidebar);
      
      const navLinks = sidebar?.querySelectorAll('a');
      navLinks?.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            toggleSidebar();
          }
        });
      });
    });
  </script>

  <script type="module">
    import { supabase } from './js/supabase.js'
    import { showNotification, showConfirm, showPrompt, toast, notify, handleError } from './js/notifications.js'

    let currentUser = null;
    let currentUserProfile = null;
    let reportsData = {
      jobs: [],
      sites: [],
      bookings: [],
      services: []
    };

    // Chart instances
    let jobsOverTimeChart = null;
    let staffHoursChart = null;
    let workerPerformanceChart = null;
    let hoursByStaffChart = null;
    let dailyHoursTrendChart = null;

    // Get current user and their profile
    async function getCurrentUser() {
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;
        if (!user) {
          window.location.href = './index.html';
          return null;
        }
        
        currentUser = user;
        
        // Get user profile
        const { data: profile, error: profileError } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          console.error('Error fetching profile:', profileError);
        }
        
        currentUserProfile = profile;
        
        return user;
      } catch (error) {
        console.error('Error getting current user:', error);
        window.location.href = './index.html';
        return null;
      }
    }

    // Fetch data based on time period
    async function fetchData(days = 30, customStartDate = null, customEndDate = null) {
      console.log('[Reports] Fetching data for period:', days, 'days', customStartDate ? `(custom: ${customStartDate} to ${customEndDate})` : '');
      
      try {
        let dateFilter = null;
        let dateEndFilter = null;
        
        if (days === 'custom' && customStartDate && customEndDate) {
          // Custom date range
          dateFilter = new Date(customStartDate).toISOString();
          const endDate = new Date(customEndDate);
          endDate.setHours(23, 59, 59, 999); // Include full end date
          dateEndFilter = endDate.toISOString();
        } else if (days !== 'all') {
          // Preset period
          const date = new Date();
          date.setDate(date.getDate() - parseInt(days));
          date.setHours(0, 0, 0, 0);
          dateFilter = date.toISOString();
        }

        // Fetch jobs (without site join since FK might not exist)
        let jobsQuery = supabase
          .from('jobs')
          .select('*');
        
        if (dateFilter) {
          jobsQuery = jobsQuery.gte('created_at', dateFilter);
        }
        if (dateEndFilter) {
          jobsQuery = jobsQuery.lte('created_at', dateEndFilter);
        }

        const { data: jobs, error: jobsError } = await jobsQuery.order('created_at', { ascending: false });
        if (jobsError) {
          console.error('[Reports] Jobs error:', jobsError);
          throw jobsError;
        }
        console.log('[Reports] âœ… Loaded', jobs?.length || 0, 'jobs');

        // Fetch sites
        const { data: sites, error: sitesError } = await supabase
          .from('sites')
          .select('*');
        if (sitesError) {
          console.error('[Reports] Sites error:', sitesError);
          throw sitesError;
        }
        console.log('[Reports] âœ… Loaded', sites?.length || 0, 'sites');

        // Manually join jobs with sites data
        const sitesMap = {};
        (sites || []).forEach(site => {
          sitesMap[site.id] = site;
        });

        reportsData.jobs = (jobs || []).map(job => ({
          ...job,
          sites: job.site_id ? sitesMap[job.site_id] : null
        }));
        reportsData.sites = sites || [];
        
        console.log('[Reports] ðŸ”— Jobs linked with sites successfully');

        // Fetch bookings with services (without site join)
        let bookingsQuery = supabase
          .from('bookings')
          .select(`
            *,
            booking_services (
              service_id,
              quantity,
              services (
                id,
                name
              )
            )
          `);
        
        if (dateFilter) {
          bookingsQuery = bookingsQuery.gte('created_at', dateFilter);
        }
        if (dateEndFilter) {
          bookingsQuery = bookingsQuery.lte('created_at', dateEndFilter);
        }

        const { data: bookings, error: bookingsError } = await bookingsQuery.order('created_at', { ascending: false });
        if (bookingsError) {
          console.error('[Reports] Bookings error:', bookingsError);
          // Don't fail if bookings error - just log it (bookings are optional)
          console.warn('[Reports] âš ï¸ Continuing without bookings data');
          reportsData.bookings = [];
        } else {
          // Manually link bookings with sites
          reportsData.bookings = (bookings || []).map(booking => ({
            ...booking,
            sites: booking.site_id ? sitesMap[booking.site_id] : null
          }));
          console.log('[Reports] âœ… Loaded', bookings?.length || 0, 'bookings');
          
          // Log emergency bookings for debugging
          const emergencyCount = (bookings || []).filter(b => b.is_emergency === true).length;
          console.log('[Reports] ðŸš¨ Emergency bookings found:', emergencyCount);
        }

        // Summary log
        console.log('[Reports] ðŸ“Š Data Summary:', {
          jobs: reportsData.jobs.length,
          sites: reportsData.sites.length,
          bookings: reportsData.bookings.length,
          completedJobs: reportsData.jobs.filter(j => j.status === 'completed').length,
          emergencyJobs: reportsData.jobs.filter(j => j.job_type === 'emergency').length
        });

        return true;
      } catch (error) {
        console.error('[Reports] âŒ Error fetching data:', error);
        handleError(error, 'Loading reports data');
        return false;
      }
    }

    // Update metrics
    function updateMetrics() {
      // Total jobs (all jobs)
      const totalJobs = reportsData.jobs.length;
      console.log('[Reports] ðŸ“Š Total Jobs:', totalJobs);
      
      // Completed jobs
      const completedJobs = reportsData.jobs.filter(j => j.status === 'completed').length;
      console.log('[Reports] âœ… Completed Jobs:', completedJobs);
      
      // Active sites (count sites that are NOT 'Inactive')
      const activeSites = reportsData.sites.filter(s => s.status !== 'Inactive').length;
      console.log('[Reports] ðŸ¢ Active Sites:', activeSites, '(Total:', reportsData.sites.length + ')');
      
      // Emergency requests (count from bookings with is_emergency true OR jobs with job_type 'emergency')
      const emergencyBookings = reportsData.bookings.filter(b => b.is_emergency === true).length;
      const emergencyJobs = reportsData.jobs.filter(j => j.job_type === 'emergency').length;
      const totalEmergencies = Math.max(emergencyBookings, emergencyJobs); // Use whichever is higher
      console.log('[Reports] ðŸš¨ Emergency Requests:', totalEmergencies, '(Bookings:', emergencyBookings, 'Jobs:', emergencyJobs + ')');

      // Update DOM
      document.getElementById('metric-total-jobs').textContent = totalJobs;
      document.getElementById('metric-completed-jobs').textContent = completedJobs;
      document.getElementById('metric-active-sites').textContent = activeSites;
      document.getElementById('metric-emergency-jobs').textContent = totalEmergencies;
      
      console.log('[Reports] âœ… Metrics updated successfully');
      
      // Show a helpful message if there's no data at all
      if (totalJobs === 0 && reportsData.sites.length === 0) {
        console.warn('[Reports] âš ï¸ No data found in the system');
        toast.warning('No data available yet. Create some sites and jobs to see reports!');
      }
    }

    // Dark Mode Support for Charts
    function getChartColors() {
      const isDark = document.documentElement.classList.contains('dark');
      return {
        text: isDark ? '#E5E7EB' : '#1F2937',
        grid: isDark ? '#374151' : '#E5E7EB',
        background: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(13, 71, 161, 0.1)',
        border: isDark ? '#3B82F6' : '#0D47A1',
        tooltipBg: isDark ? '#1F2937' : '#FFFFFF',
        tooltipBorder: isDark ? '#374151' : '#E5E7EB'
      };
    }

    // Listen for theme changes and recreate charts
    window.addEventListener('themeChange', () => {
      console.log('[Reports] Theme changed, updating charts...');
      createJobsOverTimeChart();
      createStaffHoursChart();
      createWorkerPerformanceChart();
    });

    // Create Jobs Over Time Chart
    function createJobsOverTimeChart() {
      const ctx = document.getElementById('jobs-over-time-chart');
      if (!ctx) {
        console.warn('[Reports] Jobs over time chart canvas not found');
        return;
      }

      // Group jobs by date
      const jobsByDate = {};
      reportsData.jobs.forEach(job => {
        if (job.created_at) {
          const date = new Date(job.created_at).toLocaleDateString();
          jobsByDate[date] = (jobsByDate[date] || 0) + 1;
        }
      });

      // Sort by date and get last 30 days
      const dates = Object.keys(jobsByDate).sort((a, b) => new Date(a) - new Date(b)).slice(-30);
      const counts = dates.map(date => jobsByDate[date]);

      // Handle empty data
      if (dates.length === 0) {
        dates.push(new Date().toLocaleDateString());
        counts.push(0);
      }

      if (jobsOverTimeChart) {
        jobsOverTimeChart.destroy();
      }

      const colors = getChartColors();
      jobsOverTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Jobs Created',
            data: counts,
            borderColor: colors.border,
            backgroundColor: colors.background,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
              labels: {
                color: colors.text
              }
            },
            tooltip: {
              backgroundColor: colors.tooltipBg,
              borderColor: colors.tooltipBorder,
              borderWidth: 1,
              titleColor: colors.text,
              bodyColor: colors.text,
              callbacks: {
                label: function(context) {
                  return 'Jobs: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: colors.text },
              grid: { color: colors.grid }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: colors.text,
                stepSize: 1,
                precision: 0
              },
              grid: { color: colors.grid }
            }
          }
        }
      });
    }

    // Create Staff Hours Worked Chart
    async function createStaffHoursChart() {
      const ctx = document.getElementById('staff-hours-chart');
      if (!ctx) {
        console.warn('[Reports] Staff hours chart canvas not found');
        return;
      }

      console.log('[Reports] ðŸ• Creating staff hours chart...');

      try {
        // Fetch time entries
        const timeRange = document.getElementById('time-period')?.value || '30';
        let dateFilter = null;
        let dateEndFilter = null;
        
        if (timeRange === 'custom') {
          const dateFrom = document.getElementById('date-from')?.value;
          const dateTo = document.getElementById('date-to')?.value;
          if (dateFrom) {
            dateFilter = new Date(dateFrom).toISOString();
          }
          if (dateTo) {
            const endDate = new Date(dateTo);
            endDate.setHours(23, 59, 59, 999);
            dateEndFilter = endDate.toISOString();
          }
        } else if (timeRange !== 'all') {
          const date = new Date();
          date.setDate(date.getDate() - parseInt(timeRange));
          date.setHours(0, 0, 0, 0);
          dateFilter = date.toISOString();
        }

        let query = supabase
          .from('time_entries')
          .select('user_id, total_hours, clock_in, clock_out')
          .not('clock_out', 'is', null); // Only completed shifts

        if (dateFilter) {
          query = query.gte('clock_in', dateFilter);
        }
        if (dateEndFilter) {
          query = query.lte('clock_in', dateEndFilter);
        }

        const { data: timeEntries, error } = await query;

        if (error) {
          console.warn('[Reports] âš ï¸ Could not fetch time entries (table may not exist):', error.message);
          // Show empty state
          if (staffHoursChart) staffHoursChart.destroy();
          return;
        }

        console.log('[Reports] â±ï¸ Loaded', timeEntries?.length || 0, 'time entries');

        // Fetch user profiles to get names
        const { data: profiles } = await supabase
          .from('user_profiles')
          .select('id, full_name, role')
          .in('role', ['staff', 'admin']);

        // Calculate total hours per worker
        const workerHours = {};
        timeEntries?.forEach(entry => {
          const userId = entry.user_id;
          const hours = parseFloat(entry.total_hours) || 0;
          workerHours[userId] = (workerHours[userId] || 0) + hours;
        });

        // Map to names and prepare data
        const staffData = [];
        profiles?.forEach(profile => {
          const hours = workerHours[profile.id] || 0;
          if (hours > 0) {
            staffData.push({
              name: profile.full_name || 'Unknown',
              hours: hours
            });
          }
        });

        // Sort by hours and prepare chart data
        staffData.sort((a, b) => b.hours - a.hours);
        
        const names = staffData.map(s => s.name);
        const hours = staffData.map(s => s.hours);
        const total = hours.reduce((a, b) => a + b, 0);

        console.log('[Reports] ðŸ“Š Staff hours data:', names, hours);

        // Handle empty data
        if (names.length === 0) {
          console.warn('[Reports] âš ï¸ No staff hours data available');
          console.log('[Reports] ðŸ’¡ Reason: Staff need to clock in and clock out to generate hours data');
          console.log('[Reports] ðŸ“‹ Time entries found:', timeEntries?.length || 0);
          console.log('[Reports] ðŸ‘¥ Worker profiles found:', profiles?.length || 0);
          if (timeEntries && timeEntries.length > 0) {
            console.log('[Reports] ðŸ” Sample time entry:', timeEntries[0]);
            console.log('[Reports] ðŸ“Š Hours calculated:', timeEntries.map(e => `${e.user_id}: ${e.total_hours} hrs`));
          }
          names.push('No Data Yet');
          hours.push(1); // Show something on chart
        }

        if (staffHoursChart) {
          staffHoursChart.destroy();
        }

        // Generate colors for each staff member
        const colors = [
          '#0D47A1', // Blue
          '#4CAF50', // Green
          '#FFC107', // Yellow
          '#F44336', // Red
          '#9C27B0', // Purple
          '#00BCD4', // Cyan
          '#FF9800', // Orange
          '#795548'  // Brown
        ];

        const themeColors = getChartColors();
        staffHoursChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: names,
            datasets: [{
              data: hours,
              backgroundColor: colors.slice(0, names.length),
              borderWidth: 2,
              borderColor: document.documentElement.classList.contains('dark') ? '#1F2937' : '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: themeColors.text,
                  padding: 8,
                  font: {
                    size: 11
                  },
                  boxWidth: 12
                }
              },
              tooltip: {
                backgroundColor: themeColors.tooltipBg,
                borderColor: themeColors.tooltipBorder,
                borderWidth: 1,
                titleColor: themeColors.text,
                bodyColor: themeColors.text,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value.toFixed(1)} hrs (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        console.log('[Reports] âœ… Staff hours chart created successfully');
      } catch (error) {
        console.error('[Reports] âŒ Error creating staff hours chart:', error);
      }
    }

    // Create Worker Performance Chart
    async function createWorkerPerformanceChart() {
      const ctx = document.getElementById('worker-performance-chart');
      if (!ctx) {
        console.warn('[Reports] âš ï¸ Worker performance chart canvas not found');
        return;
      }

      console.log('[Reports] ðŸ“Š Creating worker performance chart...');

      // Calculate worker stats
      const workerStats = await calculateWorkerStats();
      
      // Sort by completed jobs and get top 5
      const topWorkers = workerStats
        .sort((a, b) => b.completed - a.completed)
        .slice(0, 5);

      const workerNames = topWorkers.map(w => w.name);
      const completedCounts = topWorkers.map(w => w.completed);

      console.log('[Reports] ðŸ“ˆ Chart data:', workerNames, completedCounts);

      // Handle empty data
      if (workerNames.length === 0) {
        console.warn('[Reports] âš ï¸ No worker data for chart, showing empty state');
        workerNames.push('No Workers');
        completedCounts.push(0);
      }

      if (workerPerformanceChart) {
        workerPerformanceChart.destroy();
      }

      const colors = getChartColors();
      workerPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: workerNames,
          datasets: [{
            label: 'Completed Jobs',
            data: completedCounts,
            backgroundColor: '#4CAF50',
            borderRadius: 6,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: colors.tooltipBg,
              borderColor: colors.tooltipBorder,
              borderWidth: 1,
              titleColor: colors.text,
              bodyColor: colors.text,
              callbacks: {
                label: function(context) {
                  return 'Completed: ' + context.parsed.y + ' jobs';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: colors.text,
                stepSize: 1,
                precision: 0
              },
              grid: {
                color: colors.grid
              }
            },
            x: {
              ticks: {
                color: colors.text,
                font: {
                  size: 11
                }
              },
              grid: {
                color: colors.grid
              }
            }
          }
        }
      });
      
      console.log('[Reports] âœ… Worker performance chart created successfully');
    }

    // Calculate worker statistics
    async function calculateWorkerStats() {
      try {
        console.log('[Reports] ðŸ‘· Calculating worker statistics...');
        
        // Fetch all user profiles (workers)
        const { data: profiles, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, role')
          .in('role', ['staff', 'admin']);

        if (error) {
          console.error('[Reports] âŒ Error fetching user profiles:', error);
          return [];
        }

        console.log('[Reports] ðŸ“‹ Fetched', profiles?.length || 0, 'worker profiles');
        console.log('[Reports] ðŸ“Š Total jobs to analyze:', reportsData.jobs.length);

        const workerStats = [];
        const timeRange = document.getElementById('time-period')?.value || '30';
        let daysInPeriod = 30;
        if (timeRange === 'custom') {
          const dateFrom = document.getElementById('date-from')?.value;
          const dateTo = document.getElementById('date-to')?.value;
          if (dateFrom && dateTo) {
            const start = new Date(dateFrom);
            const end = new Date(dateTo);
            daysInPeriod = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
          }
        } else if (timeRange === 'all') {
          daysInPeriod = 365;
        } else {
          daysInPeriod = parseInt(timeRange);
        }
        const weeksInPeriod = daysInPeriod / 7;

        console.log('[Reports] ðŸ“… Time period:', timeRange, 'days =', weeksInPeriod.toFixed(1), 'weeks');

        profiles?.forEach(profile => {
          const workerId = profile.id;
          const workerJobs = reportsData.jobs.filter(j => j.assigned_to === workerId);
          
          const completed = workerJobs.filter(j => j.status === 'completed').length;
          const active = workerJobs.filter(j => j.status === 'pending' || j.status === 'in-progress').length;
          const rate = weeksInPeriod > 0 ? (completed / weeksInPeriod).toFixed(1) : '0.0';

          // Only include workers who have at least some activity
          if (completed > 0 || active > 0) {
            console.log(`[Reports] âœ… ${profile.full_name}: ${completed} completed, ${active} active, ${rate}/wk`);
            workerStats.push({
              id: workerId,
              name: profile.full_name || 'Unknown Worker',
              completed: completed,
              active: active,
              rate: rate
            });
          }
        });

        console.log('[Reports] ðŸ† Found', workerStats.length, 'workers with activity');
        
        // Debug: Show why no workers found
        if (workerStats.length === 0 && reportsData.jobs.length > 0) {
          console.warn('[Reports] âš ï¸ No workers with activity found!');
          console.log('[Reports] ðŸ” Debugging info:');
          console.log('[Reports] ðŸ“Š Total jobs:', reportsData.jobs.length);
          console.log('[Reports] ðŸ‘¥ Worker IDs:', profiles?.map(p => p.id));
          
          // Check if jobs have assigned_to field
          const sampleJob = reportsData.jobs[0];
          console.log('[Reports] ðŸ“‹ Sample job:', {
            id: sampleJob.id,
            title: sampleJob.title,
            assigned_to: sampleJob.assigned_to,
            status: sampleJob.status
          });
          
          // Count jobs with assigned_to
          const assignedJobs = reportsData.jobs.filter(j => j.assigned_to != null).length;
          console.log('[Reports] ðŸŽ¯ Jobs with assigned_to:', assignedJobs, 'out of', reportsData.jobs.length);
          
          if (assignedJobs === 0) {
            console.error('[Reports] âŒ PROBLEM: No jobs have assigned_to field set!');
            console.log('[Reports] ðŸ’¡ Solution: Assign jobs to workers in the Jobs page');
          }
        }
        
        return workerStats;
      } catch (error) {
        console.error('[Reports] âŒ Error calculating worker stats:', error);
        return [];
      }
    }

    // Update Worker Stats Table
    async function updateWorkerStatsTable() {
      const tbody = document.getElementById('worker-stats-table');
      
      console.log('[Reports] ðŸ“Š Updating worker stats table...');
      const workerStats = await calculateWorkerStats();
      
      // Sort by completed jobs and get top 5
      const topWorkers = workerStats
        .sort((a, b) => b.completed - a.completed)
        .slice(0, 5);

      console.log('[Reports] ðŸ… Top 5 workers:', topWorkers.map(w => w.name).join(', '));

      if (topWorkers.length === 0) {
        console.warn('[Reports] âš ï¸ No worker data to display');
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No worker data available</td></tr>';
        return;
      }

      tbody.innerHTML = topWorkers.map(worker => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${worker.name}</td>
          <td class="py-3 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-700 font-semibold text-sm">
              ${worker.completed}
            </span>
          </td>
          <td class="py-3 text-center">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-semibold text-sm">
              ${worker.active}
            </span>
          </td>
          <td class="py-3 text-right text-gray-700 font-medium">${worker.rate}/wk</td>
        </tr>
      `).join('');
      
      console.log('[Reports] âœ… Worker stats table updated successfully');
    }

    // Update Top Sites Table
    function updateTopSitesTable() {
      const tbody = document.getElementById('top-sites-table');
      
      // Count jobs per site
      const siteStats = {};
      reportsData.jobs.forEach(job => {
        const siteName = job.sites?.name || 'Unknown';
        if (!siteStats[siteName]) {
          siteStats[siteName] = { total: 0, completed: 0 };
        }
        siteStats[siteName].total++;
        if (job.status === 'completed') {
          siteStats[siteName].completed++;
        }
      });

      // Sort by total jobs and get top 5
      const topSites = Object.entries(siteStats)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 5);

      if (topSites.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-gray-500 dark:text-gray-400">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = topSites.map(([siteName, stats]) => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${siteName}</td>
          <td class="py-3 text-right">${stats.total}</td>
          <td class="py-3 text-right text-green-600">${stats.completed}</td>
        </tr>
      `).join('');
    }

    // Update Top Services Table
    function updateTopServicesTable() {
      const tbody = document.getElementById('top-services-table');
      
      // Count services from bookings
      const serviceCounts = {};
      reportsData.bookings.forEach(booking => {
        if (booking.booking_services) {
          booking.booking_services.forEach(bs => {
            const serviceName = bs.services?.name || 'Unknown';
            serviceCounts[serviceName] = (serviceCounts[serviceName] || 0) + 1;
          });
        }
      });

      // Sort and get top 5
      const topServices = Object.entries(serviceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      if (topServices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="py-4 text-center text-gray-500 dark:text-gray-400">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = topServices.map(([serviceName, count]) => `
        <tr class="border-b border-nfgray last:border-0">
          <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${serviceName}</td>
          <td class="py-3 text-right">${count}</td>
        </tr>
      `).join('');
    }

    // Update Recent Jobs Table
    function updateRecentJobsTable() {
      const tbody = document.getElementById('recent-jobs-table');
      
      const completedJobs = reportsData.jobs
        .filter(j => j.status === 'completed')
        .slice(0, 10);

      if (completedJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500 dark:text-gray-400">No completed jobs yet</td></tr>';
        return;
      }

      tbody.innerHTML = completedJobs.map(job => {
        const date = new Date(job.created_at).toLocaleDateString();
        return `
          <tr class="border-b border-nfgray last:border-0">
            <td class="py-3 font-medium text-nfgblue dark:text-blue-400">${job.title}</td>
            <td class="py-3 hidden md:table-cell">${job.sites?.name || 'Unknown'}</td>
            <td class="py-3 hidden md:table-cell">${date}</td>
            <td class="py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                Completed
              </span>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Refresh all reports
    async function refreshReports() {
      const timePeriod = document.getElementById('time-period')?.value || '30';
      const refreshBtn = document.getElementById('refresh-btn');
      const icon = refreshBtn?.querySelector('i');
      
      // Handle custom date range
      let customStartDate = null;
      let customEndDate = null;
      
      if (timePeriod === 'custom') {
        customStartDate = document.getElementById('date-from')?.value;
        customEndDate = document.getElementById('date-to')?.value;
        
        if (!customStartDate || !customEndDate) {
          toast.error('Please select both start and end dates for custom range');
          // Reset to default
          document.getElementById('time-period').value = '30';
          return refreshReports();
        }
        
        if (new Date(customStartDate) > new Date(customEndDate)) {
          toast.error('Start date must be before end date');
          return;
        }
      }
      
      // Add spin animation (if icon exists)
      if (icon) {
        icon.classList.add('animate-spin');
      }
      
      const success = await fetchData(timePeriod, customStartDate, customEndDate);
      
      if (success) {
        updateMetrics();
        createJobsOverTimeChart();
        await createStaffHoursChart();
        await createWorkerPerformanceChart();
        await updateWorkerStatsTable();
        updateTopSitesTable();
        updateTopServicesTable();
        updateRecentJobsTable();
        toast.success('Reports refreshed!');
      }
      
      // Remove spin animation (if icon exists)
      if (icon) {
        setTimeout(() => {
          icon.classList.remove('animate-spin');
        }, 500);
      }
    }

    // Export to CSV
    async function exportToCSV() {
      try {
        console.log('[Reports] ðŸ“¥ Exporting CSV...');
        
        // Get current filter settings
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const dateFrom = document.getElementById('date-from')?.value;
        const dateTo = document.getElementById('date-to')?.value;
        
        // Fetch user profiles for worker names
        const { data: profiles } = await supabase
          .from('user_profiles')
          .select('id, full_name, email');
        const profilesMap = {};
        (profiles || []).forEach(p => {
          profilesMap[p.id] = p;
        });
        
        // Build CSV header
        let csv = 'NFG Jobs Report\n';
        csv += `Generated: ${new Date().toLocaleString()}\n`;
        if (timePeriod === 'custom' && dateFrom && dateTo) {
          csv += `Date Range: ${dateFrom} to ${dateTo}\n`;
        } else if (timePeriod !== 'all') {
          csv += `Period: Last ${timePeriod} Days\n`;
        } else {
          csv += `Period: All Time\n`;
        }
        csv += '\n';
        
        // CSV headers
        csv += 'Job Title,Site,Status,Type,Assigned Worker,Worker Email,Created Date,Completed Date,Total Duration (hours),Description\n';
        
        // Add job data
        reportsData.jobs.forEach(job => {
          const createdDate = new Date(job.created_at).toLocaleDateString();
          const completedDate = job.completed_at ? new Date(job.completed_at).toLocaleDateString() : '';
          const worker = job.assigned_worker_id ? profilesMap[job.assigned_worker_id] : null;
          const workerName = worker?.full_name || worker?.email || 'Unassigned';
          const workerEmail = worker?.email || '';
          const duration = job.total_duration ? (job.total_duration / 3600).toFixed(2) : ''; // Convert seconds to hours
          const description = (job.description || '').replace(/"/g, '""'); // Escape quotes for CSV
          
          csv += `"${job.title}","${job.sites?.name || 'Unknown'}","${job.status}","${job.job_type || 'cleaning'}","${workerName}","${workerEmail}","${createdDate}","${completedDate}","${duration}","${description}"\n`;
        });
        
        // Create and download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().split('T')[0];
        a.download = `nfg-jobs-report-${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('[Reports] âœ… CSV exported successfully');
        toast.success('CSV exported successfully!');
      } catch (error) {
        console.error('[Reports] âŒ Error exporting CSV:', error);
        const { handleError } = await import('./js/notifications.js');
        handleError(error, 'Exporting CSV');
      }
    }

    // Print report
    function printReport() {
      window.print();
    }

    // ========== TAB SYSTEM ==========
    
    // Initialize tabs
    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.dataset.tab;
          
          // Update button styles
          tabButtons.forEach(btn => {
            btn.classList.remove('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
            btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          });
          
          button.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          button.classList.add('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
          
          // Show/hide tab content
          tabContents.forEach(content => {
            content.classList.add('hidden');
          });
          
          const targetContent = document.getElementById(`tab-content-${targetTab}`);
          if (targetContent) {
            targetContent.classList.remove('hidden');
          }
          
          // Load tab-specific data if needed
          if (targetTab === 'time-tracking') {
            loadTimeTrackingData();
          }
          
          // Recreate icons after tab switch
          setTimeout(() => {
            if (window.lucide) lucide.createIcons();
          }, 100);
        });
      });
      
      // Initialize sub-tabs for admin view
      const subtabButtons = document.querySelectorAll('.subtab-btn');
      subtabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetSubtab = button.dataset.subtab;
          
          // Update button styles
          subtabButtons.forEach(btn => {
            btn.classList.remove('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
            btn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          });
          
          button.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
          button.classList.add('border-nfgblue', 'text-nfgblue', 'dark:text-blue-400');
          
          // Show/hide sub-tab content
          document.querySelectorAll('.subtab-content').forEach(content => {
            content.classList.add('hidden');
          });
          
          const targetContent = document.getElementById(`subtab-content-${targetSubtab}`);
          if (targetContent) {
            targetContent.classList.remove('hidden');
          }
          
          // Load sub-tab data
          if (targetSubtab === 'approval') {
            loadPendingTimeEntries();
          } else if (targetSubtab === 'reports') {
            loadTimeReports();
          }
          
          setTimeout(() => {
            if (window.lucide) lucide.createIcons();
          }, 100);
        });
      });
    }

    // ========== TIME TRACKING FUNCTIONS ==========
    
    // Get date range helper
    function getDateRange(period) {
      const now = new Date();
      let startDate, endDate;
      
      if (period === 'custom') {
        startDate = document.getElementById('date-from')?.value;
        endDate = document.getElementById('date-to')?.value;
      } else if (period === 'all') {
        startDate = '2000-01-01';
        endDate = now.toISOString().split('T')[0];
      } else {
        const days = parseInt(period);
        startDate = new Date(now);
        startDate.setDate(startDate.getDate() - days);
        startDate = startDate.toISOString().split('T')[0];
        endDate = now.toISOString().split('T')[0];
      }
      
      return { startDate, endDate };
    }
    
    // Format duration helper
    function formatDuration(seconds) {
      if (!seconds) return '0:00:00';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    // Load time tracking data based on user role
    async function loadTimeTrackingData() {
      if (!currentUser || !currentUserProfile) return;
      
      const isStaff = currentUserProfile.role === 'staff';
      
      if (isStaff) {
        // Show staff view
        document.getElementById('time-sheets-view')?.classList.remove('hidden');
        document.getElementById('time-admin-view')?.classList.add('hidden');
        document.getElementById('time-tracking-title').textContent = 'My Time Sheet';
        await loadMyTimeSheet();
      } else {
        // Show admin view
        document.getElementById('time-sheets-view')?.classList.add('hidden');
        document.getElementById('time-admin-view')?.classList.remove('hidden');
        document.getElementById('time-tracking-title').textContent = 'Time Tracking & Approval';
        await loadStaffList();
        await loadPendingTimeEntries();
        await loadTimeReports();
      }
    }
    
    // Staff: Load my time sheet
    async function loadMyTimeSheet() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        // Fetch time entries
        const { data: timeEntries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .eq('user_id', currentUser.id)
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .order('clock_in', { ascending: false });
        
        if (error) {
          console.error('Error loading time sheet:', error);
          // If table doesn't exist, show empty state
          if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
            document.getElementById('time-entries-table').innerHTML = `
              <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                  Time tracking not yet set up. Please run the database migration.
                </td>
              </tr>
            `;
            return;
          }
          toast.error('Failed to load time sheet: ' + error.message);
          return;
        }
        
        const entries = timeEntries || [];
        
        // Calculate summary metrics
        const totalSeconds = entries.reduce((sum, entry) => sum + (entry.total_duration || 0), 0);
        const overtimeEntries = entries.filter(e => e.is_overtime);
        const overtimeSeconds = overtimeEntries.reduce((sum, entry) => {
          const regularSeconds = 8 * 3600; // 8 hours
          return sum + Math.max(0, (entry.total_duration || 0) - regularSeconds);
        }, 0);
        
        const totalHours = (totalSeconds / 3600).toFixed(1);
        const overtimeHours = (overtimeSeconds / 3600).toFixed(1);
        const pendingCount = entries.filter(e => e.status === 'pending').length;
        
        // Update summary cards
        document.getElementById('time-total-hours').textContent = `${totalHours}h`;
        document.getElementById('time-overtime-hours').textContent = `${overtimeHours}h`;
        document.getElementById('time-pending-count').textContent = pendingCount;
        
        // Calculate average hours per day
        const days = Math.ceil((new Date(endDate + 'T23:59:59') - new Date(startDate + 'T00:00:00')) / (1000 * 60 * 60 * 24)) || 1;
        const avgHours = (totalSeconds / 3600 / days).toFixed(1);
        document.getElementById('time-avg-hours').textContent = `${avgHours}h`;
        
        // Render time entries table
        renderTimeEntriesTable(entries, 'time-entries-table', true);
      } catch (error) {
        console.error('Error in loadMyTimeSheet:', error);
        toast.error('Failed to load time sheet');
      }
    }
    
    // Render time entries table
    function renderTimeEntriesTable(entries, tableId, isStaff = false) {
      const tbody = document.getElementById(tableId);
      if (!tbody) return;
      
      if (entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
              No time entries found for this period
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = entries.map(entry => {
        const date = new Date(entry.clock_in).toLocaleDateString();
        const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const clockOut = entry.clock_out 
          ? new Date(entry.clock_out).toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            })
          : 'In Progress';
        
        const duration = entry.total_duration 
          ? formatDuration(entry.total_duration)
          : 'Calculating...';
        
        const overtimeBadge = entry.is_overtime 
          ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300">Yes</span>'
          : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">No</span>';
        
        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300',
          'approved': 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
          'rejected': 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
        };
        
        const statusBadge = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[entry.status] || statusColors.pending}">${entry.status}</span>`;
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3">${date}</td>
            <td class="px-4 py-3">
              ${entry.jobs?.title || 'General Work'}
              ${entry.jobs?.sites?.name ? `<br><span class="text-xs text-gray-500">${entry.jobs.sites.name}</span>` : ''}
            </td>
            <td class="px-4 py-3">${clockIn}</td>
            <td class="px-4 py-3">${clockOut}</td>
            <td class="px-4 py-3 font-medium">${duration}</td>
            <td class="px-4 py-3">${overtimeBadge}</td>
            <td class="px-4 py-3">${statusBadge}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Admin: Load staff list for filter
    async function loadStaffList() {
      try {
        const { data: staff, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email')
          .eq('role', 'staff')
          .order('full_name');
        
        if (error) {
          console.error('Error loading staff list:', error);
          return;
        }
        
        const select = document.getElementById('approval-filter-staff');
        if (!select) return;
        
        // Clear existing options except "All Staff"
        select.innerHTML = '<option value="">All Staff</option>';
        
        staff.forEach(member => {
          const option = document.createElement('option');
          option.value = member.id;
          option.textContent = member.full_name || member.email;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error in loadStaffList:', error);
      }
    }
    
    // Admin: Load pending time entries
    async function loadPendingTimeEntries() {
      try {
        const staffFilter = document.getElementById('approval-filter-staff')?.value || '';
        const statusFilter = document.getElementById('approval-filter-status')?.value || 'pending';
        
        let query = supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))');
        
        if (statusFilter) {
          query = query.eq('status', statusFilter);
        }
        
        if (staffFilter) {
          query = query.eq('user_id', staffFilter);
        }
        
        const { data: entries, error } = await query.order('clock_in', { ascending: false });
        
        if (error) throw error;
        
        // Fetch user profiles separately
        if (entries && entries.length > 0) {
          const userIds = [...new Set(entries.map(e => e.user_id))];
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', userIds);
          
          // Merge profiles into entries
          const profilesMap = {};
          (profiles || []).forEach(p => {
            profilesMap[p.id] = p;
          });
          
          entries.forEach(entry => {
            entry.user_profiles = profilesMap[entry.user_id] || null;
          });
        }
        
        renderPendingTimeEntriesTable(entries || []);
      } catch (error) {
        console.error('Error in loadPendingTimeEntries:', error);
        if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
          document.getElementById('pending-time-entries-table').innerHTML = `
            <tr>
              <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                Time tracking not yet set up. Please run the database migration.
              </td>
            </tr>
          `;
        } else {
          toast.error('Failed to load pending entries: ' + (error.message || 'Unknown error'));
        }
      }
    }
    
    // Render pending time entries for admin approval
    function renderPendingTimeEntriesTable(entries) {
      const tbody = document.getElementById('pending-time-entries-table');
      if (!tbody) return;
      
      if (entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
              No pending time entries
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = entries.map(entry => {
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        const date = new Date(entry.clock_in).toLocaleDateString();
        const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const clockOut = entry.clock_out 
          ? new Date(entry.clock_out).toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              hour12: true 
            })
          : 'In Progress';
        
        const duration = entry.total_duration 
          ? formatDuration(entry.total_duration)
          : 'Calculating...';
        
        const overtimeBadge = entry.is_overtime 
          ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300">Yes</span>'
          : '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">No</span>';
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3">
              <input type="checkbox" class="time-entry-checkbox rounded" data-entry-id="${entry.id}">
            </td>
            <td class="px-4 py-3 font-medium">${staffName}</td>
            <td class="px-4 py-3">${date}</td>
            <td class="px-4 py-3">
              ${entry.jobs?.title || 'General Work'}
            </td>
            <td class="px-4 py-3">${clockIn}</td>
            <td class="px-4 py-3">${clockOut}</td>
            <td class="px-4 py-3 font-medium">${duration}</td>
            <td class="px-4 py-3">${overtimeBadge}</td>
            <td class="px-4 py-3">
              ${entry.status === 'pending' ? `
                <div class="flex gap-2">
                  <button 
                    onclick="approveTimeEntry('${entry.id}')" 
                    class="px-3 py-1 rounded-lg bg-green-600 text-white hover:bg-green-700 text-xs"
                  >
                    Approve
                  </button>
                  <button 
                    onclick="rejectTimeEntry('${entry.id}')" 
                    class="px-3 py-1 rounded-lg bg-red-600 text-white hover:bg-red-700 text-xs"
                  >
                    Reject
                  </button>
                </div>
              ` : `
                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                  entry.status === 'approved' 
                    ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' 
                    : 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
                }">${entry.status}</span>
              `}
            </td>
          </tr>
        `;
      }).join('');
      
      // Attach checkbox listeners
      attachCheckboxListeners();
    }
    
    // Attach checkbox listeners for bulk approval
    function attachCheckboxListeners() {
      const selectAll = document.getElementById('select-all-time-entries');
      const checkboxes = document.querySelectorAll('.time-entry-checkbox');
      
      if (selectAll) {
        selectAll.addEventListener('change', (e) => {
          checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
          });
        });
      }
    }
    
    // Approve time entry (global function for onclick)
    window.approveTimeEntry = async function(entryId) {
      const confirmed = await showConfirm('Approve this time entry?', 'Approve Time Entry');
      if (!confirmed) return;
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'approved',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString()
        })
        .eq('id', entryId);
      
      if (error) {
        console.error('Error approving entry:', error);
        toast.error('Failed to approve time entry');
        return;
      }
      
      toast.success('Time entry approved');
      await loadPendingTimeEntries();
      await loadTimeReports();
      if (currentUserProfile?.role === 'staff') {
        await loadMyTimeSheet();
      }
    };
    
    // Reject time entry (global function for onclick)
    window.rejectTimeEntry = async function(entryId) {
      const reason = await showPrompt('Rejection reason (optional):', 'Reject Time Entry', '');
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'rejected',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString(),
          notes: reason || 'Rejected by admin'
        })
        .eq('id', entryId);
      
      if (error) {
        console.error('Error rejecting entry:', error);
        toast.error('Failed to reject time entry');
        return;
      }
      
      toast.success('Time entry rejected');
      await loadPendingTimeEntries();
      await loadTimeReports();
    };
    
    // Bulk approve selected entries
    async function bulkApproveTimeEntries() {
      const checkboxes = document.querySelectorAll('.time-entry-checkbox:checked');
      const entryIds = Array.from(checkboxes).map(cb => cb.dataset.entryId);
      
      if (entryIds.length === 0) {
        toast.error('Please select at least one time entry');
        return;
      }
      
      const confirmed = await showConfirm(
        `Approve ${entryIds.length} selected time ${entryIds.length === 1 ? 'entry' : 'entries'}?`,
        'Bulk Approve'
      );
      if (!confirmed) return;
      
      const { error } = await supabase
        .from('staff_time_logs')
        .update({
          status: 'approved',
          approved_by: currentUser.id,
          approved_at: new Date().toISOString()
        })
        .in('id', entryIds);
      
      if (error) {
        console.error('Error bulk approving entries:', error);
        toast.error('Failed to approve time entries');
        return;
      }
      
      toast.success(`${entryIds.length} time ${entryIds.length === 1 ? 'entry' : 'entries'} approved`);
      await loadPendingTimeEntries();
      await loadTimeReports();
    }
    
    // Admin: Load time reports
    async function loadTimeReports() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        // Fetch all time entries
        const { data: timeEntries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .eq('status', 'approved'); // Only approved entries for reports
        
        if (error) throw error;
        
        // Fetch user profiles separately
        if (timeEntries && timeEntries.length > 0) {
          const userIds = [...new Set(timeEntries.map(e => e.user_id))];
          const { data: profiles } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', userIds);
          
          // Merge profiles into entries
          const profilesMap = {};
          (profiles || []).forEach(p => {
            profilesMap[p.id] = p;
          });
          
          timeEntries.forEach(entry => {
            entry.user_profiles = profilesMap[entry.user_id] || null;
          });
        }
        
        const entries = timeEntries || [];
        
        // Calculate metrics
        const totalSeconds = entries.reduce((sum, e) => sum + (e.total_duration || 0), 0);
        const overtimeEntries = entries.filter(e => e.is_overtime);
        const overtimeSeconds = overtimeEntries.reduce((sum, e) => {
          const regularSeconds = 8 * 3600;
          return sum + Math.max(0, (e.total_duration || 0) - regularSeconds);
        }, 0);
        
        // Count pending entries
        const { data: pendingEntries } = await supabase
          .from('staff_time_logs')
          .select('id')
          .eq('status', 'pending');
        
        const activeStaff = [...new Set(entries.map(e => e.user_id))].length;
        
        // Update metrics
        document.getElementById('admin-total-hours').textContent = `${(totalSeconds / 3600).toFixed(1)}h`;
        document.getElementById('admin-overtime-hours').textContent = `${(overtimeSeconds / 3600).toFixed(1)}h`;
        document.getElementById('admin-pending-count').textContent = pendingEntries?.length || 0;
        document.getElementById('admin-active-staff').textContent = activeStaff;
        
        // Create charts
        createHoursByStaffChart(entries);
        createDailyHoursTrendChart(entries);
        
        // Render staff summary table
        renderStaffTimeSummaryTable(entries, startDate, endDate);
      } catch (error) {
        console.error('Error in loadTimeReports:', error);
        if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
          // Table doesn't exist yet - silently return
          return;
        }
        toast.error('Failed to load time reports: ' + (error.message || 'Unknown error'));
      }
    }
    
    // Create hours by staff chart
    function createHoursByStaffChart(entries) {
      const ctx = document.getElementById('hours-by-staff-chart');
      if (!ctx) return;
      
      // Group by staff
      const staffHours = {};
      entries.forEach(entry => {
        const staffId = entry.user_id;
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        if (!staffHours[staffId]) {
          staffHours[staffId] = { name: staffName, hours: 0 };
        }
        staffHours[staffId].hours += (entry.total_duration || 0) / 3600;
      });
      
      const sortedStaff = Object.values(staffHours)
        .sort((a, b) => b.hours - a.hours)
        .slice(0, 10);
      
      if (hoursByStaffChart) {
        hoursByStaffChart.destroy();
      }
      
      const themeColors = {
        text: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937',
        tooltipBg: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
        tooltipBorder: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB'
      };
      
      hoursByStaffChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedStaff.map(s => s.name),
          datasets: [{
            label: 'Hours',
            data: sortedStaff.map(s => s.hours.toFixed(1)),
            backgroundColor: '#0D47A1',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: themeColors.tooltipBg,
              borderColor: themeColors.tooltipBorder,
              borderWidth: 1,
              titleColor: themeColors.text,
              bodyColor: themeColors.text
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: themeColors.text },
              grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB' }
            },
            x: {
              ticks: { color: themeColors.text },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Create daily hours trend chart
    function createDailyHoursTrendChart(entries) {
      const ctx = document.getElementById('daily-hours-trend-chart');
      if (!ctx) return;
      
      // Group by date
      const dailyHours = {};
      entries.forEach(entry => {
        const date = new Date(entry.clock_in).toISOString().split('T')[0];
        if (!dailyHours[date]) {
          dailyHours[date] = 0;
        }
        dailyHours[date] += (entry.total_duration || 0) / 3600;
      });
      
      // Sort dates
      const sortedDates = Object.keys(dailyHours).sort();
      const hours = sortedDates.map(date => dailyHours[date]);
      
      if (dailyHoursTrendChart) {
        dailyHoursTrendChart.destroy();
      }
      
      const themeColors = {
        text: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937',
        tooltipBg: document.documentElement.classList.contains('dark') ? '#1F2937' : '#FFFFFF',
        tooltipBorder: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB'
      };
      
      dailyHoursTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: sortedDates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'Hours',
            data: hours,
            borderColor: '#0D47A1',
            backgroundColor: 'rgba(13, 71, 161, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: themeColors.tooltipBg,
              borderColor: themeColors.tooltipBorder,
              borderWidth: 1,
              titleColor: themeColors.text,
              bodyColor: themeColors.text
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: themeColors.text },
              grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB' }
            },
            x: {
              ticks: { color: themeColors.text },
              grid: { display: false }
            }
          }
        }
      });
    }
    
    // Render staff time summary table
    function renderStaffTimeSummaryTable(entries, startDate, endDate) {
      const tbody = document.getElementById('staff-time-summary-table');
      if (!tbody) return;
      
      // Group by staff
      const staffStats = {};
      entries.forEach(entry => {
        const staffId = entry.user_id;
        const staffName = entry.user_profiles?.full_name || entry.user_profiles?.email || 'Unknown';
        if (!staffStats[staffId]) {
          staffStats[staffId] = {
            name: staffName,
            totalSeconds: 0,
            regularSeconds: 0,
            overtimeSeconds: 0,
            jobCount: 0,
            uniqueJobs: new Set()
          };
        }
        const seconds = entry.total_duration || 0;
        staffStats[staffId].totalSeconds += seconds;
        staffStats[staffId].uniqueJobs.add(entry.job_id);
        
        if (entry.is_overtime) {
          const regularSeconds = 8 * 3600;
          const overtimeSecs = Math.max(0, seconds - regularSeconds);
          staffStats[staffId].overtimeSeconds += overtimeSecs;
          staffStats[staffId].regularSeconds += regularSeconds;
        } else {
          staffStats[staffId].regularSeconds += seconds;
        }
      });
      
      const staffArray = Object.values(staffStats).map(stats => ({
        ...stats,
        jobCount: stats.uniqueJobs.size
      }));
      
      if (staffArray.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
              No time data available
            </td>
          </tr>
        `;
        return;
      }
      
      const days = Math.ceil((new Date(endDate + 'T23:59:59') - new Date(startDate + 'T00:00:00')) / (1000 * 60 * 60 * 24)) || 1;
      
      tbody.innerHTML = staffArray.map(stats => {
        const totalHours = (stats.totalSeconds / 3600).toFixed(1);
        const regularHours = (stats.regularSeconds / 3600).toFixed(1);
        const overtimeHours = (stats.overtimeSeconds / 3600).toFixed(1);
        const avgHours = (stats.totalSeconds / 3600 / days).toFixed(1);
        
        return `
          <tr class="hover:bg-nfglight dark:hover:bg-gray-700">
            <td class="px-4 py-3 font-medium">${stats.name}</td>
            <td class="px-4 py-3">${totalHours}h</td>
            <td class="px-4 py-3">${regularHours}h</td>
            <td class="px-4 py-3 text-orange-600">${overtimeHours}h</td>
            <td class="px-4 py-3">${stats.jobCount}</td>
            <td class="px-4 py-3">${avgHours}h</td>
          </tr>
        `;
      }).join('');
    }
    
    // Export time sheet to CSV
    async function exportTimeSheet() {
      try {
        const timePeriod = document.getElementById('time-period')?.value || '30';
        const { startDate, endDate } = getDateRange(timePeriod);
        
        const { data: entries, error } = await supabase
          .from('staff_time_logs')
          .select('*, jobs(title, sites(name))')
          .eq('user_id', currentUser.id)
          .gte('clock_in', startDate + 'T00:00:00')
          .lte('clock_in', endDate + 'T23:59:59')
          .order('clock_in', { ascending: false });
        
        if (error) {
          toast.error('Failed to export time sheet: ' + error.message);
          return;
        }
        
        // Create CSV
        const headers = ['Date', 'Job', 'Site', 'Clock In', 'Clock Out', 'Duration', 'Overtime', 'Status'];
        const rows = entries.map(entry => {
          const date = new Date(entry.clock_in).toLocaleDateString();
          const clockIn = new Date(entry.clock_in).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const clockOut = entry.clock_out ? new Date(entry.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : 'In Progress';
          const duration = entry.total_duration ? formatDuration(entry.total_duration) : '0:00:00';
          return [
            date,
            entry.jobs?.title || 'General Work',
            entry.jobs?.sites?.name || '',
            clockIn,
            clockOut,
            duration,
            entry.is_overtime ? 'Yes' : 'No',
            entry.status
          ];
        });
        
        const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `time-sheet-${startDate}-to-${endDate}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        toast.success('Time sheet exported successfully');
      } catch (error) {
        console.error('Error exporting time sheet:', error);
        toast.error('Failed to export time sheet');
      }
    }

    // Initialize
    async function init() {
      console.log('[Reports] ðŸš€ Initializing Reports page...');
      
      const user = await getCurrentUser();
      if (!user) {
        console.error('[Reports] âŒ No user found, initialization aborted');
        return;
      }
      
      console.log('[Reports] âœ… User authenticated:', user.email);
      console.log('[Reports] ðŸ‘¤ User role:', currentUserProfile?.role || 'unknown');
      
      // Update page description and Bookings link for staff
      if (currentUserProfile && currentUserProfile.role === 'staff') {
        const descriptionEl = document.getElementById('reports-description');
        if (descriptionEl) {
          descriptionEl.textContent = 'View your time tracking and time sheets';
        }
        
        const bookingsNav = document.getElementById('nav-bookings');
        if (bookingsNav) {
          const bookingsText = bookingsNav.querySelector('span') || bookingsNav.childNodes[bookingsNav.childNodes.length - 1];
          if (bookingsText && bookingsText.textContent) {
            bookingsText.textContent = 'Schedule';
          } else {
            bookingsNav.innerHTML = '<i data-lucide="calendar" class="w-4 h-4"></i> Schedule';
            if (window.lucide) lucide.createIcons();
          }
        }
        
        // Auto-switch to Time Tracking tab for staff
        const timeTrackingTab = document.getElementById('tab-time-tracking');
        if (timeTrackingTab) {
          setTimeout(() => {
            timeTrackingTab.click();
          }, 500);
        }
      }

      // Load initial data
      console.log('[Reports] ðŸ“Š Loading initial reports data...');
      await refreshReports();

      // Event listeners
      const timePeriodSelect = document.getElementById('time-period');
      const customDateRange = document.getElementById('custom-date-range');
      const applyDateRangeBtn = document.getElementById('apply-date-range');
      
      timePeriodSelect?.addEventListener('change', (e) => {
        if (e.target.value === 'custom') {
          customDateRange?.classList.remove('hidden');
          // Set default dates (last 30 days)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);
          document.getElementById('date-to')?.setAttribute('value', endDate.toISOString().split('T')[0]);
          document.getElementById('date-from')?.setAttribute('value', startDate.toISOString().split('T')[0]);
        } else {
          customDateRange?.classList.add('hidden');
          refreshReports();
        }
      });
      
      applyDateRangeBtn?.addEventListener('click', refreshReports);
      document.getElementById('refresh-btn')?.addEventListener('click', refreshReports);
      document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);
      document.getElementById('print-btn')?.addEventListener('click', printReport);
      
      // Time tracking event listeners
      document.getElementById('export-time-sheet-btn')?.addEventListener('click', exportTimeSheet);
      document.getElementById('bulk-approve-btn')?.addEventListener('click', bulkApproveTimeEntries);
      document.getElementById('approval-filter-staff')?.addEventListener('change', loadPendingTimeEntries);
      document.getElementById('approval-filter-status')?.addEventListener('change', loadPendingTimeEntries);
      
      // Initialize tabs
      initTabs();
      
      // Allow Enter key to apply date range
      document.getElementById('date-from')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshReports();
      });
      document.getElementById('date-to')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshReports();
      });
      
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
        console.log('[Reports] ðŸŽ¨ Lucide icons initialized');
      }
      
      console.log('[Reports] âœ… Initialization complete!');
    }

    // Wait for DOM to be fully loaded before initializing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Logout functionality
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = './index.html'
    });
  </script>
  
  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>

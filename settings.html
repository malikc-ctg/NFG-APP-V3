<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings ‚Äî NFG Dashboard</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Notifications -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- CSV Import Styles -->
  <style>
    /* Step Indicator Styles */
    #import-step-indicator {
      position: relative;
    }
    
    .step-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      flex: 1;
      min-width: 0;
    }
    
    .step-number {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      border: 2px solid #E5E7EB;
      background: white;
      color: #9CA3AF;
      transition: all 0.3s;
    }
    
    .dark .step-number {
      border-color: #374151;
      background: #1F2937;
      color: #6B7280;
    }
    
    .step-indicator.active .step-number {
      border-color: #0D47A1;
      background: #0D47A1;
      color: white;
    }
    
    .dark .step-indicator.active .step-number {
      border-color: #3B82F6;
      background: #3B82F6;
      color: white;
    }
    
    .step-indicator.completed .step-number {
      border-color: #10B981;
      background: #10B981;
      color: white;
    }
    
    .step-label {
      font-size: 0.75rem;
      color: #9CA3AF;
      text-align: center;
    }
    
    .dark .step-label {
      color: #6B7280;
    }
    
    .step-indicator.active .step-label {
      color: #0D47A1;
      font-weight: 600;
    }
    
    .dark .step-indicator.active .step-label {
      color: #3B82F6;
    }
    
    .step-line {
      position: absolute;
      top: 1rem;
      left: 50%;
      right: -50%;
      height: 2px;
      background: #E5E7EB;
      z-index: -1;
    }
    
    .dark .step-line {
      background: #374151;
    }
    
    .step-indicator:last-child .step-line {
      display: none;
    }
    
    .step-indicator.completed + .step-indicator .step-line,
    .step-indicator.active + .step-indicator .step-line {
      background: #10B981;
    }
    
    /* Import Step Styles */
    .import-step {
      display: none;
    }
    
    .import-step.active {
      display: block;
    }
  </style>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>
  
  <script type="module" src="./js/pwa.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>
</head>
<body class="bg-nfbg dark:bg-gray-900 font-inter">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Settings...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-nfgray dark:border-gray-700 hidden md:flex md:flex-col transition-all">
      <div class="p-5 flex items-center justify-center">
        <!-- Northern Facilities Group Logo -->
        <img 
          src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
          alt="Northern Facilities Group" 
          class="h-32 w-auto"
        />
      </div>

      <nav class="flex-1 px-3 space-y-1">
        <a href="./dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span>Overview</span>
        </a>
        <a href="./sites.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="building-2" class="w-5 h-5"></i>
          <span>Sites</span>
        </a>
        <a id="nav-bookings" href="./bookings.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="calendar" class="w-5 h-5"></i>
          <span>Bookings</span>
        </a>
        <a href="./jobs.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="briefcase" class="w-5 h-5"></i>
          <span>Jobs</span>
        </a>
        <a href="./inventory.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="package" class="w-5 h-5"></i>
          <span>Inventory</span>
        </a>
        <a id="nav-reports" href="./reports.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
          <span>Reports</span>
        </a>
        <a id="nav-messages" href="./messages.html" class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 text-nftext dark:text-gray-200 transition">
          <i data-lucide="message-circle" class="w-5 h-5"></i>
          <span>Messages</span>
        </a>
        <a href="./settings.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 transition">
          <i data-lucide="settings" class="w-5 h-5"></i>
          <span>Settings</span>
        </a>
      </nav>

      <div class="p-4 border-t border-nfgray dark:border-gray-700">
        <button id="logout-btn" class="w-full flex items-center gap-2 px-4 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight text-nftext dark:text-gray-200 transition">
          <i data-lucide="log-out" class="w-4 h-4"></i>
          <span>Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0">
      <!-- TOPBAR -->
      <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
        <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
          <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
            <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
              <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
            </button>
            <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Settings</h1>
          </div>

          <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
            <!-- Notification Bell (will be injected by notification-center.js) -->
          </div>
        </div>
      </header>
      
      <main class="flex-1 overflow-y-auto p-4 md:p-6">
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Manage your account and application preferences</p>
        
        <div class="space-y-6 max-w-4xl mx-auto">
        
        <!-- Account Settings -->
        <section class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
              <i data-lucide="user" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Account Settings</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Manage your profile information</p>
            </div>
          </div>
          
          <div class="space-y-6">
            <!-- Profile Picture -->
            <div>
              <label class="block text-sm font-medium mb-3">Profile Picture</label>
              <div class="flex items-center gap-4">
                <div class="relative">
                  <img 
                    id="profile-picture-preview" 
                    src="https://ui-avatars.com/api/?name=User&size=128&background=E3ECFA&color=0D47A1" 
                    alt="Profile Picture" 
                    class="w-24 h-24 rounded-full object-cover border-2 border-nfgray dark:border-gray-700" />
                  <div id="profile-upload-loading" class="hidden absolute inset-0 bg-black/50 rounded-full flex items-center justify-center">
                    <i data-lucide="loader" class="w-6 h-6 text-white animate-spin"></i>
                  </div>
                </div>
                <div class="flex-1">
                  <input 
                    type="file" 
                    id="profile-picture-input" 
                    accept="image/*" 
                    class="hidden" />
                  <button 
                    id="upload-profile-picture-btn" 
                    class="px-4 py-2 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight transition">
                    <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                    Upload Photo
                  </button>
                  <p class="text-xs text-gray-500 mt-2">JPG, PNG or GIF. Max 5MB.</p>
                </div>
              </div>
            </div>

            <div class="border-t border-nfgray dark:border-gray-700 pt-6">
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-1.5">Email Address</label>
                  <input 
                    id="user-email" 
                    type="email" 
                    readonly 
                    class="w-full border border-nfgray dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-xl p-2.5 bg-gray-50 text-gray-600 dark:text-gray-400" 
                    value="Loading..." />
                </div>
                
                <div>
                  <label class="block text-sm font-medium mb-1.5">Display Name</label>
                  <input 
                    id="user-display-name" 
                    type="text" 
                    placeholder="Your name" 
                    class="w-full border border-nfgray dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
                </div>
                
                <!-- Dark Mode Toggle -->
                <div>
                  <label class="block text-sm font-medium mb-3">Theme</label>
                  <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                    <div>
                      <p class="font-medium text-gray-900 dark:text-gray-100">Dark Mode</p>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Toggle between light and dark theme</p>
                    </div>
                    <label class="switch">
                      <input checked="true" id="dark-mode-toggle" type="checkbox" />
                      <span class="slider">
                        <div class="star star_1"></div>
                        <div class="star star_2"></div>
                        <div class="star star_3"></div>
                        <svg viewBox="0 0 16 16" class="cloud_1 cloud">
                          <path
                            transform="matrix(.77976 0 0 .78395-299.99-418.63)"
                            fill="#fff"
                            d="m391.84 540.91c-.421-.329-.949-.524-1.523-.524-1.351 0-2.451 1.084-2.485 2.435-1.395.526-2.388 1.88-2.388 3.466 0 1.874 1.385 3.423 3.182 3.667v.034h12.73v-.006c1.775-.104 3.182-1.584 3.182-3.395 0-1.747-1.309-3.186-2.994-3.379.007-.106.011-.214.011-.322 0-2.707-2.271-4.901-5.072-4.901-2.073 0-3.856 1.202-4.643 2.925"
                          ></path>
                        </svg>
                      </span>
                    </label>
                  </div>
                </div>
                
                <button id="save-profile-btn" class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition">
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- User Management Section -->
        <section id="user-management-section" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-4 md:p-6">
          <div class="flex items-center justify-between gap-3 mb-4">
            <div class="flex items-center gap-2 md:gap-3 min-w-0">
              <div class="w-8 h-8 md:w-10 md:h-10 flex-shrink-0 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
                <i data-lucide="users" class="w-4 h-4 md:w-5 md:h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <div class="min-w-0">
                <h3 class="text-base md:text-lg font-semibold text-nfgblue dark:text-blue-400">User Management</h3>
                <p class="text-xs md:text-sm text-gray-500 truncate">Invite and manage team members</p>
              </div>
            </div>
            <button id="invite-user-btn" class="hidden items-center gap-1.5 md:gap-2 px-3 py-2 md:px-4 bg-nfgblue dark:bg-blue-900 text-white rounded-xl hover:bg-nfgdark transition text-sm flex-shrink-0">
              <i data-lucide="user-plus" class="w-4 h-4"></i>
              <span class="hidden sm:inline">Invite User</span>
            </button>
          </div>
          
          <div id="users-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin"></i>
              <p class="mt-2">Loading users...</p>
            </div>
          </div>

          <div id="pending-invitations-container" class="mt-6 pt-4 border-t border-nfgray hidden">
            <h4 class="text-sm md:text-base font-semibold text-nfgblue dark:text-blue-400 mb-3 flex items-center gap-2">
              <i data-lucide="mail" class="w-4 h-4"></i>
              Pending Invitations
            </h4>
            <div id="pending-invitations-list" class="space-y-2 md:space-y-3">
              <!-- Populated by JS -->
            </div>
          </div>
        </section>

        <!-- Data Import Section -->
        <section id="data-import-section" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-4 md:p-6">
          <div class="flex items-center justify-between gap-3 mb-4">
            <div class="flex items-center gap-2 md:gap-3 min-w-0">
              <div class="w-8 h-8 md:w-10 md:h-10 flex-shrink-0 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
                <i data-lucide="upload" class="w-4 h-4 md:w-5 md:h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <div class="min-w-0">
                <h3 class="text-base md:text-lg font-semibold text-nfgblue dark:text-blue-400">Data Import</h3>
                <p class="text-xs md:text-sm text-gray-500 truncate">Import data from CSV files</p>
              </div>
            </div>
            <button id="open-import-modal-btn" class="items-center gap-1.5 md:gap-2 px-3 py-2 md:px-4 bg-nfgblue dark:bg-blue-900 text-white rounded-xl hover:bg-nfgdark transition text-sm flex-shrink-0 flex">
              <i data-lucide="upload-cloud" class="w-4 h-4"></i>
              <span class="hidden sm:inline">Import Data</span>
            </button>
          </div>
          
          <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
            <p>Migrate data from your existing platform quickly and easily.</p>
            <ul class="list-disc list-inside space-y-1 ml-2">
              <li>Import sites, jobs, users, and bookings</li>
              <li>Automatic column mapping</li>
              <li>Data validation before import</li>
              <li>Error reporting for failed rows</li>
            </ul>
          </div>
        </section>

        <!-- Notifications -->
        <section class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-6">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
              <i data-lucide="bell" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Notification Preferences</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Control how you receive notifications</p>
            </div>
          </div>
          
          <!-- General Preferences -->
          <div class="mb-6 pb-4 border-b border-nfgray dark:border-gray-700">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">General Settings</h4>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Email Notifications</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Receive notifications via email</p>
                </div>
                <input type="checkbox" id="notif-email-enabled" class="toggle-checkbox" data-pref="email_enabled">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">In-App Notifications</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Show notifications in the app</p>
                </div>
                <input type="checkbox" id="notif-in-app-enabled" class="toggle-checkbox" data-pref="in_app_enabled">
              </label>
              
              <div class="p-4 bg-nfglight/40 dark:bg-gray-700/40 rounded-xl border border-nfgblue/20 dark:border-blue-900/30">
                <div class="flex items-start gap-3">
                  <div class="w-9 h-9 rounded-full bg-nfgblue/10 text-nfgblue dark:text-blue-400 dark:bg-blue-900/30 flex items-center justify-center">
                    <i data-lucide="bell" class="w-4 h-4"></i>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-medium">Push Notifications</span>
                      <span id="push-permission-badge" class="text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300"></span>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
                      Receive instant alerts even when the app is closed. Browser permission required.
                    </p>
                    <div class="flex items-center gap-3 flex-wrap">
                      <button id="settings-toggle-push-btn" class="px-4 py-2 text-sm font-medium rounded-lg border border-nfgblue text-nfgblue hover:bg-nfglight dark:text-blue-400 dark:border-blue-400 dark:hover:bg-gray-600 transition">
                        Loading...
                      </button>
                      <span id="settings-push-status" class="text-xs text-gray-500 dark:text-gray-400"></span>
                    </div>
                    <input type="hidden" id="notif-push-enabled" value="true">
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Job Notifications -->
          <div class="mb-6 pb-4 border-b border-nfgray dark:border-gray-700">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Job Notifications</h4>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Job Assigned</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When you're assigned to a job</p>
                </div>
                <input type="checkbox" id="notif-job-assigned" class="toggle-checkbox" data-pref="job_assigned">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Job Completed</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When a job you're watching is completed</p>
                </div>
                <input type="checkbox" id="notif-job-completed" class="toggle-checkbox" data-pref="job_completed">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Job Updated</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When a job is modified</p>
                </div>
                <input type="checkbox" id="notif-job-updated" class="toggle-checkbox" data-pref="job_updated">
              </label>
            </div>
          </div>
          
          <!-- Site & Booking Notifications -->
          <div class="mb-6 pb-4 border-b border-nfgray dark:border-gray-700">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Site & Booking Notifications</h4>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Site Assigned</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When you're assigned to a site</p>
                </div>
                <input type="checkbox" id="notif-site-assigned" class="toggle-checkbox" data-pref="site_assigned">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Booking Created</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When a new booking is created</p>
                </div>
                <input type="checkbox" id="notif-booking-created" class="toggle-checkbox" data-pref="booking_created">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Booking Updated</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When a booking is modified</p>
                </div>
                <input type="checkbox" id="notif-booking-updated" class="toggle-checkbox" data-pref="booking_updated">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Booking Cancelled</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When a booking is cancelled</p>
                </div>
                <input type="checkbox" id="notif-booking-cancelled" class="toggle-checkbox" data-pref="booking_cancelled">
              </label>
            </div>
          </div>
          
          <!-- Other Notifications -->
          <div>
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Other Notifications</h4>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">Mentions</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">When you're mentioned in comments</p>
                </div>
                <input type="checkbox" id="notif-mention" class="toggle-checkbox" data-pref="mention">
              </label>
              
              <label class="flex items-center justify-between cursor-pointer">
                <div>
                  <span class="font-medium">System Notifications</span>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Important system updates and alerts</p>
                </div>
                <input type="checkbox" id="notif-system" class="toggle-checkbox" data-pref="system">
              </label>
            </div>
          </div>
          
          <div class="mt-6 pt-4 border-t border-nfgray dark:border-gray-700">
            <button id="save-notification-preferences-btn" class="w-full px-4 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium">
              Save Preferences
            </button>
          </div>
        </section>

        <!-- Data Management -->
        <section class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
              <i data-lucide="database" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Data Management</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Export or clear your data</p>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-3">
            <button id="export-data-btn" class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight transition inline-flex items-center gap-2">
              <i data-lucide="download" class="w-4 h-4"></i>
              Export Data
            </button>
            <button id="clear-data-btn" class="px-5 py-2.5 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 transition inline-flex items-center gap-2">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
              Clear All Data
            </button>
          </div>
        </section>

        <!-- Compliance & Insurance -->
        <section id="compliance-section" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
              <i data-lucide="shield-check" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Compliance & Insurance</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Upload and manage important documents</p>
            </div>
          </div>
          
          <div class="space-y-4">
            <!-- Document Categories -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- WSIB -->
              <div class="border border-nfgray rounded-xl p-4">
                <div class="flex items-center gap-2 mb-3">
                  <i data-lucide="file-text" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
                  <h4 class="font-semibold text-nfgblue dark:text-blue-400">WSIB</h4>
                </div>
                <input type="file" id="wsib-upload" accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                <button onclick="document.getElementById('wsib-upload').click()" class="w-full px-3 py-2 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight text-sm transition">
                  <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                  Upload WSIB
                </button>
                <div id="wsib-list" class="mt-3 space-y-2">
                  <!-- Documents will be listed here -->
                </div>
              </div>

              <!-- Insurance -->
              <div class="border border-nfgray rounded-xl p-4">
                <div class="flex items-center gap-2 mb-3">
                  <i data-lucide="shield" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
                  <h4 class="font-semibold text-nfgblue dark:text-blue-400">Insurance</h4>
                </div>
                <input type="file" id="insurance-upload" accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                <button onclick="document.getElementById('insurance-upload').click()" class="w-full px-3 py-2 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight text-sm transition">
                  <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                  Upload Insurance
                </button>
                <div id="insurance-list" class="mt-3 space-y-2">
                  <!-- Documents will be listed here -->
                </div>
              </div>

              <!-- Licenses -->
              <div class="border border-nfgray rounded-xl p-4">
                <div class="flex items-center gap-2 mb-3">
                  <i data-lucide="award" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
                  <h4 class="font-semibold text-nfgblue dark:text-blue-400">Licenses</h4>
                </div>
                <input type="file" id="license-upload" accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                <button onclick="document.getElementById('license-upload').click()" class="w-full px-3 py-2 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight text-sm transition">
                  <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                  Upload License
                </button>
                <div id="license-list" class="mt-3 space-y-2">
                  <!-- Documents will be listed here -->
                </div>
              </div>
            </div>

            <!-- Info Box -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm">
              <p class="text-blue-900"><strong>üìÑ Accepted formats:</strong> PDF, JPG, PNG</p>
              <p class="text-blue-900 mt-1"><strong>üìè Maximum size:</strong> 10MB per file</p>
              <p class="text-blue-800 mt-2 text-xs">All documents are stored securely and encrypted.</p>
            </div>
          </div>
        </section>

        <!-- About -->
        <section class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
              <i data-lucide="info" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">About</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">Application information</p>
            </div>
          </div>
          
          <div class="text-sm text-gray-600 space-y-1">
            <p><strong>Version:</strong> 3.0.0</p>
            <p><strong>Last Updated:</strong> January 2025</p>
            <p class="text-xs text-gray-500 mt-3">¬© 2025 Northern Facilities Group. All rights reserved.</p>
          </div>
        </section>
        
        </div>
      </main>
    </div>
  </div>

  <!-- Invite User Modal -->
  <div id="inviteUserModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Invite New User</h4>
        <button id="close-invite-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="invite-user-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Email Address <span class="text-red-500">*</span></label>
          <input 
            type="email" 
            name="email" 
            required 
            placeholder="user@example.com"
            class="w-full border border-nfgray dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Role <span class="text-red-500">*</span></label>
          <select 
            name="role" 
            required 
            data-custom-dropdown="true"
            data-placeholder="Select role">
            <option value="staff" selected>Staff</option>
            <option value="client">Client</option>
            <option value="admin">Admin</option>
          </select>
          <p class="text-xs text-gray-500 mt-1.5">
            <strong>Staff:</strong> Can view assigned jobs<br>
            <strong>Client:</strong> Can manage jobs and staff<br>
            <strong>Admin:</strong> Full system access
          </p>
        </div>

        <div id="invite-form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button 
            type="button" 
            id="cancel-invite-btn" 
            class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button 
            type="submit" 
            id="submit-invite-btn" 
            class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Send Invitation
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- User Details Modal -->
  <div id="userDetailsModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">User Details</h4>
        <button id="close-user-details-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="p-6 space-y-6">
        <!-- User Info -->
        <div class="flex items-center gap-4">
          <div id="user-detail-avatar-container" class="w-16 h-16 rounded-full bg-nfglight dark:bg-gray-700 flex items-center justify-center">
            <i data-lucide="user" class="w-8 h-8 text-nfgblue dark:text-blue-400"></i>
          </div>
          <div class="flex-1">
            <h5 id="user-detail-name" class="text-xl font-semibold text-nfgblue dark:text-blue-400">User Name</h5>
            <p id="user-detail-email" class="text-gray-600 dark:text-gray-400">user@example.com</p>
            <div class="flex items-center gap-2 mt-2">
              <span id="user-detail-role-badge" class="px-2 py-0.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 dark:text-gray-300">Staff</span>
              <span id="user-detail-status-badge" class="px-2 py-0.5 rounded-lg text-xs font-medium bg-green-100 text-green-700">Active</span>
            </div>
          </div>
        </div>

        <!-- Role Management (Admin/Client only) -->
        <div id="role-management-section" class="hidden bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
          <h6 class="font-semibold text-nfgblue dark:text-blue-400 mb-3">Role & Status</h6>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1.5">Role</label>
              <select id="user-detail-role-select" data-custom-dropdown="true" data-placeholder="Select role">
                <option value="staff">Staff</option>
                <option value="client">Client</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Status</label>
              <select id="user-detail-status-select" data-custom-dropdown="true" data-placeholder="Select status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="suspended">Suspended</option>
              </select>
            </div>
          </div>
          <button id="update-user-role-btn" class="mt-3 px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark text-sm">
            Update Role & Status
          </button>
        </div>

        <!-- Site Assignments (Admin/Client only) -->
        <div id="site-assignments-section" class="hidden bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h6 class="font-semibold text-nfgblue dark:text-blue-400">Site Assignments</h6>
            <button id="assign-site-btn" class="text-sm px-3 py-1.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
              <i data-lucide="plus" class="w-3 h-3 inline"></i>
              Assign Site
            </button>
          </div>
          <div id="user-sites-list" class="space-y-2">
            <p class="text-gray-500 text-sm">No sites assigned yet.</p>
          </div>
        </div>

        <!-- Danger Zone (Admin/Client only) -->
        <div id="danger-zone-section" class="hidden border-t border-red-200 pt-4">
          <h6 class="font-semibold text-red-600 mb-3">Danger Zone</h6>
          <button id="remove-user-btn" class="px-4 py-2 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 text-sm">
            <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
            Remove User
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Site Modal -->
  <div id="assignSiteModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Assign Site</h4>
        <button id="close-assign-site-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="assign-site-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Select Site <span class="text-red-500">*</span></label>
          <select 
            name="site_id" 
            id="assign-site-select"
            required 
            class="w-full border border-nfgray dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none">
            <option value="">Select a site</option>
          </select>
        </div>

        <div id="assign-site-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button 
            type="button" 
            id="cancel-assign-site-btn" 
            class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button 
            type="submit" 
            class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Assign Site
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      
      // Initialize mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleButtons = document.querySelectorAll('[data-action="toggle-sidebar"], button[aria-label="Toggle sidebar"]');
      
      let overlay = document.getElementById('sidebar-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';
        document.body.appendChild(overlay);
      }
      
      function toggleSidebar() {
        if (sidebar && overlay) {
          const isHidden = sidebar.classList.contains('hidden') || !sidebar.classList.contains('mobile-sidebar-open');
          
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in');
            overlay.classList.remove('hidden');
            overlay.classList.add('animate-fade-in');
            document.body.style.overflow = 'hidden';
          } else {
            sidebar.classList.add('animate-slide-out');
            overlay.classList.add('animate-fade-out');
            
            setTimeout(() => {
              sidebar.classList.add('hidden');
              sidebar.classList.remove('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in', 'animate-slide-out');
              overlay.classList.add('hidden');
              overlay.classList.remove('animate-fade-in', 'animate-fade-out');
              document.body.style.overflow = '';
            }, 200);
          }
        }
      }
      
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      });
      
      overlay?.addEventListener('click', toggleSidebar);
      
      const navLinks = sidebar?.querySelectorAll('a');
      navLinks?.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            toggleSidebar();
          }
        });
      });
    });
  </script>
  <script type="module" src="./js/custom-dropdown.js"></script>
  <script type="module">
    import { supabase } from './js/supabase.js'
    import { NFGDropdown, initCustomDropdowns } from './js/custom-dropdown.js'
    import { showNotification, showConfirm, showPrompt, toast, notify } from './js/notifications.js'
    import { enablePushNotifications, disablePushNotifications, getPushStatus } from './js/pwa.js'
    import {
      getCurrentUser,
      canManageUsers,
      fetchUsers,
      sendInvitation,
      renderUsersList,
      renderPendingInvitations,
      updateUserRole,
      assignUserToSite,
      removeUser
    } from './js/user-management.js'

    let currentUserData = null;
    let selectedUserId = null;

    // Check authentication
    async function checkAuth() {
      console.log('=== CHECKING AUTHENTICATION ===');
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (!session || !session.user) {
        console.error('‚ùå No active session - user not logged in');
        toast.error('You are not logged in. Please log in first.');
        setTimeout(() => {
          window.location.href = './index.html';
        }, 2000);
        return false;
      }
      
      console.log('‚úÖ User is logged in:', session.user.email);
      return true;
    }

    // Load user data
    async function loadUserData() {
      const { data: { user } } = await supabase.auth.getUser()
      
      if (user) {
        document.getElementById('user-email').value = user.email || 'No email'
        
        // Load user profile from database
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('full_name, profile_picture')
          .eq('id', user.id)
          .single()
        
        if (profile) {
          document.getElementById('user-display-name').value = profile.full_name || ''
          
          // Load profile picture
          if (profile.profile_picture) {
            document.getElementById('profile-picture-preview').src = profile.profile_picture + '?t=' + new Date().getTime()
          } else {
            // Generate avatar based on name or email
            const name = profile.full_name || user.email?.split('@')[0] || 'User'
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&size=128&background=E3ECFA&color=0D47A1`
            document.getElementById('profile-picture-preview').src = avatarUrl
          }
        } else {
          // Fallback to localStorage for display name
          const displayName = localStorage.getItem('nfg_display_name') || ''
          document.getElementById('user-display-name').value = displayName
        }
        
        // Load notification preferences from database
        await loadNotificationPreferences()
      }
    }

    // Profile picture upload button
    document.getElementById('upload-profile-picture-btn')?.addEventListener('click', () => {
      document.getElementById('profile-picture-input').click()
    })

    // Push notification controls
    const pushToggleButton = document.getElementById('settings-toggle-push-btn')
    if (pushToggleButton) {
      pushToggleButton.addEventListener('click', async () => {
        const status = getPushStatus()
        const hiddenInput = document.getElementById('notif-push-enabled')

        if (!status.supported) {
          toast.warning('Push notifications are not supported in this browser.')
          return
        }

        if (status.permission === 'denied') {
          toast.error('Notifications are blocked. Enable them in your browser settings first.')
          return
        }

        pushToggleButton.disabled = true
        const originalText = pushToggleButton.textContent
        pushToggleButton.textContent = 'Working...'

        try {
          if (status.subscribed) {
            await disablePushNotifications()
            if (hiddenInput) hiddenInput.value = 'false'
            toast.info('Push notifications disabled on this device.')
            document.getElementById('save-notification-preferences-btn')?.classList.add('opacity-90')
          } else {
            await enablePushNotifications()
            if (hiddenInput) hiddenInput.value = 'true'
            toast.success('Push notifications enabled on this device.')
            document.getElementById('save-notification-preferences-btn')?.classList.add('opacity-90')
          }
        } catch (error) {
          console.error('Failed to toggle push notifications:', error)
          toast.error(error?.message || 'Could not update push notifications.')
        } finally {
          pushToggleButton.disabled = false
          pushToggleButton.textContent = originalText
          const updatedStatus = getPushStatus()
          const prefEnabled = (document.getElementById('notif-push-enabled')?.value ?? 'true') !== 'false'
          updatePushSettingsUI(updatedStatus, prefEnabled)
        }
      })

      window.addEventListener('nfg:push-status-changed', (event) => {
        const status = event?.detail || getPushStatus()
        const prefEnabled = (document.getElementById('notif-push-enabled')?.value ?? 'true') !== 'false'
        updatePushSettingsUI(status, prefEnabled)
      })

      // Initialize on load
      const initialPref = (document.getElementById('notif-push-enabled')?.value ?? 'true') !== 'false'
      updatePushSettingsUI(getPushStatus(), initialPref)
    }

    function updatePushSettingsUI(status, preferenceEnabled = true) {
      const badge = document.getElementById('push-permission-badge')
      const button = document.getElementById('settings-toggle-push-btn')
      const statusText = document.getElementById('settings-push-status')
      const hiddenInput = document.getElementById('notif-push-enabled')

      if (!badge || !button || !statusText || !hiddenInput) return

      const isSupported = status?.supported ?? false
      const permission = status?.permission ?? 'default'
      const subscribed = status?.subscribed ?? false

      if (!isSupported) {
        badge.textContent = 'Not supported'
        badge.className = 'text-xs px-2 py-0.5 rounded-full bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-300'
        button.textContent = 'Not supported'
        button.disabled = true
        statusText.textContent = 'Push notifications are not supported in this browser.'
        hiddenInput.value = 'false'
        return
      }

      if (permission === 'denied') {
        badge.textContent = 'Blocked'
        badge.className = 'text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-300'
        button.textContent = 'Notifications blocked'
        button.disabled = true
        statusText.textContent = 'Enable notifications in your browser settings to receive push alerts.'
        hiddenInput.value = 'false'
        return
      }

      if (permission === 'granted') {
        badge.textContent = 'Allowed'
        badge.className = 'text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-600 dark:bg-green-900/40 dark:text-green-300'
      } else {
        badge.textContent = 'Needs permission'
        badge.className = 'text-xs px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-600 dark:bg-yellow-900/40 dark:text-yellow-300'
      }

      button.disabled = false

      if (!preferenceEnabled) {
        button.textContent = 'Enable Push'
        statusText.textContent = 'Push notifications are disabled in your preferences.'
        hiddenInput.value = 'false'
      } else if (subscribed) {
        button.textContent = 'Disable Push'
        statusText.textContent = 'Push notifications are enabled on this device.'
        hiddenInput.value = 'true'
      } else {
        button.textContent = 'Enable Push'
        statusText.textContent = permission === 'granted'
          ? 'Push notifications are off. Click to enable.'
          : 'Click enable to request notification permission.'
        hiddenInput.value = 'false'
      }
    }

    // Handle profile picture file selection
    document.getElementById('profile-picture-input')?.addEventListener('change', async (e) => {
      const file = e.target.files[0]
      if (!file) return

      // Validate file
      if (!file.type.startsWith('image/')) {
        toast.warning('Please select an image file.')
        return
      }

      if (file.size > 5 * 1024 * 1024) {
        toast.warning('File is too large. Please select an image under 5MB.')
        return
      }

      const loadingEl = document.getElementById('profile-upload-loading')
      const previewEl = document.getElementById('profile-picture-preview')

      try {
        loadingEl.classList.remove('hidden')
        console.log('[Profile] Uploading profile picture...', file.name)

        // Get current user
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) throw new Error('Not authenticated')

        // Upload to Supabase Storage
        const fileExt = file.name.split('.').pop()
        const fileName = `${user.id}/profile.${fileExt}`

        const { error: uploadError } = await supabase.storage
          .from('profile-pictures')
          .upload(fileName, file, { upsert: true })

        if (uploadError) {
          console.error('[Profile] Upload error:', uploadError)
          if (uploadError.message.includes('not found')) {
            toast.error('Storage not set up. Please run SETUP_PROFILE_PICTURES_STORAGE.sql')
          } else {
            toast.error('Failed to upload photo: ' + uploadError.message)
          }
          return
        }

        // Get public URL
        const { data: urlData } = supabase.storage
          .from('profile-pictures')
          .getPublicUrl(fileName)

        console.log('[Profile] ‚úÖ Photo uploaded:', urlData.publicUrl)

        // Update user profile
        const { error: updateError } = await supabase
          .from('user_profiles')
          .update({ profile_picture: urlData.publicUrl })
          .eq('id', user.id)

        if (updateError) {
          console.error('[Profile] Update error:', updateError)
          toast.error('Failed to update profile: ' + updateError.message)
        } else {
          // Update preview
          previewEl.src = urlData.publicUrl + '?t=' + new Date().getTime()
          toast.success('Profile picture updated!')
        }

      } catch (error) {
        console.error('[Profile] Error:', error)
        toast.error('An error occurred. Please try again.')
      } finally {
        loadingEl.classList.add('hidden')
        e.target.value = '' // Reset input
      }
    })

    // Save profile
    document.getElementById('save-profile-btn')?.addEventListener('click', async () => {
      const displayName = document.getElementById('user-display-name').value
      
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) throw new Error('Not authenticated')

        const { error } = await supabase
          .from('user_profiles')
          .update({ full_name: displayName })
          .eq('id', user.id)

        if (error) throw error

        toast.success('Profile updated successfully!')
      } catch (error) {
        console.error('Error updating profile:', error)
        toast.error('Failed to update profile. Please try again.')
      }
    })

    // Load notification preferences from database
    async function loadNotificationPreferences() {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return

        // Fetch preferences from database
        const { data: preferences, error } = await supabase
          .from('notification_preferences')
          .select('*')
          .eq('user_id', user.id)
          .single()

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
          console.error('Error loading preferences:', error)
          toast.error('Failed to load notification preferences')
          return
        }

        // If no preferences exist, create defaults
        if (!preferences) {
          await createDefaultPreferences(user.id)
          // Reload after creating defaults
          const { data: newPrefs } = await supabase
            .from('notification_preferences')
            .select('*')
            .eq('user_id', user.id)
            .single()
          
          if (newPrefs) {
            setPreferenceValues(newPrefs)
          }
        } else {
          setPreferenceValues(preferences)
        }
      } catch (error) {
        console.error('Error in loadNotificationPreferences:', error)
        toast.error('Failed to load notification preferences')
      }
    }

    // Create default preferences for a user
    async function createDefaultPreferences(userId) {
      try {
        const { error } = await supabase
          .from('notification_preferences')
          .insert({
            user_id: userId,
            email_enabled: true,
            push_enabled: true,
            in_app_enabled: true,
            job_assigned: true,
            job_completed: true,
            job_updated: true,
            site_assigned: true,
            booking_created: true,
            booking_updated: true,
            booking_cancelled: true,
            mention: true,
            system: true
          })

        if (error) throw error
        console.log('‚úÖ Created default notification preferences')
      } catch (error) {
        console.error('Error creating default preferences:', error)
        throw error
      }
    }

    // Set preference values in UI
    function setPreferenceValues(preferences) {
      const prefMap = {
        'email_enabled': 'notif-email-enabled',
        'push_enabled': 'notif-push-enabled',
        'in_app_enabled': 'notif-in-app-enabled',
        'job_assigned': 'notif-job-assigned',
        'job_completed': 'notif-job-completed',
        'job_updated': 'notif-job-updated',
        'site_assigned': 'notif-site-assigned',
        'booking_created': 'notif-booking-created',
        'booking_updated': 'notif-booking-updated',
        'booking_cancelled': 'notif-booking-cancelled',
        'mention': 'notif-mention',
        'system': 'notif-system'
      }

      Object.entries(prefMap).forEach(([dbKey, uiId]) => {
        const element = document.getElementById(uiId)
        if (!element) return

        if (dbKey === 'push_enabled') {
          element.value = preferences[dbKey] !== false ? 'true' : 'false'
        } else if (element.type === 'checkbox') {
          element.checked = preferences[dbKey] !== false // Default to true if null
        }
      })

      updatePushSettingsUI(getPushStatus(), preferences.push_enabled !== false)
    }

    // Save notification preferences to database
    document.getElementById('save-notification-preferences-btn')?.addEventListener('click', async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) throw new Error('Not authenticated')

        // Collect all preference values
        const preferences = {
          email_enabled: document.getElementById('notif-email-enabled')?.checked ?? true,
          push_enabled: (document.getElementById('notif-push-enabled')?.value ?? 'true') !== 'false',
          in_app_enabled: document.getElementById('notif-in-app-enabled')?.checked ?? true,
          job_assigned: document.getElementById('notif-job-assigned')?.checked ?? true,
          job_completed: document.getElementById('notif-job-completed')?.checked ?? true,
          job_updated: document.getElementById('notif-job-updated')?.checked ?? true,
          site_assigned: document.getElementById('notif-site-assigned')?.checked ?? true,
          booking_created: document.getElementById('notif-booking-created')?.checked ?? true,
          booking_updated: document.getElementById('notif-booking-updated')?.checked ?? true,
          booking_cancelled: document.getElementById('notif-booking-cancelled')?.checked ?? true,
          mention: document.getElementById('notif-mention')?.checked ?? true,
          system: document.getElementById('notif-system')?.checked ?? true
        }

        // Check if preferences exist
        const { data: existing } = await supabase
          .from('notification_preferences')
          .select('id')
          .eq('user_id', user.id)
          .single()

        let error
        if (existing) {
          // Update existing
          const { error: updateError } = await supabase
            .from('notification_preferences')
            .update(preferences)
            .eq('user_id', user.id)
          error = updateError
        } else {
          // Create new
          const { error: insertError } = await supabase
            .from('notification_preferences')
            .insert({
              user_id: user.id,
              ...preferences
            })
          error = insertError
        }

        if (error) throw error

        toast.success('Notification preferences saved successfully!')
      } catch (error) {
        console.error('Error saving notification preferences:', error)
        toast.error('Failed to save preferences. Please try again.')
      }
    })

    // Auto-save on toggle change (optional, or remove if you prefer manual save only)
    document.querySelectorAll('.toggle-checkbox[data-pref]').forEach(toggle => {
      toggle.addEventListener('change', () => {
        // Mark as changed (could show indicator)
        document.getElementById('save-notification-preferences-btn').classList.add('opacity-90')
      })
    })

    // Export data
    document.getElementById('export-data-btn')?.addEventListener('click', () => {
      const data = {
        profile: {
          displayName: localStorage.getItem('nfg_display_name')
        },
        notifications: JSON.parse(localStorage.getItem('nfg_notif_prefs') || '{}'),
        exportDate: new Date().toISOString()
      }
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `nfg-data-export-${Date.now()}.json`
      a.click()
      URL.revokeObjectURL(url)
    })

    // Clear data
    document.getElementById('clear-data-btn')?.addEventListener('click', async () => {
      const confirmed = await showConfirm(
        'Clear All Data',
        'Are you sure you want to clear all local data? This cannot be undone.'
      );
      
      if (confirmed) {
        localStorage.removeItem('nfg_display_name')
        localStorage.removeItem('nfg_notif_prefs')
        toast.success('Local data cleared!');
        setTimeout(() => location.reload(), 1500);
      }
    })

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = './index.html'
    })

    // Modal controls
    function openInviteModal() {
      const modal = document.getElementById('inviteUserModal')
      modal.classList.remove('hidden')
      modal.classList.add('flex')
      lucide.createIcons()
      
      // Initialize custom dropdowns in the modal
      setTimeout(() => {
        initCustomDropdowns()
      }, 100)
    }

    function closeInviteModal() {
      const modal = document.getElementById('inviteUserModal')
      modal.classList.add('hidden')
      modal.classList.remove('flex')
      document.getElementById('invite-user-form').reset()
      document.getElementById('invite-form-error').classList.add('hidden')
    }

    function closeUserDetailsModal() {
      const modal = document.getElementById('userDetailsModal')
      modal.classList.add('hidden')
      modal.classList.remove('flex')
    }

    function closeAssignSiteModal() {
      const modal = document.getElementById('assignSiteModal')
      modal.classList.add('hidden')
      modal.classList.remove('flex')
      document.getElementById('assign-site-form').reset()
      document.getElementById('assign-site-error').classList.add('hidden')
    }

    // Event listeners for modal buttons
    document.getElementById('invite-user-btn')?.addEventListener('click', openInviteModal)
    document.getElementById('close-invite-modal')?.addEventListener('click', closeInviteModal)
    document.getElementById('cancel-invite-btn')?.addEventListener('click', closeInviteModal)
    
    document.getElementById('close-user-details-modal')?.addEventListener('click', closeUserDetailsModal)
    
    document.getElementById('close-assign-site-modal')?.addEventListener('click', closeAssignSiteModal)
    document.getElementById('cancel-assign-site-btn')?.addEventListener('click', closeAssignSiteModal)

    // Invite user form
    document.getElementById('invite-user-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const formData = new FormData(e.target)
      const email = formData.get('email')
      const role = formData.get('role')
      
      const errorEl = document.getElementById('invite-form-error')
      const submitBtn = document.getElementById('submit-invite-btn')
      
      try {
        submitBtn.disabled = true
        submitBtn.textContent = 'Sending...'
        
        await sendInvitation(email, role)
        
        closeInviteModal()
        await renderPendingInvitations()
        toast.success('Invitation sent successfully!')
      } catch (error) {
        errorEl.textContent = error.message
        errorEl.classList.remove('hidden')
      } finally {
        submitBtn.disabled = false
        submitBtn.textContent = 'Send Invitation'
      }
    })

    // Update user role
    document.getElementById('update-user-role-btn')?.addEventListener('click', async () => {
      if (!selectedUserId) return
      
      const roleSelect = document.getElementById('user-detail-role-select');
      const statusSelect = document.getElementById('user-detail-status-select');
      
      // Get value from custom dropdown if it exists, otherwise from select element
      let role = roleSelect?.value || '';
      let status = statusSelect?.value || '';
      
      // Check if custom dropdown is initialized and get value from hidden input
      if (roleSelect) {
        const roleDropdownWrapper = roleSelect.parentNode.querySelector('.nfg-select-wrapper');
        if (roleDropdownWrapper) {
          const roleHiddenInput = roleDropdownWrapper.querySelector('input[type="hidden"]');
          if (roleHiddenInput && roleHiddenInput.value) {
            role = roleHiddenInput.value;
          } else {
            role = roleSelect.value;
          }
        }
      }
      
      if (statusSelect) {
        const statusDropdownWrapper = statusSelect.parentNode.querySelector('.nfg-select-wrapper');
        if (statusDropdownWrapper) {
          const statusHiddenInput = statusDropdownWrapper.querySelector('input[type="hidden"]');
          if (statusHiddenInput && statusHiddenInput.value) {
            status = statusHiddenInput.value;
          } else {
            status = statusSelect.value;
          }
        }
      }
      
      if (!role || !status) {
        toast.error('Please select both role and status');
        return;
      }
      
      try {
        await updateUserRole(selectedUserId, role, status)
        toast.success('User updated successfully!')
        closeUserDetailsModal()
        await renderUsersList()
      } catch (error) {
        console.error('Error updating user:', error);
        toast.error(error?.message || 'Failed to update user. Please try again.')
      }
    })

    // Assign site
    document.getElementById('assign-site-btn')?.addEventListener('click', async () => {
      console.log('Loading sites for assignment...');
      
      // Load sites from Supabase first, fallback to localStorage
      let sites = [];
      const { data: supabaseSites, error } = await supabase.from('sites').select('*').order('name');
      
      if (error) {
        console.error('Error fetching sites from Supabase:', error);
        // Fallback to localStorage
        try {
          sites = JSON.parse(localStorage.getItem('nfg_sites') || '[]');
          console.log('Loaded sites from localStorage:', sites.length);
        } catch (e) {
          console.error('Error loading from localStorage:', e);
        }
      } else {
        sites = supabaseSites || [];
        console.log('Loaded sites from Supabase:', sites.length);
      }
      
      const select = document.getElementById('assign-site-select');
      
      // Clear and populate options
      select.innerHTML = '<option value="">Select a site</option>';
      
      if (sites.length === 0) {
        select.innerHTML = '<option value="">No sites available</option>';
        toast.warning('No sites found. Please create sites first in the Sites page.');
      } else {
        sites.forEach(site => {
          const option = document.createElement('option');
          option.value = site.id;
          option.textContent = site.name;
          select.appendChild(option);
        });
      }
      
      console.log('Total options in dropdown:', select.options.length);
      
      // Open modal
      const modal = document.getElementById('assignSiteModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Reinitialize icons
      if (window.lucide) lucide.createIcons();
      
      console.log('Assign site modal opened with', sites.length, 'sites');
    })

    // Assign site form
    document.getElementById('assign-site-form')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      if (!selectedUserId) return
      
      const formData = new FormData(e.target)
      const siteId = formData.get('site_id')
      
      try {
        await assignUserToSite(selectedUserId, parseInt(siteId))
        closeAssignSiteModal()
        // Refresh the user's assigned sites list
        await loadUserSites(selectedUserId);
        toast.success('Site assigned successfully!')
      } catch (error) {
        const errorEl = document.getElementById('assign-site-error')
        errorEl.textContent = error.message
        errorEl.classList.remove('hidden')
      }
    })

    // Remove user
    document.getElementById('remove-user-btn')?.addEventListener('click', async () => {
      if (!selectedUserId) return
      
      const confirmed = await showConfirm(
        'Remove User',
        'Are you sure you want to remove this user? This action cannot be undone.'
      );
      
      if (!confirmed) return;
      
      try {
        await removeUser(selectedUserId)
        toast.success('User removed successfully!')
        closeUserDetailsModal()
        await renderUsersList()
      } catch (error) {
        toast.error('Failed to remove user. Please try again.')
      }
    })

    // Initialize
    async function init() {
      try {
        console.log('Initializing settings page...')
        
        // Check authentication FIRST
        const isAuthenticated = await checkAuth()
        if (!isAuthenticated) {
          return // Stop if not authenticated
        }
        
        // Load basic user data
        await loadUserData()
        console.log('User data loaded')
        
        // Load user management
        currentUserData = await getCurrentUser()
        console.log('Current user data:', currentUserData)
        
        // Always try to render user list
        console.log('Rendering users list...')
        await renderUsersList()
        console.log('Users list rendered')
        
        // Show/hide invite button based on role
        const inviteBtn = document.getElementById('invite-user-btn')
        if (inviteBtn) {
          if (currentUserData && canManageUsers()) {
            console.log('User can manage - showing invite button')
            inviteBtn.classList.remove('hidden')
            inviteBtn.classList.add('inline-flex')
            await renderPendingInvitations()
          } else {
            console.log('User cannot manage - hiding invite button')
            inviteBtn.classList.add('hidden')
            inviteBtn.classList.remove('inline-flex')
            const pendingContainer = document.getElementById('pending-invitations-container')
            if (pendingContainer) pendingContainer.classList.add('hidden')
          }
        }
        
        // Hide Reports navigation for staff (but allow Bookings for calendar view)
        if (currentUserData && currentUserData.role === 'staff') {
          const reportsNav = document.getElementById('nav-reports');
          if (reportsNav) reportsNav.style.display = 'none';
          
          // Update Bookings link text for staff to indicate calendar view
          const bookingsNav = document.getElementById('nav-bookings');
          if (bookingsNav) {
            const bookingsText = bookingsNav.querySelector('span') || bookingsNav.childNodes[bookingsNav.childNodes.length - 1];
            if (bookingsText && bookingsText.textContent) {
              bookingsText.textContent = 'Schedule';
            } else {
              bookingsNav.innerHTML = '<i data-lucide="calendar" class="w-4 h-4"></i> Schedule';
              if (window.lucide) lucide.createIcons();
            }
          }
        }
        
        // Load compliance documents
        await loadComplianceDocuments();
        
        console.log('Initialization complete')
      } catch (error) {
        console.error('Error during initialization:', error)
        toast.error('Error loading settings. Check console for details.')
      }
    }

    // Open user details modal
    window.openUserDetails = async function(userId) {
      selectedUserId = userId;
      console.log('Opening user details for:', userId);
      
      // Get user data
      const users = await fetchUsers();
      const user = users.find(u => u.id === userId);
      
      if (!user) {
        toast.error('User not found');
        return;
      }
      
      // Populate modal
      document.getElementById('user-detail-name').textContent = user.full_name || user.email.split('@')[0];
      document.getElementById('user-detail-email').textContent = user.email;
      
      // Role badge
      const roleColors = {
        admin: 'bg-purple-100 text-purple-700',
        client: 'bg-blue-100 text-blue-700',
        staff: 'bg-gray-100 text-gray-700'
      };
      const roleBadge = document.getElementById('user-detail-role-badge');
      roleBadge.textContent = user.role.toUpperCase();
      roleBadge.className = `px-2 py-0.5 rounded-lg text-xs font-medium ${roleColors[user.role]}`;
      
      // Status badge
      const statusColors = {
        active: 'bg-green-100 text-green-700',
        pending: 'bg-yellow-100 text-yellow-700',
        inactive: 'bg-gray-100 text-gray-700',
        suspended: 'bg-red-100 text-red-700'
      };
      const statusBadge = document.getElementById('user-detail-status-badge');
      statusBadge.textContent = user.status;
      statusBadge.className = `px-2 py-0.5 rounded-lg text-xs font-medium ${statusColors[user.status]}`;
      
      // Set role and status dropdowns - set values on select elements first
      const roleSelect = document.getElementById('user-detail-role-select');
      const statusSelect = document.getElementById('user-detail-status-select');
      
      if (roleSelect) {
        roleSelect.value = user.role;
      }
      
      if (statusSelect) {
        statusSelect.value = user.status;
      }
      
      // Show/hide sections based on current user's role and the viewed user's role
      if (currentUserData && canManageUsers()) {
        document.getElementById('role-management-section').classList.remove('hidden');
        document.getElementById('danger-zone-section').classList.remove('hidden');
        
        // Hide site assignments section if viewed user is admin (admins can see all sites)
        if (user.role === 'admin') {
          document.getElementById('site-assignments-section').classList.add('hidden');
        } else {
          document.getElementById('site-assignments-section').classList.remove('hidden');
          // Load assigned sites only for non-admin users
          await loadUserSites(userId);
        }
      } else {
        document.getElementById('role-management-section').classList.add('hidden');
        document.getElementById('site-assignments-section').classList.add('hidden');
        document.getElementById('danger-zone-section').classList.add('hidden');
      }
      
      // Open modal
      const modal = document.getElementById('userDetailsModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Re-initialize custom dropdowns after modal is visible to ensure they're properly set up
      setTimeout(() => {
        // Helper function to clean up and reinitialize a dropdown
        const cleanupAndInitDropdown = (selectElement) => {
          if (!selectElement) return;
          
          // Find the select element's parent container
          const parent = selectElement.parentElement;
          if (!parent) return;
          
          // Remove ALL existing wrappers that are siblings of this select (BEFORE the select)
          // NFGDropdown inserts the wrapper BEFORE the select element
          let sibling = selectElement.previousElementSibling;
          while (sibling) {
            const nextSibling = sibling.previousElementSibling;
            if (sibling.classList && sibling.classList.contains('nfg-select-wrapper')) {
              sibling.remove();
            }
            sibling = nextSibling;
          }
          
          // Also check if select is inside a wrapper (shouldn't happen, but just in case)
          if (parent.classList && parent.classList.contains('nfg-select-wrapper')) {
            // Move select out of wrapper before removing wrapper
            const grandparent = parent.parentElement;
            if (grandparent) {
              grandparent.insertBefore(selectElement, parent);
              parent.remove();
            }
          }
          
          // Show the select element and make sure it's visible
          selectElement.style.display = '';
          selectElement.style.visibility = 'visible';
          
          // Reset initialized flag
          selectElement.dataset.initialized = 'false';
          
          // Reinitialize dropdown (this will create a new wrapper)
          new NFGDropdown(selectElement);
        };
        
        // Clean up and reinitialize both dropdowns
        cleanupAndInitDropdown(roleSelect);
        cleanupAndInitDropdown(statusSelect);
        
        // Recreate icons
        lucide.createIcons();
      }, 100);
    }
    
    // Load user's assigned sites
    async function loadUserSites(userId) {
      console.log('Loading sites for user:', userId);
      
      const list = document.getElementById('user-sites-list');
      
      if (!list) {
        console.error('user-sites-list element not found');
        return;
      }
      
      // Show loading state
      list.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Loading sites...</p>';
      
      try {
        // First, get the assignments
        const { data: assignments, error: assignError } = await supabase
          .from('worker_site_assignments')
          .select('*')
          .eq('worker_id', userId);
        
        if (assignError) {
          console.error('Error loading site assignments:', assignError);
          
          // Check if it's a permissions issue
          if (assignError.code === 'PGRST116' || assignError.message.includes('permission') || assignError.message.includes('policy')) {
            list.innerHTML = `
              <div class="text-red-600 text-sm bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="font-semibold mb-2">‚ö†Ô∏è Database Permission Error</p>
                <p class="mb-2">The RLS policies need to be fixed. Please run this SQL in Supabase:</p>
                <code class="block bg-white dark:bg-gray-800 p-2 rounded text-xs mt-2">FIX_SITE_ASSIGNMENTS_RLS.sql</code>
                <p class="mt-2 text-xs">This file updates the policies to work with 'client' role.</p>
              </div>
            `;
          } else {
            list.innerHTML = '<p class="text-red-500 text-sm">Error loading sites: ' + assignError.message + '</p>';
          }
          return;
        }
        
        console.log('Site assignments loaded:', assignments);
        
        if (!assignments || assignments.length === 0) {
          list.innerHTML = '<p class="text-gray-500 text-sm">No sites assigned yet.</p>';
          return;
        }
        
        // Get all sites to match names
        const { data: sites, error: sitesError } = await supabase
          .from('sites')
          .select('id, name');
        
        if (sitesError) {
          console.error('Error loading sites:', sitesError);
        }
        
        console.log('Sites loaded:', sites);
        
        // Create a map of site IDs to names
        const siteMap = {};
        if (sites && sites.length > 0) {
          sites.forEach(site => {
            siteMap[site.id] = site.name;
          });
        }
        
        list.innerHTML = assignments.map(assignment => {
          const siteName = siteMap[assignment.site_id] || `Site #${assignment.site_id}`;
          return `
            <div class="flex items-center justify-between p-3 bg-nfglight/30 rounded-lg">
              <div class="flex items-center gap-2">
                <i data-lucide="building-2" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
                <span class="font-medium">${siteName}</span>
              </div>
              <button onclick="removeAssignment('${assignment.id}')" class="text-red-600 hover:bg-red-50 p-1 rounded">
                <i data-lucide="x" class="w-4 h-4"></i>
              </button>
            </div>
          `;
        }).join('');
        
        lucide.createIcons();
      } catch (err) {
        console.error('Exception loading site assignments:', err);
        list.innerHTML = '<p class="text-red-500 text-sm">Error loading sites: ' + err.message + '</p>';
      }
    }
    
    // Remove site assignment
    window.removeAssignment = async function(assignmentId) {
      const confirmed = await showConfirm(
        'Remove Assignment',
        'Are you sure you want to remove this site assignment?'
      );
      
      if (!confirmed) return;
      
      console.log('Removing assignment:', assignmentId);
      
      try {
        const { error } = await supabase
          .from('worker_site_assignments')
          .delete()
          .eq('id', assignmentId);
        
        if (error) {
          console.error('Error removing assignment:', error);
          toast.error('Failed to remove assignment: ' + error.message);
          return;
        }
        
        console.log('Assignment removed successfully');
        await loadUserSites(selectedUserId);
        toast.success('Site assignment removed successfully!');
      } catch (err) {
        console.error('Exception removing assignment:', err);
        toast.error('Failed to remove assignment');
      }
    }

    // Make closeUserDetailsModal global for user-management.js
    window.closeUserDetailsModal = closeUserDetailsModal

    // ========== COMPLIANCE & INSURANCE DOCUMENT MANAGEMENT ==========
    
    const COMPLIANCE_BUCKET = 'compliance-documents';
    
    // Document types
    const DOC_TYPES = {
      wsib: { name: 'WSIB', folder: 'wsib' },
      insurance: { name: 'Insurance', folder: 'insurance' },
      license: { name: 'Licenses', folder: 'licenses' }
    };
    
    // Load all compliance documents
    async function loadComplianceDocuments() {
      console.log('[Compliance] Loading documents...');
      
      for (const [type, config] of Object.entries(DOC_TYPES)) {
        await loadDocumentsByType(type, config);
      }
    }
    
    // Load documents by type
    async function loadDocumentsByType(type, config) {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const folder = `${user.id}/${config.folder}`;
        const { data: files, error } = await supabase.storage
          .from(COMPLIANCE_BUCKET)
          .list(folder, { sortBy: { column: 'created_at', order: 'desc' } });
        
        if (error) {
          console.error(`[Compliance] Error loading ${type} documents:`, error);
          return;
        }
        
        const listEl = document.getElementById(`${type}-list`);
        if (!files || files.length === 0) {
          listEl.innerHTML = '<p class="text-xs text-gray-500 dark:text-gray-400">No documents uploaded</p>';
          return;
        }
        
        listEl.innerHTML = files.map(file => {
          const fileUrl = supabase.storage.from(COMPLIANCE_BUCKET).getPublicUrl(`${folder}/${file.name}`).data.publicUrl;
          const uploadDate = new Date(file.created_at).toLocaleDateString();
          const isPDF = file.name.toLowerCase().endsWith('.pdf');
          
          return `
            <div class="flex items-center justify-between p-2 bg-nfglight/50 rounded-lg text-xs">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <i data-lucide="${isPDF ? 'file-text' : 'image'}" class="w-3 h-3 text-nfgblue dark:text-blue-400 flex-shrink-0"></i>
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-nfgblue dark:text-blue-400 truncate">${file.name}</p>
                  <p class="text-gray-500 dark:text-gray-400">${uploadDate}</p>
                </div>
              </div>
              <div class="flex items-center gap-1 flex-shrink-0">
                <button 
                  onclick="viewDocument('${fileUrl}')" 
                  class="p-1 rounded hover:bg-nfgblue/10 text-nfgblue dark:text-blue-400"
                  title="View">
                  <i data-lucide="eye" class="w-3 h-3"></i>
                </button>
                <button 
                  onclick="deleteDocument('${type}', '${folder}/${file.name}')" 
                  class="p-1 rounded hover:bg-red-100 text-red-600"
                  title="Delete">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error(`[Compliance] Error in loadDocumentsByType:`, error);
      }
    }
    
    // Handle file upload
    async function handleDocumentUpload(type, file) {
      try {
        // Validate file
        if (!file) return;
        
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
          toast.warning('Please upload a PDF, JPG, or PNG file.');
          return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
          toast.warning('File size must be less than 10MB.');
          return;
        }
        
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          toast.error('Not authenticated');
          return;
        }
        
        const config = DOC_TYPES[type];
        const folder = `${user.id}/${config.folder}`;
        const fileName = `${Date.now()}_${file.name}`;
        const filePath = `${folder}/${fileName}`;
        
        console.log(`[Compliance] Uploading ${type} document:`, fileName);
        
        // Upload to Supabase Storage
        const { error: uploadError } = await supabase.storage
          .from(COMPLIANCE_BUCKET)
          .upload(filePath, file);
        
        if (uploadError) {
          console.error('[Compliance] Upload error:', uploadError);
          if (uploadError.message.includes('not found')) {
            toast.error('Storage not configured. Please run SETUP_COMPLIANCE_STORAGE.sql');
          } else {
            toast.error('Failed to upload document: ' + uploadError.message);
          }
          return;
        }
        
        toast.success(`${config.name} document uploaded successfully!`);
        await loadDocumentsByType(type, config);
        
      } catch (error) {
        console.error('[Compliance] Error uploading document:', error);
        toast.error('An error occurred while uploading.');
      }
    }
    
    // View document
    window.viewDocument = function(url) {
      window.open(url, '_blank');
    };
    
    // Delete document
    window.deleteDocument = async function(type, filePath) {
      const confirmed = await showConfirm(
        'Delete Document',
        'Are you sure you want to delete this document? This action cannot be undone.'
      );
      
      if (!confirmed) return;
      
      try {
        const { error } = await supabase.storage
          .from(COMPLIANCE_BUCKET)
          .remove([filePath]);
        
        if (error) throw error;
        
        toast.success('Document deleted successfully');
        const config = DOC_TYPES[type];
        await loadDocumentsByType(type, config);
      } catch (error) {
        console.error('[Compliance] Error deleting document:', error);
        toast.error('Failed to delete document');
      }
    };
    
    // Setup file upload listeners
    document.getElementById('wsib-upload')?.addEventListener('change', (e) => {
      handleDocumentUpload('wsib', e.target.files[0]);
      e.target.value = ''; // Reset input
    });
    
    document.getElementById('insurance-upload')?.addEventListener('change', (e) => {
      handleDocumentUpload('insurance', e.target.files[0]);
      e.target.value = ''; // Reset input
    });
    
    document.getElementById('license-upload')?.addEventListener('change', (e) => {
      handleDocumentUpload('license', e.target.files[0]);
      e.target.value = ''; // Reset input
    });

    // Start initialization
    init()
  </script>
  
  <!-- CSV Import Modal -->
  <div id="csv-import-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 md:p-6 border-b border-nfgray dark:border-gray-700 flex items-center justify-between flex-shrink-0">
        <div>
          <h3 class="text-lg md:text-xl font-semibold text-nfgblue dark:text-blue-400">Import Data from CSV</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Migrate your data from existing platforms</p>
        </div>
        <button id="close-import-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-4 md:p-6">
        <!-- Step Indicator -->
        <div id="import-step-indicator" class="flex items-center justify-between mb-6">
          <div class="flex-1 flex items-center">
            <div class="step-indicator active" data-step="1">
              <div class="step-number">1</div>
              <span class="step-label">Select Type</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="2">
              <div class="step-number">2</div>
              <span class="step-label">Upload CSV</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="3">
              <div class="step-number">3</div>
              <span class="step-label">Map Columns</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="4">
              <div class="step-number">4</div>
              <span class="step-label">Preview</span>
            </div>
            <div class="step-line"></div>
            <div class="step-indicator" data-step="5">
              <div class="step-number">5</div>
              <span class="step-label">Import</span>
            </div>
          </div>
        </div>
        
        <!-- Step 1: Select Import Type -->
        <div id="import-step-1" class="import-step active">
          <h4 class="text-lg font-semibold mb-4">What would you like to import?</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button class="import-type-btn p-4 border-2 border-nfgray rounded-xl hover:border-nfgblue hover:bg-nfglight dark:hover:bg-gray-700 transition" data-type="sites">
              <i data-lucide="building-2" class="w-8 h-8 text-nfgblue dark:text-blue-400 mb-2"></i>
              <span class="font-semibold block">Sites</span>
              <span class="text-sm text-gray-500 dark:text-gray-400">Import locations and addresses</span>
            </button>
            <button class="import-type-btn p-4 border-2 border-nfgray rounded-xl hover:border-nfgblue hover:bg-nfglight dark:hover:bg-gray-700 transition" data-type="jobs" disabled>
              <i data-lucide="clipboard-list" class="w-8 h-8 text-gray-400 mb-2"></i>
              <span class="font-semibold block text-gray-400">Jobs</span>
              <span class="text-sm text-gray-500">Coming soon</span>
            </button>
            <button class="import-type-btn p-4 border-2 border-nfgray rounded-xl hover:border-nfgblue hover:bg-nfglight dark:hover:bg-gray-700 transition" data-type="users" disabled>
              <i data-lucide="users" class="w-8 h-8 text-gray-400 mb-2"></i>
              <span class="font-semibold block text-gray-400">Users</span>
              <span class="text-sm text-gray-500">Coming soon</span>
            </button>
            <button class="import-type-btn p-4 border-2 border-nfgray rounded-xl hover:border-nfgblue hover:bg-nfglight dark:hover:bg-gray-700 transition" data-type="bookings" disabled>
              <i data-lucide="calendar" class="w-8 h-8 text-gray-400 mb-2"></i>
              <span class="font-semibold block text-gray-400">Bookings</span>
              <span class="text-sm text-gray-500">Coming soon</span>
            </button>
          </div>
          <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
            <div class="flex items-start gap-3">
              <i data-lucide="download" class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"></i>
              <div>
                <p class="font-medium text-blue-900 dark:text-blue-100 mb-1">Need a template?</p>
                <a id="download-template-btn" href="#" class="text-sm text-blue-600 dark:text-blue-400 hover:underline">Download CSV template</a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Upload CSV -->
        <div id="import-step-2" class="import-step hidden">
          <h4 class="text-lg font-semibold mb-4">Upload CSV File</h4>
          <div id="csv-upload-area" class="border-2 border-dashed border-nfgray rounded-xl p-8 text-center hover:border-nfgblue transition cursor-pointer">
            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
            <i data-lucide="upload-cloud" class="w-12 h-12 text-nfgblue dark:text-blue-400 mx-auto mb-4"></i>
            <p class="text-lg font-medium mb-2">Drag & drop CSV file here</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">or click to browse</p>
            <button id="browse-csv-btn" class="px-4 py-2 bg-nfgblue dark:bg-blue-900 text-white rounded-xl hover:bg-nfgdark transition">
              Browse Files
            </button>
            <p class="text-xs text-gray-400 mt-4">Maximum file size: 10MB</p>
          </div>
          <div id="csv-file-info" class="hidden mt-4 p-4 bg-nfglight dark:bg-gray-700 rounded-xl">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i data-lucide="file-text" class="w-6 h-6 text-nfgblue dark:text-blue-400"></i>
                <div>
                  <p id="csv-file-name" class="font-medium"></p>
                  <p id="csv-file-size" class="text-sm text-gray-500 dark:text-gray-400"></p>
                </div>
              </div>
              <button id="remove-csv-file" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                <i data-lucide="x" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Column Mapping -->
        <div id="import-step-3" class="import-step hidden">
          <h4 class="text-lg font-semibold mb-4">Map CSV Columns to NFG Fields</h4>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Match your CSV columns to the correct NFG fields</p>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="border-b border-nfgray dark:border-gray-700">
                  <th class="text-left p-3 font-semibold">CSV Column</th>
                  <th class="text-left p-3 font-semibold">NFG Field</th>
                  <th class="text-left p-3 font-semibold">Sample Value</th>
                </tr>
              </thead>
              <tbody id="column-mapping-table">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Step 4: Preview & Validate -->
        <div id="import-step-4" class="import-step hidden">
          <h4 class="text-lg font-semibold mb-4">Import Preview</h4>
          <div id="validation-stats" class="mb-4 flex gap-4 flex-wrap">
            <div class="flex items-center gap-2">
              <span id="valid-count" class="text-green-600 dark:text-green-400 font-semibold">0</span>
              <span class="text-sm text-gray-600 dark:text-gray-400">valid rows</span>
            </div>
            <div class="flex items-center gap-2">
              <span id="warning-count" class="text-yellow-600 dark:text-yellow-400 font-semibold">0</span>
              <span class="text-sm text-gray-600 dark:text-gray-400">warnings</span>
            </div>
            <div class="flex items-center gap-2">
              <span id="error-count" class="text-red-600 dark:text-red-400 font-semibold">0</span>
              <span class="text-sm text-gray-600 dark:text-gray-400">errors</span>
            </div>
          </div>
          <div id="preview-table-container" class="overflow-x-auto border border-nfgray dark:border-gray-700 rounded-xl">
            <table class="w-full">
              <thead class="bg-nfglight dark:bg-gray-700">
                <tr id="preview-table-headers"></tr>
              </thead>
              <tbody id="preview-table-body"></tbody>
            </table>
          </div>
          <div id="preview-errors" class="mt-4 hidden"></div>
        </div>
        
        <!-- Step 5: Import Progress -->
        <div id="import-step-5" class="import-step hidden">
          <h4 class="text-lg font-semibold mb-4">Importing...</h4>
          <div class="space-y-4">
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium">Progress</span>
                <span id="import-progress-text" class="text-sm text-gray-500 dark:text-gray-400">0 / 0</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                <div id="import-progress-bar" class="bg-nfgblue dark:bg-blue-900 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 6: Results -->
        <div id="import-step-6" class="import-step hidden">
          <h4 class="text-lg font-semibold mb-4">Import Complete!</h4>
          <div id="import-results" class="space-y-4">
            <!-- Populated by JavaScript -->
          </div>
          <div id="import-error-report" class="mt-4 hidden">
            <a id="download-error-report" href="#" class="inline-flex items-center gap-2 px-4 py-2 border border-red-200 text-red-600 dark:text-red-400 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition">
              <i data-lucide="download" class="w-4 h-4"></i>
              Download Error Report
            </a>
          </div>
        </div>
      </div>
      
      <div class="p-4 md:p-6 border-t border-nfgray dark:border-gray-700 flex items-center justify-end gap-3 flex-shrink-0">
        <button id="import-cancel-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 transition">Cancel</button>
        <button id="import-back-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 transition hidden">Back</button>
        <button id="import-next-btn" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition hidden">Next</button>
        <button id="import-confirm-btn" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition hidden">Start Import</button>
      </div>
    </div>
  </div>
  
  <!-- CSV Import Script (load after modal HTML) -->
  <script type="module" src="./js/csv-import.js"></script>
  
  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>





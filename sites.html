<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG â€” Sites</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Sites...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <!-- Northern Facilities Group Logo -->
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
        alt="Northern Facilities Group" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="dashboard.html">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Overview
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="sites.html">
        <i data-lucide="map-pin" class="w-4 h-4"></i> Sites
      </a>
      <a id="nav-bookings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="bookings.html">
        <i data-lucide="calendar" class="w-4 h-4"></i> Bookings
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="jobs.html">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i> Jobs
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="inventory.html">
        <i data-lucide="package" class="w-4 h-4"></i> Inventory
      </a>
      <a id="nav-reports" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="reports.html">
        <i data-lucide="file-chart-column" class="w-4 h-4"></i> Reports
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700">
      <button id="logout-btn" class="w-full border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Sites</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <button id="add-site-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl bg-nfgblue text-white hover:bg-nfgdark transition flex-shrink-0"
                  data-action="open-modal" data-target="addSiteModal"
>
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span class="hidden sm:inline text-xs sm:text-sm">Add Site</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="p-4 md:p-6 space-y-6">
      <!-- Sites Header with Select All -->
      <div class="flex items-center justify-between gap-4 pb-2">
      <div>
        <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">All Sites</h2>
        <p class="text-sm text-gray-500 mt-1">Manage your properties and locations</p>
        </div>
        <!-- Select All Checkbox (only for non-staff) -->
        <div id="select-all-sites-container" class="hidden flex items-center gap-2 px-3 py-2 whitespace-nowrap flex-shrink-0">
          <input 
            type="checkbox" 
            id="select-all-sites" 
            class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue cursor-pointer"
            aria-label="Select all sites"
          />
          <label for="select-all-sites" class="text-sm font-medium text-nfgblue dark:text-blue-400 cursor-pointer">
            Select All
          </label>
        </div>
      </div>

      <!-- Sites Grid -->
      <div id="sites-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </main>
  </div>

  <!-- Bulk Actions Toolbar for Sites -->
  <div id="bulk-sites-toolbar" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-lg p-4 z-50 max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between gap-4 flex-nowrap">
      <span id="selected-sites-count" class="text-sm font-medium text-nfgblue dark:text-blue-400 whitespace-nowrap flex-shrink-0">
        0 selected
      </span>
      <div class="flex gap-2 flex-nowrap items-center">
        <button id="bulk-assign-worker-sites" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Assign Worker
        </button>
        <button id="bulk-update-status-sites" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Update Status
        </button>
        <button id="bulk-archive-sites" class="px-4 py-2 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Archive
        </button>
        <button id="bulk-cancel-sites" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Site Status Modal -->
  <div id="bulk-site-status-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Select New Status</h4>
      </div>
      <div class="p-4 space-y-2">
        <button data-status="Active" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">Active</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Site is operational</p>
        </button>
        <button data-status="Paused" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">Paused</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Site operations are temporarily paused</p>
        </button>
        <button data-status="In Setup" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">In Setup</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Site is being set up</p>
        </button>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end">
        <button data-cancel-site-status class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Site Worker Modal -->
  <div id="bulk-site-worker-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Select Worker</h4>
      </div>
      <div class="p-4 max-h-96 overflow-y-auto space-y-2" id="bulk-site-worker-list">
        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading workers...</p>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end">
        <button data-cancel-site-worker class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Add Site Modal (same as dashboard) -->
  <div id="addSiteModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Add New Site</h4>
        <button data-action="close-modal" data-target="addSiteModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="add-site-form" class="p-6 space-y-4">
        <!-- Site Name -->
        <div>
          <label class="block text-sm font-medium mb-1.5">Site Name <span class="text-red-500">*</span></label>
          <input 
            type="text"
            name="name" 
            required 
            placeholder="e.g., Downtown Office Tower"
            class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <!-- Address -->
        <div>
          <label class="block text-sm font-medium mb-1.5">Address <span class="text-red-500">*</span></label>
          <input 
            type="text"
            name="address" 
            required 
            placeholder="123 Main Street, City, Province, Postal Code"
            class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <!-- Deal Value and Square Footage Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Deal Value ($)</label>
            <input 
              type="number"
              name="deal_value" 
              placeholder="e.g., 50000.00"
              step="0.01"
              min="0"
              class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Square Footage</label>
            <input 
              type="number"
              name="square_footage" 
              placeholder="e.g., 5000"
              min="0"
              class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
        </div>

        <!-- Contact Information -->
        <div class="border-t border-nfgray pt-4">
          <h5 class="text-sm font-semibold text-nfgblue dark:text-blue-400 mb-3">Contact Information</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1.5">Contact Phone</label>
              <input 
                type="tel"
                name="contact_phone" 
                placeholder="(123) 456-7890"
                class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Contact Email</label>
              <input 
                type="email"
                name="contact_email" 
                placeholder="contact@example.com"
                class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium mb-1.5">Notes</label>
          <textarea 
            name="notes" 
            rows="3" 
            placeholder="Add any additional information about this site..."
            class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>

        <!-- Error Message -->
        <div id="form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3">
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button 
            type="button" 
            data-action="close-modal" 
            data-target="addSiteModal"
            class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button 
            type="submit" 
            id="submit-site-btn"
            class="px-5 py-2.5 rounded-xl bg-nfgblue text-white hover:bg-nfgdark font-medium transition inline-flex items-center gap-2">
            <span>Create Site</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Site Detail Modal (include from dashboard) -->
  <!-- ... (I'll add this in a moment) ... -->

  <!-- PWA Installation -->
  <script type="module" src="./js/pwa.js"></script>

  <!-- ========== SCRIPTS ========== -->
  <script>
    // Render Lucide icons
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
    });

    // Modal functionality
    document.addEventListener('click', (e) => {
      // Open modal
      const openModalBtn = e.target.closest('[data-action="open-modal"]');
      if (openModalBtn) {
        const targetId = openModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          if (window.lucide) lucide.createIcons();
        }
      }

      // Close modal
      const closeModalBtn = e.target.closest('[data-action="close-modal"]');
      if (closeModalBtn) {
        const targetId = closeModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          const form = modal.querySelector('form');
          if (form) form.reset();
          const errorEl = modal.querySelector('#form-error');
          if (errorEl) errorEl.classList.add('hidden');
        }
      }

      // Close modal when clicking backdrop
      if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
        e.target.classList.add('hidden');
        e.target.classList.remove('flex');
      }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
        modals.forEach(modal => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        });
      }
    });
  </script>

  <!-- Your modules -->
  <script type="module" src="./js/supabase.js"></script>
  <script type="module" src="./js/ui.js"></script>
  <script type="module" src="./js/notification-center.js"></script>
  <script type="module" src="./js/custom-dropdown.js"></script>
  <script type="module">
    import { supabase } from './js/supabase.js'
    import { renderSites, setSubmitLoading, showFormError, closeAddSiteModal, initializeUI } from './js/ui.js'
    import { showNotification, showConfirm, showPrompt, toast, notify } from './js/notifications.js'
    
    // Make supabase and renderSites globally available for bulk operations script
    window.supabase = supabase;
    window.renderSites = renderSites;

    // Logout functionality
    async function handleLogout() {
      await supabase.auth.signOut()
      window.location.href = './index.html'
    }

    // Global variables for user role
    let currentUser = null;
    let currentUserProfile = null;
    let selectedSites = new Set(); // Track selected site IDs
    let allSites = []; // Store all sites for selection tracking
    
    // Make currentUser globally available for bulk operations script
    window.currentUser = currentUser;
    window.currentUserProfile = currentUserProfile;

    // Get current user and their profile
    async function getCurrentUser() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      window.currentUser = currentUser; // Update global reference
      
      if (user) {
        // Get user profile to check role
        const { data: profile, error } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (!error && profile) {
          currentUserProfile = profile;
          window.currentUserProfile = currentUserProfile; // Update global reference
          console.log('User role:', profile.role);
        } else {
          // Default to staff if no profile found
          currentUserProfile = { role: 'staff' };
          window.currentUserProfile = currentUserProfile; // Update global reference
        }
      }
      
      return user;
    }

    // Fetch and display sites (with role-based filtering)
    // Calculate metrics for each site
    async function calculateSiteMetrics(sites) {
      if (!sites || sites.length === 0) return sites;
      
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Get all site IDs
        const siteIds = sites.map(s => s.id);
        
        // Fetch upcoming bookings count for each site
        const { data: bookingCounts, error: bookingsError } = await supabase
          .from('bookings')
          .select('site_id')
          .eq('status', 'pending')
          .gte('scheduled_date', today)
          .in('site_id', siteIds);
        
        if (bookingsError) {
          console.error('Error fetching booking counts:', bookingsError);
        }
        
        // Fetch completed jobs count for each site
        const { data: jobCounts, error: jobsError } = await supabase
          .from('jobs')
          .select('site_id')
          .eq('status', 'completed')
          .in('site_id', siteIds);
        
        if (jobsError) {
          console.error('Error fetching job counts:', jobsError);
        }
        
        // Create maps for counts
        const upcomingBookingsMap = {};
        const completedJobsMap = {};
        
        // Count bookings per site
        if (bookingCounts) {
          bookingCounts.forEach(booking => {
            upcomingBookingsMap[booking.site_id] = (upcomingBookingsMap[booking.site_id] || 0) + 1;
          });
        }
        
        // Count jobs per site
        if (jobCounts) {
          jobCounts.forEach(job => {
            completedJobsMap[job.site_id] = (completedJobsMap[job.site_id] || 0) + 1;
          });
        }
        
        // Attach metrics to each site
        return sites.map(site => ({
          ...site,
          upcoming_bookings: upcomingBookingsMap[site.id] || 0,
          jobs_completed: completedJobsMap[site.id] || 0
        }));
      } catch (error) {
        console.error('Error calculating site metrics:', error);
        return sites;
      }
    }

    async function fetchSites() {
      try {
        let sites = [];
        
        // If user is staff, get only assigned sites
        if (currentUserProfile && currentUserProfile.role === 'staff') {
          console.log('ðŸ” Fetching sites for staff user:', currentUser.id);
          
          // Get site IDs assigned to this worker
          const { data: assignments, error: assignError } = await supabase
            .from('worker_site_assignments')
            .select('site_id')
            .eq('worker_id', currentUser.id);
          
          console.log('ðŸ“‹ Assignments found:', assignments);
          
          if (assignError) {
            console.error('âŒ Error fetching assignments:', assignError);
            return [];
          }
          
          if (!assignments || assignments.length === 0) {
            console.warn('âš ï¸ No site assignments found for this staff member');
            return []; // No sites assigned
          }
          
          const siteIds = assignments.map(a => a.site_id);
          console.log('ðŸ¢ Fetching sites with IDs:', siteIds);
          
          // Fetch those sites from Supabase
          const { data: fetchedSites, error } = await supabase
            .from('sites')
            .select('*')
            .in('id', siteIds)
            .order('name', { ascending: true });
          
          console.log('âœ… Sites fetched:', fetchedSites);
          
          if (error) {
            console.error('âŒ Error fetching sites:', error);
            return [];
          }
          
          sites = fetchedSites || [];
        } else {
          // Admin/Client - fetch ONLY their sites from Supabase
          console.log('ðŸ” Fetching sites for user:', currentUser.id);
          const { data: fetchedSites, error } = await supabase
            .from('sites')
            .select('*')
            .eq('created_by', currentUser.id)
            .order('name', { ascending: true });
          
          if (error) {
            console.error('Error fetching sites from Supabase:', error);
            return [];
          }
          
          sites = fetchedSites || [];
        }
        
        // Calculate metrics for all sites
        const sitesWithMetrics = await calculateSiteMetrics(sites);
        console.log('Sites with metrics:', sitesWithMetrics);
        
        return sitesWithMetrics;
      } catch (error) {
        console.error('Error fetching sites:', error)
        return []
      }
    }
    
    // Make fetchSites globally available for bulk operations script
    window.fetchSites = fetchSites;

    // Create new site
    async function createSite(siteData) {
      try {
        console.log('Creating site in Supabase:', siteData);
        
        // Ensure we have current user
        if (!currentUser) {
          await getCurrentUser();
        }
        
        // Create site in Supabase
        const { data: newSite, error } = await supabase
          .from('sites')
          .insert({
            name: siteData.name,
            address: siteData.address,
              status: siteData.status || 'Active',
              deal_value: siteData.deal_value,
            square_footage: siteData.square_footage,
            contact_phone: siteData.contact_phone,
            contact_email: siteData.contact_email,
            notes: siteData.notes,
            created_by: currentUser.id  // CRITICAL: Set the owner!
          })
          .select()
          .single();
        
        if (error) {
          console.error('Error creating site in Supabase:', error);
          throw error;
        }
        
        console.log('âœ… Site created in Supabase:', newSite);
        return newSite;
      } catch (error) {
        console.error('Error creating site:', error)
        throw error
      }
    }

    // Handle site form submission
    async function handleSiteFormSubmit(e) {
      e.preventDefault()
      
      const form = e.target
      const formData = new FormData(form)
      
      const siteData = {
        name: formData.get('name'),
        address: formData.get('address'),
        deal_value: formData.get('deal_value') ? parseFloat(formData.get('deal_value')) : null,
        square_footage: formData.get('square_footage') ? parseInt(formData.get('square_footage')) : null,
        contact_phone: formData.get('contact_phone') || null,
        contact_email: formData.get('contact_email') || null,
        notes: formData.get('notes') || null
      }
      
      setSubmitLoading(true)
      
      try {
        await createSite(siteData)
        
        const sites = await fetchSites()
        allSites = sites;
        window.allSites = allSites;
        window.selectedSites = selectedSites;
        await renderSites(sites, { currentUserProfile })
        
        closeAddSiteModal()
        
        console.log('Site created successfully!')
        
      } catch (error) {
        showFormError(error.message || 'Failed to create site. Please try again.')
      } finally {
        setSubmitLoading(false)
      }
    }

    // Load and render sites (make it globally accessible)
    async function loadAndRenderSites() {
      console.log('ðŸ”„ Loading and rendering sites...');
      const sites = await fetchSites();
      allSites = sites;
      window.allSites = sites; // Update global reference
      window.selectedSites = selectedSites;
      await renderSites(sites, { currentUserProfile });
      window.lastSitesRefresh = Date.now(); // Update refresh timestamp
    }
    
    // Make loadAndRenderSites globally available for CSV import to call
    window.loadAndRenderSites = loadAndRenderSites;
    
    // Listen for refresh trigger from CSV import (localStorage event for cross-tab)
    window.addEventListener('storage', (e) => {
      if (e.key === 'sites-refresh-trigger') {
        console.log('ðŸ”„ Storage event triggered sites refresh');
        loadAndRenderSites();
      }
    });
    
    // Also check on focus in case localStorage event doesn't fire
    window.addEventListener('focus', () => {
      // Debounce: only refresh if last refresh was more than 2 seconds ago
      if (window.lastSitesRefresh && Date.now() - window.lastSitesRefresh < 2000) {
        return;
      }
      window.lastSitesRefresh = Date.now();
      // Don't auto-refresh on focus to avoid interrupting user
      // loadAndRenderSites();
    });
    
    // Initialize page
    async function initPage() {
      // Get current user first
      await getCurrentUser();
      if (!currentUser) {
        window.location.href = './index.html';
        return;
      }
      
      // Hide "Add Site" button for staff
      if (currentUserProfile && currentUserProfile.role === 'staff') {
        const addSiteBtn = document.getElementById('add-site-btn');
        if (addSiteBtn) {
          addSiteBtn.style.display = 'none';
        }
        
        // Hide Reports navigation for staff (but allow Bookings for calendar view)
        const reportsNav = document.getElementById('nav-reports');
        if (reportsNav) reportsNav.style.display = 'none';
        
        // Update Bookings link text for staff to indicate calendar view
        const bookingsNav = document.getElementById('nav-bookings');
        if (bookingsNav) {
          const bookingsText = bookingsNav.querySelector('span') || bookingsNav.childNodes[bookingsNav.childNodes.length - 1];
          if (bookingsText && bookingsText.textContent) {
            bookingsText.textContent = 'Schedule';
          } else {
            bookingsNav.innerHTML = '<i data-lucide="calendar" class="w-4 h-4"></i> Schedule';
            if (window.lucide) lucide.createIcons();
          }
        }
      }
      
      // Use the loadAndRenderSites function instead
      await loadAndRenderSites();
      
      // Initialize UI event handlers (for View Site buttons and modals)
      initializeUI()
      
      // Initialize global variables
      window.currentEditSite = null;
      
      // Initialize bulk site operations
      initBulkSiteOperations();
      
      // View Job History button handler
      document.getElementById('view-job-history-btn')?.addEventListener('click', async () => {
        const siteId = window.currentEditSite?.id;
        if (!siteId) {
          toast.error('No site selected. Please close and reopen the site details.', 'Error');
          return;
        }
        await openJobHistoryModal(siteId);
      });
      
      // Close Job History Modal
      document.getElementById('close-job-history-modal')?.addEventListener('click', () => {
        document.getElementById('jobHistoryModal').classList.add('hidden');
      });
      
      // Close Photo Viewer Modal
      document.getElementById('close-photo-viewer')?.addEventListener('click', () => {
        document.getElementById('photoViewerModal').classList.add('hidden');
      });
      
      // Close photo viewer on backdrop click
      document.getElementById('photoViewerModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'photoViewerModal') {
          document.getElementById('photoViewerModal').classList.add('hidden');
        }
      });
      
      // Close photo viewer on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const photoViewer = document.getElementById('photoViewerModal');
          if (photoViewer && !photoViewer.classList.contains('hidden')) {
            photoViewer.classList.add('hidden');
          }
          const jobHistory = document.getElementById('jobHistoryModal');
          if (jobHistory && !jobHistory.classList.contains('hidden')) {
            jobHistory.classList.add('hidden');
          }
        }
      });
      
      // Open photo viewer function (global)
      window.viewJobPhoto = function(photoUrl, caption) {
        const modal = document.getElementById('photoViewerModal');
        const img = document.getElementById('photo-viewer-image');
        const captionEl = document.getElementById('photo-viewer-caption');
        
        if (modal && img && photoUrl) {
          img.src = photoUrl;
          captionEl.textContent = caption || 'Job Photo';
          modal.classList.remove('hidden');
        }
      };
      
      // Edit Site button handler
      document.getElementById('edit-site-btn')?.addEventListener('click', () => {
        console.log('[Edit] Edit button clicked! Current site:', window.currentEditSite);
        
        // Check if user is staff - prevent editing
        if (currentUserProfile && currentUserProfile.role === 'staff') {
          toast.error('Staff members cannot edit sites.', 'Access Denied');
          return;
        }
        
        if (!window.currentEditSite) {
          console.error('[Edit] âŒ No site selected for editing');
          toast.error('No site selected. Please close and reopen the site details.', 'Edit Error');
          return;
        }

        console.log('[Edit] âœ… Opening edit modal for:', window.currentEditSite.name);

        // Populate form with current site data
        document.getElementById('edit-site-id').value = window.currentEditSite.id;
        document.getElementById('edit-site-name').value = window.currentEditSite.name || '';
        document.getElementById('edit-site-address').value = window.currentEditSite.address || '';
        document.getElementById('edit-site-status').value = window.currentEditSite.status || 'Active';
        document.getElementById('edit-site-sqft').value = window.currentEditSite.square_footage || '';
        document.getElementById('edit-site-deal-value').value = window.currentEditSite.deal_value || '';
        document.getElementById('edit-site-phone').value = window.currentEditSite.contact_phone || '';
        document.getElementById('edit-site-email').value = window.currentEditSite.contact_email || '';
        document.getElementById('edit-site-notes').value = window.currentEditSite.notes || '';

        // Close site detail modal and open edit modal
        document.getElementById('siteDetailModal').classList.add('hidden');
        document.getElementById('siteDetailModal').classList.remove('flex');
        document.getElementById('editSiteModal').classList.remove('hidden');
        document.getElementById('editSiteModal').classList.add('flex');

        // Re-render icons
        if (window.lucide) lucide.createIcons();
      });

      // Handle edit site form submission
      document.getElementById('edit-site-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const siteId = formData.get('id');
        
        const updateData = {
          name: formData.get('name'),
          address: formData.get('address'),
          status: formData.get('status'),
          square_footage: formData.get('square_footage') ? parseInt(formData.get('square_footage')) : null,
          deal_value: formData.get('deal_value') ? parseFloat(formData.get('deal_value')) : null,
          contact_phone: formData.get('contact_phone') || null,
          contact_email: formData.get('contact_email') || null,
          notes: formData.get('notes') || null
        };

        try {
          const { error } = await supabase
            .from('sites')
            .update(updateData)
            .eq('id', siteId);

          if (error) throw error;

          // Close modal
          document.getElementById('editSiteModal').classList.add('hidden');
          document.getElementById('editSiteModal').classList.remove('flex');

          // Refresh sites display
          const sites = await fetchSites();
          allSites = sites;
          window.allSites = allSites;
          window.selectedSites = selectedSites;
          await renderSites(sites, { currentUserProfile });

          toast.success('Site has been updated successfully!', 'Site Updated');
        } catch (error) {
          console.error('Error updating site:', error);
          const errorEl = document.getElementById('edit-form-error');
          if (errorEl) {
            errorEl.textContent = 'Failed to update site: ' + error.message;
            errorEl.classList.remove('hidden');
          }
        }
      });
      
      // Attach form submit handler
      const form = document.getElementById('add-site-form')
      form?.addEventListener('submit', handleSiteFormSubmit)
      
      // Attach logout handler
      document.getElementById('logout-btn')?.addEventListener('click', handleLogout)
      
      // Re-render icons after modals are added
      if (window.lucide) {
        lucide.createIcons()
      }
    }

    // Open Job History Modal
    async function openJobHistoryModal(siteId) {
      try {
        console.log('[Job History] Opening modal for site:', siteId);
        
        // Get site name
        const site = window.currentEditSite;
        const siteName = site?.name || 'Unknown Site';
        document.getElementById('job-history-site-name').textContent = `Job History - ${siteName}`;
        
        // Show modal
        const modal = document.getElementById('jobHistoryModal');
        if (!modal) {
          console.error('[Job History] Modal not found');
          return;
        }
        modal.classList.remove('hidden');
        
        // Show loading state
        const listContainer = document.getElementById('job-history-list');
        listContainer.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <i data-lucide="loader" class="w-12 h-12 mx-auto mb-3 animate-spin"></i>
            <p>Loading job history...</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        
        // Fetch all jobs for this site
        const { data: jobs, error: jobsError } = await supabase
          .from('jobs')
          .select('*')
          .eq('site_id', siteId)
          .order('created_at', { ascending: false });
        
        if (jobsError) {
          console.error('[Job History] Error fetching jobs:', jobsError);
          const { handleError } = await import('./js/notifications.js');
          const friendlyMessage = handleError(jobsError, 'Loading job history');
          listContainer.innerHTML = `
            <div class="text-center py-8 text-red-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-3"></i>
              <p>${friendlyMessage}</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        if (!jobs || jobs.length === 0) {
          listContainer.innerHTML = `
            <div class="text-center py-12 text-gray-500 dark:text-gray-400">
              <i data-lucide="clipboard-x" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-2">No Jobs Yet</h3>
              <p>This site doesn't have any jobs yet.</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        console.log('[Job History] Found', jobs.length, 'jobs');
        
        // Fetch tasks and worker info for each job
        const jobIds = jobs.map(j => j.id);
        const { data: tasks, error: tasksError } = await supabase
          .from('job_tasks')
          .select('*')
          .in('job_id', jobIds);
        
        if (tasksError) {
          console.warn('[Job History] Error fetching tasks:', tasksError);
        }
        
        // Fetch worker profiles
        const workerIds = [...new Set(jobs.map(j => j.assigned_worker_id).filter(Boolean))];
        let workersMap = {};
        if (workerIds.length > 0) {
          const { data: workers } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .in('id', workerIds);
          
          if (workers) {
            workers.forEach(w => {
              workersMap[w.id] = w;
            });
          }
        }
        
        // Group tasks by job_id
        const tasksByJob = {};
        (tasks || []).forEach(task => {
          if (!tasksByJob[task.job_id]) {
            tasksByJob[task.job_id] = [];
          }
          tasksByJob[task.job_id].push(task);
        });
        
        // Render jobs
        const statusColors = {
          'pending': 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
          'in-progress': 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
          'completed': 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
          'cancelled': 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300'
        };
        
        const statusIcons = {
          'pending': 'clock',
          'in-progress': 'loader',
          'completed': 'check-circle',
          'cancelled': 'x-circle'
        };
        
        listContainer.innerHTML = jobs.map(job => {
          const jobTasks = tasksByJob[job.id] || [];
          const completedTasks = jobTasks.filter(t => t.completed).length;
          const totalTasks = jobTasks.length;
          const worker = job.assigned_worker_id ? workersMap[job.assigned_worker_id] : null;
          const workerName = worker?.full_name || worker?.email || 'Unassigned';
          const statusClass = statusColors[job.status] || 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
          const statusIcon = statusIcons[job.status] || 'circle';
          const createdDate = new Date(job.created_at).toLocaleDateString();
          const completedDate = job.completed_at ? new Date(job.completed_at).toLocaleDateString() : null;
          const isEmergency = job.job_type === 'emergency';
          
          // Get tasks with photos
          const tasksWithPhotos = jobTasks.filter(t => t.photo_url);
          
          return `
            <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg">
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <h5 class="text-lg font-semibold text-nfgblue dark:text-blue-400 ${isEmergency ? 'text-red-600' : ''}">
                      ${isEmergency ? 'ðŸš¨ ' : ''}${job.title}
                    </h5>
                  </div>
                  <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
                    <span class="flex items-center gap-1">
                      <i data-lucide="calendar" class="w-3 h-3"></i>
                      ${createdDate}
                    </span>
                    ${completedDate ? `
                      <span class="flex items-center gap-1">
                        <i data-lucide="check" class="w-3 h-3"></i>
                        Completed: ${completedDate}
                      </span>
                    ` : ''}
                    <span class="flex items-center gap-1">
                      <i data-lucide="user" class="w-3 h-3"></i>
                      ${workerName}
                    </span>
                    <span class="flex items-center gap-1">
                      <i data-lucide="list-checks" class="w-3 h-3"></i>
                      ${completedTasks}/${totalTasks} tasks
                    </span>
                  </div>
                </div>
                <span class="px-3 py-1 rounded-lg text-xs font-medium ${statusClass} flex items-center gap-1 flex-shrink-0 ml-2">
                  <i data-lucide="${statusIcon}" class="w-3 h-3"></i>
                  ${job.status.charAt(0).toUpperCase() + job.status.slice(1).replace('-', ' ')}
                </span>
              </div>
              
              ${job.description ? `
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">${job.description}</p>
              ` : ''}
              
              ${tasksWithPhotos.length > 0 ? `
                <div class="mb-3">
                  <h6 class="text-sm font-medium text-nfgblue dark:text-blue-400 mb-2 flex items-center gap-2">
                    <i data-lucide="image" class="w-4 h-4"></i>
                    Photos (${tasksWithPhotos.length})
                  </h6>
                  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    ${tasksWithPhotos.map(task => `
                      <div class="relative group cursor-pointer" onclick="viewJobPhoto('${task.photo_url}', '${(task.title || 'Task').replace(/'/g, "\\'")}')">
                        <img src="${task.photo_url}" alt="${task.title}" class="w-full h-24 object-cover rounded-lg border border-nfgray dark:border-gray-700 hover:opacity-80 transition">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 rounded-lg transition flex items-center justify-center">
                          <i data-lucide="zoom-in" class="w-5 h-5 text-white opacity-0 group-hover:opacity-100 transition"></i>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 truncate">${task.title || 'Task'}</p>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${jobTasks.length > 0 ? `
                <div class="border-t border-nfgray dark:border-gray-700 pt-3">
                  <h6 class="text-sm font-medium text-nfgblue dark:text-blue-400 mb-2">Tasks</h6>
                  <div class="space-y-2">
                    ${jobTasks.map(task => `
                      <div class="flex items-center gap-2 text-sm">
                        ${task.completed ? `
                          <i data-lucide="check-circle" class="w-4 h-4 text-green-600 flex-shrink-0"></i>
                          <span class="text-gray-600 dark:text-gray-300 line-through">${task.title}</span>
                        ` : `
                          <i data-lucide="circle" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
                          <span class="text-gray-700 dark:text-gray-200">${task.title}</span>
                        `}
                        ${task.photo_url ? `
                          <button onclick="viewJobPhoto('${task.photo_url}', '${(task.title || 'Task').replace(/'/g, "\\'")}')" 
                                  class="ml-auto text-xs px-2 py-1 rounded border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 flex items-center gap-1">
                            <i data-lucide="image" class="w-3 h-3"></i>
                            View Photo
                          </button>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
        
        if (window.lucide) lucide.createIcons();
        
      } catch (error) {
        console.error('[Job History] Error:', error);
        const { handleError } = await import('./js/notifications.js');
        const friendlyMessage = handleError(error, 'Loading job history');
        const listContainer = document.getElementById('job-history-list');
        if (listContainer) {
          listContainer.innerHTML = `
            <div class="text-center py-8 text-red-500">
              <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-3"></i>
              <p>${friendlyMessage}</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
        }
      }
    }

    // Load page
    initPage()
  </script>

  <!-- Site Detail Modal -->
  <div id="siteDetailModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <!-- Header -->
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <i data-lucide="building-2" class="w-6 h-6 text-nfgblue dark:text-blue-400 flex-shrink-0"></i>
          <div class="flex-1 min-w-0">
            <h4 id="site-detail-name" class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Site Name</h4>
            <div id="site-detail-address" class="text-sm text-gray-500 dark:text-gray-400">Address</div>
          </div>
        </div>
        <button data-action="close-modal" data-target="siteDetailModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 flex-shrink-0 text-gray-700 dark:text-gray-300">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 space-y-6">
        <!-- Site Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Status Card -->
          <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgblue/20 dark:border-blue-500/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="activity" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium text-nftext dark:text-gray-200">Status</span>
            </div>
            <p id="site-detail-status" class="text-xl font-semibold text-nfgblue dark:text-blue-400">Active</p>
          </div>

          <!-- Square Footage Card -->
          <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgblue/20 dark:border-blue-500/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="ruler" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium text-nftext dark:text-gray-200">Square Footage</span>
            </div>
            <p id="site-detail-sqft" class="text-xl font-semibold text-nfgblue dark:text-blue-400">â€”</p>
          </div>

          <!-- Deal Value Card -->
          <div class="bg-nfglight/30 dark:bg-gray-700/30 border border-nfgblue/20 dark:border-blue-500/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="dollar-sign" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium text-nftext dark:text-gray-200">Deal Value</span>
            </div>
            <p id="site-detail-deal-value" class="text-xl font-semibold text-nfgblue dark:text-blue-400">â€”</p>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
          <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="contact" class="w-4 h-4"></i>
            Contact Information
          </h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Phone</p>
              <p id="site-detail-phone" class="text-nftext dark:text-gray-200 font-medium">â€”</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Email</p>
              <p id="site-detail-email" class="text-nftext dark:text-gray-200 font-medium">â€”</p>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="clipboard-check" class="w-4 h-4"></i>
              Jobs Completed
            </h5>
            <p id="site-detail-jobs" class="text-3xl font-bold text-nfgblue dark:text-blue-400">0</p>
          </div>
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
              <i data-lucide="calendar" class="w-4 h-4"></i>
              Upcoming Bookings
            </h5>
            <p id="site-detail-bookings" class="text-3xl font-bold text-nfgblue dark:text-blue-400">0</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
          <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            Notes
          </h5>
          <p id="site-detail-notes" class="text-nftext dark:text-gray-200">No notes available.</p>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
          <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="history" class="w-4 h-4"></i>
            Recent Activity
          </h5>
          <div id="site-detail-activity" class="space-y-2">
            <p class="text-gray-500 dark:text-gray-400 text-sm">No recent activity.</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 border-t border-nfgray dark:border-gray-700 pt-4">
          <button id="view-job-history-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark transition">
            <i data-lucide="history" class="w-4 h-4"></i>
            View Job History
          </button>
          <button class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark transition">
            <i data-lucide="calendar-plus" class="w-4 h-4"></i>
            Schedule Booking
          </button>
          <button id="edit-site-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-nfgray dark:border-gray-700 dark:text-gray-200 hover:bg-nfglight dark:hover:bg-gray-700 transition">
            <i data-lucide="edit" class="w-4 h-4"></i>
            Edit Site
          </button>
          <button id="delete-site-btn" data-action="delete-site" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition ml-auto">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            Delete Site
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job History Modal -->
  <div id="jobHistoryModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <div class="flex items-center gap-3">
          <i data-lucide="history" class="w-6 h-6 text-nfgblue dark:text-blue-400"></i>
          <div>
            <h4 id="job-history-site-name" class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Job History</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">All jobs for this site</p>
          </div>
        </div>
        <button id="close-job-history-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 flex-shrink-0 text-gray-700 dark:text-gray-300">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <!-- Job List -->
      <div id="job-history-list" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i data-lucide="loader" class="w-12 h-12 mx-auto mb-3 animate-spin"></i>
          <p>Loading job history...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Viewer Modal -->
  <div id="photoViewerModal" class="hidden fixed inset-0 bg-black/90 items-center justify-center p-4 z-[70]">
    <div class="relative w-full h-full max-w-7xl max-h-[90vh] flex flex-col">
      <button id="close-photo-viewer" class="absolute top-4 right-4 z-10 p-2 rounded-full bg-white/10 hover:bg-white/20 text-white transition">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <img id="photo-viewer-image" src="" alt="Job Photo" class="max-w-full max-h-full object-contain mx-auto">
      <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-4 py-2 rounded-lg">
        <p id="photo-viewer-caption" class="text-sm"></p>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteSiteConfirmModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-red-200 w-full max-w-md">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
          </div>
          <div>
            <h4 class="text-lg font-semibold text-nftext dark:text-gray-200">Delete Site?</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone</p>
          </div>
        </div>
        
        <p class="text-nftext mb-6">
          Are you sure you want to delete <strong id="delete-site-name" class="text-nfgblue dark:text-blue-400">this site</strong>? 
          All associated data, bookings, and job history will be permanently removed.
        </p>
        
        <div class="flex items-center gap-3">
          <button 
            data-action="close-modal" 
            data-target="deleteSiteConfirmModal"
            class="flex-1 px-4 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button 
            id="confirm-delete-btn"
            data-action="confirm-delete-site"
            class="flex-1 px-4 py-2.5 rounded-xl bg-red-600 text-white hover:bg-red-700 font-medium transition inline-flex items-center justify-center gap-2">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span>Delete Site</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Site Modal -->
  <div id="editSiteModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Edit Site</h4>
        <button data-action="close-modal" data-target="editSiteModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="edit-site-form" class="p-6 space-y-4">
        <input type="hidden" id="edit-site-id" name="id" />
        
        <!-- Site Name -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Site Name <span class="text-red-500">*</span></label>
          <input 
            type="text"
            id="edit-site-name"
            name="name" 
            required 
            placeholder="e.g., Downtown Office Tower"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Address -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Address</label>
          <input 
            type="text"
            id="edit-site-address"
            name="address" 
            placeholder="e.g., 123 Main St, Toronto, ON"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Status</label>
          <select 
            id="edit-site-status" 
            name="status"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Under Maintenance">Under Maintenance</option>
          </select>
        </div>

        <!-- Square Footage -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Square Footage</label>
          <input 
            type="number"
            id="edit-site-sqft"
            name="square_footage" 
            placeholder="e.g., 5000"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Deal Value -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Deal Value ($)</label>
          <input 
            type="number"
            id="edit-site-deal-value"
            name="deal_value" 
            step="0.01"
            min="0"
            placeholder="e.g., 50000.00"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Contact Phone -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Contact Phone</label>
          <input 
            type="tel"
            id="edit-site-phone"
            name="contact_phone" 
            placeholder="e.g., 416-555-0100"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Contact Email -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Contact Email</label>
          <input 
            type="email"
            id="edit-site-email"
            name="contact_email" 
            placeholder="e.g., contact@site.com"
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none" />
        </div>

        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium mb-1.5 dark:text-gray-200">Notes</label>
          <textarea 
            id="edit-site-notes"
            name="notes" 
            rows="3"
            placeholder="Additional notes about the site..."
            class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-2.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-400 focus:ring-2 focus:ring-nfgblue dark:focus:ring-blue-500 outline-none resize-none"></textarea>
        </div>

        <div id="edit-form-error" class="hidden text-red-600 dark:text-red-400 text-sm bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-3">
        </div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button 
            type="button" 
            data-action="close-modal" 
            data-target="editSiteModal"
            class="px-5 py-2.5 rounded-xl border border-nfgray dark:border-gray-700 dark:text-gray-200 hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
            Cancel
          </button>
          <button 
            type="submit" 
            id="update-site-btn"
            class="px-5 py-2.5 rounded-xl bg-nfgblue text-white hover:bg-nfgdark font-medium transition inline-flex items-center gap-2"
>
            <span>Update Site</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Site Operations JavaScript -->
  <script>
    // Initialize bulk operations
    function initBulkSiteOperations() {
      // Select All checkbox
      const selectAllCheckbox = document.getElementById('select-all-sites');
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectAllSites();
          } else {
            deselectAllSites();
          }
        });
      }

      // Cancel selection
      document.getElementById('bulk-cancel-sites')?.addEventListener('click', () => {
        deselectAllSites();
        renderSites(allSites, { currentUserProfile });
      });

      // Bulk assign worker
      document.getElementById('bulk-assign-worker-sites')?.addEventListener('click', async () => {
        if (selectedSites.size === 0) {
          toast.error('Please select at least one site');
          return;
        }
        
        const workerId = await showBulkSiteWorkerModal();
        if (!workerId) return;
        
        const confirmed = await showConfirm(
          `Assign selected worker to ${selectedSites.size} site(s)?`,
          'Bulk Assign Worker'
        );
        if (!confirmed) return;
        
        await bulkAssignWorkerToSites(workerId);
      });

      // Bulk update status
      document.getElementById('bulk-update-status-sites')?.addEventListener('click', async () => {
        if (selectedSites.size === 0) {
          toast.error('Please select at least one site');
          return;
        }
        
        const status = await showBulkSiteStatusModal();
        if (!status) return;
        
        const confirmed = await showConfirm(
          `Update ${selectedSites.size} site(s) to "${status}"?`,
          'Bulk Update Status'
        );
        if (!confirmed) return;
        
        await bulkUpdateSiteStatus(status);
      });

      // Bulk archive
      document.getElementById('bulk-archive-sites')?.addEventListener('click', async () => {
        if (selectedSites.size === 0) {
          toast.error('Please select at least one site');
          return;
        }
        
        const confirmed = await showConfirm(
          `Archive ${selectedSites.size} site(s)? They will be hidden but preserved for records.`,
          'Bulk Archive Sites',
          'warning'
        );
        if (!confirmed) return;
        
        await bulkArchiveSites();
      });
    }

    // Get visible sites (based on current filter)
    function getVisibleSites() {
      // For now, return all sites. If filtering is added later, apply it here
      return allSites || [];
    }

    // Select all visible sites
    function selectAllSites() {
      const visibleSites = getVisibleSites();
      visibleSites.forEach(site => {
        selectedSites.add(site.id);
      });
      // Force update after a tiny delay to ensure DOM is ready
      setTimeout(() => {
        updateSiteCheckboxes();
        updateBulkSitesToolbar();
        updateSelectAllSitesCheckbox();
      }, 0);
    }

    // Deselect all sites
    function deselectAllSites() {
      selectedSites.clear();
      // Force update after a tiny delay to ensure DOM is ready
      setTimeout(() => {
        updateSiteCheckboxes();
        updateBulkSitesToolbar();
        updateSelectAllSitesCheckbox();
      }, 0);
    }

    // Attach checkbox listeners (make globally available)
    window.attachSiteCheckboxListeners = function() {
      document.querySelectorAll('.site-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const siteId = e.target.dataset.siteId;
          toggleSiteSelection(siteId);
        });
      });
    };

    // Toggle site selection
    function toggleSiteSelection(siteId) {
      // Convert siteId to string for consistent comparison
      const siteIdStr = String(siteId);
      // Find existing ID in Set using loose comparison
      const existingId = Array.from(selectedSites).find(id => id == siteId);
      
      if (existingId !== undefined) {
        selectedSites.delete(existingId);
      } else {
        // Use the original siteId from the Set or use the string version
        selectedSites.add(siteId);
      }
      updateBulkSitesToolbar();
      updateSelectAllSitesCheckbox();
      updateSiteCheckboxes();
    }

    // Update select all checkbox (make globally available)
    window.updateSelectAllSitesCheckbox = function() {
      const selectAllCheckbox = document.getElementById('select-all-sites');
      if (!selectAllCheckbox) return;
      
      const visibleSites = getVisibleSites();
      const allVisibleSelected = visibleSites.length > 0 && visibleSites.every(site => selectedSites.has(site.id));
      
      selectAllCheckbox.checked = allVisibleSelected;
      selectAllCheckbox.indeterminate = !allVisibleSelected && visibleSites.some(site => selectedSites.has(site.id));
    };

    // Update checkbox states
    function updateSiteCheckboxes() {
      document.querySelectorAll('.site-checkbox').forEach(checkbox => {
        const siteId = checkbox.dataset.siteId;
        // Use loose equality to handle both string and UUID types
        const isSelected = Array.from(selectedSites).some(id => id == siteId);
        checkbox.checked = isSelected;
        
        const card = checkbox.closest('.bg-white, .dark\\:bg-gray-800');
        if (card) {
          if (checkbox.checked) {
            card.classList.remove('border-nfgray', 'dark:border-gray-700');
            card.classList.add('border-nfgblue', 'ring-2', 'ring-nfgblue', 'bg-nfglight/30', 'dark:bg-blue-900/20');
          } else {
            card.classList.remove('border-nfgblue', 'ring-2', 'ring-nfgblue', 'bg-nfglight/30', 'dark:bg-blue-900/20');
            card.classList.add('border-nfgray', 'dark:border-gray-700');
          }
        }
      });
    }

    // Update bulk toolbar
    function updateBulkSitesToolbar() {
      const toolbar = document.getElementById('bulk-sites-toolbar');
      const count = document.getElementById('selected-sites-count');
      
      if (!toolbar || !count) return;
      
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
      
      if (selectedSites.size > 0 && !isStaff) {
        toolbar.classList.remove('hidden');
        count.textContent = `${selectedSites.size} ${selectedSites.size === 1 ? 'site' : 'sites'} selected`;
      } else {
        toolbar.classList.add('hidden');
      }
    }

    // Bulk assign worker to sites
    async function bulkAssignWorkerToSites(workerId) {
      const siteIds = Array.from(selectedSites);
      
      // Get supabase from global scope
      const supabaseClient = window.supabase;
      if (!supabaseClient) {
        toast.error('Error: Supabase client not available');
        return;
      }
      
      try {
        // Get currentUser from global scope
        const user = window.currentUser;
        if (!user) {
          toast.error('Error: User not available');
          return;
        }
        
        // Convert site_id to BIGINT if needed (sites use BIGSERIAL)
        const assignments = siteIds.map(siteId => ({
          worker_id: workerId,
          site_id: typeof siteId === 'string' ? parseInt(siteId, 10) : siteId,
          assigned_by: user.id,
          can_manage: false // Default to view-only access
          // created_at is auto-generated by the database
        }));
        
        // Check for existing assignments first, then insert only new ones
        // and update existing ones if needed
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const assignment of assignments) {
          // Check if assignment already exists
          const { data: existing, error: checkError } = await supabaseClient
            .from('worker_site_assignments')
            .select('id')
            .eq('worker_id', assignment.worker_id)
            .eq('site_id', assignment.site_id)
            .maybeSingle();
          
          if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = not found, which is fine
            errors.push(`Site ID ${assignment.site_id}: ${checkError.message}`);
            errorCount++;
            continue;
          }
          
          if (existing) {
            // Update existing assignment
            const { error: updateError } = await supabaseClient
              .from('worker_site_assignments')
              .update({
                assigned_by: assignment.assigned_by,
                can_manage: assignment.can_manage
              })
              .eq('id', existing.id);
            
            if (updateError) {
              errors.push(`Site ID ${assignment.site_id}: ${updateError.message}`);
              errorCount++;
            } else {
              successCount++;
            }
          } else {
            // Insert new assignment
            const { error: insertError } = await supabaseClient
              .from('worker_site_assignments')
              .insert(assignment);
            
            if (insertError) {
              errors.push(`Site ID ${assignment.site_id}: ${insertError.message}`);
              errorCount++;
            } else {
              successCount++;
            }
          }
        }
        
        if (errorCount > 0) {
          toast.error(`Failed to assign worker to ${errorCount} site(s). ${successCount > 0 ? `${successCount} succeeded.` : ''}`);
          console.error('Assignment errors:', errors);
          return;
        }
        
        toast.success(`Worker assigned to ${siteIds.length} site(s) successfully`);
        deselectAllSites();
        // Use global fetchSites if available, otherwise it will be called from module scope
        const fetchSitesFunc = window.fetchSites || fetchSites;
        const sites = await fetchSitesFunc();
        allSites = sites;
        window.allSites = allSites;
        // Use global renderSites if available
        const renderSitesFunc = window.renderSites || renderSites;
        await renderSitesFunc(sites, { currentUserProfile });
      } catch (err) {
        console.error('Error bulk assigning worker:', err);
        toast.error('An error occurred while assigning worker');
      }
    }

    // Bulk update site status
    async function bulkUpdateSiteStatus(status) {
      const siteIds = Array.from(selectedSites);
      
      // Get supabase from global scope
      const supabaseClient = window.supabase;
      if (!supabaseClient) {
        toast.error('Error: Supabase client not available');
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('sites')
          .update({ status: status })
          .in('id', siteIds);
        
        if (error) {
          toast.error('Failed to update sites: ' + error.message);
          return;
        }
        
        toast.success(`${siteIds.length} site(s) updated successfully`);
        deselectAllSites();
        const fetchSitesFunc = window.fetchSites || fetchSites;
        const sites = await fetchSitesFunc();
        allSites = sites;
        window.allSites = allSites;
        const renderSitesFunc = window.renderSites || renderSites;
        await renderSitesFunc(sites, { currentUserProfile });
      } catch (err) {
        console.error('Error bulk updating sites:', err);
        toast.error('An error occurred while updating sites');
      }
    }

    // Bulk archive sites
    async function bulkArchiveSites() {
      const siteIds = Array.from(selectedSites);
      const now = new Date().toISOString();
      
      // Get supabase from global scope
      const supabaseClient = window.supabase;
      if (!supabaseClient) {
        toast.error('Error: Supabase client not available');
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .from('sites')
          .update({ 
            archived_at: now,
            status: 'Paused'
          })
          .in('id', siteIds);
        
        if (error) {
          toast.error('Failed to archive sites: ' + error.message);
          return;
        }
        
        toast.success(`${siteIds.length} site(s) archived successfully`);
        deselectAllSites();
        const fetchSitesFunc = window.fetchSites || fetchSites;
        const sites = await fetchSitesFunc();
        allSites = sites;
        window.allSites = allSites;
        const renderSitesFunc = window.renderSites || renderSites;
        await renderSitesFunc(sites, { currentUserProfile });
      } catch (err) {
        console.error('Error archiving sites:', err);
        toast.error('An error occurred while archiving sites');
      }
    }

    // Show bulk status modal
    async function showBulkSiteStatusModal() {
      return new Promise((resolve) => {
        const modal = document.getElementById('bulk-site-status-modal');
        const statusButtons = modal.querySelectorAll('[data-status]');
        const cancelBtn = modal.querySelector('[data-cancel-site-status]');
        
        // Remove existing listeners
        statusButtons.forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
        });
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Add new listeners
        modal.querySelectorAll('[data-status]').forEach(btn => {
          btn.addEventListener('click', () => {
            const status = btn.dataset.status;
            modal.classList.add('hidden');
            resolve(status);
          });
        });
        
        modal.querySelector('[data-cancel-site-status]').addEventListener('click', () => {
          modal.classList.add('hidden');
          resolve(null);
        });
        
        modal.classList.remove('hidden');
      });
    }

    // Show bulk worker modal
    async function showBulkSiteWorkerModal() {
      return new Promise(async (resolve) => {
        const modal = document.getElementById('bulk-site-worker-modal');
        const workerList = document.getElementById('bulk-site-worker-list');
        const cancelBtn = modal.querySelector('[data-cancel-site-worker]');
        
        workerList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading workers...</p>';
        modal.classList.remove('hidden');
        
        // Get supabase from global scope
        const supabaseClient = window.supabase;
        if (!supabaseClient) {
          workerList.innerHTML = '<p class="text-red-500 text-center py-4">Error: Supabase client not available</p>';
          return;
        }
        
        try {
          const { data: workers, error } = await supabaseClient
            .from('user_profiles')
            .select('id, full_name, email')
            .eq('role', 'staff')
            .order('full_name');
          
          if (error) {
            workerList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load workers</p>';
            return;
          }
          
          if (workers.length === 0) {
            workerList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No workers available</p>';
            return;
          }
          
          workerList.innerHTML = workers.map(worker => `
            <button 
              data-worker-id="${worker.id}" 
              class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition"
            >
              <span class="font-medium block">${worker.full_name || worker.email}</span>
              <p class="text-sm text-gray-500 dark:text-gray-400">${worker.email}</p>
            </button>
          `).join('');
          
          if (window.lucide) lucide.createIcons();
          
          workerList.querySelectorAll('[data-worker-id]').forEach(btn => {
            btn.addEventListener('click', () => {
              const workerId = btn.dataset.workerId;
              modal.classList.add('hidden');
              resolve(workerId);
            });
          });
        } catch (err) {
          console.error('Error loading workers:', err);
          workerList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load workers</p>';
        }
        
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.addEventListener('click', () => {
          modal.classList.add('hidden');
          resolve(null);
        });
      });
    }
  </script>

  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>


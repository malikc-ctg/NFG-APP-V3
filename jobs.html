<!doctype html>
<html lang="en" class="h-full overflow-hidden">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG â€” Jobs</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

  <!-- Prevent page scrollbar -->
  <style>
    html {
      height: 100% !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      overflow-x: hidden !important;
      overflow-y: hidden !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
    }
    body {
      height: 100vh !important;
      width: 100vw !important;
      max-height: 100vh !important;
      max-width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      overflow-x: hidden !important;
      overflow-y: hidden !important;
      display: flex !important;
      position: relative !important;
    }
    body::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
    }
    html::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
    }
    body > aside {
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
    }
    body > div.flex-1 {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1;
      min-width: 0;
      height: 100vh;
      max-height: 100vh;
    }
    body > div.flex-1 > header {
      flex-shrink: 0;
    }
    body > div.flex-1 > main {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    /* Scrollable content wrapper - NO SCROLLBAR AT ALL */
    body > div.flex-1 > main > div.scrollable-content {
      flex: 1;
      overflow-y: scroll;
      overflow-x: hidden;
      /* Hide scrollbar by making it invisible and 0 width */
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
      /* Use negative margin to hide scrollbar completely */
      margin-right: -20px !important;
      padding-right: 20px !important;
    }
    /* Chrome/Safari/Edge - make scrollbar invisible */
    body > div.flex-1 > main > div.scrollable-content::-webkit-scrollbar {
      width: 0px !important;
      display: none !important;
      background: transparent !important;
      -webkit-appearance: none !important;
    }
    body > div.flex-1 > main > div.scrollable-content::-webkit-scrollbar-track,
    body > div.flex-1 > main > div.scrollable-content::-webkit-scrollbar-thumb,
    body > div.flex-1 > main > div.scrollable-content::-webkit-scrollbar-corner {
      display: none !important;
      width: 0px !important;
      background: transparent !important;
    }
  </style>

</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 h-screen flex text-nftext dark:text-gray-200 overflow-hidden">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Jobs...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <!-- Northern Facilities Group Logo -->
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/2.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzLzIucG5nIiwiaWF0IjoxNzYxODY2MTE0LCJleHAiOjQ4ODM5MzAxMTR9.E1JoQZxqPy0HOKna6YfjPCfin5Pc3QF0paEV7qzVfDw" 
        alt="Northern Facilities Group" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="dashboard.html">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Overview
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="sites.html">
        <i data-lucide="map-pin" class="w-4 h-4"></i> Sites
      </a>
      <a id="nav-bookings" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="bookings.html">
        <i data-lucide="calendar" class="w-4 h-4"></i> Bookings
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="jobs.html">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i> Jobs
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="inventory.html">
        <i data-lucide="package" class="w-4 h-4"></i> Inventory
      </a>
      <a id="nav-reports" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="reports.html">
        <i data-lucide="file-chart-column" class="w-4 h-4"></i> Reports
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700">
      <button id="logout-btn" class="w-full border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Jobs</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <button id="create-job-btn" data-action="open-modal" data-target="createJobModal" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition flex-shrink-0">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span class="hidden sm:inline text-xs sm:text-sm">Create Job</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <div class="flex-shrink-0 p-4 md:p-6 pb-0">
        <div>
          <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Jobs</h2>
          <p class="text-sm text-gray-500 mt-1">Track active jobs and work orders</p>
        </div>

        <!-- Status Tabs with Select All -->
        <div class="flex items-center justify-between gap-4 border-b border-nfgray overflow-x-hidden mt-6 pb-2">
          <div class="flex gap-1 sm:gap-2 flex-1 overflow-x-auto">
          <button class="job-filter-tab px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue whitespace-nowrap flex-shrink-0" data-status="all">
            All Jobs
          </button>
          <button class="job-filter-tab px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap flex-shrink-0" data-status="pending">
            Pending
          </button>
          <button class="job-filter-tab px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap flex-shrink-0" data-status="in-progress">
            In Progress
          </button>
          <button class="job-filter-tab px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap flex-shrink-0" data-status="completed">
            Completed
          </button>
          <button class="job-filter-tab px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap flex-shrink-0" data-status="cancelled">
            Cancelled
          </button>
          </div>
          <!-- Select All Checkbox (only for non-staff) -->
          <div id="select-all-container" class="hidden flex items-center gap-2 px-3 py-2 whitespace-nowrap flex-shrink-0">
            <input 
              type="checkbox" 
              id="select-all-jobs" 
              class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue cursor-pointer"
              aria-label="Select all jobs"
            />
            <label for="select-all-jobs" class="text-sm font-medium text-nfgblue dark:text-blue-400 cursor-pointer">
              Select All
            </label>
          </div>
        </div>
      </div>

      <!-- Scrollable content area -->
      <div class="scrollable-content flex-1 p-4 md:p-6 pt-4">
        <!-- Jobs Grid -->
        <div id="jobs-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      </div>
    </main>
  </div>

  <!-- Bulk Actions Toolbar -->
  <div id="bulk-actions-toolbar" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-lg p-4 z-50 max-w-4xl w-full mx-4">
    <div class="flex items-center justify-between gap-4 flex-nowrap">
      <span id="selected-count" class="text-sm font-medium text-nfgblue dark:text-blue-400 whitespace-nowrap flex-shrink-0">
        0 selected
      </span>
      <div class="flex gap-2 flex-nowrap items-center">
        <button id="bulk-update-status-btn" class="px-4 py-2 rounded-xl bg-nfgblue text-white hover:bg-nfgdark text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Update Status
        </button>
        <button id="bulk-assign-worker-btn" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Assign Worker
        </button>
        <button id="bulk-archive-btn" class="px-4 py-2 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Archive
        </button>
        <button id="bulk-cancel-selection" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-sm font-medium transition whitespace-nowrap flex-shrink-0">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Job Details Modal -->
  <div id="jobDetailModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <i data-lucide="clipboard-check" class="w-6 h-6 text-nfgblue dark:text-blue-400 flex-shrink-0"></i>
          <div class="flex-1 min-w-0">
            <h4 id="job-detail-title" class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Job Title</h4>
            <div id="job-detail-site" class="text-sm text-gray-500 dark:text-gray-400">Site Name</div>
          </div>
          <div id="job-timer-display" class="hidden px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg font-mono text-sm font-semibold flex-shrink-0">
            <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
            <span id="timer-value">00:00:00</span>
          </div>
        </div>
        <button data-action="close-modal" data-target="jobDetailModal" class="p-1 rounded-lg hover:bg-nfglight flex-shrink-0">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="p-6 space-y-6">
        <!-- Job Info -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="tag" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium">Status</span>
            </div>
            <p id="job-detail-status" class="text-xl font-semibold text-nfgblue dark:text-blue-400 capitalize">Pending</p>
          </div>
          <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="repeat" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium">Frequency</span>
            </div>
            <p id="job-detail-frequency" class="text-xl font-semibold text-nfgblue dark:text-blue-400 capitalize">Single Visit</p>
          </div>
          <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="calendar" class="w-4 h-4 text-nfgblue dark:text-blue-400"></i>
              <span class="text-sm font-medium">Scheduled</span>
            </div>
            <p id="job-detail-date" class="text-xl font-semibold text-nfgblue dark:text-blue-400">â€”</p>
          </div>
        </div>

        <!-- Assigned Worker -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2">
              <i data-lucide="user-check" class="w-4 h-4"></i>
              Assigned Worker
            </h5>
            <button id="assign-worker-btn" class="text-sm px-3 py-1.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
              <i data-lucide="user-plus" class="w-4 h-4 inline"></i>
              Assign
            </button>
          </div>
          <div id="job-assigned-worker" class="space-y-2">
            <p class="text-gray-500 text-sm">No worker assigned yet.</p>
          </div>
        </div>

        <!-- Job Details -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <h5 class="text-nfgblue dark:text-blue-400 font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            Job Details
          </h5>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500 dark:text-gray-400">Job Type:</span>
              <span id="job-detail-type" class="font-medium capitalize">â€”</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500 dark:text-gray-400">Estimated Hours:</span>
              <span id="job-detail-hours" class="font-medium">â€”</span>
            </div>
            <div class="border-t border-nfgray pt-2 mt-2">
              <span class="text-gray-500 text-sm">Description:</span>
              <p id="job-detail-description" class="text-nftext mt-1">â€”</p>
            </div>
          </div>
        </div>

        <!-- Assigned Employees -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2">
              <i data-lucide="users" class="w-4 h-4"></i>
              Assigned Employees
            </h5>
            <button id="assign-employee-btn" class="text-sm px-3 py-1.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
              <i data-lucide="user-plus" class="w-4 h-4 inline"></i>
              Assign
            </button>
          </div>
          <div id="job-employees-list" class="space-y-2">
            <p class="text-gray-500 text-sm">No employees assigned yet.</p>
          </div>
        </div>

        <!-- Invoice Section -->
        <div id="job-invoice-section" class="hidden bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h5 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2 mb-2">
                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                Invoice
              </h5>
              <p id="job-invoice-status" class="text-sm text-gray-500 dark:text-gray-400">No invoice created</p>
            </div>
            <div id="job-invoice-actions" class="flex gap-2">
              <!-- Show if no invoice and job is completed -->
              <button id="generate-invoice-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 text-sm font-medium">
                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                Generate Invoice
              </button>
              <!-- Show if invoice exists -->
              <a id="view-invoice-link" href="#" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark text-sm font-medium">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                View Invoice <span id="invoice-number-text" class="font-semibold"></span>
              </a>
            </div>
          </div>
        </div>

        <!-- Materials Used Section -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2">
              <i data-lucide="package" class="w-4 h-4"></i>
              Materials Used
            </h5>
            <div class="flex gap-2">
              <button 
                id="export-materials-btn" 
                onclick="exportJobMaterials()"
                class="text-sm px-3 py-1.5 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700"
                title="Export to CSV"
              >
                <i data-lucide="download" class="w-4 h-4 inline"></i>
                Export
              </button>
              <button 
                id="use-materials-btn" 
                onclick="openInventoryForJob()"
                class="text-sm px-3 py-1.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700"
              >
                <i data-lucide="package-plus" class="w-4 h-4 inline"></i>
                Use Materials
              </button>
            </div>
          </div>
          
          <!-- Materials Summary Cards -->
          <div id="job-materials-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Items Used</p>
              <p id="job-materials-count" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">â€”</p>
            </div>
            <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Quantity</p>
              <p id="job-materials-quantity" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">â€”</p>
            </div>
            <div class="bg-nfglight/30 border border-nfgblue/20 rounded-xl p-4">
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Est. Cost</p>
              <p id="job-materials-cost" class="text-2xl font-semibold text-green-600 dark:text-green-400">â€”</p>
            </div>
          </div>
          
          <!-- Materials Detail Table -->
          <div id="job-materials-content" class="space-y-3">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-nfglight/50 border-b border-nfgray dark:border-gray-700">
                  <tr>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Item</th>
                    <th class="px-3 py-2 text-center font-medium text-nfgblue dark:text-blue-400">Quantity</th>
                    <th class="px-3 py-2 text-right font-medium text-nfgblue dark:text-blue-400">Unit Cost</th>
                    <th class="px-3 py-2 text-right font-medium text-nfgblue dark:text-blue-400">Total</th>
                    <th class="px-3 py-2 text-left font-medium text-nfgblue dark:text-blue-400">Date</th>
                  </tr>
                </thead>
                <tbody id="job-materials-list">
                  <tr>
                    <td colspan="5" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">Loading materials...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <p id="job-materials-empty" class="hidden text-center text-gray-500 dark:text-gray-400 text-sm py-4">
              No materials used for this job yet
            </p>
          </div>
        </div>

        <!-- Task Checklist -->
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h5 class="text-nfgblue dark:text-blue-400 font-semibold flex items-center gap-2">
              <i data-lucide="list-checks" class="w-4 h-4"></i>
              Task Checklist
            </h5>
            <button id="add-task-btn" class="text-sm px-3 py-1.5 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
              <i data-lucide="plus" class="w-4 h-4 inline"></i>
              Add Task
            </button>
          </div>
          <div id="job-tasks-list" class="space-y-3">
            <p class="text-gray-500 text-sm">No tasks added yet.</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3 border-t border-nfgray pt-4">
          <!-- For Staff: Begin/End Work buttons -->
          <button id="begin-work-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700">
            <i data-lucide="play-circle" class="w-4 h-4"></i>
            Begin Work
          </button>
          <button id="end-work-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700">
            <i data-lucide="stop-circle" class="w-4 h-4"></i>
            End Work
          </button>
          
          <!-- Use Materials Button (available for all users) -->
          <button 
            id="use-materials-btn" 
            onclick="openInventoryForJob()"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium transition"
          >
            <i data-lucide="package" class="w-4 h-4"></i>
            Use Materials
          </button>
          
          <!-- For Admin/Client: Edit and Update Status buttons -->
          <button id="edit-job-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700">
            <i data-lucide="edit" class="w-4 h-4"></i>
            Edit Job
          </button>
          <button id="update-status-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            Update Status
          </button>
          
          <button id="archive-job-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-red-200 text-red-600 hover:bg-red-50 ml-auto">
            <i data-lucide="x-circle" class="w-4 h-4"></i>
            Cancel Job
          </button>

          <!-- Delete Permanently (only for cancelled jobs) -->
          <button id="delete-job-permanently-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700 ml-2">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            Delete Permanently
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="addTaskModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-lg">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Add Task</h4>
        <button data-action="close-modal" data-target="addTaskModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="add-task-form" class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Task Title <span class="text-red-500">*</span></label>
          <input type="text" name="task_title" required placeholder="e.g., Clean all windows" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Description</label>
          <textarea name="task_description" rows="2" placeholder="Task details..." class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>
        <div class="flex items-center gap-2">
          <input type="checkbox" name="task_required" id="task-required" checked class="w-4 h-4 text-nfgblue dark:text-blue-400 rounded border-nfgray focus:ring-2 focus:ring-nfgblue">
          <label for="task-required" class="text-sm font-medium">Photo required to complete</label>
        </div>
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="addTaskModal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
            Add Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Upload Photo Modal -->
  <div id="uploadPhotoModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-lg">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Upload Task Photo</h4>
        <button data-action="close-modal" data-target="uploadPhotoModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Select Photo <span class="text-red-500">*</span></label>
          <input type="file" id="task-photo-input" accept="image/*" capture="environment" class="w-full border border-nfgray rounded-xl p-2.5 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-nfgblue file:text-white file:cursor-pointer hover:file:bg-nfgdark" />
          <p class="text-xs text-gray-500 mt-1">Take a photo or upload from your device</p>
        </div>
        <div id="photo-preview" class="hidden">
          <img id="preview-image" src="" alt="Preview" class="w-full h-48 object-cover rounded-xl border border-nfgray dark:border-gray-700" />
        </div>
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="uploadPhotoModal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
            Cancel
          </button>
          <button id="upload-photo-btn" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
            Upload & Complete Task
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Worker Modal -->
  <div id="assignWorkerModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-lg">
      <div class="p-4 border-b border-nfgray flex items-center justify-between">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Assign Worker</h4>
        <button data-action="close-modal" data-target="assignWorkerModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="assign-worker-form" class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Select Worker <span class="text-red-500">*</span></label>
          <select name="worker_id" id="worker-select" required data-custom-dropdown="true" data-placeholder="Select a worker">
            <option value="">Select a worker</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Only staff members will appear in this list</p>
        </div>
        <div id="assign-worker-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="assignWorkerModal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
            Assign Worker
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Job Modal -->
  <div id="createJobModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Create New Job</h4>
        <button data-action="close-modal" data-target="createJobModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="create-job-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Job Title <span class="text-red-500">*</span></label>
          <input type="text" name="title" required placeholder="e.g., Office Deep Clean" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Site <span class="text-red-500">*</span></label>
          <select name="site_id" id="job-site-select" required data-custom-dropdown="true" data-placeholder="Select a site">
            <option value="">Select a site</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Job Type <span class="text-red-500">*</span></label>
            <select name="job_type" required data-custom-dropdown="true" data-placeholder="Select job type">
              <option value="cleaning">Cleaning</option>
              <option value="maintenance">Maintenance</option>
              <option value="repair">Repair</option>
              <option value="inspection">Inspection</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Frequency</label>
            <select name="frequency" id="job-frequency-select" data-custom-dropdown="true" data-placeholder="Select frequency">
              <option value="single visit" selected>Single Visit</option>
              <option value="recurring">Recurring</option>
            </select>
          </div>
        </div>
        
        <!-- Recurrence Pattern (only shown for recurring jobs) -->
        <div id="recurrence-pattern-section" class="hidden">
          <label class="block text-sm font-medium mb-1.5">Recurrence Pattern <span class="text-red-500">*</span></label>
          <select name="recurrence_pattern" data-custom-dropdown="true" data-placeholder="How often should this job repeat?">
            <option value="weekly" selected>Weekly</option>
            <option value="biweekly">Every 2 Weeks</option>
            <option value="monthly">Monthly</option>
          </select>
          <p class="text-xs text-gray-500 mt-1.5">
            ðŸ“… The next instance will automatically be created when this job is completed.
          </p>
        </div>

          <div>
            <label class="block text-sm font-medium mb-1.5">Scheduled Date</label>
          <input type="date" name="scheduled_date" id="job-scheduled-date" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>

        <!-- Time Selection (shown after date is selected) -->
        <div id="job-time-section" class="hidden">
          <label class="block text-sm font-medium mb-1.5">Scheduled Time</label>
          <div class="flex items-center gap-4">
            <input 
              type="time" 
              name="scheduled_time" 
              id="job-scheduled-time" 
              class="flex-1 border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none"
            />
            <label class="flex items-center gap-2 cursor-pointer">
              <input 
                type="checkbox" 
                id="job-all-day" 
                class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue"
                checked
              />
              <span class="text-sm text-gray-600 dark:text-gray-400">All Day</span>
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1.5">
            Select a specific time or leave as "All Day" for the entire day
          </p>
        </div>

          <div>
            <label class="block text-sm font-medium mb-1.5">Estimated Hours</label>
            <input type="number" name="estimated_hours" min="0" step="0.5" placeholder="4" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Description</label>
          <textarea name="description" rows="3" placeholder="Add job details..." class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>

        <div id="job-form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="createJobModal" class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button type="submit" id="submit-job-btn" class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Create Job
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Status Selection Modal -->
  <div id="bulk-status-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Select New Status</h4>
      </div>
      <div class="p-4 space-y-2">
        <button data-status="pending" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">Pending</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Job is scheduled but not started</p>
        </button>
        <button data-status="in-progress" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">In Progress</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Work has started on this job</p>
        </button>
        <button data-status="completed" class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition">
          <span class="font-medium block">Completed</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Job is finished</p>
        </button>
        <button data-status="cancelled" class="w-full px-4 py-3 rounded-xl border border-red-200 hover:bg-red-50 dark:hover:bg-red-900/20 text-left transition">
          <span class="font-medium text-red-600 dark:text-red-400 block">Cancelled</span>
          <p class="text-sm text-gray-500 dark:text-gray-400">Job was cancelled</p>
        </button>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end">
        <button data-cancel-status class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Worker Selection Modal -->
  <div id="bulk-worker-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-md">
      <div class="p-4 border-b border-nfgray">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold">Select Worker</h4>
      </div>
      <div class="p-4 max-h-96 overflow-y-auto space-y-2" id="bulk-worker-list">
        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading workers...</p>
      </div>
      <div class="p-4 border-t border-nfgray flex justify-end">
        <button data-cancel-worker class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 font-medium transition">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Job Modal -->
  <div id="editJobModal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
        <h4 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Edit Job</h4>
        <button data-action="close-modal" data-target="editJobModal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="edit-job-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Job Title <span class="text-red-500">*</span></label>
          <input type="text" name="title" id="edit-job-title" required placeholder="e.g., Office Deep Clean" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Site <span class="text-red-500">*</span></label>
          <select name="site_id" id="edit-job-site-select" required data-custom-dropdown="true" data-placeholder="Select a site">
            <option value="">Select a site</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Job Type <span class="text-red-500">*</span></label>
            <select name="job_type" id="edit-job-type" required data-custom-dropdown="true" data-placeholder="Select job type">
              <option value="cleaning">Cleaning</option>
              <option value="maintenance">Maintenance</option>
              <option value="repair">Repair</option>
              <option value="inspection">Inspection</option>
              <option value="emergency">Emergency</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Frequency</label>
            <select name="frequency" id="edit-job-frequency-select" data-custom-dropdown="true" data-placeholder="Select frequency">
              <option value="single visit">Single Visit</option>
              <option value="recurring">Recurring</option>
            </select>
          </div>
        </div>
        
        <!-- Recurrence Pattern (only shown for recurring jobs) -->
        <div id="edit-recurrence-pattern-section" class="hidden">
          <label class="block text-sm font-medium mb-1.5">Recurrence Pattern <span class="text-red-500">*</span></label>
          <select name="recurrence_pattern" id="edit-job-recurrence-pattern" data-custom-dropdown="true" data-placeholder="How often should this job repeat?">
            <option value="weekly">Weekly</option>
            <option value="biweekly">Every 2 Weeks</option>
            <option value="monthly">Monthly</option>
          </select>
          <p class="text-xs text-gray-500 mt-1.5">
            ðŸ“… The next instance will automatically be created when this job is completed.
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Scheduled Date</label>
            <input type="date" name="scheduled_date" id="edit-job-scheduled-date" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Estimated Hours</label>
            <input type="number" name="estimated_hours" id="edit-job-estimated-hours" min="0" step="0.5" placeholder="4" class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none" />
          </div>
        </div>

        <!-- Time Selection (shown after date is selected) -->
        <div id="edit-job-time-section" class="hidden">
          <label class="block text-sm font-medium mb-1.5">Scheduled Time</label>
          <div class="flex items-center gap-4">
            <input 
              type="time" 
              name="scheduled_time" 
              id="edit-job-scheduled-time" 
              class="flex-1 border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none"
            />
            <label class="flex items-center gap-2 cursor-pointer">
              <input 
                type="checkbox" 
                id="edit-job-all-day" 
                class="w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue"
              />
              <span class="text-sm text-gray-600 dark:text-gray-400">All Day</span>
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1.5">
            Select a specific time or leave as "All Day" for the entire day
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1.5">Description</label>
          <textarea name="description" id="edit-job-description" rows="3" placeholder="Add job details..." class="w-full border border-nfgray rounded-xl p-2.5 focus:ring-2 focus:ring-nfgblue outline-none resize-none"></textarea>
        </div>

        <div id="edit-job-form-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray dark:border-gray-700">
          <button type="button" data-action="close-modal" data-target="editJobModal" class="px-5 py-2.5 rounded-xl border border-nfgray hover:bg-nfglight font-medium transition">
            Cancel
          </button>
          <button type="submit" id="submit-edit-job-btn" class="px-5 py-2.5 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark font-medium transition">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- PWA Installation -->
  <script type="module" src="./js/pwa.js"></script>

  <!-- ========== SCRIPTS ========== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Force remove scrollbars
      document.documentElement.style.overflow = 'hidden';
      document.documentElement.style.height = '100%';
      document.documentElement.style.width = '100%';
      document.body.style.overflow = 'hidden';
      document.body.style.height = '100vh';
      document.body.style.width = '100vw';
      document.body.style.maxHeight = '100vh';
      document.body.style.maxWidth = '100vw';
      
      // FORCE REMOVE SCROLLBAR - use negative margin technique
      const scrollableContent = document.querySelector('.scrollable-content');
      if (scrollableContent) {
        // Apply negative margin to hide scrollbar
        scrollableContent.style.marginRight = '-20px';
        scrollableContent.style.paddingRight = '20px';
        scrollableContent.style.scrollbarWidth = 'none';
        scrollableContent.style.msOverflowStyle = 'none';
        // Inject style to completely hide webkit scrollbar
        const style = document.createElement('style');
        style.id = 'force-hide-scrollbar';
        style.textContent = `
          .scrollable-content {
            margin-right: -20px !important;
            padding-right: 20px !important;
          }
          .scrollable-content::-webkit-scrollbar {
            width: 0px !important;
            display: none !important;
            background: transparent !important;
            -webkit-appearance: none !important;
            appearance: none !important;
          }
          .scrollable-content::-webkit-scrollbar-track,
          .scrollable-content::-webkit-scrollbar-thumb,
          .scrollable-content::-webkit-scrollbar-corner {
            display: none !important;
            width: 0px !important;
            background: transparent !important;
          }
        `;
        // Remove existing style if present
        const existing = document.getElementById('force-hide-scrollbar');
        if (existing) existing.remove();
        document.head.appendChild(style);
      }
      
      // Prevent any scrolling on html/body
      document.addEventListener('wheel', (e) => {
        if (e.target === document.body || e.target === document.documentElement) {
          e.preventDefault();
        }
      }, { passive: false });
      
      if (window.lucide) lucide.createIcons();
      
      // Initialize mobile sidebar
      const sidebar = document.getElementById('sidebar');
      const toggleButtons = document.querySelectorAll('[data-action="toggle-sidebar"], button[aria-label="Toggle sidebar"]');
      
      let overlay = document.getElementById('sidebar-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.className = 'fixed inset-0 bg-black/50 z-40 hidden';
        document.body.appendChild(overlay);
      }
      
      function toggleSidebar() {
        if (sidebar && overlay) {
          const isHidden = sidebar.classList.contains('hidden') || !sidebar.classList.contains('mobile-sidebar-open');
          
          if (isHidden) {
            sidebar.classList.remove('hidden');
            sidebar.classList.add('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in');
            overlay.classList.remove('hidden');
            overlay.classList.add('animate-fade-in');
            document.body.style.overflow = 'hidden';
          } else {
            sidebar.classList.add('animate-slide-out');
            overlay.classList.add('animate-fade-out');
            
            setTimeout(() => {
              sidebar.classList.add('hidden');
              sidebar.classList.remove('mobile-sidebar-open', 'flex', 'flex-col', 'fixed', 'inset-y-0', 'left-0', 'z-50', 'w-64', 'max-w-[80vw]', 'shadow-2xl', 'animate-slide-in', 'animate-slide-out');
              overlay.classList.add('hidden');
              overlay.classList.remove('animate-fade-in', 'animate-fade-out');
              document.body.style.overflow = '';
            }, 200);
          }
        }
      }
      
      toggleButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          toggleSidebar();
        });
      });
      
      overlay?.addEventListener('click', toggleSidebar);
      
      const navLinks = sidebar?.querySelectorAll('a');
      navLinks?.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768) {
            toggleSidebar();
          }
        });
      });
    });

    // Modal functionality
    document.addEventListener('click', (e) => {
      const openModalBtn = e.target.closest('[data-action="open-modal"]');
      if (openModalBtn) {
        const targetId = openModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          if (window.lucide) lucide.createIcons();
          
          // Trigger custom event for modal opening (so module script can handle it)
          if (targetId === 'createJobModal') {
            window.dispatchEvent(new CustomEvent('createJobModalOpened'));
          }
        }
      }

      const closeModalBtn = e.target.closest('[data-action="close-modal"]');
      if (closeModalBtn) {
        const targetId = closeModalBtn.dataset.target;
        const modal = document.getElementById(targetId);
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          const form = modal.querySelector('form');
          if (form) form.reset();
        }
      }

      if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
        e.target.classList.add('hidden');
        e.target.classList.remove('flex');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
        modals.forEach(modal => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        });
      }
    });
  </script>

  <script type="module">
    import { supabase } from './js/supabase.js'
    import { NFGDropdown } from './js/custom-dropdown.js'
    import { handleJobCompletion } from './js/recurring-jobs.js'
    import { showNotification, showConfirm, showPrompt, toast, notify } from './js/notifications.js'

    let currentFilter = 'all';
    let currentJobId = null;
    let currentTaskId = null;
    let currentUser = null;
    let currentUserProfile = null;
    let selectedJobs = new Set(); // Track selected job IDs
    let allJobs = []; // Store all jobs for selection tracking

    // Get current user and their profile
    async function getCurrentUser() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      
      if (user) {
        // Get user profile to check role
        const { data: profile, error } = await supabase
          .from('user_profiles')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (!error && profile) {
          currentUserProfile = profile;
          console.log('User role:', profile.role);
        } else {
          // Default to staff if no profile found
          currentUserProfile = { role: 'staff' };
        }
      }
      
      return user;
    }

    // Fetch jobs from Supabase (filtered by role)
    async function getJobs() {
      console.log('ðŸ” Fetching jobs for user:', currentUser.id, 'role:', currentUserProfile?.role);
      let query = supabase
        .from('jobs')
        .select(`
          *,
          sites (
            id,
            name,
            address
          )
        `);
      
      // If user is staff, only show jobs assigned to them
      if (currentUserProfile && currentUserProfile.role === 'staff') {
        query = query.eq('assigned_worker_id', currentUser.id);
      }
      // Admin/Client can see all jobs (no filter needed, RLS will handle permissions)
      
      const { data, error } = await query.order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error fetching jobs:', error);
        return [];
      }
      return data || [];
    }

    // Fetch sites from Supabase
    async function getSites() {
      const { data, error } = await supabase
        .from('sites')
        .select('*')
        .order('name', { ascending: true });
      
      if (error) {
        console.error('Error fetching sites:', error);
        // Fallback to localStorage if sites table doesn't exist yet
        return JSON.parse(localStorage.getItem('nfg_sites') || '[]');
      }
      return data || [];
    }

    // Get job tasks from Supabase
    async function getJobTasks(jobId) {
      const { data, error } = await supabase
        .from('job_tasks')
        .select('*')
        .eq('job_id', jobId)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error fetching tasks:', error);
        return [];
      }
      return data || [];
    }

    // Get job employees from Supabase
    async function getJobEmployees(jobId) {
      const { data, error } = await supabase
        .from('job_employees')
        .select('*')
        .eq('job_id', jobId)
        .order('assigned_at', { ascending: true });
      
      if (error) {
        console.error('Error fetching employees:', error);
        return [];
      }
      return data || [];
    }

    // Render jobs
    async function renderJobs() {
      const grid = document.getElementById('jobs-grid');
      const jobs = await getJobs();
      allJobs = jobs; // Store all jobs for selection tracking
      const sites = await getSites();
      
      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.status === currentFilter);

      if (filtered.length === 0) {
        const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-nfgray rounded-xl p-12 max-w-md mx-auto">
              <i data-lucide="clipboard-check" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-xl mb-2">No Jobs Found</h3>
              <p class="text-gray-500 mb-6">${isStaff ? 'No jobs have been assigned to you yet.' : 'Create your first job to get started.'}</p>
              ${!isStaff ? `
                <button data-action="open-modal" data-target="createJobModal" class="inline-flex items-center gap-2 px-6 py-3 bg-nfgblue dark:bg-blue-900 text-white rounded-xl hover:bg-nfgdark transition">
                  <i data-lucide="plus" class="w-5 h-5"></i>
                  Create Job
                </button>
              ` : ''}
            </div>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      // Show/hide Select All checkbox based on role
      const selectAllContainer = document.getElementById('select-all-container');
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
      if (selectAllContainer) {
        if (isStaff) {
          selectAllContainer.classList.add('hidden');
        } else {
          selectAllContainer.classList.remove('hidden');
        }
      }

      grid.innerHTML = filtered.map(job => {
        // Use site from joined data if available, otherwise fall back to sites array
        const site = job.sites || sites.find(s => s.id == job.site_id);
        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400',
          'in-progress': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400',
          'completed': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
          'cancelled': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'
        };

        const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
        const isSelected = selectedJobs.has(job.id);

        return `
          <div class="bg-white dark:bg-gray-800 border ${isSelected ? 'border-nfgblue ring-2 ring-nfgblue' : 'border-nfgray'} rounded-xl p-4 shadow-nfg hover:shadow-lg transition-shadow ${isSelected ? 'bg-nfglight/30 dark:bg-blue-900/20' : ''}">
            <div class="flex justify-between items-start mb-3">
              <div class="flex items-start gap-3 flex-1">
                ${!isStaff ? `
                  <input 
                    type="checkbox" 
                    class="job-checkbox w-4 h-4 text-nfgblue border-nfgray rounded focus:ring-nfgblue cursor-pointer mt-1 flex-shrink-0" 
                    data-job-id="${job.id}"
                    ${isSelected ? 'checked' : ''}
                    aria-label="Select job ${job.title}"
                  />
                ` : ''}
                <div class="flex-1 min-w-0">
                <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">${job.title}</h3>
                <p class="text-gray-500 text-sm mt-1">${site ? site.name : 'Unknown Site'}</p>
                </div>
              </div>
              <span class="px-2 py-1 rounded-lg text-xs font-medium ${statusColors[job.status]}">${job.status.replace('-', ' ')}</span>
            </div>
            
            <div class="space-y-2 mb-4 py-3 border-t border-b border-nfgray dark:border-gray-700">
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Type:</span>
                <span class="font-medium capitalize">${job.job_type}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Frequency:</span>
                <span class="font-medium capitalize">${job.frequency}</span>
              </div>
              ${job.scheduled_date ? `
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-500 dark:text-gray-400">Scheduled:</span>
                  <span class="font-medium">${new Date(job.scheduled_date).toLocaleDateString()}</span>
                </div>
              ` : ''}
            </div>
            
            <button 
              onclick="viewJob('${job.id}')" 
              class="w-full bg-nfgblue hover:bg-nfgdark text-white rounded-xl py-2 text-sm font-medium transition cursor-pointer">
              View Details
            </button>
          </div>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
      
      // Attach checkbox event listeners
      attachJobCheckboxListeners();
      
      // Update select all checkbox state
      updateSelectAllCheckbox();
    }

    // Attach checkbox listeners for job selection
    function attachJobCheckboxListeners() {
      document.querySelectorAll('.job-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const jobId = e.target.dataset.jobId;
          toggleJobSelection(jobId);
        });
      });
    }

    // Toggle job selection
    function toggleJobSelection(jobId) {
      if (selectedJobs.has(jobId)) {
        selectedJobs.delete(jobId);
      } else {
        selectedJobs.add(jobId);
      }
      updateBulkActionsToolbar();
      updateSelectAllCheckbox();
    }

    // Update select all checkbox state
    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('select-all-jobs');
      if (!selectAllCheckbox) return;
      
      const visibleJobs = getVisibleJobs();
      const allVisibleSelected = visibleJobs.length > 0 && visibleJobs.every(job => selectedJobs.has(job.id));
      
      selectAllCheckbox.checked = allVisibleSelected;
      selectAllCheckbox.indeterminate = !allVisibleSelected && visibleJobs.some(job => selectedJobs.has(job.id));
    }

    // Get visible jobs (based on current filter)
    function getVisibleJobs() {
      const filtered = currentFilter === 'all' ? allJobs : allJobs.filter(j => j.status === currentFilter);
      return filtered;
    }

    // Select all visible jobs
    function selectAllJobs() {
      const visibleJobs = getVisibleJobs();
      visibleJobs.forEach(job => selectedJobs.add(job.id));
      updateCheckboxes();
      updateBulkActionsToolbar();
      updateSelectAllCheckbox();
    }

    // Deselect all jobs
    function deselectAllJobs() {
      selectedJobs.clear();
      updateCheckboxes();
      updateBulkActionsToolbar();
      updateSelectAllCheckbox();
    }

    // Update checkbox states in DOM
    function updateCheckboxes() {
      document.querySelectorAll('.job-checkbox').forEach(checkbox => {
        checkbox.checked = selectedJobs.has(checkbox.dataset.jobId);
        
        // Update card visual state
        const card = checkbox.closest('.bg-white, .dark\\:bg-gray-800');
        if (card) {
          if (checkbox.checked) {
            card.classList.remove('border-nfgray');
            card.classList.add('border-nfgblue', 'ring-2', 'ring-nfgblue', 'bg-nfglight/30', 'dark:bg-blue-900/20');
          } else {
            card.classList.remove('border-nfgblue', 'ring-2', 'ring-nfgblue', 'bg-nfglight/30', 'dark:bg-blue-900/20');
            card.classList.add('border-nfgray');
          }
        }
      });
    }

    // Update bulk actions toolbar visibility and count
    function updateBulkActionsToolbar() {
      const toolbar = document.getElementById('bulk-actions-toolbar');
      const count = document.getElementById('selected-count');
      
      if (!toolbar || !count) return;
      
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';
      
      if (selectedJobs.size > 0 && !isStaff) {
        toolbar.classList.remove('hidden');
        count.textContent = `${selectedJobs.size} ${selectedJobs.size === 1 ? 'job' : 'jobs'} selected`;
      } else {
        toolbar.classList.add('hidden');
      }
    }

    // View job details
    window.viewJob = async function(jobId) {
      console.log('[Jobs] âœ… viewJob function called! Job ID:', jobId, 'Type:', typeof jobId);
      console.log('[Jobs] Opening job details for ID:', jobId);
      const jobs = await getJobs();
      const sites = await getSites();
      console.log('[Jobs] All jobs:', jobs);
      console.log('[Jobs] Looking for job with ID:', jobId);
      // Use loose equality to handle both string and number IDs
      const job = jobs.find(j => j.id == jobId);
      
      if (!job) {
        console.error('[Jobs] âŒ Job not found:', jobId);
        console.error('[Jobs] Available job IDs:', jobs.map(j => j.id));
        toast.error('Job not found! ID: ' + jobId, 'Job Not Found');
        return;
      }

      currentJobId = jobId;
      // Use site from joined data if available, otherwise fall back to sites array
      const site = job.sites || sites.find(s => s.id == job.site_id);

      // Populate job details
      document.getElementById('job-detail-title').textContent = job.title;
      
      // Display site name and address with copy button
      const siteContainer = document.getElementById('job-detail-site');
      if (site && site.address) {
        siteContainer.innerHTML = `
          <div class="flex flex-col gap-1">
            <span class="font-medium">${site.name}</span>
            <div class="flex items-center gap-1.5">
              <span class="text-xs text-gray-600 truncate">${site.address}</span>
              <button 
                onclick="copyAddress('${site.address.replace(/'/g, "\\'")}', event)" 
                class="text-gray-400 hover:text-nfgblue dark:text-blue-400 transition p-0.5 rounded hover:bg-nfglight flex-shrink-0"
                title="Copy address">
                <i data-lucide="copy" class="w-3 h-3"></i>
              </button>
            </div>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      } else {
        siteContainer.textContent = site ? site.name : 'Unknown Site';
      }
      document.getElementById('job-detail-status').textContent = job.status.replace('-', ' ');
      document.getElementById('job-detail-frequency').textContent = job.frequency || 'single visit';
      document.getElementById('job-detail-date').textContent = job.scheduled_date ? new Date(job.scheduled_date).toLocaleDateString() : 'â€”';
      document.getElementById('job-detail-type').textContent = job.job_type;
      document.getElementById('job-detail-hours').textContent = job.estimated_hours ? `${job.estimated_hours} hrs` : 'â€”';
      document.getElementById('job-detail-description').textContent = job.description || 'No description provided.';

      // Load assigned worker, employees and tasks
      await renderAssignedWorker();
      await renderJobEmployees();
      await renderJobTasks();
      
      // Load job materials
      await loadJobMaterials(jobId);

      // Hide assign worker button for staff (they can't assign workers)
      const assignWorkerBtn = document.getElementById('assign-worker-btn');
      if (assignWorkerBtn && currentUserProfile && currentUserProfile.role === 'staff') {
        assignWorkerBtn.style.display = 'none';
      } else if (assignWorkerBtn) {
        assignWorkerBtn.style.display = '';
      }

      // Show/hide Edit Job button (only for admins and clients)
      const editJobBtn = document.getElementById('edit-job-btn');
      if (editJobBtn) {
        const isAdminOrClient = currentUserProfile && ['admin', 'client', 'super_admin'].includes(currentUserProfile.role);
        if (isAdminOrClient) {
          editJobBtn.classList.remove('hidden');
          editJobBtn.classList.add('inline-flex');
        } else {
          editJobBtn.classList.add('hidden');
          editJobBtn.classList.remove('inline-flex');
        }
      }

      // Hide archive job button for staff
      const archiveJobBtn = document.getElementById('archive-job-btn');
      if (archiveJobBtn && currentUserProfile && currentUserProfile.role === 'staff') {
        archiveJobBtn.style.display = 'none';
      } else if (archiveJobBtn) {
        archiveJobBtn.style.display = '';
      }

      // Show/hide delete permanently button
      const deleteJobBtn = document.getElementById('delete-job-permanently-btn');
      if (deleteJobBtn) {
        // Only show for cancelled jobs and only for admin/client
        const isCancelled = job.status === 'cancelled';
        const canDelete = currentUserProfile && ['admin', 'client', 'super_admin'].includes(currentUserProfile.role);
        
        if (isCancelled && canDelete) {
          deleteJobBtn.classList.remove('hidden');
          deleteJobBtn.classList.add('inline-flex');
          // Hide cancel button when showing delete button
          if (archiveJobBtn) archiveJobBtn.style.display = 'none';
        } else {
          deleteJobBtn.classList.add('hidden');
          deleteJobBtn.classList.remove('inline-flex');
        }
      }

      // Hide add task button for staff
      const addTaskBtn = document.getElementById('add-task-btn');
      if (addTaskBtn && currentUserProfile && currentUserProfile.role === 'staff') {
        addTaskBtn.style.display = 'none';
      } else if (addTaskBtn) {
        addTaskBtn.style.display = '';
      }

      // Handle timer and button visibility for staff vs admin/client
      const beginWorkBtn = document.getElementById('begin-work-btn');
      const endWorkBtn = document.getElementById('end-work-btn');
      const updateStatusBtn = document.getElementById('update-status-btn');
      const timerDisplay = document.getElementById('job-timer-display');
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';

      if (isStaff) {
        // Staff user - show Begin/End Work buttons, hide Update Status
        updateStatusBtn.style.display = 'none';
        
        if (job.work_started_at && !job.work_ended_at) {
          // Work in progress - show timer and End Work button
          beginWorkBtn.classList.add('hidden');
          endWorkBtn.classList.remove('hidden');
          timerDisplay.classList.remove('hidden');
          startTimer(job.work_started_at);
        } else if (!job.work_started_at) {
          // Not started - show Begin Work button
          beginWorkBtn.classList.remove('hidden');
          endWorkBtn.classList.add('hidden');
          timerDisplay.classList.add('hidden');
        } else {
          // Work completed - hide both buttons, show final time
          beginWorkBtn.classList.add('hidden');
          endWorkBtn.classList.add('hidden');
          if (job.total_duration) {
            timerDisplay.classList.remove('hidden');
            document.getElementById('timer-value').textContent = formatDuration(job.total_duration);
          }
        }
      } else {
        // Admin/Client - show Update Status, hide Begin/End Work
        updateStatusBtn.style.display = '';
        beginWorkBtn.classList.add('hidden');
        endWorkBtn.classList.add('hidden');
        timerDisplay.classList.add('hidden');
      }

      // Check for invoice
      await checkJobInvoice(jobId);

      // Show modal
      const modal = document.getElementById('jobDetailModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
      console.log('[Jobs] âœ… Job details modal opened');
    };
    
    // Open inventory page with job context
    window.openInventoryForJob = async function() {
      if (!currentJobId) {
        toast.error('No job selected', 'Error');
        return;
      }
      
      // Get job details from current job
      const jobs = await getJobs();
      const job = jobs.find(j => j.id === currentJobId);
      
      if (!job) {
        toast.error('Job not found', 'Error');
        return;
      }
      
      // Store job context in session storage
      const jobContext = {
        jobId: job.id,
        jobTitle: job.title,
        siteId: job.site_id
      };
      
      sessionStorage.setItem('inventoryJobContext', JSON.stringify(jobContext));
      
      // Navigate to inventory page
      window.location.href = '/inventory.html';
    };
    
    // Check if job has invoice and update UI
    async function checkJobInvoice(jobId) {
      try {
        const invoiceSection = document.getElementById('job-invoice-section');
        const generateBtn = document.getElementById('generate-invoice-btn');
        const viewLink = document.getElementById('view-invoice-link');
        const invoiceStatus = document.getElementById('job-invoice-status');
        const invoiceNumberText = document.getElementById('invoice-number-text');

        if (!invoiceSection || !generateBtn || !viewLink || !invoiceStatus) {
          console.error('[Jobs] Invoice section elements not found');
          return;
        }

        // Check if invoice exists for this job
        const { data: invoice, error } = await supabase
          .from('invoices')
          .select('id, invoice_number, status, total_amount, balance_due')
          .eq('job_id', jobId)
          .maybeSingle();

        if (error) {
          // Check if table doesn't exist
          if (error.code === 'PGRST204' || error.message?.includes('does not exist')) {
            // Table doesn't exist yet, hide invoice section
            invoiceSection.classList.add('hidden');
            return;
          }
          console.error('[Jobs] Error checking job invoice:', error);
          invoiceSection.classList.add('hidden');
          return;
        }

        // Get job to check status
        const jobs = await getJobs();
        const job = jobs.find(j => j.id == jobId);

        if (!job) {
          invoiceSection.classList.add('hidden');
          return;
        }

        if (invoice) {
          // Invoice exists - show view link
          invoiceSection.classList.remove('hidden');
          generateBtn.classList.add('hidden');
          viewLink.classList.remove('hidden');
          invoiceNumberText.textContent = invoice.invoice_number;
          viewLink.href = `reports.html?tab=billing&invoice=${invoice.id}`;
          
          const statusText = invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1);
          const amount = parseFloat(invoice.total_amount || 0);
          const balance = parseFloat(invoice.balance_due || 0);
          
          if (invoice.status === 'paid') {
            invoiceStatus.textContent = `Invoice ${invoice.invoice_number} - Paid ($${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
          } else if (balance > 0) {
            invoiceStatus.textContent = `Invoice ${invoice.invoice_number} - ${statusText} (Balance: $${balance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
          } else {
            invoiceStatus.textContent = `Invoice ${invoice.invoice_number} - ${statusText}`;
          }
        } else if (job.status === 'completed') {
          // No invoice but job is completed - show generate button
          invoiceSection.classList.remove('hidden');
          generateBtn.classList.remove('hidden');
          viewLink.classList.add('hidden');
          invoiceStatus.textContent = 'Ready to generate invoice';
        } else {
          // Job not completed - hide invoice section
          invoiceSection.classList.add('hidden');
        }

      } catch (error) {
        console.error('[Jobs] Error checking job invoice:', error);
        // Hide invoice section on error
        const invoiceSection = document.getElementById('job-invoice-section');
        if (invoiceSection) {
          invoiceSection.classList.add('hidden');
        }
      }
    }
    
    // Generate invoice from job
    async function generateInvoiceFromJob(jobId) {
      try {
        // Fetch job details (without relationships to avoid PostgREST errors)
        const { data: job, error: jobError } = await supabase
          .from('jobs')
          .select('*')
          .eq('id', jobId)
          .single();

        if (jobError || !job) {
          toast.error('Failed to load job details', 'Error');
          return;
        }

        // Fetch related data separately
        let siteName = 'Unknown Site';
        let clientName = 'Unknown Client';

        if (job.site_id) {
          const { data: site } = await supabase
            .from('sites')
            .select('id, name')
            .eq('id', job.site_id)
            .single();
          if (site) siteName = site.name;
        }

        if (job.client_id) {
          const { data: profile } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .eq('id', job.client_id)
            .single();
          if (profile) {
            clientName = profile.full_name || profile.email || 'Unknown Client';
          }
        }

        // Check if invoice already exists
        const { data: existingInvoice } = await supabase
          .from('invoices')
          .select('id, invoice_number')
          .eq('job_id', jobId)
          .maybeSingle();

        if (existingInvoice) {
          toast.warning('Invoice already exists for this job', 'Duplicate');
          // Redirect to view invoice
          window.location.href = `reports.html?tab=billing&invoice=${existingInvoice.id}`;
          return;
        }

        // Check if job is completed
        if (job.status !== 'completed') {
          toast.error('Can only generate invoices for completed jobs', 'Invalid Status');
          return;
        }

        // For now, redirect to reports page with job ID
        // In Phase 4, we'll open a modal to create the invoice
        // Store job data in sessionStorage for the invoice creation modal
        sessionStorage.setItem('pendingInvoiceJob', JSON.stringify({
          jobId: job.id,
          clientId: job.client_id,
          siteId: job.site_id,
          jobTitle: job.title,
          siteName: siteName,
          clientName: clientName,
          estimatedHours: job.estimated_hours || 0,
          jobType: job.job_type || 'cleaning'
        }));

        // Redirect to reports billing tab
        window.location.href = 'reports.html?tab=billing&create_invoice=true';

      } catch (error) {
        console.error('[Jobs] Error generating invoice from job:', error);
        toast.error('Failed to generate invoice', 'Error');
      }
    }

    // Timer variables
    let timerInterval = null;

    // Format duration in seconds to HH:MM:SS
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Start the timer display
    function startTimer(startTime) {
      // Clear any existing timer
      if (timerInterval) clearInterval(timerInterval);
      
      const startTimestamp = new Date(startTime).getTime();
      
      function updateTimer() {
        const now = Date.now();
        const elapsed = Math.floor((now - startTimestamp) / 1000); // seconds
        document.getElementById('timer-value').textContent = formatDuration(elapsed);
      }
      
      // Update immediately
      updateTimer();
      
      // Update every second
      timerInterval = setInterval(updateTimer, 1000);
    }

    // Stop the timer
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // Format timestamp to readable time
    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    // Calculate task duration
    function calculateTaskDuration(startTime, endTime) {
      if (!startTime || !endTime) return null;
      const start = new Date(startTime).getTime();
      const end = new Date(endTime).getTime();
      const duration = Math.floor((end - start) / 1000); // seconds
      return duration;
    }

    // Render assigned worker
    async function renderAssignedWorker() {
      const jobs = await getJobs();
      const job = jobs.find(j => j.id === currentJobId);
      const list = document.getElementById('job-assigned-worker');
      
      if (!job || !job.assigned_worker_id) {
        list.innerHTML = '<p class="text-gray-500 text-sm">No worker assigned yet.</p>';
        return;
      }

      // Fetch worker profile
      const { data: worker, error } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('id', job.assigned_worker_id)
        .single();

      if (error || !worker) {
        console.error('Error fetching worker:', error);
        list.innerHTML = '<p class="text-gray-500 text-sm">Worker not found.</p>';
        return;
      }

      const initials = (worker.full_name || worker.email).charAt(0).toUpperCase();
      const displayName = worker.full_name || worker.email.split('@')[0];

      list.innerHTML = `
        <div class="flex items-center justify-between p-3 bg-nfglight/30 rounded-xl">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-nfgblue dark:bg-blue-900 text-white flex items-center justify-center font-semibold">
              ${initials}
            </div>
            <div>
              <p class="font-medium text-nfgblue dark:text-blue-400">${displayName}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">${worker.email}</p>
            </div>
          </div>
          <button onclick="unassignWorker()" class="p-1.5 hover:bg-red-100 rounded-lg text-red-600" title="Unassign worker">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `;
      if (window.lucide) lucide.createIcons();
    }

    // Render job employees
    async function renderJobEmployees() {
      const employees = await getJobEmployees(currentJobId);
      const list = document.getElementById('job-employees-list');
      
      if (employees.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">No employees assigned yet.</p>';
        return;
      }

      list.innerHTML = employees.map(emp => `
        <div class="flex items-center justify-between p-3 bg-nfglight/30 rounded-xl">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-nfgblue dark:bg-blue-900 text-white flex items-center justify-center font-semibold">
              ${emp.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <p class="font-medium text-nfgblue dark:text-blue-400">${emp.name}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">${emp.role || 'Employee'}</p>
            </div>
          </div>
          <button onclick="removeEmployee('${emp.id}')" class="p-1.5 hover:bg-red-100 rounded-lg text-red-600">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      `).join('');
      if (window.lucide) lucide.createIcons();
    }

    // Render job tasks
    // Load and display job materials
    async function loadJobMaterials(jobId) {
      try {
        // Get summary from job_materials_used view
        const { data: summary, error: summaryError } = await supabase
          .from('job_materials_used')
          .select('*')
          .eq('job_id', jobId)
          .single();
        
        if (summaryError && summaryError.code !== 'PGRST116') {
          console.error('[Jobs] Failed to load materials summary:', summaryError);
        }
        
        // Get detailed transactions
        const { data: materials, error: materialsError } = await supabase
          .from('job_materials_detailed')
          .select('*')
          .eq('job_id', jobId)
          .order('usage_date', { ascending: false });
        
        if (materialsError) {
          console.error('[Jobs] Failed to load materials:', materialsError);
          // Fallback: try direct query if views don't exist
          const { data: fallbackData, error: fallbackError } = await supabase
            .from('inventory_transactions')
            .select(`
              id,
              quantity_change,
              created_at,
              notes,
              inventory_items:inventory_items(name, unit, unit_cost, average_cost),
              site_inventory:site_inventory(unit_cost),
              user_profiles:user_id(full_name)
            `)
            .eq('job_id', jobId)
            .eq('transaction_type', 'use')
            .order('created_at', { ascending: false });
          
          if (fallbackError) {
            throw fallbackError;
          }
          
          // Transform fallback data
          renderJobMaterialsList((fallbackData || []).map(t => ({
            transaction_id: t.id,
            item_name: t.inventory_items?.name || 'Unknown',
            unit: t.inventory_items?.unit || '',
            quantity_used: Math.abs(t.quantity_change || 0),
            unit_cost: t.site_inventory?.unit_cost || t.inventory_items?.average_cost || t.inventory_items?.unit_cost || 0,
            total_cost: Math.abs(t.quantity_change || 0) * (t.site_inventory?.unit_cost || t.inventory_items?.average_cost || t.inventory_items?.unit_cost || 0),
            usage_date: t.created_at,
            notes: t.notes,
            used_by: t.user_profiles?.full_name || null
          })), summary);
          return;
        }
        
        // Update summary cards
        if (summary) {
          document.getElementById('job-materials-count').textContent = summary.unique_items_used || 0;
          document.getElementById('job-materials-quantity').textContent = summary.total_quantity_used || 0;
          document.getElementById('job-materials-cost').textContent = formatCurrency(summary.estimated_cost || 0);
        } else {
          document.getElementById('job-materials-count').textContent = '0';
          document.getElementById('job-materials-quantity').textContent = '0';
          document.getElementById('job-materials-cost').textContent = formatCurrency(0);
        }
        
        // Store materials for export
        currentJobMaterials = materialsWithUsers;
        
        // Render materials list
        renderJobMaterialsList(materialsWithUsers, summary);
        
      } catch (error) {
        console.error('[Jobs] Error loading job materials:', error);
        document.getElementById('job-materials-list').innerHTML = `
          <tr>
            <td colspan="5" class="px-4 py-6 text-center text-red-500">
              Error loading materials. Please try again.
            </td>
          </tr>
        `;
      }
    }
    
    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(amount || 0);
    }
    
    // Render materials list
    function renderJobMaterialsList(materials, summary) {
      const listBody = document.getElementById('job-materials-list');
      const emptyMsg = document.getElementById('job-materials-empty');
      const chartContainer = document.getElementById('job-materials-chart-container');
      
      if (!listBody) return;
      
      if (!materials || materials.length === 0) {
        listBody.innerHTML = '';
        if (emptyMsg) {
          emptyMsg.classList.remove('hidden');
        }
        if (chartContainer) {
          chartContainer.classList.add('hidden');
        }
        return;
      }
      
      if (emptyMsg) {
        emptyMsg.classList.add('hidden');
      }
      
      // Show and render chart if we have materials
      if (chartContainer && materials.length > 0) {
        chartContainer.classList.remove('hidden');
        renderMaterialsChart(materials);
      }
      
      listBody.innerHTML = materials.map(material => {
        const date = new Date(material.usage_date).toLocaleDateString();
        const hasNotes = material.notes && material.notes.trim();
        const hasPhotos = material.photo_urls && Array.isArray(material.photo_urls) && material.photo_urls.length > 0;
        
        return `
          <tr class="border-b border-nfgray dark:border-gray-700 last:border-0 hover:bg-nfglight/30">
            <td class="px-3 py-3">
              <div class="font-medium text-nfgblue dark:text-blue-400">${material.item_name}</div>
              ${material.unit ? `<div class="text-xs text-gray-500">${material.unit}</div>` : ''}
              ${hasNotes ? `<div class="text-xs text-gray-500 mt-1">${material.notes}</div>` : ''}
              ${hasPhotos ? `
                <div class="flex gap-1 mt-1">
                  ${material.photo_urls.slice(0, 3).map((url, idx) => `
                    <img 
                      src="${url}" 
                      alt="Photo ${idx + 1}" 
                      onclick="viewMaterialPhoto('${url}')"
                      class="w-8 h-8 rounded cursor-pointer hover:opacity-80 object-cover border border-nfgray"
                      title="View photo"
                    />
                  `).join('')}
                  ${material.photo_urls.length > 3 ? `<span class="text-xs text-gray-500">+${material.photo_urls.length - 3}</span>` : ''}
                </div>
              ` : ''}
            </td>
            <td class="px-3 py-3 text-center font-medium">${material.quantity_used}</td>
            <td class="px-3 py-3 text-right">${formatCurrency(material.unit_cost)}</td>
            <td class="px-3 py-3 text-right font-semibold text-green-600 dark:text-green-400">${formatCurrency(material.total_cost)}</td>
            <td class="px-3 py-3">
              <div class="text-sm">${date}</div>
              ${material.used_by ? `<div class="text-xs text-gray-500">by ${material.used_by}</div>` : ''}
            </td>
          </tr>
        `;
      }).join('');
      
      if (window.lucide) lucide.createIcons();
    }
    
    // View material photo in full size
    window.viewMaterialPhoto = function(photoUrl) {
      // Create modal for photo viewing
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="relative max-w-4xl max-h-[90vh]">
          <img src="${photoUrl}" alt="Material photo" class="max-w-full max-h-[90vh] object-contain rounded-lg">
          <button 
            onclick="this.closest('.fixed').remove()"
            class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white rounded-full w-10 h-10 flex items-center justify-center transition"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      if (window.lucide) lucide.createIcons();
    };
    
    // Store materials data for export
    let currentJobMaterials = [];
    
    // Export job materials to CSV
    window.exportJobMaterials = function() {
      if (!currentJobId) {
        toast.error('No job selected', 'Error');
        return;
      }
      
      if (!currentJobMaterials || currentJobMaterials.length === 0) {
        toast.warning('No materials to export', 'Empty');
        return;
      }
      
      // Get job title for filename
      const jobTitle = document.getElementById('job-detail-title')?.textContent || 'job';
      const sanitizedTitle = jobTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
      
      // CSV headers
      const headers = [
        'Item Name',
        'Unit',
        'Quantity Used',
        'Unit Cost',
        'Total Cost',
        'Usage Date',
        'Used By',
        'Notes'
      ];
      
      // CSV rows
      const rows = currentJobMaterials.map(material => {
        const date = new Date(material.usage_date).toLocaleString();
        return [
          material.item_name || '',
          material.unit || '',
          material.quantity_used || 0,
          (material.unit_cost || 0).toFixed(2),
          (material.total_cost || 0).toFixed(2),
          date,
          material.used_by || '',
          (material.notes || '').replace(/"/g, '""') // Escape quotes
        ];
      });
      
      // Add summary row
      const totalQuantity = currentJobMaterials.reduce((sum, m) => sum + (m.quantity_used || 0), 0);
      const totalCost = currentJobMaterials.reduce((sum, m) => sum + (m.total_cost || 0), 0);
      
      rows.push([]); // Empty row
      rows.push(['TOTAL', '', totalQuantity, '', totalCost.toFixed(2), '', '', '']);
      
      // Create CSV content
      const csvContent = [
        headers.map(h => `"${h}"`).join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `job-materials-${sanitizedTitle}-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast.success('Materials exported to CSV', 'Success');
    };
    
    // Render materials cost breakdown chart
    function renderMaterialsChart(materials) {
      const chartEl = document.getElementById('job-materials-chart');
      if (!chartEl) return;
      
      // Group by item and sum costs
      const itemCosts = {};
      materials.forEach(m => {
        const itemName = m.item_name || 'Unknown';
        if (!itemCosts[itemName]) {
          itemCosts[itemName] = 0;
        }
        itemCosts[itemName] += m.total_cost || 0;
      });
      
      // Sort by cost (descending) and take top 10
      const sortedItems = Object.entries(itemCosts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      if (sortedItems.length === 0) {
        chartEl.innerHTML = '<p class="text-center text-gray-500 text-sm py-8">No cost data available</p>';
        return;
      }
      
      const maxCost = Math.max(...sortedItems.map(([_, cost]) => cost));
      
      // Create simple bar chart with HTML/CSS
      chartEl.innerHTML = sortedItems.map(([itemName, cost]) => {
        const percentage = (cost / maxCost) * 100;
        const barWidth = Math.max(percentage, 5); // Minimum 5% width for visibility
        
        return `
          <div class="mb-3">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-nfgblue dark:text-blue-400 truncate flex-1 mr-2">${itemName}</span>
              <span class="text-xs font-semibold text-green-600 dark:text-green-400">${formatCurrency(cost)}</span>
            </div>
            <div class="w-full bg-nfgray dark:bg-gray-700 rounded-full h-2 overflow-hidden">
              <div 
                class="bg-gradient-to-r from-blue-500 to-blue-600 h-full rounded-full transition-all duration-500"
                style="width: ${barWidth}%"
              ></div>
            </div>
          </div>
        `;
      }).join('');
    };
    
    async function renderJobTasks() {
      const tasks = await getJobTasks(currentJobId);
      const list = document.getElementById('job-tasks-list');
      
      if (tasks.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-sm">No tasks added yet.</p>';
        return;
      }

      // Check if user is staff to hide delete button
      const isStaff = currentUserProfile && currentUserProfile.role === 'staff';

      list.innerHTML = tasks.map(task => {
        const hasPhoto = task.photo_url && task.photo_url.length > 0;
        const isCompleted = task.completed;
        
        return `
          <div class="border border-nfgray rounded-xl p-4 ${isCompleted ? 'bg-green-50' : ''}">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-start gap-3 flex-1">
                <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                  onchange="toggleTask('${task.id}')" 
                  class="w-5 h-5 mt-0.5 text-nfgblue dark:text-blue-400 rounded border-nfgray focus:ring-2 focus:ring-nfgblue" />
                <div class="flex-1">
                  <h6 class="font-medium text-nfgblue dark:text-blue-400 ${isCompleted ? 'line-through' : ''}">${task.title}</h6>
                  ${task.description ? `<p class="text-sm text-gray-600 mt-1">${task.description}</p>` : ''}
                  ${task.photo_required ? '<p class="text-xs text-orange-600 mt-1">ðŸ“¸ Photo required</p>' : ''}
                </div>
              </div>
              ${!isStaff ? `
                <button onclick="deleteTask('${task.id}')" class="p-1 hover:bg-red-100 rounded text-red-600">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              ` : ''}
            </div>
            
            ${isCompleted && task.completed_at ? `
              <div class="mt-3 pt-3 border-t border-gray-200">
                <div class="flex items-center justify-between text-xs text-gray-500 mb-2">
                  <span>âœ… Completed at ${formatTimestamp(task.completed_at)}</span>
                </div>
                ${hasPhoto ? `
                  <button onclick="viewTaskPhoto('${task.photo_url}')" class="text-sm px-3 py-1.5 rounded-lg border border-green-200 text-green-700 hover:bg-green-50 w-full flex items-center justify-center gap-2">
                    <i data-lucide="image" class="w-4 h-4"></i>
                    <span>View Photo</span>
                  </button>
                ` : ''}
              </div>
            ` : (task.photo_required && !isCompleted ? `
              <button onclick="uploadTaskPhoto('${task.id}')" class="mt-3 w-full text-sm px-3 py-2 rounded-lg border border-nfgblue text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-600 dark:bg-gray-700">
                <i data-lucide="camera" class="w-4 h-4 inline"></i>
                Upload Photo
              </button>
            ` : '')}
          </div>
        `;
      }).join('');
      if (window.lucide) lucide.createIcons();
    }

    // Toggle task completion
    window.toggleTask = async function(taskId) {
      const tasks = await getJobTasks(currentJobId);
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        // If photo required and not uploaded, prevent completion
        if (task.photo_required && !task.photo_url && !task.completed) {
          toast.warning('Please upload a photo before completing this task.', 'Photo Required');
          await renderJobTasks(); // Reset checkbox
          return;
        }
        
        const newCompleted = !task.completed;
        const { error } = await supabase
          .from('job_tasks')
          .update({
            completed: newCompleted,
            completed_at: newCompleted ? new Date().toISOString() : null
          })
          .eq('id', taskId);

        if (error) {
          console.error('Error updating task:', error);
          toast.error('Failed to update task. Please try again.', 'Update Error');
        } else {
          await renderJobTasks();
          
          // Check if all tasks are now complete
          const updatedTasks = await getJobTasks(currentJobId);
          const allComplete = updatedTasks.length > 0 && updatedTasks.every(t => t.completed);
          
          if (allComplete && newCompleted) {
            console.log('ðŸŽ‰ All tasks completed!');
            
            // Get job to check if work is in progress
            const jobs = await getJobs();
            const job = jobs.find(j => j.id === currentJobId);
            
            if (job && job.work_started_at && !job.work_ended_at) {
              // Auto-complete job and stop timer
              const now = new Date().toISOString();
              const startTime = new Date(job.work_started_at).getTime();
              const endTime = new Date(now).getTime();
              const totalDuration = Math.floor((endTime - startTime) / 1000);
              
              const { error: jobError } = await supabase
                .from('jobs')
                .update({
                  status: 'completed',
                  work_ended_at: now,
                  total_duration: totalDuration
                })
                .eq('id', currentJobId);
              
              if (!jobError) {
                stopTimer();
                
                // Notify admins about job completion
                try {
                  const { notifyJobCompleted, getAdminUserIds } = await import('./js/notification-triggers.js');
                  const adminIds = await getAdminUserIds();
                  // Get site name from job data or fetch it
                  let siteName = job?.sites?.name;
                  if (!siteName && job?.site_id) {
                    const { data: site } = await supabase
                      .from('sites')
                      .select('name')
                      .eq('id', job.site_id)
                      .maybeSingle();
                    siteName = site?.name || `Site #${job.site_id}`;
                  } else if (!siteName) {
                    siteName = 'Unknown Site';
                  }
                  const jobTitle = job?.title || 'Untitled Job';
                  await notifyJobCompleted(currentJobId, adminIds, jobTitle, siteName);
                  console.log('âœ… Job completion notifications sent to admins');
                } catch (notifError) {
                  console.warn('âš ï¸ Failed to create job completion notifications:', notifError);
                }
                
                // Handle recurring job creation if applicable
                const completedJob = { ...job, status: 'completed' };
                const recurrenceResult = await handleJobCompletion(completedJob);
                
                toast.success(`${recurrenceResult.message}\nTotal time: ${formatDuration(totalDuration)}`, 'Job Completed! ðŸŽ‰');
                document.getElementById('jobDetailModal').classList.add('hidden');
                document.getElementById('jobDetailModal').classList.remove('flex');
                await renderJobs();
              }
            }
          }
        }
      }
    };

    // Delete task
    window.deleteTask = async function(taskId) {
      const confirmed = await showConfirm('Are you sure you want to delete this task?', 'Delete Task', 'warning');
      if (confirmed) {
        const { error } = await supabase
          .from('job_tasks')
          .delete()
          .eq('id', taskId);

        if (error) {
          console.error('Error deleting task:', error);
          toast.error('Failed to delete task. Please try again.', 'Delete Error');
        } else {
          await renderJobTasks();
        }
      }
    };

    // Upload task photo
    window.uploadTaskPhoto = function(taskId) {
      currentTaskId = taskId;
      document.getElementById('task-photo-input').value = '';
      document.getElementById('photo-preview').classList.add('hidden');
      const modal = document.getElementById('uploadPhotoModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    };

    // View task photo
    window.viewTaskPhoto = function(photoUrl) {
      if (photoUrl) {
        window.open(photoUrl, '_blank');
      } else {
        toast.error('Photo not found', 'View Photo');
      }
    };

    // Photo preview
    document.getElementById('task-photo-input')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          document.getElementById('preview-image').src = event.target.result;
          document.getElementById('photo-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    // Upload photo button
    document.getElementById('upload-photo-btn')?.addEventListener('click', async () => {
      const fileInput = document.getElementById('task-photo-input');
      const uploadBtn = document.getElementById('upload-photo-btn');
      
      if (!fileInput.files[0]) {
        toast.warning('Please select a photo first.', 'No Photo Selected');
        return;
      }

      const file = fileInput.files[0];
      
      // Validate file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        toast.warning('File is too large. Please select an image under 10MB.', 'File Too Large');
        return;
      }

      // Validate file type
      if (!file.type.startsWith('image/')) {
        toast.warning('Please select a valid image file.', 'Invalid File Type');
        return;
      }
      
      console.log('[Upload] Starting photo upload for task:', currentTaskId);
      console.log('[Upload] File:', file.name, 'Size:', (file.size / 1024).toFixed(2), 'KB');
      
      // Show loading state
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline animate-spin"></i> Uploading...';
      if (window.lucide) lucide.createIcons();

      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/${currentJobId}/${currentTaskId}_${Date.now()}.${fileExt}`;

      try {
        // Upload to Supabase Storage
        console.log('[Upload] Uploading to Supabase storage:', fileName);
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('job-photos')
          .upload(fileName, file);

        if (uploadError) {
          console.error('[Upload] âŒ Error uploading photo:', uploadError);
          if (uploadError.message.includes('not found')) {
            toast.error('Storage bucket not set up. Please see SETUP_PHOTO_STORAGE.md', 'Storage Error');
          } else {
            toast.error('Failed to upload photo: ' + uploadError.message, 'Upload Error');
          }
          return;
        }

        console.log('[Upload] âœ… Photo uploaded successfully:', uploadData);

        // Get public URL
        const { data: urlData } = supabase.storage
          .from('job-photos')
          .getPublicUrl(fileName);

        console.log('[Upload] Public URL:', urlData.publicUrl);

        // Update task with photo URL
        const { error: updateError } = await supabase
          .from('job_tasks')
          .update({
            photo_url: urlData.publicUrl,
            completed: true,
            completed_at: new Date().toISOString()
          })
          .eq('id', currentTaskId);

        if (updateError) {
          console.error('[Upload] âŒ Error updating task with photo:', updateError);
          toast.error('Failed to save photo: ' + updateError.message, 'Save Error');
        } else {
          console.log('[Upload] âœ… Task updated with photo URL and marked complete');
          // Close modal
          document.getElementById('uploadPhotoModal').classList.add('hidden');
          document.getElementById('uploadPhotoModal').classList.remove('flex');
          await renderJobTasks();
          toast.success('Photo uploaded and task completed!', 'Upload Complete');
        }
      } catch (err) {
        console.error('[Upload] âŒ Exception:', err);
        toast.error('An error occurred. Please try again.', 'Error');
      } finally {
        // Reset button
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = 'Upload & Complete Task';
        if (window.lucide) lucide.createIcons();
      }
    });

    // Add task
    document.getElementById('add-task-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const { error } = await supabase
        .from('job_tasks')
        .insert({
          job_id: currentJobId,
          title: formData.get('task_title'),
          description: formData.get('task_description') || null,
          photo_required: formData.get('task_required') === 'on',
          completed: false,
          photo_url: null
        });

      if (error) {
        console.error('Error adding task:', error);
        toast.error('Failed to add task. Please try again.', 'Add Task Error');
      } else {
        // Close modal
        document.getElementById('addTaskModal').classList.add('hidden');
        document.getElementById('addTaskModal').classList.remove('flex');
        e.target.reset();
        await renderJobTasks();
      }
    });

    // Assign employee
    document.getElementById('assign-employee-btn')?.addEventListener('click', async () => {
      const name = await showPrompt('Enter the employee name to assign to this job:', 'Assign Employee', '');
      if (name && name.trim()) {
        const { error } = await supabase
          .from('job_employees')
          .insert({
            job_id: currentJobId,
            name: name.trim(),
            role: 'Employee'
          });

        if (error) {
          console.error('Error assigning employee:', error);
          toast.error('Failed to assign employee. Please try again.', 'Assignment Error');
        } else {
          await renderJobEmployees();
        }
      }
    });

    // Remove employee
    window.removeEmployee = async function(empId) {
      const confirmed = await showConfirm('Are you sure you want to remove this employee from the job?', 'Remove Employee', 'warning');
      if (confirmed) {
        const { error } = await supabase
          .from('job_employees')
          .delete()
          .eq('id', empId);

        if (error) {
          console.error('Error removing employee:', error);
          toast.error('Failed to remove employee. Please try again.', 'Remove Error');
        } else {
          await renderJobEmployees();
        }
      }
    };

    // Update job status
    document.getElementById('update-status-btn')?.addEventListener('click', async () => {
      const statuses = ['pending', 'in-progress', 'completed', 'cancelled'];
      const jobs = await getJobs();
      const job = jobs.find(j => j.id === currentJobId);
      
      if (job) {
        const currentIndex = statuses.indexOf(job.status);
        const nextIndex = (currentIndex + 1) % statuses.length;
        const newStatus = statuses[nextIndex];
        
        const { error } = await supabase
          .from('jobs')
          .update({ status: newStatus })
          .eq('id', currentJobId);

        if (error) {
          console.error('Error updating job status:', error);
          toast.error('Failed to update status. Please try again.', 'Update Error');
        } else {
          // Handle recurring job creation if status changed to completed
          if (newStatus === 'completed') {
            const completedJob = { ...job, status: 'completed' };
            const recurrenceResult = await handleJobCompletion(completedJob);
            if (recurrenceResult.nextJob) {
              toast.success(recurrenceResult.message, 'Job Completed! ðŸŽ‰');
            }
          }
          
          // Refresh invoice section after status change
          await checkJobInvoice(currentJobId);
          
          // Update display
          document.getElementById('job-detail-status').textContent = newStatus.replace('-', ' ');
          await renderJobs();
        }
      }
    });

    // Cancel job (keeps for paper trail)
    document.getElementById('archive-job-btn')?.addEventListener('click', async () => {
      const confirmed = await showConfirm('Cancel this job? It will be marked as cancelled but kept for records.', 'Cancel Job', 'warning');
      if (confirmed) {
        const { error } = await supabase
          .from('jobs')
          .update({ 
            status: 'cancelled',
            cancelled_at: new Date().toISOString()
          })
          .eq('id', currentJobId);

        if (error) {
          console.error('Error cancelling job:', error);
          toast.error('Failed to cancel job. Please try again.', 'Cancel Error');
        } else {
          // Close modal and refresh
          document.getElementById('jobDetailModal').classList.add('hidden');
          document.getElementById('jobDetailModal').classList.remove('flex');
          await renderJobs();
          toast.success('Job has been cancelled successfully!', 'Job Cancelled');
        }
      }
    });

    // Delete job permanently (only for cancelled jobs)
    document.getElementById('delete-job-permanently-btn')?.addEventListener('click', async () => {
      const userInput = await showPrompt(
        'âš ï¸ PERMANENTLY DELETE THIS JOB?\n\n' +
        'This action CANNOT be undone!\n\n' +
        'The following will be permanently deleted:\n' +
        'â€¢ Job record\n' +
        'â€¢ All tasks\n' +
        'â€¢ All uploaded photos\n\n' +
        'Type "DELETE" to confirm:',
        'Permanent Deletion Warning',
        ''
      );
      
      if (userInput !== 'DELETE') {
        if (userInput !== null && userInput !== '') {
          toast.warning('Deletion cancelled. You must type "DELETE" exactly to confirm.', 'Cancelled');
        }
        return;
      }

      try {
        console.log('ðŸ—‘ï¸ Permanently deleting job:', currentJobId);
        
        // 1. Get all tasks to find photos
        const { data: tasks, error: tasksError } = await supabase
          .from('job_tasks')
          .select('photo_url')
          .eq('job_id', currentJobId);
        
        if (tasksError) throw tasksError;
        
        // 2. Delete photos from storage
        if (tasks && tasks.length > 0) {
          for (const task of tasks) {
            if (task.photo_url) {
              try {
                // Extract file path from URL
                const urlParts = task.photo_url.split('/job-photos/');
                if (urlParts.length === 2) {
                  const filePath = urlParts[1].split('?')[0]; // Remove query params
                  await supabase.storage
                    .from('job-photos')
                    .remove([filePath]);
                  console.log('ðŸ—‘ï¸ Deleted photo:', filePath);
                }
              } catch (photoError) {
                console.warn('Could not delete photo:', photoError);
                // Continue even if photo deletion fails
              }
            }
          }
        }
        
        // 3. Delete all tasks
        const { error: deleteTasksError } = await supabase
          .from('job_tasks')
          .delete()
          .eq('job_id', currentJobId);
        
        if (deleteTasksError) throw deleteTasksError;
        console.log('âœ… Deleted all tasks');
        
        // 4. Unlink from any bookings (don't delete bookings)
        const { error: unlinkError } = await supabase
          .from('bookings')
          .update({ job_id: null })
          .eq('job_id', currentJobId);
        
        if (unlinkError) {
          console.warn('Could not unlink bookings:', unlinkError);
          // Continue even if unlinking fails
        }
        
        // 5. Finally, delete the job
        const { error: deleteJobError } = await supabase
          .from('jobs')
          .delete()
          .eq('id', currentJobId);
        
        if (deleteJobError) throw deleteJobError;
        
        console.log('âœ… Job permanently deleted');
        
        // Close modal and refresh
        document.getElementById('jobDetailModal').classList.add('hidden');
        document.getElementById('jobDetailModal').classList.remove('flex');
        await renderJobs();
        
        toast.success('Job permanently deleted! All related data has been removed from the system.', 'Deletion Complete');
        
      } catch (error) {
        console.error('Error deleting job permanently:', error);
        toast.error('Failed to delete job: ' + error.message, 'Deletion Error');
      }
    });

    // Begin Work button (for staff)
    document.getElementById('begin-work-btn')?.addEventListener('click', async () => {
      const now = new Date().toISOString();
      
      // Update jobs table
      const { error: jobError } = await supabase
        .from('jobs')
        .update({ 
          status: 'in-progress',
          work_started_at: now
        })
        .eq('id', currentJobId);

      if (jobError) {
        console.error('Error starting work:', jobError);
        toast.error('Failed to start work. Please try again.');
        return;
      }

      // Create time log entry
      const { data: timeLog, error: timeLogError } = await supabase
        .from('staff_time_logs')
        .insert({
          user_id: currentUser.id,
          job_id: currentJobId,
          clock_in: now,
          status: 'pending'
        })
        .select()
        .single();
      
      if (timeLogError) {
        console.warn('âš ï¸ Could not create time log:', timeLogError);
        // Continue anyway - time log is not critical for timer functionality
      } else {
        console.log('âœ… Time log created:', timeLog);
      }
      
        console.log('âœ… Work started!');
      toast.success('Work started! Timer is running.');
        // Refresh the job view to show timer
        await viewJob(currentJobId);
    });

    // End Work button (for staff)
    document.getElementById('end-work-btn')?.addEventListener('click', async () => {
      const confirmed = await showConfirm('End work on this job? The timer will stop.', 'End Work', 'info');
      if (confirmed) {
        const now = new Date().toISOString();
        
        // Get current job to calculate duration
        const jobs = await getJobs();
        const job = jobs.find(j => j.id === currentJobId);
        
        if (!job || !job.work_started_at) {
          toast.error('Job start time not found.', 'Error');
          return;
        }
        
        const startTime = new Date(job.work_started_at).getTime();
        const endTime = new Date(now).getTime();
        const totalDuration = Math.floor((endTime - startTime) / 1000); // seconds
        
        // Check if all tasks are completed
        const tasks = await getJobTasks(currentJobId);
        const allTasksComplete = tasks.length > 0 && tasks.every(t => t.completed);
        
        const updateData = {
          work_ended_at: now,
          total_duration: totalDuration
        };
        
        // If all tasks complete, mark job as completed
        if (allTasksComplete) {
          updateData.status = 'completed';
        }
        
        // Check for overtime (8 hours = 28800 seconds)
        const OVERTIME_THRESHOLD = 8 * 3600; // 8 hours in seconds
        const isOvertime = totalDuration > OVERTIME_THRESHOLD;
        
        // Update jobs table
        const { error: jobError } = await supabase
          .from('jobs')
          .update(updateData)
          .eq('id', currentJobId);

        if (jobError) {
          console.error('Error ending work:', jobError);
          toast.error('Failed to end work. Please try again.', 'End Work Error');
          return;
        }

        // Update or create time log entry
        const { data: existingLog } = await supabase
          .from('staff_time_logs')
          .select('id')
          .eq('user_id', currentUser.id)
          .eq('job_id', currentJobId)
          .is('clock_out', null)
          .order('clock_in', { ascending: false })
          .limit(1)
          .maybeSingle();
        
        if (existingLog) {
          // Update existing log
          const { error: timeLogError } = await supabase
            .from('staff_time_logs')
            .update({
              clock_out: now,
              total_duration: totalDuration,
              is_overtime: isOvertime
            })
            .eq('id', existingLog.id);
          
          if (timeLogError) {
            console.warn('âš ï¸ Could not update time log:', timeLogError);
        } else {
            console.log('âœ… Time log updated:', existingLog.id);
          }
        } else {
          // Create new log (fallback if Begin Work didn't create one)
          const { error: timeLogError } = await supabase
            .from('staff_time_logs')
            .insert({
              user_id: currentUser.id,
              job_id: currentJobId,
              clock_in: job.work_started_at,
              clock_out: now,
              total_duration: totalDuration,
              is_overtime: isOvertime,
              status: 'pending'
            });
          
          if (timeLogError) {
            console.warn('âš ï¸ Could not create time log:', timeLogError);
          } else {
            console.log('âœ… Time log created (fallback)');
          }
        }
        
          stopTimer();
          console.log('âœ… Work ended! Duration:', formatDuration(totalDuration));
          if (allTasksComplete) {
            // Handle recurring job creation if applicable
            const updatedJob = { ...job, status: 'completed' };
            const recurrenceResult = await handleJobCompletion(updatedJob);
            
            toast.success(`${recurrenceResult.message}\nTotal time: ${formatDuration(totalDuration)}`, 'Job Completed! ðŸŽ‰');
            document.getElementById('jobDetailModal').classList.add('hidden');
            document.getElementById('jobDetailModal').classList.remove('flex');
            await renderJobs();
          } else {
            toast.info(`Work stopped. Total time: ${formatDuration(totalDuration)}`, 'Work Ended');
            await viewJob(currentJobId);
        }
      }
    });

    // Add task button
    document.getElementById('add-task-btn')?.addEventListener('click', () => {
      const modal = document.getElementById('addTaskModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    });

    // Generate invoice button
    document.getElementById('generate-invoice-btn')?.addEventListener('click', async () => {
      if (currentJobId) {
        await generateInvoiceFromJob(currentJobId);
      } else {
        toast.error('No job selected', 'Error');
      }
    });

    // Show/hide recurrence pattern based on frequency selection
    document.getElementById('job-frequency-select')?.addEventListener('change', (e) => {
      const recurrenceSection = document.getElementById('recurrence-pattern-section');
      if (e.target.value === 'recurring') {
        recurrenceSection?.classList.remove('hidden');
      } else {
        recurrenceSection?.classList.add('hidden');
      }
    });

    // Show/hide recurrence pattern in edit form
    document.getElementById('edit-job-frequency-select')?.addEventListener('change', (e) => {
      const recurrenceSection = document.getElementById('edit-recurrence-pattern-section');
      if (e.target.value === 'recurring') {
        recurrenceSection?.classList.remove('hidden');
      } else {
        recurrenceSection?.classList.add('hidden');
      }
    });
    
    // Create job
    // Date selection - show time input when date is selected
    document.getElementById('job-scheduled-date')?.addEventListener('change', (e) => {
      const timeSection = document.getElementById('job-time-section');
      if (e.target.value) {
        timeSection?.classList.remove('hidden');
        // Set default time to 9:00 AM if not already set
        const timeInput = document.getElementById('job-scheduled-time');
        if (timeInput && !timeInput.value) {
          timeInput.value = '09:00';
        }
      } else {
        timeSection?.classList.add('hidden');
      }
    });

    // All-day checkbox - toggle time input disabled state
    document.getElementById('job-all-day')?.addEventListener('change', (e) => {
      const timeInput = document.getElementById('job-scheduled-time');
      if (timeInput) {
        timeInput.disabled = e.target.checked;
        if (e.target.checked) {
          timeInput.value = ''; // Clear time when all-day is checked
        } else {
          timeInput.value = timeInput.value || '09:00'; // Set default if empty
        }
      }
    });

    document.getElementById('create-job-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const scheduledDate = formData.get('scheduled_date');
      const scheduledTime = formData.get('scheduled_time');
      const isAllDay = document.getElementById('job-all-day')?.checked || false;
      
      // Combine date + time into datetime string with proper timezone handling
      let scheduledDatetime = null;
      if (scheduledDate) {
        if (isAllDay || !scheduledTime) {
          // All-day event: store as date at midnight in user's local timezone
          // Create a Date object at midnight local time, then convert to ISO string
          const date = new Date(scheduledDate + 'T00:00:00');
          scheduledDatetime = date.toISOString();
        } else {
          // Timed event: combine date + time in user's local timezone
          // Create a Date object with local date/time, then convert to ISO string (UTC)
          const date = new Date(scheduledDate + 'T' + scheduledTime + ':00');
          scheduledDatetime = date.toISOString();
        }
      }
      
      const jobData = {
        title: formData.get('title'),
        site_id: formData.get('site_id'),
        job_type: formData.get('job_type'),
        frequency: formData.get('frequency'),
        status: 'pending',
        scheduled_date: scheduledDate || null, // Keep for backward compatibility
        scheduled_datetime: scheduledDatetime, // New datetime field
        is_all_day: isAllDay, // Track if all-day event
        estimated_hours: formData.get('estimated_hours') || null,
        description: formData.get('description') || null,
        user_id: currentUser.id,
        created_by: currentUser.id  // CRITICAL: Set the owner!
      };
      
      // Add recurrence pattern if this is a recurring job
      if (jobData.frequency === 'recurring') {
        jobData.recurrence_pattern = formData.get('recurrence_pattern') || 'weekly';
        jobData.recurrence_series_id = crypto.randomUUID();
      }
      
      const { error } = await supabase
        .from('jobs')
        .insert(jobData);

      if (error) {
        console.error('Error creating job:', error);
        document.getElementById('job-form-error').textContent = 'Failed to create job. Please try again.';
        document.getElementById('job-form-error').classList.remove('hidden');
      } else {
        document.getElementById('createJobModal').classList.add('hidden');
        document.getElementById('createJobModal').classList.remove('flex');
        e.target.reset();
        await renderJobs();
      }
    });

    // Filter tabs
    document.querySelectorAll('.job-filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        currentFilter = tab.dataset.status;
        document.querySelectorAll('.job-filter-tab').forEach(t => {
          t.classList.remove('text-nfgblue', 'border-nfgblue');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        tab.classList.remove('text-gray-500', 'border-transparent');
        tab.classList.add('text-nfgblue', 'border-nfgblue');
        // Clear selection when filter changes
        selectedJobs.clear();
        updateBulkActionsToolbar();
        renderJobs();
      });
    });

    // Select All checkbox
    document.getElementById('select-all-jobs')?.addEventListener('change', (e) => {
      if (e.target.checked) {
        selectAllJobs();
      } else {
        deselectAllJobs();
      }
    });

    // Bulk actions handlers
    document.getElementById('bulk-cancel-selection')?.addEventListener('click', () => {
      deselectAllJobs();
      renderJobs(); // Re-render to update visual state
    });

    // Bulk update status
    document.getElementById('bulk-update-status-btn')?.addEventListener('click', async () => {
      if (selectedJobs.size === 0) {
        toast.error('Please select at least one job');
        return;
      }
      
      const status = await showBulkStatusModal();
      if (!status) return; // User cancelled
      
      const confirmed = await showConfirm(
        `Update ${selectedJobs.size} job(s) to "${status.replace('-', ' ')}"?`,
        'Bulk Update Status'
      );
      if (!confirmed) return;
      
      await bulkUpdateJobStatus(status);
    });

    // Bulk assign worker
    document.getElementById('bulk-assign-worker-btn')?.addEventListener('click', async () => {
      if (selectedJobs.size === 0) {
        toast.error('Please select at least one job');
        return;
      }
      
      const workerId = await showBulkWorkerModal();
      if (!workerId) return; // User cancelled
      
      const confirmed = await showConfirm(
        `Assign ${selectedJobs.size} job(s) to selected worker?`,
        'Bulk Assign Worker'
      );
      if (!confirmed) return;
      
      await bulkAssignWorker(workerId);
    });

    // Bulk archive
    document.getElementById('bulk-archive-btn')?.addEventListener('click', async () => {
      if (selectedJobs.size === 0) {
        toast.error('Please select at least one job');
        return;
      }
      
      const confirmed = await showConfirm(
        `Archive ${selectedJobs.size} job(s)? They will be hidden from the main list but preserved for records.`,
        'Bulk Archive Jobs',
        'warning'
      );
      if (!confirmed) return;
      
      await bulkArchiveJobs();
    });

    // Bulk update job status
    async function bulkUpdateJobStatus(status) {
      const jobIds = Array.from(selectedJobs);
      
      try {
        const { error } = await supabase
          .from('jobs')
          .update({ status: status })
          .in('id', jobIds);
        
        if (error) {
          toast.error('Failed to update jobs: ' + error.message);
          return;
        }
        
        toast.success(`${jobIds.length} job(s) updated successfully`);
        deselectAllJobs();
        await renderJobs(); // Refresh list
      } catch (err) {
        console.error('Error bulk updating jobs:', err);
        toast.error('An error occurred while updating jobs');
      }
    }

    // Bulk assign worker
    async function bulkAssignWorker(workerId) {
      const jobIds = Array.from(selectedJobs);
      
      try {
        const { error } = await supabase
          .from('jobs')
          .update({ assigned_worker_id: workerId })
          .in('id', jobIds);
        
        if (error) {
          toast.error('Failed to assign jobs: ' + error.message);
          return;
        }
        
        toast.success(`${jobIds.length} job(s) assigned successfully`);
        deselectAllJobs();
        await renderJobs(); // Refresh list
      } catch (err) {
        console.error('Error bulk assigning jobs:', err);
        toast.error('An error occurred while assigning jobs');
      }
    }

    // Bulk archive jobs
    async function bulkArchiveJobs() {
      const jobIds = Array.from(selectedJobs);
      const now = new Date().toISOString();
      
      try {
        const { error } = await supabase
          .from('jobs')
          .update({ 
            archived_at: now,
            status: 'completed' // Optionally set status to completed
          })
          .in('id', jobIds);
        
        if (error) {
          toast.error('Failed to archive jobs: ' + error.message);
          return;
        }
        
        toast.success(`${jobIds.length} job(s) archived successfully`);
        deselectAllJobs();
        await renderJobs(); // Refresh list
      } catch (err) {
        console.error('Error archiving jobs:', err);
        toast.error('An error occurred while archiving jobs');
      }
    }

    // Show bulk status selection modal
    async function showBulkStatusModal() {
      return new Promise((resolve) => {
        const modal = document.getElementById('bulk-status-modal');
        const statusButtons = modal.querySelectorAll('[data-status]');
        const cancelBtn = modal.querySelector('[data-cancel-status]');
        
        // Remove existing listeners
        statusButtons.forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
        });
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Add new listeners
        modal.querySelectorAll('[data-status]').forEach(btn => {
          btn.addEventListener('click', () => {
            const status = btn.dataset.status;
            modal.classList.add('hidden');
            resolve(status);
          });
        });
        
        modal.querySelector('[data-cancel-status]').addEventListener('click', () => {
          modal.classList.add('hidden');
          resolve(null);
        });
        
        modal.classList.remove('hidden');
      });
    }

    // Show bulk worker selection modal
    async function showBulkWorkerModal() {
      return new Promise(async (resolve) => {
        const modal = document.getElementById('bulk-worker-modal');
        const workerList = document.getElementById('bulk-worker-list');
        const cancelBtn = modal.querySelector('[data-cancel-worker]');
        
        // Fetch workers
        workerList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Loading workers...</p>';
        modal.classList.remove('hidden');
        
        try {
          const { data: workers, error } = await supabase
            .from('user_profiles')
            .select('id, full_name, email')
            .eq('role', 'staff')
            .order('full_name');
          
          if (error) {
            workerList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load workers</p>';
            return;
          }
          
          if (workers.length === 0) {
            workerList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No workers available</p>';
            return;
          }
          
          workerList.innerHTML = workers.map(worker => `
            <button 
              data-worker-id="${worker.id}" 
              class="w-full px-4 py-3 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-700 text-left transition"
            >
              <span class="font-medium block">${worker.full_name || worker.email}</span>
              <p class="text-sm text-gray-500 dark:text-gray-400">${worker.email}</p>
            </button>
          `).join('');
          
          if (window.lucide) lucide.createIcons();
          
          // Add click listeners
          workerList.querySelectorAll('[data-worker-id]').forEach(btn => {
            btn.addEventListener('click', () => {
              const workerId = btn.dataset.workerId;
              modal.classList.add('hidden');
              resolve(workerId);
            });
          });
        } catch (err) {
          console.error('Error loading workers:', err);
          workerList.innerHTML = '<p class="text-red-500 text-center py-4">Failed to load workers</p>';
        }
        
        // Cancel handler
        const newCancelBtn = cancelBtn.cloneNode(true);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        newCancelBtn.addEventListener('click', () => {
          modal.classList.add('hidden');
          resolve(null);
        });
      });
    }

    // Load sites for dropdown
    async function loadSitesDropdown() {
      const sites = await getSites();
      const select = document.getElementById('job-site-select');
      if (select) {
        select.innerHTML = '<option value="">Select a site</option>' + 
          sites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
        
        // Reinitialize custom dropdown for this select
        const wrapper = select.previousElementSibling;
        if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
          wrapper.remove();
        }
        select.style.display = '';
        new NFGDropdown(select);
      }
    }

    // Load workers for dropdown
    async function loadWorkersDropdown() {
      // Fetch all staff members
      const { data: workers, error } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('role', 'staff')
        .eq('status', 'active')
        .order('full_name', { ascending: true });

      const select = document.getElementById('worker-select');
      if (select) {
        if (error || !workers || workers.length === 0) {
          select.innerHTML = '<option value="">No staff members available</option>';
        } else {
          select.innerHTML = '<option value="">Select a worker</option>' + 
            workers.map(worker => {
              const displayName = worker.full_name || worker.email.split('@')[0];
              return `<option value="${worker.id}">${displayName} (${worker.email})</option>`;
            }).join('');
        }
        
        // Reinitialize custom dropdown
        const wrapper = select.previousElementSibling;
        if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
          wrapper.remove();
        }
        select.style.display = '';
        new NFGDropdown(select);
      }
    }

    // Assign worker button
    document.getElementById('assign-worker-btn')?.addEventListener('click', async () => {
      await loadWorkersDropdown();
      const modal = document.getElementById('assignWorkerModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    });

    // Assign worker form submission
    document.getElementById('assign-worker-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const workerId = formData.get('worker_id');

      if (!workerId) {
        document.getElementById('assign-worker-error').textContent = 'Please select a worker';
        document.getElementById('assign-worker-error').classList.remove('hidden');
        return;
      }

      // Get job details for notification
      const jobs = await getJobs();
      const job = jobs.find(j => j.id === currentJobId);
      const jobTitle = job?.title || 'Untitled Job';
      // Get site name from joined sites data, or fetch it if not available
      let siteName = job?.sites?.name;
      if (!siteName && job?.site_id) {
        // Fallback: fetch site name if not in job data
        const { data: site } = await supabase
          .from('sites')
          .select('name')
          .eq('id', job.site_id)
          .maybeSingle();
        siteName = site?.name || `Site #${job.site_id}`;
      } else if (!siteName) {
        siteName = 'Unknown Site';
      }

      // Get scheduled datetime from job data if available
      const scheduledDatetime = job?.scheduled_datetime || null;
      const isAllDay = job?.is_all_day || false;

      const { error } = await supabase
        .from('jobs')
        .update({ assigned_worker_id: workerId })
        .eq('id', currentJobId);

      if (error) {
        console.error('Error assigning worker:', error);
        document.getElementById('assign-worker-error').textContent = 'Failed to assign worker. Please try again.';
        document.getElementById('assign-worker-error').classList.remove('hidden');
      } else {
        // Create notification for the assigned worker
        try {
          const { notifyJobAssigned } = await import('./js/notification-triggers.js');
          await notifyJobAssigned(
            currentJobId, 
            workerId, 
            jobTitle, 
            siteName,
            scheduledDatetime,
            isAllDay
          );
          console.log('âœ… Job assignment notification created');
        } catch (notifError) {
          console.warn('âš ï¸ Failed to create job assignment notification:', notifError);
        }

        document.getElementById('assignWorkerModal').classList.add('hidden');
        document.getElementById('assignWorkerModal').classList.remove('flex');
        e.target.reset();
        await renderAssignedWorker();
        await renderJobs();
        toast.success('Worker has been assigned successfully!', 'Worker Assigned');
      }
    });

    // Unassign worker
    window.unassignWorker = async function() {
      const confirmed = await showConfirm('Are you sure you want to remove the assigned worker from this job?', 'Unassign Worker', 'warning');
      if (!confirmed) return;
      
      const { error } = await supabase
        .from('jobs')
        .update({ assigned_worker_id: null })
        .eq('id', currentJobId);

      if (error) {
        console.error('Error unassigning worker:', error);
        toast.error('Failed to unassign worker. Please try again.', 'Unassign Error');
      } else {
        await renderAssignedWorker();
        await renderJobs();
        toast.success('Worker has been unassigned successfully!', 'Worker Unassigned');
      }
    };

    // Edit Job button handler
    document.getElementById('edit-job-btn')?.addEventListener('click', async () => {
      if (!currentJobId) {
        toast.error('No job selected', 'Error');
        return;
      }

      const jobs = await getJobs();
      const job = jobs.find(j => j.id === currentJobId);
      
      if (!job) {
        toast.error('Job not found', 'Error');
        return;
      }

      // Populate edit form with current job data
      document.getElementById('edit-job-title').value = job.title || '';
      document.getElementById('edit-job-type').value = job.job_type || 'cleaning';
      document.getElementById('edit-job-frequency-select').value = job.frequency || 'single visit';
      
      // Handle scheduled date and time
      const editDateInput = document.getElementById('edit-job-scheduled-date');
      const editTimeSection = document.getElementById('edit-job-time-section');
      const editTimeInput = document.getElementById('edit-job-scheduled-time');
      const editAllDayCheckbox = document.getElementById('edit-job-all-day');
      
      if (job.scheduled_datetime) {
        // Parse scheduled_datetime (UTC) and convert to local time
        const scheduledDate = new Date(job.scheduled_datetime);
        editDateInput.value = scheduledDate.toISOString().split('T')[0];
        
        // Show time section
        editTimeSection?.classList.remove('hidden');
        
        // Check if it's all-day
        const isAllDay = job.is_all_day || false;
        editAllDayCheckbox.checked = isAllDay;
        
        if (isAllDay) {
          // For all-day events, set time input to disabled and clear value
          editTimeInput.disabled = true;
          editTimeInput.value = '';
        } else {
          // For timed events, extract local time (HH:MM format)
          editTimeInput.disabled = false;
          const hours = String(scheduledDate.getHours()).padStart(2, '0');
          const minutes = String(scheduledDate.getMinutes()).padStart(2, '0');
          editTimeInput.value = `${hours}:${minutes}`;
        }
      } else if (job.scheduled_date) {
        // Fallback to scheduled_date if scheduled_datetime doesn't exist
        editDateInput.value = job.scheduled_date;
        editTimeSection?.classList.remove('hidden');
        const isAllDay = job.is_all_day !== undefined ? job.is_all_day : true;
        editAllDayCheckbox.checked = isAllDay;
        editTimeInput.disabled = isAllDay;
        if (!isAllDay) {
          // Default to 9:00 AM if not all-day but no time specified
          editTimeInput.value = '09:00';
        } else {
          editTimeInput.value = '';
        }
      } else {
        editDateInput.value = '';
        editTimeSection?.classList.add('hidden');
        editAllDayCheckbox.checked = true;
        editTimeInput.disabled = true;
        editTimeInput.value = '';
      }
      
      document.getElementById('edit-job-estimated-hours').value = job.estimated_hours || '';
      document.getElementById('edit-job-description').value = job.description || '';

      // Handle recurrence pattern
      const editRecurrenceSection = document.getElementById('edit-recurrence-pattern-section');
      if (job.frequency === 'recurring') {
        editRecurrenceSection?.classList.remove('hidden');
        document.getElementById('edit-job-recurrence-pattern').value = job.recurrence_pattern || 'weekly';
      } else {
        editRecurrenceSection?.classList.add('hidden');
      }

      // Helper function to clean up and reinitialize dropdown
      const cleanupAndInitDropdown = (selectElement) => {
        if (!selectElement) return;
        
        // Find the select element's parent container
        const parent = selectElement.parentElement;
        if (!parent) return;
        
        // Remove ALL existing wrappers that are siblings of this select
        // NFGDropdown inserts the wrapper BEFORE the select element
        let sibling = selectElement.previousElementSibling;
        while (sibling) {
          const nextSibling = sibling.previousElementSibling;
          if (sibling.classList && sibling.classList.contains('nfg-select-wrapper')) {
            sibling.remove();
          }
          sibling = nextSibling;
        }
        
        // Also check if select is inside a wrapper (shouldn't happen, but just in case)
        if (parent.classList && parent.classList.contains('nfg-select-wrapper')) {
          // Move select out of wrapper before removing wrapper
          const grandparent = parent.parentElement;
          if (grandparent) {
            grandparent.insertBefore(selectElement, parent);
            parent.remove();
          }
        }
        
        // Show the select element and make sure it's visible
        selectElement.style.display = '';
        selectElement.style.visibility = 'visible';
        
        // Reinitialize dropdown (this will create a new wrapper)
        new NFGDropdown(selectElement);
      };

      // Load sites dropdown for edit form
      const sites = await getSites();
      const editSiteSelect = document.getElementById('edit-job-site-select');
      if (editSiteSelect) {
        editSiteSelect.innerHTML = '<option value="">Select a site</option>' + 
          sites.map(site => `<option value="${site.id}" ${site.id == job.site_id ? 'selected' : ''}>${site.name}</option>`).join('');
        
        // Clean up and reinitialize
        cleanupAndInitDropdown(editSiteSelect);
      }

      // Clean up and reinitialize other dropdowns
      cleanupAndInitDropdown(document.getElementById('edit-job-type'));
      cleanupAndInitDropdown(document.getElementById('edit-job-frequency-select'));
      if (job.frequency === 'recurring') {
        cleanupAndInitDropdown(document.getElementById('edit-job-recurrence-pattern'));
      }

      // Open edit modal
      const modal = document.getElementById('editJobModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (window.lucide) lucide.createIcons();
    });

    // Edit Job form - Date selection - show time input when date is selected
    document.getElementById('edit-job-scheduled-date')?.addEventListener('change', (e) => {
      const timeSection = document.getElementById('edit-job-time-section');
      if (e.target.value) {
        timeSection?.classList.remove('hidden');
        // Set default time to 9:00 AM if not already set and not all-day
        const timeInput = document.getElementById('edit-job-scheduled-time');
        const allDayCheckbox = document.getElementById('edit-job-all-day');
        if (timeInput && !timeInput.value && !allDayCheckbox?.checked) {
          timeInput.value = '09:00';
        }
      } else {
        timeSection?.classList.add('hidden');
      }
    });

    // Edit Job form - All-day checkbox - toggle time input disabled state
    document.getElementById('edit-job-all-day')?.addEventListener('change', (e) => {
      const timeInput = document.getElementById('edit-job-scheduled-time');
      if (timeInput) {
        timeInput.disabled = e.target.checked;
        if (e.target.checked) {
          timeInput.value = ''; // Clear time when all-day is checked
        } else {
          timeInput.value = timeInput.value || '09:00'; // Set default if empty
        }
      }
    });

    // Edit Job form submission
    document.getElementById('edit-job-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentJobId) {
        toast.error('No job selected', 'Error');
        return;
      }

      const formData = new FormData(e.target);
      
      // Handle scheduled date and time
      const scheduledDate = formData.get('scheduled_date');
      const scheduledTime = formData.get('scheduled_time');
      const isAllDay = document.getElementById('edit-job-all-day')?.checked || false;
      
      // Combine date + time into datetime string with proper timezone handling
      let scheduledDatetime = null;
      if (scheduledDate) {
        if (isAllDay || !scheduledTime) {
          // All-day event: store as date at midnight in user's local timezone
          const date = new Date(scheduledDate + 'T00:00:00');
          scheduledDatetime = date.toISOString();
        } else {
          // Timed event: combine date + time in user's local timezone
          const date = new Date(scheduledDate + 'T' + scheduledTime + ':00');
          scheduledDatetime = date.toISOString();
        }
      }
      
      const jobData = {
        title: formData.get('title'),
        site_id: formData.get('site_id'),
        job_type: formData.get('job_type'),
        frequency: formData.get('frequency'),
        scheduled_date: scheduledDate || null, // Keep for backward compatibility
        scheduled_datetime: scheduledDatetime, // New datetime field with timezone
        is_all_day: isAllDay, // Track if all-day event
        estimated_hours: formData.get('estimated_hours') || null,
        description: formData.get('description') || null,
        updated_at: new Date().toISOString()
      };

      // Add recurrence pattern if this is a recurring job
      if (jobData.frequency === 'recurring') {
        jobData.recurrence_pattern = formData.get('recurrence_pattern') || 'weekly';
      } else {
        jobData.recurrence_pattern = null;
        jobData.recurrence_series_id = null;
      }

      const submitBtn = document.getElementById('submit-edit-job-btn');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      const { error } = await supabase
        .from('jobs')
        .update(jobData)
        .eq('id', currentJobId);

      submitBtn.disabled = false;
      submitBtn.textContent = originalText;

      if (error) {
        console.error('Error updating job:', error);
        document.getElementById('edit-job-form-error').textContent = 'Failed to update job. Please try again.';
        document.getElementById('edit-job-form-error').classList.remove('hidden');
        toast.error('Failed to update job: ' + error.message, 'Update Error');
      } else {
        document.getElementById('editJobModal').classList.add('hidden');
        document.getElementById('editJobModal').classList.remove('flex');
        e.target.reset();
        
        // Refresh job details and jobs list
        await viewJob(currentJobId);
        await renderJobs();
        toast.success('Job updated successfully!', 'Job Updated');
      }
    });

    // Update "Create Job" button
    const createJobBtn = document.querySelector('[data-action="open-modal"][data-target="createJobModal"]');
    if (!createJobBtn) {
      const header = document.querySelector('header .flex.items-center.gap-2:last-child');
      if (header) {
        const btn = header.querySelector('button');
        if (btn) {
          btn.setAttribute('data-action', 'open-modal');
          btn.setAttribute('data-target', 'createJobModal');
        }
      }
    }

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = './index.html';
    });

    // Initialize
    async function init() {
      console.log('[Jobs] ðŸš€ Initializing jobs page...');
      
      await getCurrentUser();
      if (!currentUser) {
        window.location.href = './index.html';
        return;
      }
      
      console.log('[Jobs] Current user:', currentUser.email);
      console.log('[Jobs] Current user profile:', currentUserProfile);
      
      // Test if viewJob is accessible
      console.log('[Jobs] viewJob function available:', typeof window.viewJob);
      
      // Hide "Create Job" button for staff users
      if (currentUserProfile && currentUserProfile.role === 'staff') {
        const createJobBtn = document.getElementById('create-job-btn');
        if (createJobBtn) {
          createJobBtn.style.display = 'none';
        }
        
        // Hide Reports navigation for staff (but allow Bookings for calendar view)
        const reportsNav = document.getElementById('nav-reports');
        if (reportsNav) reportsNav.style.display = 'none';
        
        // Update Bookings link text for staff to indicate calendar view
        const bookingsNav = document.getElementById('nav-bookings');
        if (bookingsNav) {
          const bookingsText = bookingsNav.querySelector('span') || bookingsNav.childNodes[bookingsNav.childNodes.length - 1];
          if (bookingsText && bookingsText.textContent) {
            bookingsText.textContent = 'Schedule';
          } else {
            bookingsNav.innerHTML = '<i data-lucide="calendar" class="w-4 h-4"></i> Schedule';
            if (window.lucide) lucide.createIcons();
          }
        }
      }
      
      await loadSitesDropdown();
      await renderJobs();
      
      // Listen for create job modal opening to reload sites dropdown
      window.addEventListener('createJobModalOpened', async () => {
        await loadSitesDropdown();
        
        // Initialize Job Type dropdown
        const jobTypeSelect = document.querySelector('#createJobModal select[name="job_type"]');
        if (jobTypeSelect) {
          // Clean up existing wrapper if any
          let wrapper = jobTypeSelect.previousElementSibling;
          if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
            wrapper.remove();
          }
          jobTypeSelect.style.display = '';
          new NFGDropdown(jobTypeSelect);
        }
        
        // Initialize Frequency dropdown
        const frequencySelect = document.getElementById('job-frequency-select');
        if (frequencySelect) {
          // Clean up existing wrapper if any
          let wrapper = frequencySelect.previousElementSibling;
          if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
            wrapper.remove();
          }
          frequencySelect.style.display = '';
          new NFGDropdown(frequencySelect);
        }
        
        // Initialize Recurrence Pattern dropdown (if visible)
        const recurrenceSelect = document.querySelector('#createJobModal select[name="recurrence_pattern"]');
        if (recurrenceSelect) {
          // Clean up existing wrapper if any
          let wrapper = recurrenceSelect.previousElementSibling;
          if (wrapper && wrapper.classList.contains('nfg-select-wrapper')) {
            wrapper.remove();
          }
          recurrenceSelect.style.display = '';
          new NFGDropdown(recurrenceSelect);
        }
      });
      
      console.log('[Jobs] âœ… Initialization complete');
      
      // Check if we need to auto-open a specific job (from URL parameter)
      const urlParams = new URLSearchParams(window.location.search);
      const jobIdParam = urlParams.get('job');
      if (jobIdParam) {
        console.log('[Jobs] ðŸ”— Auto-opening job from URL:', jobIdParam);
        setTimeout(() => {
          window.viewJob(jobIdParam);
        }, 500); // Small delay to ensure everything is loaded
      }
    }

    // Copy address to clipboard
    window.copyAddress = async function(address, event) {
      event?.stopPropagation();
      event?.preventDefault();
      
      try {
        await navigator.clipboard.writeText(address);
        
        // Show success feedback
        const button = event?.target.closest('button');
        if (button) {
          const originalHTML = button.innerHTML;
          button.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i>';
          button.classList.add('text-green-600');
          if (window.lucide) lucide.createIcons();
          
          setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('text-green-600');
            if (window.lucide) lucide.createIcons();
          }, 1500);
        }
      } catch (err) {
        console.error('Failed to copy address:', err);
        toast.error('Failed to copy address', 'Copy Error');
      }
    }

    init();
  </script>
  
  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- Hide loader when page is ready -->
  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('page-loader')?.classList.add('hidden');
      }, 300);
    });
  </script>
</body>
</html>



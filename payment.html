<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pay Invoice — NFG</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Stripe Elements -->
  <script src="https://js.stripe.com/v3/"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Stripe Elements styling */
    .StripeElement {
      background-color: white;
      padding: 12px 16px;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
    }

    .StripeElement--focus {
      border-color: #0D47A1;
      box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
      outline: none;
    }

    .StripeElement--invalid {
      border-color: #DC2626;
    }

    .StripeElement--complete {
      border-color: #059669;
    }

    .dark .StripeElement {
      background-color: #374151;
      border-color: #4B5563;
      color: #F3F4F6;
    }

    .dark .StripeElement--focus {
      border-color: #60A5FA;
    }
  </style>
</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen">
  <!-- Loading State -->
  <div id="loading-state" class="min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-nfgblue mb-4"></div>
      <p class="text-gray-600 dark:text-gray-400">Loading invoice...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-state" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-red-200 dark:border-red-800 p-8 max-w-md w-full text-center">
      <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
      <h2 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-2">Invoice Not Found</h2>
      <p id="error-message" class="text-gray-600 dark:text-gray-400 mb-6"></p>
      <a href="index.html" class="inline-block px-6 py-3 bg-nfgblue text-white rounded-xl font-medium hover:bg-nfgdark transition">
        Go to Home
      </a>
    </div>
  </div>

  <!-- Already Paid State -->
  <div id="paid-state" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-green-200 dark:border-green-800 p-8 max-w-md w-full text-center">
      <i data-lucide="check-circle" class="w-16 h-16 mx-auto text-green-500 mb-4"></i>
      <h2 class="text-2xl font-semibold text-green-600 dark:text-green-400 mb-2">Invoice Already Paid</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-6">This invoice has already been paid in full.</p>
      <a href="index.html" class="inline-block px-6 py-3 bg-nfgblue text-white rounded-xl font-medium hover:bg-nfgdark transition">
        Go to Home
      </a>
    </div>
  </div>

  <!-- Payment Page -->
  <div id="payment-container" class="hidden min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <img 
          src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/Untitled%20design.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL1VudGl0bGVkIGRlc2lnbi5wbmciLCJpYXQiOjE3NjQ5NzExMTUsImV4cCI6NDg4NzAzNTExNX0.gLGPNDBFahGt3_dmWSFIny3YZbuU3eWBA86Gnu2Umpw" 
          alt="handl.it" 
          class="h-16 mx-auto mb-4 company-logo"
          data-branding="logo"
        />
        <h1 class="text-3xl font-bold text-nfgblue dark:text-blue-400 mb-2">Pay Invoice</h1>
        <p class="text-gray-600 dark:text-gray-400">Secure payment powered by Stripe</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Invoice Details (Left Column) -->
        <div class="lg:col-span-1">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray p-6 sticky top-4">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Invoice Details</h3>
            
            <div class="space-y-4">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Invoice Number</p>
                <p id="invoice-number" class="font-semibold text-lg">—</p>
              </div>

              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Client</p>
                <p id="invoice-client" class="font-medium">—</p>
              </div>

              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Due Date</p>
                <p id="invoice-due-date" class="font-medium">—</p>
              </div>

              <div class="pt-4 border-t border-nfgray dark:border-gray-600">
                <div class="flex justify-between items-center mb-2">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Amount Due</p>
                  <p id="invoice-balance" class="text-2xl font-bold text-nfgblue dark:text-blue-400">$0.00</p>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Total: <span id="invoice-total">$0.00</span></p>
              </div>
            </div>

            <!-- Line Items Preview -->
            <div class="mt-6 pt-6 border-t border-nfgray dark:border-gray-600">
              <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Line Items</p>
              <div id="invoice-line-items" class="space-y-2 text-sm">
                <p class="text-gray-500">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Form (Right Column) -->
        <div class="lg:col-span-2">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray p-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-6">Payment Information</h3>

            <!-- Payment Method Selection -->
            <div class="mb-6">
              <label class="block text-sm font-medium mb-3 dark:text-gray-200">Payment Method</label>
              <div class="grid grid-cols-2 gap-3">
                <button 
                  id="method-card-btn"
                  class="payment-method-btn active px-4 py-3 rounded-xl border-2 border-nfgblue bg-nfglight dark:bg-blue-900/20 text-nfgblue dark:text-blue-400 font-medium transition"
                >
                  <i data-lucide="credit-card" class="w-5 h-5 inline mr-2"></i>
                  Credit Card
                </button>
                <button 
                  id="method-ach-btn"
                  class="payment-method-btn px-4 py-3 rounded-xl border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 font-medium transition"
                >
                  <i data-lucide="building-2" class="w-5 h-5 inline mr-2"></i>
                  Bank Account
                </button>
              </div>
            </div>

            <!-- Payment Form -->
            <form id="payment-form">
              <!-- Card Payment -->
              <div id="card-payment-section" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2 dark:text-gray-200">Card Information</label>
                  <div id="card-element" class="StripeElement">
                    <!-- Stripe Elements will create form elements here -->
                  </div>
                  <div id="card-errors" class="text-red-600 text-sm mt-2 hidden"></div>
                </div>

                <div>
                  <label class="block text-sm font-medium mb-2 dark:text-gray-200">Billing Email</label>
                  <input 
                    type="email" 
                    id="billing-email"
                    required
                    class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-3 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none"
                    placeholder="your@email.com"
                  />
                </div>
              </div>

              <!-- ACH Payment -->
              <div id="ach-payment-section" class="hidden space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-2 dark:text-gray-200">Bank Account</label>
                  <div id="bank-element" class="StripeElement">
                    <!-- Stripe Elements will create form elements here -->
                  </div>
                  <div id="bank-errors" class="text-red-600 text-sm mt-2 hidden"></div>
                </div>

                <div>
                  <label class="block text-sm font-medium mb-2 dark:text-gray-200">Billing Email</label>
                  <input 
                    type="email" 
                    id="ach-billing-email"
                    required
                    class="w-full border border-nfgray dark:border-gray-600 rounded-xl p-3 dark:bg-gray-700 focus:ring-2 focus:ring-nfgblue outline-none"
                    placeholder="your@email.com"
                  />
                </div>

                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4">
                  <p class="text-sm text-blue-800 dark:text-blue-200">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                    <strong>Bank transfers</strong> take 5-7 business days to process and have lower fees.
                  </p>
                </div>
              </div>

              <!-- Error Message -->
              <div id="payment-error" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4">
                <p id="payment-error-message" class="text-sm text-red-600 dark:text-red-400"></p>
              </div>

              <!-- Submit Button -->
              <button 
                type="submit"
                id="submit-payment-btn"
                class="w-full bg-nfgblue hover:bg-nfgdark text-white font-semibold py-4 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span id="submit-text">Pay <span id="payment-amount">$0.00</span></span>
                <span id="submit-loading" class="hidden">Processing...</span>
              </button>

              <!-- Security Badge -->
              <div class="mt-4 text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center justify-center gap-2">
                  <i data-lucide="lock" class="w-4 h-4"></i>
                  Secure payment powered by Stripe
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Receipt State -->
  <div id="success-state" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-green-200 dark:border-green-800 p-8 max-w-md w-full text-center">
      <i data-lucide="check-circle" class="w-16 h-16 mx-auto text-green-500 mb-4"></i>
      <h2 class="text-2xl font-semibold text-green-600 dark:text-green-400 mb-2">Payment Successful!</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">Your payment has been processed successfully.</p>
      
      <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 mb-6 text-left">
        <div class="flex justify-between mb-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Invoice:</span>
          <span id="receipt-invoice" class="text-sm font-medium">—</span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">Amount Paid:</span>
          <span id="receipt-amount" class="text-sm font-medium">—</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-600 dark:text-gray-400">Payment Method:</span>
          <span id="receipt-method" class="text-sm font-medium">—</span>
        </div>
      </div>

      <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
        A receipt has been sent to your email address.
      </p>

      <div class="flex gap-3">
        <a 
          id="receipt-link"
          href="#"
          target="_blank"
          class="flex-1 px-4 py-2 border border-nfgblue text-nfgblue dark:text-blue-400 rounded-xl font-medium hover:bg-nfglight dark:hover:bg-blue-900/20 transition"
        >
          View Receipt
        </a>
        <a 
          href="index.html"
          class="flex-1 px-4 py-2 bg-nfgblue text-white rounded-xl font-medium hover:bg-nfgdark transition"
        >
          Done
        </a>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabase.js'

    // Get invoice ID or number from URL
    const urlParams = new URLSearchParams(window.location.search)
    const invoiceId = urlParams.get('invoice_id') || urlParams.get('id')
    const invoiceNumber = urlParams.get('invoice_number') || urlParams.get('invoice')

    let stripe = null
    let cardElement = null
    let bankElement = null
    let elements = null
    let currentPaymentMethod = 'card'
    let invoiceData = null
    let paymentIntentData = null

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.lucide) lucide.createIcons()

      if (!invoiceId && !invoiceNumber) {
        showError('Invoice ID or number is required in the URL')
        return
      }

      await loadInvoice()
    })

    // Load invoice details
    async function loadInvoice() {
      try {
        let query = supabase
          .from('invoices')
          .select(`
            *,
            sites:site_id(name),
            clients:client_id(full_name, email)
          `)

        if (invoiceId) {
          query = query.eq('id', invoiceId).single()
        } else {
          query = query.eq('invoice_number', invoiceNumber).single()
        }

        const { data: invoice, error } = await query

        if (error || !invoice) {
          showError('Invoice not found. Please check the link and try again.')
          return
        }

        invoiceData = invoice

        // Check if already paid
        if (invoice.status === 'paid' || parseFloat(invoice.balance_due || 0) <= 0) {
          showPaidState()
          return
        }

        // Display invoice details
        displayInvoiceDetails(invoice)

        // Initialize payment
        await initializePayment()

      } catch (error) {
        console.error('Error loading invoice:', error)
        showError('Failed to load invoice. Please try again.')
      }
    }

    // Display invoice details
    function displayInvoiceDetails(invoice) {
      document.getElementById('invoice-number').textContent = invoice.invoice_number || 'N/A'
      document.getElementById('invoice-client').textContent = invoice.clients?.full_name || invoice.clients?.email || 'N/A'
      document.getElementById('invoice-due-date').textContent = invoice.due_date 
        ? new Date(invoice.due_date).toLocaleDateString()
        : 'N/A'
      document.getElementById('invoice-balance').textContent = `$${parseFloat(invoice.balance_due || invoice.total_amount).toFixed(2)}`
      document.getElementById('invoice-total').textContent = `$${parseFloat(invoice.total_amount).toFixed(2)}`
      document.getElementById('payment-amount').textContent = `$${parseFloat(invoice.balance_due || invoice.total_amount).toFixed(2)}`

      // Load line items
      loadLineItems(invoice.id)

      // Hide loading, show payment form
      document.getElementById('loading-state').classList.add('hidden')
      document.getElementById('payment-container').classList.remove('hidden')
    }

    // Load line items
    async function loadLineItems(invoiceId) {
      try {
        const { data: lineItems } = await supabase
          .from('invoice_line_items')
          .select('*')
          .eq('invoice_id', invoiceId)

        const container = document.getElementById('invoice-line-items')
        if (lineItems && lineItems.length > 0) {
          container.innerHTML = lineItems.map(item => `
            <div class="flex justify-between text-xs">
              <span class="text-gray-600 dark:text-gray-400">${item.description || 'Item'}</span>
              <span class="font-medium">$${parseFloat(item.amount || 0).toFixed(2)}</span>
            </div>
          `).join('')
        } else {
          container.innerHTML = '<p class="text-gray-500 text-xs">No line items</p>'
        }
      } catch (error) {
        console.error('Error loading line items:', error)
      }
    }

    // Initialize payment
    async function initializePayment() {
      try {
        // Create payment intent
        const response = await supabase.functions.invoke('create-payment-intent', {
          body: {
            invoice_id: invoiceData.id,
            invoice_number: invoiceData.invoice_number
          }
        })

        if (response.error) {
          throw new Error(response.error.message || 'Failed to initialize payment')
        }

        paymentIntentData = response.data

        // Get Stripe publishable key via Edge Function
        const keyResponse = await supabase.functions.invoke('get-stripe-key', {
          body: {
            invoice_id: invoiceData.id
          }
        })

        if (keyResponse.error) {
          throw new Error('Failed to load payment gateway. Please contact support.')
        }

        const STRIPE_PUBLISHABLE_KEY = keyResponse.data.publishable_key
        
        if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY.includes('placeholder')) {
          throw new Error('Payment gateway not configured. Please contact the invoice sender.')
        }

        stripe = Stripe(STRIPE_PUBLISHABLE_KEY)
        elements = stripe.elements({
          clientSecret: paymentIntentData.client_secret,
          appearance: {
            theme: document.documentElement.classList.contains('dark') ? 'night' : 'stripe',
            variables: {
              colorPrimary: '#0D47A1',
              borderRadius: '12px'
            }
          }
        })

        // Create card element
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#1E293B',
              fontFamily: '"Inter", sans-serif',
              '::placeholder': {
                color: '#9CA3AF'
              }
            }
          }
        })
        cardElement.mount('#card-element')

        cardElement.on('change', (event) => {
          const displayError = document.getElementById('card-errors')
          if (event.error) {
            displayError.textContent = event.error.message
            displayError.classList.remove('hidden')
          } else {
            displayError.classList.add('hidden')
          }
        })

        // Create bank account element (for ACH)
        bankElement = elements.create('usBankAccount', {
          style: {
            base: {
              fontSize: '16px',
              color: '#1E293B',
              fontFamily: '"Inter", sans-serif'
            }
          }
        })
        bankElement.mount('#bank-element')

        bankElement.on('change', (event) => {
          const displayError = document.getElementById('bank-errors')
          if (event.error) {
            displayError.textContent = event.error.message
            displayError.classList.remove('hidden')
          } else {
            displayError.classList.add('hidden')
          }
        })

        // Payment method selection
        document.getElementById('method-card-btn').addEventListener('click', () => {
          currentPaymentMethod = 'card'
          document.getElementById('card-payment-section').classList.remove('hidden')
          document.getElementById('ach-payment-section').classList.add('hidden')
          document.getElementById('method-card-btn').classList.add('active', 'border-nfgblue', 'bg-nfglight', 'dark:bg-blue-900/20', 'text-nfgblue', 'dark:text-blue-400')
          document.getElementById('method-card-btn').classList.remove('border-nfgray', 'dark:border-gray-600')
          document.getElementById('method-ach-btn').classList.remove('active', 'border-nfgblue', 'bg-nfglight', 'dark:bg-blue-900/20', 'text-nfgblue', 'dark:text-blue-400')
          document.getElementById('method-ach-btn').classList.add('border-nfgray', 'dark:border-gray-600')
        })

        document.getElementById('method-ach-btn').addEventListener('click', () => {
          currentPaymentMethod = 'ach'
          document.getElementById('card-payment-section').classList.add('hidden')
          document.getElementById('ach-payment-section').classList.remove('hidden')
          document.getElementById('method-ach-btn').classList.add('active', 'border-nfgblue', 'bg-nfglight', 'dark:bg-blue-900/20', 'text-nfgblue', 'dark:text-blue-400')
          document.getElementById('method-ach-btn').classList.remove('border-nfgray', 'dark:border-gray-600')
          document.getElementById('method-card-btn').classList.remove('active', 'border-nfgblue', 'bg-nfglight', 'dark:bg-blue-900/20', 'text-nfgblue', 'dark:text-blue-400')
          document.getElementById('method-card-btn').classList.add('border-nfgray', 'dark:border-gray-600')
        })

        // Form submission
        document.getElementById('payment-form').addEventListener('submit', handlePayment)

      } catch (error) {
        console.error('Error initializing payment:', error)
        showError(error.message || 'Failed to initialize payment. Please try again.')
      }
    }

    // Handle payment submission
    async function handlePayment(e) {
      e.preventDefault()

      const submitBtn = document.getElementById('submit-payment-btn')
      const submitText = document.getElementById('submit-text')
      const submitLoading = document.getElementById('submit-loading')
      const errorDiv = document.getElementById('payment-error')
      const errorMessage = document.getElementById('payment-error-message')

      // Disable button
      submitBtn.disabled = true
      submitText.classList.add('hidden')
      submitLoading.classList.remove('hidden')
      errorDiv.classList.add('hidden')

      try {
        const email = currentPaymentMethod === 'card' 
          ? document.getElementById('billing-email').value
          : document.getElementById('ach-billing-email').value

        if (!email) {
          throw new Error('Billing email is required')
        }

        // Confirm payment with Stripe
        const { error: stripeError, paymentIntent } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: `${window.location.origin}/payment.html?invoice_id=${invoiceData.id}&success=true`,
            payment_method_data: {
              billing_details: {
                email: email
              }
            }
          },
          redirect: 'if_required'
        })

        if (stripeError) {
          throw new Error(stripeError.message)
        }

        // If payment succeeded, process it
        if (paymentIntent && paymentIntent.status === 'succeeded') {
          await processPayment(paymentIntent.id)
        } else {
          // Payment requires action (like 3D Secure)
          // Stripe Elements will handle the redirect
        }

      } catch (error) {
        console.error('Payment error:', error)
        errorMessage.textContent = error.message || 'Payment failed. Please try again.'
        errorDiv.classList.remove('hidden')
        
        submitBtn.disabled = false
        submitText.classList.remove('hidden')
        submitLoading.classList.add('hidden')
      }
    }

    // Process payment after Stripe confirms
    async function processPayment(paymentIntentId) {
      try {
        const response = await supabase.functions.invoke('process-client-payment', {
          body: {
            payment_intent_id: paymentIntentId,
            invoice_id: invoiceData.id
          }
        })

        if (response.error) {
          throw new Error(response.error.message || 'Failed to process payment')
        }

        // Show success
        showSuccess(response.data)

      } catch (error) {
        console.error('Error processing payment:', error)
        throw error
      }
    }

    // Show success state
    function showSuccess(paymentData) {
      document.getElementById('payment-container').classList.add('hidden')
      document.getElementById('success-state').classList.remove('hidden')

      document.getElementById('receipt-invoice').textContent = invoiceData.invoice_number
      document.getElementById('receipt-amount').textContent = `$${parseFloat(paymentData.payment.amount).toFixed(2)}`
      document.getElementById('receipt-method').textContent = paymentData.payment.status === 'succeeded' 
        ? (currentPaymentMethod === 'card' ? 'Credit Card' : 'Bank Transfer')
        : 'Processing...'

      if (paymentData.payment.receipt_url) {
        document.getElementById('receipt-link').href = paymentData.payment.receipt_url
      } else {
        document.getElementById('receipt-link').classList.add('hidden')
      }

      if (window.lucide) lucide.createIcons()
    }

    // Show error state
    function showError(message) {
      document.getElementById('loading-state').classList.add('hidden')
      document.getElementById('error-state').classList.remove('hidden')
      document.getElementById('error-message').textContent = message
      if (window.lucide) lucide.createIcons()
    }

    // Show paid state
    function showPaidState() {
      document.getElementById('loading-state').classList.add('hidden')
      document.getElementById('paid-state').classList.remove('hidden')
      if (window.lucide) lucide.createIcons()
    }

    // Handle success redirect
    if (urlParams.get('success') === 'true' && invoiceId) {
      // Payment was successful, check status
      checkPaymentStatus()
    }

    async function checkPaymentStatus() {
      try {
        const { data: invoice } = await supabase
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single()

        if (invoice && invoice.status === 'paid') {
          // Get payment details
          const { data: payment } = await supabase
            .from('payments')
            .select('*')
            .eq('invoice_id', invoiceId)
            .order('payment_date', { ascending: false })
            .limit(1)
            .single()

          showSuccess({
            payment: {
              amount: payment?.amount || invoice.total_amount,
              receipt_url: payment?.receipt_url
            }
          })
        } else {
          // Still processing
          showError('Payment is still processing. Please wait a moment and refresh.')
        }
      } catch (error) {
        console.error('Error checking payment status:', error)
      }
    }
  </script>
</body>
</html>

